<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIN-TEL AgroManager PRO v4.0 | Sistema de Gesti贸n Ganadera Integral</title>
    
    <!-- Font Awesome para iconos WIN-TEL -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet para Mapas Satelitales (solo se carga si se accede a la vista de mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Leaflet Draw para dibujar pol铆gonos en el mapa -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Leaflet GeometryUtil para c谩lculos geod茅sicos -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>
    
    <!-- jsPDF para generaci贸n de reportes PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- QRCode.js para generaci贸n de c贸digos QR OFFLINE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* ========================================
           RESET Y VARIABLES
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Paleta Profesional Ganadera */
            --verde-oscuro: #0f3629;
            --verde-medio: #2d6a4f;
            --verde-claro: #52b788;
            --verde-muy-claro: #d8f3dc;
            --acento-dorado: #d4a373;
            --acento-dorado-oscuro: #b08968;
            
            /* Neutrales */
            --gris-900: #1a1a1a;
            --gris-800: #2d2d2d;
            --gris-700: #404040;
            --gris-600: #666666;
            --gris-400: #999999;
            --gris-300: #cccccc;
            --gris-200: #e5e5e5;
            --gris-100: #f5f5f5;
            --blanco: #ffffff;
            
            /* Estados */
            --azul: #3b82f6;
            --rojo: #ef4444;
            --amarillo: #fbbf24;
            --verde: #10b981;
            
            /* Sombras */
            --sombra-sm: 0 1px 2px rgba(0,0,0,0.05);
            --sombra-md: 0 4px 6px rgba(0,0,0,0.07);
            --sombra-lg: 0 10px 15px rgba(0,0,0,0.1);
            --sombra-xl: 0 20px 25px rgba(0,0,0,0.15);
            
            /* Animaciones */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* ========================================
           TIPOGRAFA Y BASE
        ======================================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, var(--gris-100) 0%, var(--gris-200) 100%);
            color: var(--gris-800);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ========================================
           PANTALLA DE LOGIN
        ======================================== */
        #loginScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }

        .login-container {
            background: var(--blanco);
            border-radius: 24px;
            box-shadow: var(--sombra-xl);
            padding: 48px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            animation: slideUp 0.6s ease;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--verde-claro) 0%, var(--verde-medio) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
            box-shadow: var(--sombra-md);
        }

        .login-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--verde-oscuro);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .login-subtitle {
            color: var(--gris-600);
            font-size: 14px;
            margin-bottom: 32px;
            font-weight: 500;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input-group {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gris-400);
            font-size: 18px;
        }

        .login-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 2px solid var(--gris-200);
            border-radius: 12px;
            font-size: 15px;
            transition: all var(--transition-normal);
            background: var(--gris-100);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--verde-claro);
            background: var(--blanco);
            box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
        }

        .login-button {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: var(--blanco);
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--sombra-md);
            margin-top: 8px;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-lg);
        }

        .login-button:active {
            transform: translateY(0);
        }

        /* ========================================
           LAYOUT PRINCIPAL
        ======================================== */
        #mainApp {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .app-layout {
            display: flex;
            height: 100%;
        }

        /* ========================================
           SIDEBAR
        ======================================== */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--verde-oscuro) 0%, #0a2419 100%);
            color: var(--blanco);
            display: flex;
            flex-direction: column;
            box-shadow: var(--sombra-xl);
            position: relative;
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--acento-dorado);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .sidebar-logo-text {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            margin-bottom: 4px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--blanco);
        }

        .nav-item.active {
            background: var(--verde-medio);
            color: var(--blanco);
            border-left-color: var(--acento-dorado);
            box-shadow: var(--sombra-md);
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--acento-dorado) 0%, var(--acento-dorado-oscuro) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: var(--sombra-md);
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 12px;
            color: var(--verde-claro);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--verde-claro);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .logout-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 8px;
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            background: rgba(255, 0, 0, 0.2);
            color: var(--rojo);
        }

        /* ========================================
           CONTENIDO PRINCIPAL
        ======================================== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: var(--blanco);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--sombra-sm);
            z-index: 10;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gris-900);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--verde-claro) 0%, var(--verde-medio) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blanco);
            font-size: 18px;
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .date-display {
            color: var(--gris-600);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--gris-100);
            border-radius: 10px;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: var(--gris-100);
        }

        /* ========================================
           KPI CARDS
        ======================================== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--blanco);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-sm);
            border-left: 4px solid var(--azul);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: currentColor;
            opacity: 0.05;
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-lg);
        }

        .kpi-card.azul { border-left-color: var(--azul); color: var(--azul); }
        .kpi-card.rojo { border-left-color: var(--rojo); color: var(--rojo); }
        .kpi-card.verde { border-left-color: var(--verde); color: var(--verde); }
        .kpi-card.dorado { border-left-color: var(--acento-dorado); color: var(--acento-dorado); }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .kpi-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gris-600);
        }

        .kpi-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: currentColor;
            color: var(--blanco);
            opacity: 0.9;
            font-size: 16px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--gris-900);
            line-height: 1;
            margin-bottom: 8px;
        }

        .kpi-trend {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-trend.up { color: var(--verde); }
        .kpi-trend.down { color: var(--rojo); }
        .kpi-trend.neutral { color: var(--gris-600); }

        /* ========================================
           CARDS Y PANELES
        ======================================== */
        .card {
            background: var(--blanco);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-sm);
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gris-100);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gris-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title-icon {
            color: var(--verde-medio);
            font-size: 20px;
        }

        /* ========================================
           TABLAS
        ======================================== */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--gris-200);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: var(--blanco);
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid var(--gris-200);
            transition: all var(--transition-fast);
        }

        tbody tr:hover {
            background: var(--gris-100);
        }

        td {
            padding: 16px;
        }

        /* ========================================
           BADGES Y ESTADOS
        ======================================== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge.libre {
            background: rgba(16, 185, 129, 0.1);
            color: var(--verde);
        }

        .badge.ocupado {
            background: rgba(239, 68, 68, 0.1);
            color: var(--rojo);
        }

        .badge.descanso {
            background: rgba(251, 191, 36, 0.1);
            color: var(--amarillo);
        }

        /* ========================================
           BOTONES
        ======================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition-normal);
            box-shadow: var(--sombra-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: var(--blanco);
        }

        .btn-secondary {
            background: var(--gris-100);
            color: var(--gris-700);
        }

        .btn-secondary:hover {
            background: var(--gris-200);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--rojo) 0%, #dc2626 100%);
            color: var(--blanco);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--verde) 0%, #059669 100%);
            color: var(--blanco);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-icon {
            padding: 10px;
            aspect-ratio: 1;
            justify-content: center;
        }

        /* ========================================
           FORMULARIOS
        ======================================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--gris-700);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all var(--transition-normal);
            background: var(--blanco);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--verde-claro);
            box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 12px;
            color: var(--gris-600);
            font-style: italic;
        }

        /* ========================================
           MODAL
        ======================================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--blanco);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--sombra-xl);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: var(--blanco);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--blanco);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 24px;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 24px;
            background: var(--gris-100);
            border-top: 1px solid var(--gris-200);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* ========================================
           NOTIFICACIONES
        ======================================== */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--blanco);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--sombra-xl);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
        }

        .notification.success {
            border-left: 4px solid var(--verde);
        }

        .notification.error {
            border-left: 4px solid var(--rojo);
        }

        .notification.warning {
            border-left: 4px solid var(--amarillo);
        }

        .notification.info {
            border-left: 4px solid var(--azul);
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification.success .notification-icon { color: var(--verde); }
        .notification.error .notification-icon { color: var(--rojo); }
        .notification.warning .notification-icon { color: var(--amarillo); }
        .notification.info .notification-icon { color: var(--azul); }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .notification-message {
            font-size: 13px;
            color: var(--gris-600);
        }

        /* ========================================
           ANIMACIONES
        ======================================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========================================
            BOT WHATSAPP CON IA
        ======================================== */
        
        .bot-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 24px;
            height: calc(100vh - 200px);
            min-height: 500px;
        }

        @media (max-width: 900px) {
            .bot-container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        /* Chat principal */
        .bot-chat {
            background: #e5ddd5;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--sombra-lg);
        }

        .bot-chat-header {
            background: linear-gradient(135deg, #075e54 0%, #128c7e 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bot-avatar {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .bot-info {
            flex: 1;
        }

        .bot-name {
            font-weight: 700;
            font-size: 16px;
        }

        .bot-status {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bot-status-dot {
            width: 8px;
            height: 8px;
            background: #25D366;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .bot-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c5c5c5' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .bot-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 8px;
            position: relative;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message.received {
            background: white;
            align-self: flex-start;
            border-top-left-radius: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .bot-message.sent {
            background: #dcf8c6;
            align-self: flex-end;
            border-top-right-radius: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .bot-message-text {
            font-size: 14px;
            line-height: 1.5;
            color: #303030;
            white-space: pre-wrap;
        }

        .bot-message-time {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 4px;
        }

        .bot-message.sent .bot-message-time {
            color: #6b9f78;
        }

        /* Typing indicator */
        .bot-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border-top-left-radius: 0;
            align-self: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .bot-typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .bot-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .bot-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* Input area */
        .bot-chat-input {
            background: #f0f0f0;
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .bot-input-field {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 24px;
            background: white;
            font-size: 14px;
            outline: none;
        }

        .bot-input-field:focus {
            box-shadow: 0 0 0 2px #25D366;
        }

        .bot-send-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: #25D366;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .bot-send-btn:hover {
            background: #128c7e;
            transform: scale(1.05);
        }

        .bot-voice-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: white;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bot-voice-btn:hover {
            background: #e0e0e0;
        }

        .bot-voice-btn.recording {
            background: #ef4444;
            color: white;
            animation: pulse 1s infinite;
        }

        /* Quick actions */
        .bot-quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 8px 16px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .bot-quick-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bot-quick-btn:hover {
            background: #25D366;
            color: white;
            border-color: #25D366;
        }

        /* Panel lateral */
        .bot-sidebar {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
            display: flex;
            flex-direction: column;
        }

        .bot-sidebar-header {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            padding: 16px;
            text-align: center;
        }

        .bot-sidebar-title {
            font-weight: 700;
            font-size: 14px;
        }

        .bot-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .bot-command-group {
            margin-bottom: 20px;
        }

        .bot-command-group-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--gris-500);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .bot-command-item {
            padding: 10px 12px;
            background: var(--gris-100);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bot-command-item:hover {
            background: var(--verde-muy-claro);
            transform: translateX(4px);
        }

        .bot-command-text {
            font-size: 13px;
            color: var(--gris-700);
        }

        .bot-command-desc {
            font-size: 11px;
            color: var(--gris-500);
            margin-top: 2px;
        }

        /* Data cards en respuestas */
        .bot-data-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            border-left: 3px solid #25D366;
        }

        .bot-data-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }

        .bot-data-label {
            color: #666;
        }

        .bot-data-value {
            font-weight: 600;
            color: #333;
        }

        /* ========================================
            GESTIN DE INSUMOS / STOCK
        ======================================== */
        
        .insumos-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .insumo-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--sombra-sm);
            border-left: 4px solid var(--verde-medio);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .insumo-stat-card.warning {
            border-left-color: #f59e0b;
        }

        .insumo-stat-card.danger {
            border-left-color: #ef4444;
        }

        .insumo-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--verde-muy-claro);
        }

        .insumo-stat-card.warning .insumo-stat-icon {
            background: #fef3c7;
        }

        .insumo-stat-card.danger .insumo-stat-icon {
            background: #fee2e2;
        }

        .insumo-stat-info {
            flex: 1;
        }

        .insumo-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gris-800);
        }

        .insumo-stat-label {
            font-size: 12px;
            color: var(--gris-500);
        }

        /* Categor铆as de insumos */
        .insumos-categorias {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .insumo-categoria-btn {
            padding: 10px 18px;
            border: 2px solid var(--gris-200);
            border-radius: 25px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insumo-categoria-btn:hover {
            border-color: var(--verde-claro);
            background: var(--verde-muy-claro);
        }

        .insumo-categoria-btn.active {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            border-color: var(--verde-medio);
        }

        .insumo-categoria-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }

        .insumo-categoria-btn.active .insumo-categoria-count {
            background: rgba(255,255,255,0.3);
        }

        /* Tabla de insumos */
        .insumos-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
        }

        .insumos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .insumos-table th {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
        }

        .insumos-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--gris-100);
            font-size: 13px;
        }

        .insumos-table tr:hover td {
            background: var(--verde-muy-claro);
        }

        /* Stock visual */
        .stock-bar {
            width: 100%;
            height: 8px;
            background: var(--gris-200);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .stock-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .stock-bar-fill.alto {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .stock-bar-fill.medio {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .stock-bar-fill.bajo {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .stock-nivel {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .stock-nivel.alto {
            background: #d1fae5;
            color: #065f46;
        }

        .stock-nivel.medio {
            background: #fef3c7;
            color: #92400e;
        }

        .stock-nivel.bajo {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Cards de insumos */
        .insumos-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .insumo-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
            transition: all 0.3s;
        }

        .insumo-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-lg);
        }

        .insumo-card-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--gris-100);
        }

        .insumo-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .insumo-card-titulo {
            flex: 1;
        }

        .insumo-card-nombre {
            font-weight: 700;
            font-size: 15px;
            color: var(--gris-800);
        }

        .insumo-card-categoria {
            font-size: 11px;
            color: var(--gris-500);
        }

        .insumo-card-body {
            padding: 16px;
        }

        .insumo-card-stock {
            text-align: center;
            margin-bottom: 16px;
        }

        .insumo-card-stock-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--verde-medio);
        }

        .insumo-card-stock-unit {
            font-size: 14px;
            color: var(--gris-500);
        }

        .insumo-card-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .insumo-card-meta-item {
            background: var(--gris-100);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .insumo-card-footer {
            padding: 12px 16px;
            background: var(--gris-50);
            display: flex;
            gap: 8px;
        }

        .insumo-card-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .insumo-card-btn.entrada {
            background: #d1fae5;
            color: #065f46;
        }

        .insumo-card-btn.salida {
            background: #fee2e2;
            color: #991b1b;
        }

        .insumo-card-btn:hover {
            transform: scale(1.02);
        }

        /* Movimientos de insumos */
        .movimiento-tipo {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .movimiento-tipo.entrada {
            background: #d1fae5;
            color: #065f46;
        }

        .movimiento-tipo.salida {
            background: #fee2e2;
            color: #991b1b;
        }

        .movimiento-tipo.ajuste {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Alertas de stock */
        .alerta-stock {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left: 4px solid #ef4444;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .alerta-stock-icon {
            font-size: 24px;
        }

        .alerta-stock-info {
            flex: 1;
        }

        .alerta-stock-titulo {
            font-weight: 600;
            font-size: 14px;
            color: var(--gris-800);
        }

        .alerta-stock-mensaje {
            font-size: 12px;
            color: var(--gris-600);
        }

        /* Historial de movimientos */
        .movimientos-timeline {
            position: relative;
            padding-left: 30px;
        }

        .movimientos-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gris-200);
        }

        .movimiento-item {
            position: relative;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: var(--sombra-sm);
        }

        .movimiento-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 18px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--verde-medio);
            border: 2px solid white;
        }

        .movimiento-item.entrada::before {
            background: #10b981;
        }

        .movimiento-item.salida::before {
            background: #ef4444;
        }

        /* ========================================
            SISTEMA MULTI-ESPECIE
        ======================================== */
        
        .especies-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .especie-tab {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border: 2px solid var(--gris-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .especie-tab:hover {
            border-color: var(--verde-claro);
            transform: translateY(-2px);
        }

        .especie-tab.active {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            border-color: var(--verde-medio);
        }

        .especie-tab-icon {
            font-size: 28px;
        }

        .especie-tab-info {
            text-align: left;
        }

        .especie-tab-nombre {
            font-weight: 700;
            font-size: 14px;
        }

        .especie-tab-count {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Cards de resumen por especie */
        .especies-resumen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .especie-resumen-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
            transition: all 0.3s;
        }

        .especie-resumen-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-lg);
        }

        .especie-resumen-header {
            padding: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .especie-resumen-header.bovinos {
            background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
        }

        .especie-resumen-header.ovinos {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
        }

        .especie-resumen-header.caprinos {
            background: linear-gradient(135deg, #7c2d12 0%, #c2410c 100%);
        }

        .especie-resumen-header.equinos {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .especie-resumen-header.porcinos {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        .especie-resumen-header.aves {
            background: linear-gradient(135deg, #eab308 0%, #facc15 100%);
        }

        .especie-resumen-icon {
            font-size: 48px;
        }

        .especie-resumen-titulo {
            flex: 1;
        }

        .especie-resumen-nombre {
            font-size: 20px;
            font-weight: 700;
        }

        .especie-resumen-subtitulo {
            font-size: 12px;
            opacity: 0.9;
        }

        .especie-resumen-body {
            padding: 20px;
        }

        .especie-stats-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gris-100);
        }

        .especie-stats-row:last-child {
            border-bottom: none;
        }

        .especie-stats-label {
            color: var(--gris-600);
            font-size: 13px;
        }

        .especie-stats-value {
            font-weight: 700;
            color: var(--gris-800);
            font-size: 14px;
        }

        /* Selector de especie en formularios */
        .especie-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .especie-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: var(--gris-100);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .especie-option:hover {
            background: var(--verde-muy-claro);
            border-color: var(--verde-claro);
        }

        .especie-option.selected {
            background: var(--verde-muy-claro);
            border-color: var(--verde-medio);
        }

        .especie-option-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .especie-option-nombre {
            font-size: 12px;
            font-weight: 600;
            color: var(--gris-700);
        }

        /* Badge de especie */
        .especie-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .especie-badge.bovinos {
            background: #fef3c7;
            color: #92400e;
        }

        .especie-badge.ovinos {
            background: #f3f4f6;
            color: #374151;
        }

        .especie-badge.caprinos {
            background: #ffedd5;
            color: #7c2d12;
        }

        .especie-badge.equinos {
            background: #dbeafe;
            color: #1e40af;
        }

        .especie-badge.porcinos {
            background: #fce7f3;
            color: #9d174d;
        }

        .especie-badge.aves {
            background: #fef9c3;
            color: #854d0e;
        }

        /* Configuraci贸n de especies */
        .especies-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .especie-config-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--sombra-sm);
            border: 2px solid var(--gris-100);
        }

        .especie-config-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gris-100);
        }

        .especie-config-icon {
            font-size: 36px;
        }

        .especie-config-titulo {
            flex: 1;
        }

        .especie-config-nombre {
            font-weight: 700;
            font-size: 16px;
            color: var(--gris-800);
        }

        .especie-config-desc {
            font-size: 12px;
            color: var(--gris-500);
        }

        .especie-toggle {
            width: 50px;
            height: 26px;
            background: var(--gris-300);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .especie-toggle.active {
            background: var(--verde-medio);
        }

        .especie-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .especie-toggle.active::after {
            transform: translateX(24px);
        }

        /* ========================================
           э REGISTRO DE LLUVIAS / PLUVIMETRO
        ======================================== */
        
        .lluvia-dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .lluvia-dashboard {
                grid-template-columns: 1fr;
            }
        }

        .lluvia-registro-card {
            background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .lluvia-registro-card::before {
            content: 'э';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 120px;
            opacity: 0.15;
        }

        .lluvia-registro-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .lluvia-registro-fecha {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .lluvia-input-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .lluvia-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 32px;
            font-weight: 700;
            color: white;
            text-align: center;
            width: 100px;
        }

        .lluvia-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .lluvia-input:focus {
            outline: none;
        }

        .lluvia-unit {
            font-size: 18px;
            opacity: 0.8;
        }

        .lluvia-quick-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .lluvia-quick-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lluvia-quick-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .lluvia-save-btn {
            width: 100%;
            padding: 14px;
            background: white;
            border: none;
            border-radius: 10px;
            color: #0369a1;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lluvia-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Acumulados */
        .lluvia-acumulados {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-md);
        }

        .lluvia-acumulados-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lluvia-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .lluvia-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .lluvia-stat-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .lluvia-stat-card.mes {
            background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
            color: white;
        }

        .lluvia-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #0369a1;
        }

        .lluvia-stat-card.mes .lluvia-stat-value {
            color: white;
        }

        .lluvia-stat-label {
            font-size: 11px;
            color: #0369a1;
            margin-top: 4px;
        }

        .lluvia-stat-card.mes .lluvia-stat-label {
            color: rgba(255,255,255,0.9);
        }

        /* Gr谩fico de barras */
        .lluvia-chart-container {
            margin-top: 20px;
        }

        .lluvia-chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gris-700);
            margin-bottom: 12px;
        }

        .lluvia-bars {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 150px;
            padding: 10px 0;
            border-bottom: 2px solid var(--gris-200);
        }

        .lluvia-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .lluvia-bar {
            width: 100%;
            max-width: 40px;
            background: linear-gradient(180deg, #0ea5e9 0%, #0369a1 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            cursor: pointer;
            position: relative;
        }

        .lluvia-bar:hover {
            opacity: 0.8;
        }

        .lluvia-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 600;
            color: var(--gris-600);
            white-space: nowrap;
        }

        .lluvia-bar-label {
            font-size: 10px;
            color: var(--gris-500);
            margin-top: 8px;
            text-align: center;
        }

        /* Historial */
        .lluvia-historial {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-md);
            margin-top: 24px;
        }

        .lluvia-historial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .lluvia-historial-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lluvia-historial-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .lluvia-historial-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: var(--gris-100);
            border-radius: 10px;
            transition: background 0.2s;
        }

        .lluvia-historial-item:hover {
            background: #e0f2fe;
        }

        .lluvia-historial-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .lluvia-historial-info {
            flex: 1;
        }

        .lluvia-historial-fecha {
            font-weight: 600;
            font-size: 14px;
            color: var(--gris-800);
        }

        .lluvia-historial-notas {
            font-size: 12px;
            color: var(--gris-500);
        }

        .lluvia-historial-valor {
            font-size: 24px;
            font-weight: 700;
            color: #0369a1;
        }

        .lluvia-historial-valor span {
            font-size: 12px;
            font-weight: 400;
        }

        .lluvia-historial-actions {
            display: flex;
            gap: 4px;
        }

        /* Comparativa anual */
        .lluvia-comparativa {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 4px;
            margin-top: 16px;
        }

        .lluvia-mes-card {
            background: var(--gris-100);
            padding: 8px 4px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lluvia-mes-card:hover {
            transform: scale(1.05);
        }

        .lluvia-mes-card.actual {
            background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
            color: white;
        }

        .lluvia-mes-nombre {
            font-size: 10px;
            font-weight: 600;
        }

        .lluvia-mes-valor {
            font-size: 12px;
            font-weight: 700;
            margin-top: 2px;
        }

        /* Intensidad visual */
        .intensidad-baja { background: #bae6fd; }
        .intensidad-media { background: #38bdf8; color: white; }
        .intensidad-alta { background: #0284c7; color: white; }
        .intensidad-muy-alta { background: #075985; color: white; }

        /* ========================================
            REPORTES AUTOMTICOS SEMANALES
        ======================================== */
        
        .auto-report-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--sombra-lg);
        }

        .auto-report-header {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .auto-report-header h3 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .auto-report-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .auto-report-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 30px;
            display: inline-flex;
        }

        .auto-report-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .auto-report-status-dot.active {
            background: #10b981;
        }

        .auto-report-status-dot.inactive {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .auto-report-config {
            padding: 24px;
        }

        .auto-report-section {
            margin-bottom: 24px;
        }

        .auto-report-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gris-100);
        }

        /* Schedule picker */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .schedule-day {
            padding: 12px 8px;
            border: 2px solid var(--gris-200);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-day:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .schedule-day.selected {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            border-color: #7c3aed;
        }

        .schedule-day-name {
            font-size: 12px;
            font-weight: 600;
        }

        .schedule-day-short {
            font-size: 10px;
            opacity: 0.7;
        }

        /* Time picker */
        .time-picker-container {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .time-picker {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--gris-100);
            border-radius: 10px;
        }

        .time-picker input {
            border: none;
            background: transparent;
            font-size: 24px;
            font-weight: 700;
            width: 60px;
            text-align: center;
            color: #7c3aed;
        }

        .time-picker input:focus {
            outline: none;
        }

        .time-picker-label {
            font-size: 12px;
            color: var(--gris-600);
        }

        /* Recipients */
        .recipients-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recipient-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--gris-100);
            border-radius: 10px;
        }

        .recipient-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .recipient-icon.whatsapp {
            background: #25D366;
            color: white;
        }

        .recipient-icon.email {
            background: #EA4335;
            color: white;
        }

        .recipient-info {
            flex: 1;
        }

        .recipient-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--gris-800);
        }

        .recipient-contact {
            font-size: 12px;
            color: var(--gris-500);
        }

        .recipient-toggle {
            width: 50px;
            height: 26px;
            background: var(--gris-300);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .recipient-toggle.active {
            background: #10b981;
        }

        .recipient-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .recipient-toggle.active::after {
            transform: translateX(24px);
        }

        .add-recipient-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: 2px dashed var(--gris-300);
            border-radius: 10px;
            color: var(--gris-500);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-recipient-btn:hover {
            border-color: #a855f7;
            color: #7c3aed;
            background: rgba(168, 85, 247, 0.05);
        }

        /* Content checklist */
        .content-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .content-check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .content-check-item:hover {
            background: rgba(168, 85, 247, 0.1);
        }

        .content-check-item.checked {
            background: rgba(168, 85, 247, 0.1);
            border-color: #a855f7;
        }

        .content-check-item input {
            width: 20px;
            height: 20px;
            accent-color: #7c3aed;
        }

        .content-check-item span {
            font-size: 13px;
            color: var(--gris-700);
        }

        /* Preview */
        .report-preview-card {
            background: var(--gris-100);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--gris-200);
        }

        .report-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gris-200);
        }

        .report-preview-title {
            font-weight: 700;
            color: var(--gris-800);
        }

        .report-preview-date {
            font-size: 12px;
            color: var(--gris-500);
        }

        /* History */
        .report-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .report-history-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 10px;
        }

        .report-history-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .report-history-info {
            flex: 1;
        }

        .report-history-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--gris-800);
        }

        .report-history-meta {
            font-size: 12px;
            color: var(--gris-500);
            display: flex;
            gap: 12px;
        }

        .report-history-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .report-history-status.sent {
            background: #d1fae5;
            color: #065f46;
        }

        .report-history-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Next report countdown */
        .next-report-countdown {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
        }

        .countdown-label {
            font-size: 12px;
            color: var(--gris-600);
            margin-bottom: 8px;
        }

        .countdown-value {
            font-size: 32px;
            font-weight: 700;
            color: #7c3aed;
        }

        .countdown-detail {
            font-size: 13px;
            color: var(--gris-500);
            margin-top: 4px;
        }

        /* ========================================
            INVENTARIO DE GANADO
        ======================================== */
        
        .ganado-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .ganado-stat-card {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .ganado-stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .ganado-stat-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .ganado-stat-card.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .ganado-stat-value {
            font-size: 36px;
            font-weight: 700;
            position: relative;
        }

        .ganado-stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Tabla de ganado */
        .ganado-table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: var(--sombra-md);
        }

        .ganado-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .ganado-table th {
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .ganado-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gris-200);
            font-size: 13px;
        }

        .ganado-table tr:hover td {
            background: var(--verde-muy-claro);
        }

        .ganado-table tr.selected td {
            background: rgba(82, 183, 136, 0.2);
        }

        /* Badge de categor铆a */
        .ganado-categoria-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .ganado-categoria-badge.vaca {
            background: #fef3c7;
            color: #92400e;
        }

        .ganado-categoria-badge.toro {
            background: #fee2e2;
            color: #991b1b;
        }

        .ganado-categoria-badge.novillo {
            background: #dbeafe;
            color: #1e40af;
        }

        .ganado-categoria-badge.novilla {
            background: #fce7f3;
            color: #9d174d;
        }

        .ganado-categoria-badge.ternero {
            background: #d1fae5;
            color: #065f46;
        }

        .ganado-categoria-badge.ternera {
            background: #ede9fe;
            color: #5b21b6;
        }

        /* Estado de salud */
        .ganado-estado {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .ganado-estado.sano {
            background: #d1fae5;
            color: #065f46;
        }

        .ganado-estado.observacion {
            background: #fef3c7;
            color: #92400e;
        }

        .ganado-estado.tratamiento {
            background: #fee2e2;
            color: #991b1b;
        }

        .ganado-estado.prenada {
            background: #fce7f3;
            color: #9d174d;
        }

        /* Card de animal */
        .ganado-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ganado-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-lg);
        }

        .ganado-card-header {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ganado-card-id {
            font-size: 18px;
            font-weight: 700;
        }

        .ganado-card-categoria {
            font-size: 24px;
        }

        .ganado-card-body {
            padding: 16px;
        }

        .ganado-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .ganado-card-info-item {
            text-align: center;
            padding: 8px;
            background: var(--gris-100);
            border-radius: 8px;
        }

        .ganado-card-info-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--verde-medio);
        }

        .ganado-card-info-label {
            font-size: 10px;
            color: var(--gris-500);
        }

        /* Filtros */
        .ganado-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 12px;
        }

        .ganado-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ganado-filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gris-600);
        }

        .ganado-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 8px;
            font-size: 14px;
        }

        .ganado-search:focus {
            border-color: var(--verde-claro);
            outline: none;
        }

        /* Vista de cards */
        .ganado-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Modal de animal */
        .ganado-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .ganado-detail-section {
            background: var(--gris-100);
            padding: 16px;
            border-radius: 10px;
        }

        .ganado-detail-section h4 {
            font-size: 14px;
            color: var(--gris-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ganado-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gris-200);
            font-size: 13px;
        }

        .ganado-detail-row:last-child {
            border-bottom: none;
        }

        .ganado-detail-label {
            color: var(--gris-600);
        }

        .ganado-detail-value {
            font-weight: 600;
            color: var(--gris-800);
        }

        /* Historial de peso */
        .peso-history {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .peso-history-item {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            text-align: center;
            border: 1px solid var(--gris-200);
        }

        .peso-history-value {
            font-weight: 700;
            color: var(--verde-medio);
        }

        .peso-history-date {
            color: var(--gris-500);
            font-size: 10px;
        }

        /* Tabs de vista */
        .ganado-view-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .ganado-view-tab {
            padding: 8px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 8px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ganado-view-tab:hover {
            border-color: var(--verde-claro);
        }

        .ganado-view-tab.active {
            background: var(--verde-medio);
            color: white;
            border-color: var(--verde-medio);
        }

        /* Acciones en tabla */
        .ganado-actions {
            display: flex;
            gap: 4px;
        }

        .ganado-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .ganado-action-btn.edit {
            background: var(--verde-muy-claro);
            color: var(--verde-medio);
        }

        .ganado-action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .ganado-action-btn.weight {
            background: #dbeafe;
            color: #2563eb;
        }

        .ganado-action-btn:hover {
            transform: scale(1.1);
        }

        /* Resumen por categor铆a */
        .ganado-resumen-categoria {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--sombra-sm);
            margin-bottom: 12px;
        }

        .ganado-resumen-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .ganado-resumen-info {
            flex: 1;
        }

        .ganado-resumen-nombre {
            font-weight: 700;
            font-size: 14px;
            color: var(--gris-800);
        }

        .ganado-resumen-cantidad {
            font-size: 24px;
            font-weight: 700;
            color: var(--verde-medio);
        }

        .ganado-resumen-detalles {
            font-size: 12px;
            color: var(--gris-500);
        }

        /* ========================================
            CALCULADORA DE CARGA ANIMAL
        ======================================== */
        
        .calc-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .calc-container {
                grid-template-columns: 1fr;
            }
        }

        .calc-panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-md);
        }

        .calc-panel-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gris-100);
        }

        .calc-panel-title span {
            font-size: 24px;
        }

        .calc-input-group {
            margin-bottom: 16px;
        }

        .calc-input-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .calc-input-label label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gris-700);
        }

        .calc-input-label .calc-help {
            font-size: 11px;
            color: var(--gris-500);
            cursor: help;
        }

        .calc-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .calc-input:focus {
            border-color: var(--verde-claro);
            outline: none;
            box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.2);
        }

        .calc-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .calc-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Resultados */
        .calc-results {
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
        }

        .calc-results-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calc-result-main {
            text-align: center;
            padding: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .calc-result-value {
            font-size: 56px;
            font-weight: 700;
            line-height: 1;
        }

        .calc-result-unit {
            font-size: 18px;
            opacity: 0.8;
            margin-top: 8px;
        }

        .calc-result-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .calc-results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .calc-result-item {
            background: rgba(255,255,255,0.1);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .calc-result-item-value {
            font-size: 24px;
            font-weight: 700;
        }

        .calc-result-item-label {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Indicador de estado */
        .calc-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .calc-status.optimo {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .calc-status.moderado {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid rgba(245, 158, 11, 0.5);
        }

        .calc-status.critico {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }

        .calc-status-icon {
            font-size: 32px;
        }

        .calc-status-text {
            flex: 1;
        }

        .calc-status-title {
            font-weight: 700;
            font-size: 14px;
        }

        .calc-status-message {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Balance Forrajero */
        .balance-bar-container {
            margin: 20px 0;
        }

        .balance-bar-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .balance-bar {
            height: 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .balance-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .balance-bar-fill.deficit {
            background: linear-gradient(90deg, #ef4444, #f59e0b);
        }

        .balance-bar-fill.equilibrio {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .balance-bar-fill.excedente {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .balance-bar-marker {
            position: absolute;
            top: -8px;
            transform: translateX(-50%);
            font-size: 16px;
        }

        /* Tabla de categor铆as */
        .calc-categories-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .calc-categories-table th,
        .calc-categories-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gris-200);
            font-size: 13px;
        }

        .calc-categories-table th {
            background: var(--gris-100);
            font-weight: 600;
            color: var(--gris-700);
        }

        .calc-categories-table tr:hover td {
            background: var(--verde-muy-claro);
        }

        .calc-categories-table input {
            width: 70px;
            padding: 6px 10px;
            border: 1px solid var(--gris-300);
            border-radius: 6px;
            text-align: center;
        }

        /* Cards de informaci贸n */
        .calc-info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .calc-info-card {
            background: var(--gris-100);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--verde-claro);
        }

        .calc-info-card-title {
            font-size: 12px;
            color: var(--gris-600);
            margin-bottom: 4px;
        }

        .calc-info-card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--verde-medio);
        }

        .calc-info-card-unit {
            font-size: 12px;
            color: var(--gris-500);
        }

        /* Tabs de calculadora */
        .calc-tabs {
            display: flex;
            gap: 4px;
            background: var(--gris-200);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 24px;
        }

        .calc-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gris-600);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-tab:hover {
            color: var(--verde-medio);
        }

        .calc-tab.active {
            background: white;
            color: var(--verde-medio);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Recomendaciones */
        .calc-recommendations {
            margin-top: 24px;
            padding: 20px;
            background: var(--verde-muy-claro);
            border-radius: 12px;
        }

        .calc-recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(45, 106, 79, 0.2);
        }

        .calc-recommendation-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .calc-recommendation-icon {
            font-size: 20px;
        }

        .calc-recommendation-text {
            font-size: 13px;
            color: var(--gris-700);
            line-height: 1.5;
        }

        /* Gr谩fico de pastel UGM */
        .ugm-chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin: 20px 0;
        }

        .ugm-pie {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            position: relative;
        }

        .ugm-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ugm-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .ugm-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* ========================================
           ★ SISTEMA DE CLIMA EN TIEMPO REAL
        ======================================== */
        
        .weather-dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .weather-dashboard {
                grid-template-columns: 1fr;
            }
        }

        .weather-current {
            background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .weather-current::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .weather-location {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .weather-icon {
            font-size: 72px;
            line-height: 1;
        }

        .weather-temp {
            font-size: 56px;
            font-weight: 700;
            line-height: 1;
        }

        .weather-temp-unit {
            font-size: 24px;
            font-weight: 400;
            opacity: 0.8;
        }

        .weather-desc {
            font-size: 18px;
            margin-bottom: 20px;
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .weather-detail-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-detail-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .weather-detail-value {
            font-size: 16px;
            font-weight: 700;
        }

        .weather-detail-label {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Pron贸stico */
        .weather-forecast {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--sombra-md);
        }

        .weather-forecast-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .forecast-days {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .forecast-day {
            min-width: 100px;
            background: var(--gris-100);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .forecast-day:hover {
            background: var(--verde-muy-claro);
            transform: translateY(-2px);
        }

        .forecast-day.today {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
        }

        .forecast-day-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .forecast-day-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .forecast-day-temps {
            display: flex;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
        }

        .forecast-temp-max {
            font-weight: 700;
        }

        .forecast-temp-min {
            opacity: 0.6;
        }

        .forecast-day-rain {
            font-size: 11px;
            margin-top: 6px;
            color: #3b82f6;
        }

        .forecast-day.today .forecast-day-rain {
            color: rgba(255,255,255,0.9);
        }

        /* Alertas clim谩ticas */
        .weather-alerts {
            margin-bottom: 20px;
        }

        .weather-alert {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .weather-alert.lluvia {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.2) 100%);
            border-left: 4px solid #3b82f6;
        }

        .weather-alert.calor {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%);
            border-left: 4px solid #ef4444;
        }

        .weather-alert.frio {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.2) 100%);
            border-left: 4px solid #6366f1;
        }

        .weather-alert.sequia {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%);
            border-left: 4px solid #f59e0b;
        }

        .weather-alert.optimo {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%);
            border-left: 4px solid #10b981;
        }

        .weather-alert-icon {
            font-size: 32px;
        }

        .weather-alert-content {
            flex: 1;
        }

        .weather-alert-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--gris-800);
            margin-bottom: 4px;
        }

        .weather-alert-message {
            font-size: 13px;
            color: var(--gris-600);
        }

        /* Recomendaciones */
        .weather-recommendations {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--sombra-md);
            margin-bottom: 20px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .recommendation-item:last-child {
            margin-bottom: 0;
        }

        .recommendation-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .recommendation-content h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 4px;
        }

        .recommendation-content p {
            font-size: 13px;
            color: var(--gris-600);
            line-height: 1.5;
        }

        /* Historial clim谩tico */
        .weather-history {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--sombra-md);
        }

        .history-chart-container {
            height: 200px;
            margin-top: 16px;
        }

        .weather-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .weather-stat-card {
            background: var(--gris-100);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--verde-medio);
        }

        .weather-stat-label {
            font-size: 11px;
            color: var(--gris-600);
            margin-top: 4px;
        }

        /* Loading state */
        .weather-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--gris-500);
        }

        .weather-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gris-200);
            border-top-color: var(--verde-claro);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        /* Selector de ubicaci贸n */
        .weather-location-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .weather-location-btn {
            padding: 10px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 10px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weather-location-btn:hover {
            border-color: var(--verde-claro);
            background: var(--verde-muy-claro);
        }

        .weather-location-btn.active {
            border-color: var(--verde-medio);
            background: var(--verde-muy-claro);
            color: var(--verde-oscuro);
            font-weight: 600;
        }

        /* ========================================
            GENERADOR DE REPORTES PDF
        ======================================== */
        
        .report-generator {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--sombra-lg);
        }

        .report-header {
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .report-header h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .report-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .report-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 24px;
        }

        .report-type-card {
            background: var(--gris-100);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .report-type-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-lg);
            border-color: var(--verde-claro);
        }

        .report-type-card.selected {
            border-color: var(--verde-medio);
            background: var(--verde-muy-claro);
        }

        .report-type-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 16px;
        }

        .report-type-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 8px;
        }

        .report-type-desc {
            font-size: 13px;
            color: var(--gris-600);
            line-height: 1.5;
        }

        .report-type-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--acento-dorado);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Configuraci贸n de reporte */
        .report-config {
            padding: 24px;
            background: var(--gris-100);
            border-top: 1px solid var(--gris-200);
        }

        .report-config-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .report-config-item {
            background: white;
            padding: 16px;
            border-radius: 10px;
        }

        .report-config-item label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--gris-600);
            margin-bottom: 8px;
        }

        /* Preview del reporte */
        .report-preview {
            background: white;
            border: 2px dashed var(--gris-300);
            border-radius: 12px;
            padding: 40px;
            margin: 24px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .report-preview.loading {
            background: var(--gris-100);
        }

        .report-preview-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .report-preview-text {
            color: var(--gris-500);
            font-size: 14px;
        }

        /* Botones de acci贸n */
        .report-actions {
            display: flex;
            gap: 12px;
            padding: 24px;
            background: var(--gris-100);
            border-top: 1px solid var(--gris-200);
            justify-content: center;
            flex-wrap: wrap;
        }

        .report-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-action-btn.primary {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
        }

        .report-action-btn.whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
        }

        .report-action-btn.email {
            background: linear-gradient(135deg, #EA4335 0%, #FBBC05 100%);
            color: white;
        }

        .report-action-btn.secondary {
            background: white;
            color: var(--gris-700);
            border: 2px solid var(--gris-300);
        }

        .report-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .report-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal de progreso */
        .report-progress-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .report-progress-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .report-progress-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gris-200);
            border-top-color: var(--verde-claro);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .report-progress-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 8px;
        }

        .report-progress-status {
            color: var(--gris-600);
            font-size: 14px;
        }

        /* Historial de reportes */
        .report-history {
            padding: 24px;
        }

        .report-history-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 16px;
        }

        .report-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-history-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 10px;
            transition: background 0.2s;
        }

        .report-history-item:hover {
            background: var(--verde-muy-claro);
        }

        .report-history-icon {
            width: 44px;
            height: 44px;
            background: var(--verde-claro);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .report-history-info {
            flex: 1;
        }

        .report-history-name {
            font-weight: 600;
            color: var(--gris-800);
            font-size: 14px;
        }

        .report-history-date {
            font-size: 12px;
            color: var(--gris-500);
        }

        .report-history-actions {
            display: flex;
            gap: 8px;
        }

        /* Checklist de contenido */
        .report-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .report-check-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid var(--gris-200);
        }

        .report-check-item:hover {
            border-color: var(--verde-claro);
        }

        .report-check-item.checked {
            background: var(--verde-muy-claro);
            border-color: var(--verde-claro);
        }

        .report-check-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--verde-medio);
        }

        .report-check-item span {
            font-size: 13px;
            color: var(--gris-700);
        }

        /* ========================================
            SISTEMA DE ROTACIN PRV - PLANIFICADOR
        ======================================== */
        
        /* Tarjetas de configuraci贸n PRV */
        .prv-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .prv-config-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--sombra-md);
            border-left: 4px solid var(--verde-claro);
        }

        .prv-config-card h4 {
            font-size: 14px;
            color: var(--gris-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prv-config-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--verde-medio);
        }

        .prv-config-unit {
            font-size: 14px;
            color: var(--gris-500);
            margin-left: 4px;
        }

        .prv-config-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gris-200);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            transition: border-color 0.2s;
        }

        .prv-config-input:focus {
            border-color: var(--verde-claro);
            outline: none;
        }

        /* Vista Gantt */
        .gantt-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
        }

        .gantt-header {
            display: flex;
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .gantt-header-potrero {
            min-width: 150px;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 13px;
            border-right: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
        }

        .gantt-header-days {
            display: flex;
            flex: 1;
            overflow-x: auto;
        }

        .gantt-day-header {
            min-width: 40px;
            padding: 8px 4px;
            text-align: center;
            font-size: 10px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .gantt-day-header.weekend {
            background: rgba(0,0,0,0.2);
        }

        .gantt-day-header.today {
            background: var(--acento-dorado);
            color: var(--gris-900);
            font-weight: 700;
        }

        .gantt-day-header .day-number {
            font-size: 14px;
            font-weight: 700;
        }

        .gantt-day-header .day-name {
            font-size: 9px;
            opacity: 0.8;
        }

        .gantt-body {
            max-height: 500px;
            overflow-y: auto;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid var(--gris-200);
            transition: background 0.15s;
        }

        .gantt-row:hover {
            background: var(--verde-muy-claro);
        }

        .gantt-row-potrero {
            min-width: 150px;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 13px;
            border-right: 1px solid var(--gris-200);
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--gris-100);
        }

        .gantt-row-potrero .potrero-id {
            color: var(--verde-medio);
        }

        .gantt-row-potrero .potrero-info {
            font-size: 10px;
            color: var(--gris-500);
            font-weight: 400;
        }

        .gantt-row-days {
            display: flex;
            flex: 1;
            position: relative;
        }

        .gantt-cell {
            min-width: 40px;
            height: 50px;
            border-right: 1px solid var(--gris-100);
            position: relative;
        }

        .gantt-cell.weekend {
            background: var(--gris-100);
        }

        .gantt-cell.today {
            background: rgba(212, 163, 115, 0.2);
        }

        /* Barras de ocupaci贸n */
        .gantt-bar {
            position: absolute;
            top: 8px;
            height: 34px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 5;
        }

        .gantt-bar:hover {
            transform: scaleY(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .gantt-bar.ocupado {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .gantt-bar.descanso {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .gantt-bar.planificado {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: 2px dashed rgba(255,255,255,0.5);
        }

        .gantt-bar.alerta {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            animation: pulseBar 2s infinite;
        }

        @keyframes pulseBar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Leyenda Gantt */
        .gantt-legend {
            display: flex;
            gap: 20px;
            padding: 16px;
            background: var(--gris-100);
            border-top: 1px solid var(--gris-200);
            flex-wrap: wrap;
        }

        .gantt-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gris-700);
        }

        .gantt-legend-color {
            width: 24px;
            height: 12px;
            border-radius: 4px;
        }

        .gantt-legend-color.ocupado { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .gantt-legend-color.descanso { background: linear-gradient(135deg, #10b981, #059669); }
        .gantt-legend-color.planificado { background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px dashed #2563eb; }
        .gantt-legend-color.alerta { background: linear-gradient(135deg, #f59e0b, #d97706); }

        /* Calendario de Rotaci贸n */
        .rotation-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: var(--gris-200);
            padding: 4px;
            border-radius: 12px;
        }

        .calendar-header-cell {
            background: var(--verde-medio);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 12px;
        }

        .calendar-cell {
            background: white;
            min-height: 80px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-cell:hover {
            background: var(--verde-muy-claro);
            transform: scale(1.02);
            z-index: 5;
        }

        .calendar-cell.other-month {
            background: var(--gris-100);
            opacity: 0.5;
        }

        .calendar-cell.today {
            border: 2px solid var(--acento-dorado);
        }

        .calendar-day-number {
            font-size: 14px;
            font-weight: 700;
            color: var(--gris-700);
            margin-bottom: 4px;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-event {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }

        .calendar-event.entrada { background: #ef4444; }
        .calendar-event.salida { background: #10b981; }
        .calendar-event.planificado { background: #3b82f6; }

        /* Controles de navegaci贸n del calendario */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--verde-claro);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: var(--verde-medio);
            transform: scale(1.1);
        }

        .calendar-month-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--verde-oscuro);
        }

        /* Panel de Planificaci贸n */
        .planning-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--sombra-md);
        }

        .planning-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Secuencia de rotaci贸n visual */
        .rotation-sequence {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 16px 0;
        }

        .rotation-step {
            min-width: 100px;
            padding: 12px;
            background: var(--verde-muy-claro);
            border-radius: 10px;
            text-align: center;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .rotation-step.active {
            border-color: var(--verde-claro);
            background: white;
            box-shadow: 0 4px 12px rgba(45,106,79,0.2);
        }

        .rotation-step.completed {
            background: var(--verde-claro);
            color: white;
        }

        .rotation-step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--verde-medio);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            margin: 0 auto 8px;
        }

        .rotation-step-potrero {
            font-weight: 700;
            font-size: 14px;
            color: var(--verde-oscuro);
        }

        .rotation-step-days {
            font-size: 11px;
            color: var(--gris-600);
        }

        .rotation-step-arrow {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--verde-claro);
        }

        /* Stats de rotaci贸n */
        .prv-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .prv-stat-card {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .prv-stat-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .prv-stat-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .prv-stat-value {
            font-size: 36px;
            font-weight: 700;
        }

        .prv-stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Tabs de PRV */
        .prv-tabs {
            display: flex;
            gap: 4px;
            background: var(--gris-200);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .prv-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gris-600);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .prv-tab:hover {
            color: var(--verde-medio);
        }

        .prv-tab.active {
            background: white;
            color: var(--verde-medio);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Tooltip de Gantt */
        .gantt-tooltip {
            position: fixed;
            background: var(--gris-900);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 9999;
            pointer-events: none;
            max-width: 250px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .gantt-tooltip-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .gantt-tooltip-info {
            opacity: 0.8;
        }

        /* ========================================
            SISTEMA DE FOTOGRAFAS GEOLOCALIZADAS
        ======================================== */
        .photo-gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
        }

        .photo-card {
            background: var(--blanco);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--sombra-md);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--sombra-lg);
        }

        .photo-card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: var(--gris-200);
        }

        .photo-card-info {
            padding: 12px;
        }

        .photo-card-date {
            font-size: 11px;
            color: var(--gris-500);
            margin-bottom: 4px;
        }

        .photo-card-location {
            font-size: 12px;
            color: var(--gris-700);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .photo-card-potrero {
            font-weight: 700;
            color: var(--verde-medio);
            font-size: 13px;
        }

        .photo-card-actions {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--gris-100);
            border-top: 1px solid var(--gris-200);
        }

        .photo-card-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .photo-card-btn.primary {
            background: var(--verde-claro);
            color: white;
        }

        .photo-card-btn.danger {
            background: var(--rojo);
            color: white;
        }

        .photo-card-btn:hover {
            transform: scale(1.05);
        }

        /* Modal de captura de foto */
        .photo-capture-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .photo-capture-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
        }

        .photo-capture-title {
            font-size: 18px;
            font-weight: 700;
        }

        .photo-capture-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .photo-capture-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .photo-capture-preview {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .photo-capture-video {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            background: #000;
        }

        .photo-capture-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .photo-capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: var(--verde-claro);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .photo-capture-btn:hover {
            transform: scale(1.1);
            background: var(--verde-medio);
        }

        .photo-capture-btn:active {
            transform: scale(0.95);
        }

        .photo-capture-btn.retake {
            width: 50px;
            height: 50px;
            background: var(--gris-600);
            font-size: 20px;
        }

        .photo-capture-btn.confirm {
            width: 50px;
            height: 50px;
            background: var(--verde);
            font-size: 20px;
        }

        .photo-capture-actions {
            display: flex;
            gap: 20px;
        }

        .photo-gps-info {
            background: rgba(0,0,0,0.6);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photo-gps-info.success {
            background: rgba(16, 185, 129, 0.8);
        }

        .photo-gps-info.error {
            background: rgba(239, 68, 68, 0.8);
        }

        /* Visor de foto ampliada */
        .photo-viewer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .photo-viewer-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .photo-viewer-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .photo-viewer-details h4 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .photo-viewer-details p {
            font-size: 12px;
            opacity: 0.8;
        }

        .photo-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .photo-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .photo-viewer-nav:hover {
            background: rgba(255,255,255,0.3);
        }

        .photo-viewer-nav.prev { left: 20px; }
        .photo-viewer-nav.next { right: 20px; }

        /* Comparador antes/despu茅s */
        .photo-compare-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: var(--sombra-lg);
        }

        .photo-compare-wrapper {
            position: relative;
            width: 100%;
            height: 400px;
        }

        .photo-compare-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-compare-image.after {
            clip-path: inset(0 50% 0 0);
        }

        .photo-compare-slider {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 4px;
            background: white;
            cursor: ew-resize;
            z-index: 10;
            transform: translateX(-50%);
        }

        .photo-compare-slider::before {
            content: ' ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--gris-700);
            white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .photo-compare-labels {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }

        .photo-compare-label {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Filtros de galer铆a */
        .photo-filters {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: var(--gris-100);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .photo-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photo-filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gris-600);
        }

        .photo-filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gris-300);
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .photo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .photo-stat-card {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .photo-stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .photo-stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Bot贸n flotante de c谩mara */
        .camera-fab {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(45, 106, 79, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }

        .camera-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(45, 106, 79, 0.5);
        }

        .camera-fab.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Empty state para fotos */
        .photo-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gris-600);
        }

        .photo-empty-icon {
            font-size: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .photo-empty-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--gris-700);
        }

        .photo-empty-message {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* ========================================
            BUSCADOR DE UBICACIONES EN MAPA
        ======================================== */
        .map-search-container {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            max-width: 400px;
            width: calc(100% - 120px);
        }

        .map-search-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid var(--verde-claro);
            border-radius: 25px;
            font-size: 14px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            outline: none;
            transition: all 0.2s ease;
        }

        .map-search-input:focus {
            border-color: var(--verde-medio);
            box-shadow: 0 4px 15px rgba(45,106,79,0.3);
        }

        .map-search-input::placeholder {
            color: var(--gris-400);
        }

        .map-search-btn {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-search-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(45,106,79,0.4);
        }

        .map-search-btn:disabled {
            background: var(--gris-400);
            cursor: not-allowed;
            transform: none;
        }

        .map-search-results {
            position: absolute;
            top: 52px;
            left: 0;
            right: 50px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-height: 250px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .map-search-results.active {
            display: block;
        }

        .map-search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gris-100);
            transition: background 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .map-search-result-item:hover {
            background: var(--verde-muy-claro);
        }

        .map-search-result-item:last-child {
            border-bottom: none;
        }

        .map-search-result-icon {
            font-size: 18px;
        }

        .map-search-result-text {
            flex: 1;
        }

        .map-search-result-name {
            font-weight: 600;
            color: var(--gris-800);
            font-size: 13px;
        }

        .map-search-result-detail {
            font-size: 11px;
            color: var(--gris-500);
        }

        .map-search-loading {
            padding: 20px;
            text-align: center;
            color: var(--gris-500);
        }

        .map-search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--gris-500);
        }

        /* ========================================
            BSQUEDA GLOBAL (CTRL+K)
        ======================================== */
        .global-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 100px;
            animation: fadeIn 0.2s ease;
        }

        .global-search-container {
            background: var(--blanco);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: slideUp 0.2s ease;
        }

        .global-search-header {
            padding: 20px;
            border-bottom: 1px solid var(--gris-200);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .global-search-icon {
            font-size: 20px;
            color: var(--verde-medio);
        }

        .global-search-input {
            flex: 1;
            border: none;
            font-size: 18px;
            outline: none;
            background: transparent;
        }

        .global-search-input::placeholder {
            color: var(--gris-400);
        }

        .global-search-shortcut {
            display: flex;
            gap: 4px;
        }

        .global-search-shortcut kbd {
            background: var(--gris-100);
            border: 1px solid var(--gris-200);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            color: var(--gris-600);
            font-family: monospace;
        }

        .global-search-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-category {
            padding: 8px 20px;
            background: var(--gris-100);
            font-size: 11px;
            font-weight: 700;
            color: var(--gris-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-result-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid var(--gris-100);
        }

        .search-result-item:hover,
        .search-result-item.active {
            background: var(--verde-muy-claro);
        }

        .search-result-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--verde-claro);
            color: white;
        }

        .search-result-icon.potrero { background: var(--verde-medio); }
        .search-result-icon.movimiento { background: var(--acento-dorado); }
        .search-result-icon.accion { background: var(--azul); }

        .search-result-content {
            flex: 1;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--gris-800);
            margin-bottom: 2px;
        }

        .search-result-subtitle {
            font-size: 12px;
            color: var(--gris-600);
        }

        .search-result-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 999px;
            font-weight: 600;
        }

        .search-no-results {
            padding: 40px 20px;
            text-align: center;
            color: var(--gris-600);
        }

        .search-no-results-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .global-search-footer {
            padding: 12px 20px;
            background: var(--gris-100);
            border-top: 1px solid var(--gris-200);
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--gris-600);
        }

        .search-highlight {
            background: var(--amarillo);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* ========================================
           凤 SISTEMA DE ETIQUETAS
        ======================================== */
        .tags-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tags-input-container {
            position: relative;
        }

        .tags-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gris-200);
            border-radius: 10px;
            font-size: 14px;
            transition: all var(--transition-normal);
            background: var(--blanco);
        }

        .tags-input:focus {
            outline: none;
            border-color: var(--verde-claro);
            box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
        }

        .tags-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--blanco);
            border: 1px solid var(--gris-200);
            border-radius: 10px;
            box-shadow: var(--sombra-lg);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .tags-suggestions.active {
            display: block;
        }

        .tag-suggestion-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s ease;
        }

        .tag-suggestion-item:hover {
            background: var(--verde-muy-claro);
        }

        .tag-suggestion-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .tag-suggestion-text {
            flex: 1;
        }

        .tag-suggestion-category {
            font-size: 10px;
            color: var(--gris-500);
            text-transform: uppercase;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            animation: fadeIn 0.2s ease;
        }

        .tag-chip-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.15s ease;
            font-size: 14px;
        }

        .tag-chip-remove:hover {
            opacity: 1;
        }

        .tags-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .tag-category {
            background: var(--gris-100);
            border-radius: 10px;
            padding: 12px;
        }

        .tag-category-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--gris-600);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .tag-category-options {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag-quick-add {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s ease;
        }

        .tag-quick-add:hover {
            transform: scale(1.05);
        }

        /* ========================================
            CENTRO DE ALERTAS
        ======================================== */
        .alert-center-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 99998;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .alert-center-container {
            background: var(--blanco);
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        .alert-center-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--rojo) 0%, #dc2626 100%);
            color: var(--blanco);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .alert-center-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .alert-center-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.15s ease;
        }

        .alert-center-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .alert-center-tabs {
            display: flex;
            border-bottom: 1px solid var(--gris-200);
            padding: 0 24px;
            background: var(--gris-100);
        }

        .alert-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gris-600);
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-tab:hover {
            color: var(--verde-medio);
        }

        .alert-tab.active {
            color: var(--verde-medio);
            border-bottom-color: var(--verde-medio);
        }

        .alert-tab-count {
            background: var(--rojo);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            font-weight: 700;
        }

        .alert-center-body {
            padding: 20px 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--gris-300);
            transition: all 0.15s ease;
        }

        .alert-item:hover {
            transform: translateX(4px);
        }

        .alert-item.critical {
            border-left-color: var(--rojo);
            background: rgba(239, 68, 68, 0.05);
        }

        .alert-item.warning {
            border-left-color: var(--amarillo);
            background: rgba(251, 191, 36, 0.05);
        }

        .alert-item.info {
            border-left-color: var(--azul);
            background: rgba(59, 130, 246, 0.05);
        }

        .alert-item.success {
            border-left-color: var(--verde);
            background: rgba(16, 185, 129, 0.05);
        }

        .alert-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .alert-item.critical .alert-icon { background: rgba(239, 68, 68, 0.15); }
        .alert-item.warning .alert-icon { background: rgba(251, 191, 36, 0.15); }
        .alert-item.info .alert-icon { background: rgba(59, 130, 246, 0.15); }
        .alert-item.success .alert-icon { background: rgba(16, 185, 129, 0.15); }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 13px;
            color: var(--gris-600);
            line-height: 1.5;
        }

        .alert-meta {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--gris-500);
        }

        .alert-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .alert-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .alert-action-btn.primary {
            background: var(--verde-medio);
            color: white;
        }

        .alert-action-btn.secondary {
            background: var(--gris-200);
            color: var(--gris-700);
        }

        .alert-action-btn:hover {
            transform: scale(1.05);
        }

        .alert-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: var(--rojo);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        /* ========================================
            GRFICOS CON CHART.JS
        ======================================== */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-card {
            background: var(--gris-100);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--gris-200);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--gris-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chart-controls select {
            padding: 6px 12px;
            border: 1px solid var(--gris-200);
            border-radius: 6px;
            font-size: 12px;
            background: white;
            cursor: pointer;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
            justify-content: center;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--gris-600);
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* ========================================
            PLANTILLAS DE MOVIMIENTOS
        ======================================== */
        .template-selector {
            position: relative;
        }

        .template-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--blanco);
            border: 1px solid var(--gris-200);
            border-radius: 10px;
            box-shadow: var(--sombra-lg);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .template-dropdown.active {
            display: block;
        }

        .template-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gris-100);
            transition: background 0.15s ease;
        }

        .template-item:hover {
            background: var(--verde-muy-claro);
        }

        .template-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .template-item-name {
            font-weight: 700;
            color: var(--gris-800);
        }

        .template-item-badge {
            font-size: 10px;
            padding: 2px 8px;
            background: var(--verde-claro);
            color: white;
            border-radius: 999px;
        }

        .template-item-desc {
            font-size: 12px;
            color: var(--gris-600);
        }

        .template-preview {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: var(--verde-muy-claro);
            border-radius: 8px;
            border: 1px solid var(--verde-claro);
            font-size: 12px;
        }

        .template-preview.active {
            display: block;
        }

        .template-preview-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed var(--verde-claro);
        }

        .template-preview-row:last-child {
            border-bottom: none;
        }

        .template-preview-label {
            color: var(--gris-600);
        }

        .template-preview-value {
            font-weight: 600;
            color: var(--verde-oscuro);
        }

        /* ========================================
            EXPORTACIN MEJORADA
        ======================================== */
        .export-section {
            margin-bottom: 32px;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .export-card {
            background: var(--gris-100);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .export-card:hover {
            border-color: var(--verde-claro);
            transform: translateY(-2px);
            box-shadow: var(--sombra-md);
        }

        .export-card-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .export-card-title {
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 4px;
        }

        .export-card-desc {
            font-size: 12px;
            color: var(--gris-600);
        }

        .export-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .export-preview-container {
            background: var(--blanco);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .export-preview-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-claro) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .export-preview-body {
            padding: 20px 24px;
            max-height: 400px;
            overflow: auto;
        }

        .export-preview-content {
            background: var(--gris-100);
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .export-preview-footer {
            padding: 16px 24px;
            background: var(--gris-100);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* ========================================
            HISTORIAL DE CAMBIOS
        ======================================== */
        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 99998;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .history-container {
            background: var(--blanco);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .history-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--azul) 0%, #2563eb 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-body {
            padding: 20px 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: 32px;
            top: 60px;
            bottom: -12px;
            width: 2px;
            background: var(--gris-200);
        }

        .history-item:last-child::before {
            display: none;
        }

        .history-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--verde-claro);
            color: white;
            flex-shrink: 0;
            z-index: 1;
        }

        .history-icon.create { background: var(--verde); }
        .history-icon.update { background: var(--azul); }
        .history-icon.delete { background: var(--rojo); }

        .history-content {
            flex: 1;
        }

        .history-title {
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 4px;
        }

        .history-desc {
            font-size: 13px;
            color: var(--gris-600);
        }

        .history-meta {
            font-size: 11px;
            color: var(--gris-500);
            margin-top: 8px;
        }

        .history-undo {
            padding: 6px 12px;
            background: var(--gris-200);
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-undo:hover {
            background: var(--azul);
            color: white;
        }

        /* ========================================
            INDICADOR DE PLUGINS
        ======================================== */
        .plugins-indicator {
            position: fixed;
            bottom: 90px;
            right: 24px;
            background: var(--blanco);
            padding: 8px 16px;
            border-radius: 999px;
            box-shadow: var(--sombra-lg);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .plugins-indicator:hover {
            transform: scale(1.05);
        }

        .plugins-indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--verde);
            animation: pulse 2s infinite;
        }

        /* ========================================
           锔 ATAJOS DE TECLADO TOOLTIP
        ======================================== */
        .shortcuts-help {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: var(--blanco);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: var(--sombra-lg);
            font-size: 11px;
            display: none;
            z-index: 1000;
        }

        .shortcuts-help.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .shortcuts-help-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--gris-700);
        }

        .shortcuts-help-item {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding: 4px 0;
        }

        .shortcuts-help-key {
            display: flex;
            gap: 4px;
        }

        .shortcuts-help-key kbd {
            background: var(--gris-100);
            border: 1px solid var(--gris-200);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
        }

        /* ========================================
           GRFICOS SVG
        ======================================== */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        /* ========================================
           RESPONSIVE
        ======================================== */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                transition: left var(--transition-normal);
                z-index: 1000;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .content-area {
                padding: 16px;
            }

            .topbar {
                padding: 16px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
           UTILIDADES
        ======================================== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .gap-1 { gap: 8px; }
        .gap-2 { gap: 16px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }

        /* ========================================
           LOADING SPINNER
        ======================================== */
        .spinner {
            border: 3px solid var(--gris-200);
            border-top: 3px solid var(--verde-medio);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           EMPTY STATE
        ======================================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gris-600);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--gris-700);
        }

        .empty-state-message {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* ========================================
           MAPA SATELITAL
        ======================================== */
        .map-container {
            width: 100%;
            height: 600px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--sombra-lg);
            position: relative;
        }

        #mapView {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--blanco);
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--sombra-lg);
            max-width: 300px;
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--sombra-lg);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .legend-marker.libre {
            background: var(--verde);
        }

        .legend-marker.ocupado {
            background: var(--rojo);
        }

        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 8px;
        }

        .popup-content {
            padding: 12px;
            min-width: 200px;
        }

        .popup-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--verde-oscuro);
            margin-bottom: 8px;
        }

        .popup-info {
            font-size: 13px;
            color: var(--gris-700);
            margin-bottom: 4px;
        }

        .popup-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 8px;
        }

        /* ========================================
           STATS MINI
        ======================================== */
        .stat-mini {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gris-100);
            border-radius: 10px;
        }

        .stat-mini-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-mini-content {
            flex: 1;
        }

        .stat-mini-label {
            font-size: 11px;
            color: var(--gris-600);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .stat-mini-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--gris-900);
        }

        /* ========================================
            INDICADOR DE ESTADO DE RED
        ======================================== */
        .network-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: default;
        }

        .network-indicator.online {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.25));
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .network-indicator.offline {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.25));
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
            animation: pulseOffline 2s infinite;
        }

        @keyframes pulseOffline {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .network-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
        }

        .network-indicator.online .network-dot {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .network-indicator.offline .network-dot {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        .network-indicator.online .network-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: #10b981;
            animation: networkPing 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        @keyframes networkPing {
            0% { transform: scale(1); opacity: 0.75; }
            75%, 100% { transform: scale(2); opacity: 0; }
        }

        /* ========================================
            MDULO DE FINANZAS
        ======================================== */
        .finanzas-dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .finanzas-dashboard {
                grid-template-columns: 1fr;
            }
        }

        .saldo-card {
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            border-radius: 20px;
            padding: 32px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(15, 54, 41, 0.3);
        }

        .saldo-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .saldo-card-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .saldo-card-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .saldo-card-value {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .saldo-card-value.positivo { color: #6ee7b7; }
        .saldo-card-value.negativo { color: #fca5a5; }

        .saldo-card-subtitle {
            font-size: 13px;
            opacity: 0.8;
        }

        .finanzas-resumen {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-md);
        }

        .finanzas-resumen-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .finanzas-stat {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .finanzas-stat.ingresos {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            border-left: 4px solid #10b981;
        }

        .finanzas-stat.egresos {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
            border-left: 4px solid #ef4444;
        }

        .finanzas-stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .finanzas-stat.ingresos .finanzas-stat-value { color: #059669; }
        .finanzas-stat.egresos .finanzas-stat-value { color: #dc2626; }

        .finanzas-stat-label {
            font-size: 12px;
            color: var(--gris-600);
            margin-top: 4px;
        }

        .finanzas-movimiento-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--gris-100);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .finanzas-movimiento-item:hover {
            background: var(--verde-muy-claro);
            transform: translateX(4px);
        }

        .finanzas-movimiento-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .finanzas-movimiento-icon.ingreso {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .finanzas-movimiento-icon.egreso {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .finanzas-movimiento-info {
            flex: 1;
        }

        .finanzas-movimiento-concepto {
            font-weight: 600;
            color: var(--gris-800);
            font-size: 14px;
        }

        .finanzas-movimiento-fecha {
            font-size: 12px;
            color: var(--gris-500);
        }

        .finanzas-movimiento-monto {
            font-size: 18px;
            font-weight: 700;
        }

        .finanzas-movimiento-monto.ingreso { color: #059669; }
        .finanzas-movimiento-monto.egreso { color: #dc2626; }

        /* ========================================
            SISTEMA DE BACKUP
        ======================================== */
        .backup-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-md);
            margin-bottom: 24px;
        }

        .backup-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gris-100);
        }

        .backup-section-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--azul), #2563eb);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .backup-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gris-800);
        }

        .backup-section-subtitle {
            font-size: 13px;
            color: var(--gris-600);
        }

        .backup-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .backup-actions {
                grid-template-columns: 1fr;
            }
        }

        .backup-card {
            padding: 24px;
            border-radius: 16px;
            border: 2px dashed var(--gris-300);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .backup-card:hover {
            border-color: var(--verde-claro);
            background: var(--verde-muy-claro);
            transform: translateY(-4px);
        }

        .backup-card-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .backup-card.export .backup-card-icon {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .backup-card.import .backup-card-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .backup-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 8px;
        }

        .backup-card-desc {
            font-size: 13px;
            color: var(--gris-600);
            line-height: 1.5;
        }

        .backup-info-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .backup-info-box h4 {
            font-size: 14px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .backup-info-box p {
            font-size: 13px;
            color: var(--gris-700);
            line-height: 1.6;
        }

        /* ========== WIN-TEL CHATBOT ========== */
        .chatbot-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--verde-claro), var(--verde-medio));
            border: none;
            cursor: pointer;
            z-index: 8000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(82, 183, 136, 0.5);
            transition: all 0.3s ease;
            animation: chatbotPulse 2s ease-in-out infinite;
        }
        .chatbot-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(82, 183, 136, 0.7);
        }
        .chatbot-btn i { font-size: 26px; color: #fff; }
        .chatbot-btn .chat-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 18px;
            height: 18px;
            background: var(--rojo);
            border-radius: 50%;
            border: 2px solid var(--blanco);
            animation: badgePulse 1.5s ease-in-out infinite;
        }
        @keyframes chatbotPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(82, 183, 136, 0.5); }
            50% { box-shadow: 0 4px 35px rgba(82, 183, 136, 0.8); }
        }
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .chatbot-container {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 380px;
            height: 520px;
            background: var(--blanco);
            border: 1px solid var(--gris-200);
            border-radius: 20px;
            box-shadow: var(--sombra-xl);
            z-index: 8001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: chatSlideUp 0.3s ease;
        }
        .chatbot-container.active { display: flex; }
        @keyframes chatSlideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chatbot-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--verde-claro), var(--verde-medio));
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chatbot-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .chatbot-info { flex: 1; }
        .chatbot-name { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .chatbot-status {
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chatbot-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--verde-muy-claro);
            border-radius: 50%;
            animation: statusPulse 1.5s ease-in-out infinite;
        }
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chatbot-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chatbot-close:hover { background: rgba(255,255,255,0.3); }

        .chatbot-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--gris-100);
        }
        .chatbot-messages::-webkit-scrollbar { width: 5px; }
        .chatbot-messages::-webkit-scrollbar-thumb { background: var(--gris-300); border-radius: 3px; }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.5;
            animation: messageIn 0.3s ease;
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.bot {
            align-self: flex-start;
            background: var(--blanco);
            border: 1px solid var(--gris-200);
            border-bottom-left-radius: 4px;
            color: var(--gris-800);
            box-shadow: var(--sombra-sm);
        }
        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--verde-claro), var(--verde-medio));
            border-bottom-right-radius: 4px;
            color: #fff;
        }
        .chat-message.bot p { margin-bottom: 8px; }
        .chat-message.bot p:last-child { margin-bottom: 0; }

        .chat-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .chat-option {
            padding: 10px 14px;
            background: rgba(82, 183, 136, 0.1);
            border: 1px solid rgba(82, 183, 136, 0.3);
            border-radius: 10px;
            color: var(--gris-800);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-option:hover {
            background: var(--verde-claro);
            color: #fff;
            border-color: var(--verde-claro);
            transform: translateX(5px);
        }
        .chat-option i { font-size: 14px; }

        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #25D366, #128C7E);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
        }
        .whatsapp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        }
        .whatsapp-btn i { font-size: 18px; }

        .chatbot-input {
            padding: 16px;
            background: var(--blanco);
            border-top: 1px solid var(--gris-200);
            display: flex;
            gap: 10px;
        }
        .chatbot-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--gris-100);
            border: 1px solid var(--gris-200);
            border-radius: 25px;
            font-size: 13px;
            color: var(--gris-800);
            outline: none;
            transition: all 0.2s;
        }
        .chatbot-input input:focus {
            border-color: var(--verde-claro);
            box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.2);
        }
        .chatbot-input input::placeholder { color: var(--gris-400); }
        .chatbot-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--verde-claro), var(--verde-medio));
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chatbot-send:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(82, 183, 136, 0.5);
        }
        .chatbot-send i { font-size: 16px; }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--blanco);
            border: 1px solid var(--gris-200);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            max-width: 70px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--verde-claro);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        @media (max-width: 768px) {
            .chatbot-container {
                width: 100%;
                height: 100vh;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            .chatbot-btn {
                width: 55px;
                height: 55px;
                bottom: 15px;
                right: 15px;
            }
        }

        /* ========================================
            IDENTIDAD DIGITAL - CDULA ANIMAL v3.0
        ======================================== */
        .identity-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--verde-claro);
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .identity-section::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(82, 183, 136, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        .identity-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .identity-badge {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--verde-medio), var(--verde-claro));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(45, 106, 79, 0.3);
        }

        .identity-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--verde-oscuro);
        }

        .identity-subtitle {
            font-size: 12px;
            color: var(--gris-600);
        }

        .identity-content {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 24px;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 600px) {
            .identity-content {
                grid-template-columns: 1fr;
                justify-items: center;
            }
        }

        .qr-container {
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .qr-code-wrapper {
            padding: 12px;
            background: white;
            border-radius: 12px;
            border: 3px solid var(--verde-claro);
        }

        .qr-code-wrapper canvas,
        .qr-code-wrapper img {
            display: block !important;
        }

        .qr-label {
            font-size: 11px;
            color: var(--gris-600);
            text-align: center;
            font-weight: 500;
        }

        .identity-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .identity-data-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--sombra-sm);
        }

        .identity-data-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: var(--verde-muy-claro);
        }

        .identity-data-label {
            font-size: 11px;
            color: var(--gris-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .identity-data-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--gris-800);
        }

        .print-cedula-btn {
            margin-top: 16px;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--acento-dorado), var(--acento-dorado-oscuro));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 163, 115, 0.4);
            width: 100%;
        }

        .print-cedula-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 163, 115, 0.5);
        }

        /* ========================================
           锔 FICHA DE IMPRESIN (CDULA)
        ======================================== */
        .cedula-preview {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            margin: 0 auto;
            border: 3px solid var(--verde-claro);
            position: relative;
        }

        .cedula-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 16px;
            border-bottom: 2px dashed var(--gris-200);
            margin-bottom: 16px;
        }

        .cedula-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cedula-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--verde-medio), var(--verde-claro));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .cedula-logo-text {
            font-size: 14px;
            font-weight: 800;
            color: var(--verde-oscuro);
            line-height: 1.2;
        }

        .cedula-logo-sub {
            font-size: 10px;
            color: var(--gris-600);
            font-weight: 500;
        }

        .cedula-tipo {
            background: var(--verde-claro);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cedula-body {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .cedula-qr-section {
            flex-shrink: 0;
        }

        .cedula-qr-box {
            background: var(--gris-100);
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--gris-200);
        }

        .cedula-info-section {
            flex: 1;
        }

        .cedula-id-big {
            font-size: 28px;
            font-weight: 800;
            color: var(--verde-oscuro);
            line-height: 1;
        }

        .cedula-nombre {
            font-size: 16px;
            font-weight: 600;
            color: var(--gris-700);
            margin-top: 4px;
            margin-bottom: 12px;
        }

        .cedula-detail {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            color: var(--gris-600);
            margin-bottom: 6px;
        }

        .cedula-detail-icon {
            width: 20px;
            text-align: center;
        }

        .cedula-footer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 2px dashed var(--gris-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cedula-fecha {
            font-size: 10px;
            color: var(--gris-500);
        }

        .cedula-validez {
            background: var(--verde-muy-claro);
            color: var(--verde-medio);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        /* ========================================
            ALERTAS SANITARIAS DASHBOARD
        ======================================== */
        .alerta-sanitaria-card {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fca5a5;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            animation: alertPulse 2s ease-in-out infinite;
        }

        .alerta-sanitaria-card.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fcd34d;
            animation: none;
        }

        .alerta-sanitaria-card.ok {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
            animation: none;
        }

        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .alerta-sanitaria-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .alerta-sanitaria-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .alerta-sanitaria-card .alerta-sanitaria-icon {
            background: rgba(239, 68, 68, 0.2);
        }

        .alerta-sanitaria-card.warning .alerta-sanitaria-icon {
            background: rgba(245, 158, 11, 0.2);
        }

        .alerta-sanitaria-card.ok .alerta-sanitaria-icon {
            background: rgba(16, 185, 129, 0.2);
        }

        .alerta-sanitaria-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gris-800);
        }

        .alerta-sanitaria-subtitle {
            font-size: 12px;
            color: var(--gris-600);
        }

        .alerta-sanitaria-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alerta-sanitaria-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--sombra-sm);
        }

        .alerta-sanitaria-animal {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alerta-sanitaria-animal-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gris-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .alerta-sanitaria-animal-id {
            font-weight: 700;
            color: var(--gris-800);
        }

        .alerta-sanitaria-animal-nombre {
            font-size: 12px;
            color: var(--gris-600);
        }

        .alerta-sanitaria-fecha {
            text-align: right;
        }

        .alerta-sanitaria-fecha-label {
            font-size: 10px;
            color: var(--gris-500);
            text-transform: uppercase;
        }

        .alerta-sanitaria-fecha-valor {
            font-weight: 700;
            font-size: 13px;
        }

        .alerta-sanitaria-fecha-valor.vencida {
            color: var(--rojo);
        }

        .alerta-sanitaria-fecha-valor.proxima {
            color: var(--amarillo);
        }

        /* Modal de C茅dula para imprimir */
        .cedula-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .cedula-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 480px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .cedula-modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--verde-medio), var(--verde-claro));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cedula-modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cedula-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .cedula-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .cedula-modal-body {
            padding: 24px;
        }

        .cedula-modal-actions {
            padding: 16px 24px;
            background: var(--gris-100);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Tabs en modal de detalle animal */
        .animal-detail-tabs {
            display: flex;
            gap: 4px;
            background: var(--gris-100);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .animal-detail-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gris-600);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .animal-detail-tab:hover {
            color: var(--verde-medio);
            background: rgba(82, 183, 136, 0.1);
        }

        .animal-detail-tab.active {
            background: white;
            color: var(--verde-medio);
            box-shadow: var(--sombra-sm);
        }

        .animal-detail-content {
            display: none;
        }

        .animal-detail-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* ========================================
           Л IFRAME GEOMATICS PRO FULLSCREEN
        ======================================== */
        .geomatics-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0f1c;
            z-index: 999999;
            display: flex;
            flex-direction: column;
        }

        .geomatics-toolbar {
            background: linear-gradient(135deg, #151921, #1e293b);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        .geomatics-toolbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .geomatics-toolbar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .geomatics-toolbar-logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #10d393, #34eab0);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .geomatics-toolbar-title {
            color: #ffffff;
            font-size: 14px;
            font-weight: 700;
        }

        .geomatics-toolbar-subtitle {
            color: #94a3b8;
            font-size: 11px;
        }

        .geomatics-toolbar-badge {
            background: linear-gradient(135deg, #10d393, #059669);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .geomatics-close-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .geomatics-close-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .geomatics-iframe-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .geomatics-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .geomatics-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0f1c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .geomatics-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(16, 211, 147, 0.2);
            border-top-color: #10d393;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .geomatics-loading-text {
            color: #94a3b8;
            font-size: 14px;
        }

        /* Bot贸n flotante para volver desde la app principal */
        .geomatics-back-float {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999999;
        }

        /* ========================================
            MDULO REPRODUCCIN v4.0
        ======================================== */
        .repro-timeline { position: relative; padding-left: 30px; }
        .repro-timeline::before { content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--verde-claro), var(--azul), var(--rojo)); border-radius: 3px; }
        .repro-event { position: relative; background: var(--gris-100); border-radius: 12px; padding: 16px; margin-bottom: 16px; border-left: 4px solid var(--verde-claro); }
        .repro-event::before { content: ''; position: absolute; left: -26px; top: 20px; width: 12px; height: 12px; background: var(--verde-claro); border-radius: 50%; border: 3px solid white; }
        .repro-event.celo { border-left-color: #ec4899; }
        .repro-event.celo::before { background: #ec4899; }
        .repro-event.servicio { border-left-color: var(--azul); }
        .repro-event.servicio::before { background: var(--azul); }
        .repro-event.diagnostico { border-left-color: var(--amarillo); }
        .repro-event.diagnostico::before { background: var(--amarillo); }
        .repro-event.parto { border-left-color: var(--verde); }
        .repro-event.parto::before { background: var(--verde); }
        .repro-event.secado { border-left-color: #8b5cf6; }
        .repro-event.secado::before { background: #8b5cf6; }
        .repro-event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .repro-event-type { font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .repro-event-date { font-size: 11px; color: var(--gris-500); }
        .repro-event-detail { font-size: 13px; color: var(--gris-700); }

        /* ========================================
            MDULO SANIDAD v4.0
        ======================================== */
        .historial-clinico { max-height: 400px; overflow-y: auto; }
        .historial-item { display: flex; gap: 16px; padding: 16px; background: var(--gris-100); border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--gris-300); }
        .historial-item.tratamiento { border-left-color: var(--azul); }
        .historial-item.vacuna { border-left-color: var(--verde); }
        .historial-item.enfermedad { border-left-color: var(--rojo); }
        .historial-item.desparasitacion { border-left-color: #8b5cf6; }
        .historial-item.vitaminas { border-left-color: var(--amarillo); }
        .historial-item.muerte { border-left-color: #374151; }
        .historial-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: white; flex-shrink: 0; }
        .historial-content { flex: 1; }
        .historial-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .historial-meta { font-size: 11px; color: var(--gris-500); display: flex; gap: 12px; flex-wrap: wrap; }

        /* ========================================
            MDULO LECHERA v4.0
        ======================================== */
        .lecheria-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .lecheria-stat { background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #7dd3fc; border-radius: 16px; padding: 20px; text-align: center; }
        .lecheria-stat-icon { font-size: 32px; margin-bottom: 8px; }
        .lecheria-stat-value { font-size: 28px; font-weight: 800; color: #0369a1; }
        .lecheria-stat-label { font-size: 11px; color: #0c4a6e; text-transform: uppercase; font-weight: 600; }
        .lactancia-chart { background: var(--gris-100); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .lactancia-chart-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .lactancia-bars { display: flex; align-items: flex-end; gap: 4px; height: 120px; padding: 10px 0; border-bottom: 2px solid var(--gris-300); }
        .lactancia-bar { flex: 1; background: linear-gradient(180deg, #3b82f6, #1d4ed8); border-radius: 4px 4px 0 0; min-height: 5px; position: relative; }
        .lactancia-bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--gris-500); }
        .orde帽o-registro { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
        .orde帽o-card { background: white; border: 2px solid var(--gris-200); border-radius: 12px; padding: 16px; }
        .orde帽o-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--gris-200); }
        .orde帽o-animal { display: flex; align-items: center; gap: 10px; }
        .orde帽o-animal-icon { width: 40px; height: 40px; background: var(--verde-muy-claro); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .orde帽o-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .orde帽o-input-group label { font-size: 10px; font-weight: 700; color: var(--gris-500); text-transform: uppercase; display: block; margin-bottom: 4px; }
        .orde帽o-input-group input { width: 100%; padding: 10px; border: 2px solid var(--gris-200); border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center; }
        .orde帽o-input-group input:focus { border-color: var(--azul); outline: none; }

        /* ========================================
            MDULO ANALYTICS v4.0
        ======================================== */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .analytics-card { background: white; border-radius: 16px; padding: 20px; box-shadow: var(--sombra-md); }
        .analytics-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .analytics-card-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .analytics-card-badge { font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 700; }
        .analytics-card-badge.up { background: var(--verde-muy-claro); color: var(--verde-medio); }
        .analytics-card-badge.down { background: #fef2f2; color: var(--rojo); }
        .analytics-kpi-big { font-size: 42px; font-weight: 800; color: var(--verde-medio); line-height: 1; margin-bottom: 4px; }
        .analytics-kpi-label { font-size: 12px; color: var(--gris-500); }
        .analytics-mini-chart { height: 50px; display: flex; align-items: flex-end; gap: 3px; margin-top: 16px; }
        .analytics-mini-bar { flex: 1; background: var(--verde-claro); border-radius: 2px; opacity: 0.6; }
        .analytics-mini-bar:last-child { opacity: 1; }
        .analytics-comparison { display: flex; gap: 12px; margin-top: 16px; }
        .analytics-comparison-item { flex: 1; text-align: center; padding: 10px; background: var(--gris-100); border-radius: 10px; }
        .analytics-comparison-value { font-size: 16px; font-weight: 700; }
        .analytics-comparison-label { font-size: 9px; color: var(--gris-500); text-transform: uppercase; }
        .analytics-trend { display: flex; align-items: center; gap: 4px; font-weight: 700; font-size: 12px; }
        .analytics-trend.up { color: var(--verde); }
        .analytics-trend.down { color: var(--rojo); }

        /* ========================================
            MDULO ECONOMA v4.0
        ======================================== */
        .economia-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .economia-card { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #fbbf24; border-radius: 16px; padding: 20px; text-align: center; }
        .economia-card.green { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-color: #10b981; }
        .economia-card.blue { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-color: #3b82f6; }
        .economia-card.purple { background: linear-gradient(135deg, #ede9fe, #ddd6fe); border-color: #8b5cf6; }
        .economia-value { font-size: 32px; font-weight: 800; color: #1f2937; margin-bottom: 4px; }
        .economia-label { font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; }
        .economia-trend { font-size: 11px; margin-top: 8px; padding: 4px 8px; border-radius: 12px; display: inline-block; }
        .economia-trend.up { background: #d1fae5; color: #065f46; }
        .economia-trend.down { background: #fee2e2; color: #991b1b; }
        .valorizacion-table { width: 100%; border-collapse: collapse; }
        .valorizacion-table th, .valorizacion-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gris-200); }
        .valorizacion-table th { background: var(--gris-100); font-weight: 700; font-size: 12px; text-transform: uppercase; }
        .valorizacion-table tr:hover { background: var(--gris-100); }
        .precio-input { width: 100px; padding: 8px; border: 2px solid var(--gris-200); border-radius: 8px; text-align: right; font-weight: 600; }
        .precio-input:focus { border-color: var(--verde); outline: none; }
        .costo-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .costo-badge.alto { background: #fee2e2; color: #991b1b; }
        .costo-badge.medio { background: #fef3c7; color: #92400e; }
        .costo-badge.bajo { background: #d1fae5; color: #065f46; }

        /* ========================================
            GALERA DE FOTOS v4.0
        ======================================== */
        .galeria-animal { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .galeria-thumb { position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; background: var(--gris-200); }
        .galeria-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .galeria-thumb:hover img { transform: scale(1.1); }
        .galeria-thumb-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 8px; color: white; font-size: 10px; }
        .galeria-add { display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--gris-100); border: 2px dashed var(--gris-300); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .galeria-add:hover { border-color: var(--verde); background: var(--verde-muy-claro); }
        .galeria-add-icon { font-size: 32px; margin-bottom: 8px; }
        .galeria-add-text { font-size: 12px; color: var(--gris-500); }
        .galeria-modal-img { max-width: 100%; max-height: 70vh; border-radius: 12px; }
        .foto-animal-mini { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN WIN-TEL -->
    <div id="splash-screen" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#0f3629 0%,#2d6a4f 100%);z-index:999999;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div style="animation:splashFloat 2s ease-in-out infinite;">
            <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAgEASABIAAD/7QAsUGhvdG9zaG9wIDMuMAA4QklNA+0AAAAAABAASAAAAAEAAQBIAAAAAQAB/+E7VWh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8APD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4zLWMwMTEgNjYuMTQ1NjYxLCAyMDEyLzAyLzA2LTE0OjU2OjI3ICAgICAgICAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOlhSZXNvbHV0aW9uPjE1MDAwMDAvMTAwMDA8L3RpZmY6WFJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOllSZXNvbHV0aW9uPjE1MDAwMDAvMTAwMDA8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjY8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOkpQRUdJbnRlcmNoYW5nZUZvcm1hdD4zMDI8L3RpZmY6SlBFR0ludGVyY2hhbmdlRm9ybWF0PgogICAgICAgICA8dGlmZjpKUEVHSW50ZXJjaGFuZ2VGb3JtYXRMZW5ndGg+MjU3OTwvdGlmZjpKUEVHSW50ZXJjaGFuZ2VGb3JtYXRMZW5ndGg+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOnhtcEdJbWc9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9nL2ltZy8iPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIElsbHVzdHJhdG9yIENTNiAoTWFjaW50b3NoKTwveG1wOkNyZWF0b3JUb29sPgogICAgICAgICA8eG1wOk1vZGlmeURhdGU+MjAxMy0wMy0xMVQxODo0ODowMlo8L3htcDpNb2RpZnlEYXRlPgogICAgICAgICA8eG1wOkNyZWF0ZURhdGU+MjAxMy0wMy0xMVQxNDoxNzo1OC0wNDozMDwveG1wOkNyZWF0ZURhdGU+CiAgICAgICAgIDx4bXA6TWV0YWRhdGFEYXRlPjIwMTMtMDMtMTFUMTQ6MTc6NTgtMDQ6MzA8L3htcDpNZXRhZGF0YURhdGU+CiAgICAgICAgIDx4bXA6VGh1bWJuYWlscz4KICAgICAgICAgICAgPHJkZjpBbHQ+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8eG1wR0ltZzp3aWR0aD4yNTY8L3htcEdJbWc6d2lkdGg+CiAgICAgICAgICAgICAgICAgIDx4bXBHSW1nOmhlaWdodD4xMTI8L3htcEdJbWc6aGVpZ2h0PgogICAgICAgICAgICAgICAgICA8eG1wR0ltZzpmb3JtYXQ+SlBFRzwveG1wR0ltZzpmb3JtYXQ+CiAgICAgICAgICAgICAgICAgIDx4bXBHSW1nOmltYWdlPi85ai80QUFRU2taSlJnQUJBZ0VBU0FCSUFBRC83UUFzVUdodmRHOXphRzl3SURNdU1BQTRRa2xOQSswQUFBQUFBQkFBU0FBQUFBRUEmI3hBO0FRQklBQUFBQVFBQi8rNEFEa0ZrYjJKbEFHVEFBQUFBQWYvYkFJUUFCZ1FFQkFVRUJnVUZCZ2tHQlFZSkN3Z0dCZ2dMREFvS0N3b0smI3hBO0RCQU1EQXdNREF3UURBNFBFQThPREJNVEZCUVRFeHdiR3hzY0h4OGZIeDhmSHg4Zkh3RUhCd2NOREEwWUVCQVlHaFVSRlJvZkh4OGYmI3hBO0h4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zi84QUFFUWdBY0FFQUF3RVImI3hBO0FBSVJBUU1SQWYvRUFhSUFBQUFIQVFFQkFRRUFBQUFBQUFBQUFBUUZBd0lHQVFBSENBa0tDd0VBQWdJREFRRUJBUUVBQUFBQUFBQUEmI3hBO0FRQUNBd1FGQmdjSUNRb0xFQUFDQVFNREFnUUNCZ2NEQkFJR0FuTUJBZ01SQkFBRklSSXhRVkVHRTJFaWNZRVVNcEdoQnhXeFFpUEImI3hBO1V0SGhNeFppOENSeWd2RWxRelJUa3FLeVkzUENOVVFuazZPek5oZFVaSFREMHVJSUpvTUpDaGdaaEpSRlJxUzBWdE5WS0JyeTQvUEUmI3hBOzFPVDBaWFdGbGFXMXhkWGw5V1oyaHBhbXRzYlc1dlkzUjFkbmQ0ZVhwN2ZIMStmM09FaFlhSGlJbUtpNHlOam8rQ2s1U1ZscGVZbVomI3hBO3FibkoyZW41S2pwS1dtcDZpcHFxdXNyYTZ2b1JBQUlDQVFJREJRVUVCUVlFQ0FNRGJRRUFBaEVEQkNFU01VRUZVUk5oSWdaeGdaRXkmI3hBO29iSHdGTUhSNFNOQ0ZWSmljdkV6SkRSRGdoYVNVeVdpWTdMQ0IzUFNOZUpFZ3hkVWt3Z0pDaGdaSmpaRkdpZGtkRlUzOHFPend5Z3AmI3hBOzArUHpoSlNrdE1UVTVQUmxkWVdWcGJYRjFlWDFSbFptZG9hV3ByYkcxdWIyUjFkbmQ0ZVhwN2ZIMStmM09FaFlhSGlJbUtpNHlOam8mI3hBOytEbEpXV2w1aVptcHVjblo2ZmtxT2twYWFucUttcXE2eXRycSt2L2FBQXdEQVFBQ0VRTVJBRDhBNlA1OC9NL3pKNVNudGRDaG0rdjYmI3hBO25hLzZSZTZqZFc2eEpjeE01S1Jvc2ZGQlJXVldaYVZJb0tIWTdEU2FNWkJaZFpyTmJLRXVHSTM1N3ZTUEp2bW0yODBlWHJYV2JlR1MmI3hBOzNTNEJEUlNnZ3E2bWpCV0lBZGE5R0g2NmpNVFBoT09SaVhPdzVSa2lKRHFuV1ZOcVdEWEZQbVk2RjlVbjVMWkMrTjl3L3dCR29aVEUmI3hBO0l1ZisvTnVWQjIraXFySEQrYTJpL3dDSTlXMEVXMXdMdlRCUkpHUXJITTQyWlFTS3JRblluWmh1TzFaNnZITEZnOFg2dkw4ZmIzT1AmI3hBO0RVeGxNdzN1TExkT3ZSZTJVTjBJMmlFcThnajlSL1o0Wmo0TXZIQVNxcmNoRTVhcnNWZGlyc1ZVN2lWNHJlV1dPRjdoNDBaa2dqS0ImI3hBOzVDQlVJcGtaRTVOMEhKZ1BFakZVcThtK1lqNWs4cmFacnB0alpuVWJkSnphbC9VOVBsK3p6b25MNTBHS29EVi9NbXUyOTFxUzJWcEMmI3hBOzl0cGl4bVpwUzNOaEl2S3FnRUNnSFhDaEd3ZVloQTZXK3FCVW5jS3l2Q0dNZEdjUjcxcVJ4Y2dIQWx0UE5tbUV5ODFsUVJsYUVvYWwmI3hBO1hSV1EwNmpsekFYRlY4Zm12UlpaNDRJNWk3eU9JMUlWdVBJc1VIeGROeU52YmZGVTN4VjJLdXhWMkt1eFYyS3V4VjJLdXhWMkt1eFYmI3hBOzJLdXhWMkt1eFYyS3ZQZk9INWFhaDVzODVXZDFxOTZqK1ZySkEwZW5vQ3NoazI1b3hIWjZWTFZyVDRRQjlyTTNCcWhqZ1JFZXM5WEImI3hBO3phV1dUSURJK2dkR3RXL0txNGNBNlpyMnB3Z00zcDI1dkpFampqTEF4eFJoTmxXTVY0N1Z6RTFPczFGRHdoanZyeERtMm5UQS93QVUmI3hBO3ZtczByeUI1cTA2OHRwMDFtNXVCYXllckhIZFhrc3FIWmdWY0JSVU1IK0wzQXpCeWFyWFNKcU9FQSs5bERCdzF2SS9GbkUvNmI5T0gmI3hBOzBQcXdmaCsvRW5PZ2VuN1BIdFh4ektoZkNPTG4xYjBtdk5KdTc2OU1sMUhwY2x6Q3ltVnFTZW9JSzFRUHZVL3RVcnQrT1RKTmVTTnImI3hBO1IwVXZtV1cyUjREcDhnYXZHUlRMd0svczBwV24zN1pHTWdSWTVKVFMxK3RlZ3YxdjAvWDM1K2xYaDEycHkzNllWVmNWZGlyc1ZkaXImI3hBO3NWU0RXZE8xbVc0U1N5amhha29rbGFSeXZxUmhHVDAzQVUvNzhZVjhNVlFDK1hmTVpsbXZYbHR6ZFN5TXlRdVM4Y2FGeElvVXNwL2EmI3hBO0ZlMjlEbEdlT1Exd0ZoSUhvcTIrZ2ExQklTaVdBNHN6Uk1Jd0dVc3hwUWxUU2kwSHkyRysrVkNPZnZDS2t2dHRDMWxKNDNrU3g5T0omI3hBO28yVUxHb05WS2hqWGdQMlYrSDZQbmhqSFBlNUg0NXFCSmsyWmJZN0ZYWXE3RlhZcTByS3dxcEREeEcrS3Q0cTdGWFlxN0ZYWXE3RlgmI3hBO1lxN0ZYWXE3RlhtdXQ2OXFxZVlydUdDOWxFQ1gxdEVxSTU0Z0ZXNXJ0N2pmTkxselRHWWl6WEZGdG9jUHdXYUI1bXZUbzltMTlyencmI3hBO1N6S1c0dkI2em45KzZsaEpYK1JDS0ViZGQrbWRIT0F2WU9oMDJwa2NZTXAwVDVlWi9RajAxNlY3Y1BINW5aZ3lNZVNXWExrVnFDUlUmI3hBO05RVjMrakk4UGszRE5ZMnlmN0ZtSTFQVDdlSkk3cStnRXlvdnFNN3BHU2VOZVhFbmFvM3lrdXlISjU1ZWVUZEpUelRxUG1QVDlkRnomI3hBO2RhaXZBV1J1VTRqbi9lY21ERG5HcWdjVlAyZm9GTDhtZmp4ZUdSczRzZEtCa003TzdOZERsMEhUZFBTM2kxQzNldFdrazlaQ0dlZzUmI3hBO0ViOUJtQnA5UEhGR2c1UTJUaUc0Z25UbkJJa3FWcHlSZ3dxTzFSbDZWK0t1eFYyS3V4VmlIa1A4eGJUelo1Zm4xa1d2MVNLQzhsc2cmI3hBO3FUUjNLdVlncDVySkY4Skh4VThLaXFsbDRzVXFnYlB6dnJSMU5ZcHhETGJWbTVyRXJCejZTRnVJTEViN0RLOGVhTXdTT2pHTXdVNC8mI3hBO3h2YnZJdm8yMGpSbFdvV29wSkRLRnBVOUNyaHZweXhOdWZ6cmJDZWl3TjZQQm1CWmtWNnJ2OFFKb3RRcDQxKzF0VHJpbHVienZhUkcmI3hBO1ZmcWszT0VrU0tRRm9BM0VuYytKWHA0NGFWa1VNcXl4Skt0ZU1paGxyMW9SWEFxN0ZYWXFrUG51THpSSjVUMUgvQ3N6UStZVWlMNmQmI3hBO3dGdWVjbyt5amZXVmVLamU5UG1NVlJYbVI1MDB1UXdzVk5SVWpyUWJuOVdLc1I4cjJWdk9BTlB0NUV2WWl3bXVkeEdqRGloVXNldkkmI3hBO0F2dDBQdGhRRVRlNm5yTnMxMVpUYXRHSHRFRFRqa3FPdkwxR1JGYjArUkxSaFRUN1JOZDZkYU1tb2pDNzJZbVlITkdmWDlacVVYWGImI3hBO0VTQjJEQWxHMkZCUVVSYWIxMk5lMjV3L21NZjg0SjR4M3B6NWRudkpiT1EzVjdGZk9KU0ZsaElJQ1VGRmJpc1lyOUdUaE9NdHdiU0QmI3hBO2FhWkpMc1ZkaXFFYldOSlc0K3J0ZXdMY2JVaU1pQnQ5eHRXdUtvc0VFVkc0UFE0cTdGWFlxbEdnYVRvT2d4dm91bGdRMWVhK2EzWjImI3hBO2QvOEFTWm1kMytNbHVQcU1RUERwaG8xYUxGMG1GbmQyVi9heFhscklrOXZNdktHWmQxWmZFSERLSkJvcUNEdUZpM0VIMTgyWVJRNngmI3hBO0NXdTNRdHhwVDZNcjQvVlM5VUJhZVRmTE5vOTI4V254czk5Y3kzbHkwdFpTMDArOGpBeUZpb0ovWkd3N0RKSlNLMjE3eS9GcUVzSjgmI3hBO3ZTd1BZdVVsdUZ0eHhFbk1vZURFSnpTbER5SGlNc25EaEEzNXRVTWxraXVTTXNydnlkZVhBWDlIckRKTVNyUE5DcUNyQXNRU1QzNC8mI3hBO2o3NUJ0WkphV1ZuWnhtSzFoU0NNbmtValVLSzlLMEdCVmJGWFlxN0ZYWXFoSjlNdHBMZjBJMVdCT1hNaU5RQlh4b01WUTYrWDdENnQmI3hBO05ESW9kcFZaUFdLcjZpaDE0bml4QnAxeUVvQXhJNzBFYlVoVjhvV1FJYjZ6Y2NsazlVTUhVR3V4cHN2VDRjeHZ5Y2U4ODJIaGh6K1UmI3hBO0xOMEt0ZFhIMmVJSVpRUlR2VUtLbnhyMU8vWEU2T0o2bGZEQ2EyZGxGYTJ3dDFKZEZMRUY2RTBaaTFQa0swR1pPT0hDS0RNQ2tSazAmI3hBO3V4VjJLdXhWWlBCRlBHWTVWNUllcW52aXJjY2NjYUJJMUNJdlJWRkFQdXhWQ3lhTnBVczgwOGxyRzgxeFQxblpRUzNGZUFyWC9KTk0mI3hBO2hMSEdYTVdnZ0ZzNlRwaEZEYXhFVnJUaUtWcVQwK2JIQjRNTzRMd2hWdHJPMHRWSzIwU1FxeHF3UUFBbjZNbEdFWThoU2dBSzJTUzcmI3hBO0ZWSzdVdGJTZ0dsVk80K1dLdk85T3Q1cGRTbXRocG4xMTVnb001QVZVQklTWVBJZitLMStIdUQwNjRxbW1zMTAzVTQ0cGRVa2l1ZFMmI3hBO1NXYjBvdlU0b3NVSVNXUXFyRGxTcTA2R3ZUMnB6WnVDaWVUR1VxUTFnOFFobTQ2MWN4RVBLQ2lSejFVdk96azBaMkgyVkpQSWNoWGQmI3hBO3UyVlIxc0NFRElFMDBPNnRsMU1GdGJsdVFJU3BoblZrVmlXNWM2czNDb0I2QVZ5Y05WamthQlNKZ3BkcnY1ZGE1ck9wWDE1TDVsbnQmI3hBO1JKTC9BTGpSYnhLajI5cTBLQjdkbVZsOVJXbmlXVGYzSDdXMnd3WitEbUxEVm53Y2RFRXhJN2sxdFBLK3MyVnJiV2RscTVndGJSUFMmI3hBO2dqRVFQR01iS3U1L1pVQ2xmRDN5bVVyTm5xM1JqUW9LT29hRDVpYStqbWp2YXZNVldTNmlpUldqVlFOcUZsUEV0dnNhL1BNYVlJbUMmI3hBO0JmVDNJcmRIUjZONWtxUFUxdGlLQ3ZHRkFTYWo1OXN2WkxyYnlwREhyK3BhdmMzazk2dW9wYkFhZmNGWHRyZDdWU09kdWhGWXk5YXQmI3hBO1E3bjZLS282UFF0RmpZTkhZd0l3NkVScUNQbHQ3NHFqc1ZkaXJzVmRpcnNWWXArWG5uNkR6bm9WMXEwTm9iUmJXNmx0REg2Z21EZW0mI3hBO3FPSFYxQ2o0bGtHM1kxR0VoVUhxMXJxbW8zOXpKK2tKWW92UlE2Y3NMR05HbGNzUFRZQ3UvSkNQSHBpaFV0TlZtMGNwYkpLMTQ3TEcmI3hBOzF6SE5JV1pIOUlPOVB0RmVXOUJrWlRBNWxicEZXdm1qVTU3eG8wdEE0Ymp4akFmNFR5Q3N2SUwxSExkdnMvRDc0SXppZVJVRlVYekwmI3hBO3JoTWZMUjVFQmtWSktoNjBiYjRhTFRZcWE3K0dUU3lYQXJzVmRpcVVlYVBOZWllVjlMT3Fheks4Tm1HNEZvNHBaMnJ4WnllRVN1MUYmI3hBO1JHWmpTZ0F4VkVYZXNXME9tSnFFUDcrQ1ZVZUZsTkF5eVVLdFduZ2E0cWxHbGVaZFRsdGt1cjZHRXdPYWhvQ3dZS1F1L0Y2MW83OEQmI3hBO3YxeFZHbnpkb25vbVJaSFpsRlRFSTM1ZFNEMUhHZ0trRnEwcjN4VlVielZvQ2dGN29JQ2FLV1NSYTdWcXRWM0ZEMUdLb3pUOVRzdFEmI3hBO2hhYTBrOVJFWW8xVlpDR0FCb1ZjS2VoeFZFNHE3RlhFQWloNkhGVnNjYVJyeFJRcStBeFZEM0dtV3M5eUxod2ZWQ0dQa0NSVmQ5dHYmI3hBOzlZNUdVUWVhQ0docGRxQVI4VkdOVDhSOS93RG1vNUR3WXJ3dVRUTFJINWdNVzkyYjVlT0VZb2cydEl2TEVwTEpwV3RKZjZoZXg2azgmI3hBO3NjOGx1OW5ZTUFzVUt3cHhrVU1QaVBxc2VUVjlzeDlUR1pqNkRVZ2I5L2trS0dvUDV0RXNON2JSUkNPRTBtc21rUHhvVklMVkcxUWQmI3hBO3hnd2NaTXBaZlNCSFlEZmZ6WVpPTGJoK0tYUlhQbmFlMWxudDcyeFJaRmtNWW1xV1NoQVVtZ29EU3A3Z2JiWlpvczJId3hLY2pJOHomI3hBO3kyN3g3ZzE1QmxzMVFUaXdiemI5Y2crdkd4K3AwYjEvU01ucUUwcXBYbFFENHRpUERNcVJ4VnRkckh4TDNxazZ5cHVkaXJzVmRpcnMmI3hBO1ZkaXF6MGtFYlJxQWdibFdncHV4Skora211S3NSMVRUN0dQbFpYR3N4Mm85VmJrUWxsRHE0NkdwM0hqaFZINlo1ZjBDN2htdVBYL1MmI3hBO1VrOG5LZTU1OVhDbGFVU2dGRmM3ZjJaVmt4Um1La3hNUVVVM2xUU0FnRUtOQTZxSTFrUmlTRkRjcVVma092dGxKMGNPbXlQREN3K1YmI3hBO0xScGpLMTFjRnVSWURrdEFUWC9KcjFOZm9HRDhuRzdzbzhOTzh5MngyS3V4VkovTmZsVFNQTk9rTnBPckNackpwSTVXU0NhU0FzMFQmI3hBO2MwNUdNcnlVTUFlTGJWQVBZWXFpdFQwODNHbkcxakpKQUNxWFlzZGhRRXN4SlB6SnJpcVc2TDVPc05QZHBwMk4zTXhQQVNmM2NZWTgmI3hBO2lFUTFIWHVmd3hWTEpmTFBtU1MrMWFSMXNQcWt6aGRLZ0NjdlFoRWJWWW5nbjcxcFdMOXd0ZHE3azR1YUdRazhCNmZqOURYSVM2SmomI3hBOytpZFpVbmpiYWJ4THMzRVEwSHhOMXI0MFViMDMrakg5OS9SVDZreDBTMXZMYTNranVvYmVGaTVaUmFyd1UxQXFXSGpsdUxqcjExZmsmI3hBO21OOVV4eTFrN0ZYWXE3RlhZcTdGWFlxeHkvOEFNdW8yMnN0WnBaQ1dFMEVMTVRHV1BHdXpHcTlkaG1ITFVTR1lRclk5V0lPNnEzblQmI3hBO1JvWkRCZU05dmNwL2VROFRKUThRMzJrREtldVpqSmN2blR5OHl5c2s3c0lWNXkwaWsrRmVRV3Bxdml3eFZBVGE3NUprTEJub1hBZVEmI3hBO1JySU85S0VMM3IyekZub2NVdWNlZndUeEpucHRyb0dvVzZ6MmkrcENqRUN2TVVhZ3FDR29lbE1BMEdJVnR5WGlLYnFvVlFxN0JSUWYmI3hBO0labEFVS1EzaFYyS3V4VjJLdUpvQ2FWOWhpckZmSlBtRHpYcStqNm5jK1k5R2ZRYjIzdnJpQzF0SDRrbTJRSzBVbk5KSlVrcnlJTHEmI3hBO1FwSTJGTVZTNU5JMHhyR1dTOVpXazFtVVF3M0QwTFF5cUhJTlR2UXNvcnZ2WENocTkxR3ovU2MxeEU4a0VWck1JV2VNY2xMUnNwRksmI3hBO092TDRJdUovMXNvelp4anErckdVNlVyWFdOUTlhVUc5ZU11MVpHSkpJNHFzYnQ4U0t1L0JpbzJwWHVkc3FHdGdVRElFVlk2dHEwdDMmI3hBO0NadFVqSEdaUFZnSVpRVVloeit3ZjVpb3FkZ045K2s0NnJHZHJTSmhtK1pETjJLdXhWMkt1eFYyS3V4VjJLdXhWMkt1eFYyS3V4VjImI3hBO0t1eFYyS3ZPL09INVlheHFta1hkbnBldVRpVzYxV1RWL3dEVG5keEd6eGlOWUlYVDRvNFk2RXF0RDF6SjB1YU9PVmtXNHVyd1N5UkEmI3hBO2lhbzJ5alRvTFR5MzVhMCsydnBQVmt0WVlvSkppZVRTUzhhTzNKNmRUeVlrOXN4ZFRuaUNaSFlFdDBmUkVBbFcwblg3SFZMdTV0b0wmI3hBO2VWR3Rxck84aUtGclhqeHFHYmMwUDNaajRkVEhKSWdBN0pqTUUwbWZvUWJmdTEyNmJETWxtdkFBNmQrdUt1eFYyS3V4VjJLdXhWMksmI3hBO3JaZVBwdHpGVm9lUTlzU1ZZVkpxUGxDYUpMbWF4dXZxMGo4VnVIaXBGeUpvZmlyeDdiNWlZOVlKOG95K1RXTWdQUXNpczlTOHV4UkMmI3hBOzN0SllVaVQ5aEJSUlU4YW5ieDZuTXVteEd4M2xqTFA2TWNxU1M4Qkp4VWh2Z3FDRHQ4OGFWZExZMlVzbnFTd1J2SUFBSFpRVFFFa2ImI3hBO2tlTEhJSEhFbXlFVUZiSnBkaXJzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWWVpENUg4d1hHa3hXbXQrWVcxRzcmI3hBO2llWWk3K3JKSFdPU1ZtVUZGWURrRTRMWDJOTmptSnF0S2N2V212Smo0dXFNMUhRdkxXbWFNcjZsRzBpeGYza3NaZFhsa2NLcEpDdCsmI3hBOzF4NkUweTdCaEdPTkJsR0lBUzdUN2J5YmN6U1drV24zY1JVOForWmtRSnpCQTUvSFhjQ25UTGtwdlA1YThxbVF6TUFEZFNEWlpXNHUmI3hBOzlhYktEVHEyQktNMHZSOUUwMWpMWTBUbXZFL3ZXY0ZhazlHWWpiaWZ4eFZORWRIWGtqQmw2VkJxTnR1Mkt0NHE3RlhZcTdGV0cvbHImI3hBOzVDbThrK1Y3blIzdi93QkltVzRsdVZtNE1sQTZJbFBpZVYyTGVuellsdXJFRDRRTUV1U2xKWFc3bjhxVzJqTFpYSzNhejh5elF1STYmI3hBO0ZtL2FwL2xacmRGbTRJQ0pFcjl6ajQ1VUtvc2l2UExkcmI2ZGI4YkVUWERxRXUxWDFHWW5nQ3hYaTYvdEptZG1uS0l1SXR1bFlRQ3gmI3hBO1FTU0k0MGk5dDZ5YmNTeFhnaUlmajVocUFucVZGYWUrMlk4ZFhMckFzQk05eXRaQ1d5dllabzdMVUptaVYycEt4SzFjQldEZnUrdGYmI3hBO2lwNy9BRVpJNnFYOHdwNHozTXhqYm5HcmxTdklBOFRzUlhzY3lnYkRZdXdxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0YmI3hBO1hZcTdGWFlxeEM5OGt3UjYvcUd1emFwcVZ4QnFDUnhOcGNrelRXZHZ3Wkg5V0dFMUtubkh2UTdjbTJwaFZEeDZsZTNNNE1Oak1MNjgmI3hBO3VSRmNzOFRxaHQxRWlySnlJVUFoSk8vaGloQnBwNEVJSjA2OW9xeENkQUtGdU1YSDRDWTZyUXI4UkhYN3N3QnE1MTlCYStNOXlLbDAmI3hBO3kyY281MDY5ZVFNd2RDQW9iaXdOR0Nwdyt5ekNnMm9UMU9XSFV5L21sUEg1TWc4cVFMQnByUnJETkFCSlhoUDlyNGtSdHFLbTI5T24mI3hBO1d1VzRzaG1MSXBsRTJuT1dzbllxN0ZYWXFsbmwvd0F5NkY1aXNudnRGdkV2ck9PVjRHbmpEY1BVanB5Q2xnT1EzRkdHeDdIRlVCci8mI3hBO0FKaDFDMXVrczlPamlhNFk3R2ZrUTFGWThWQ2tibmpRYjRWWFA1bmx0RWpGN0FzanlQeERXN2JFTXhWV0FZOXo0bmJBcXovRzlnWkImI3hBO3hnbE1SVG1HcWdiN1BPbkV0dDhOYVY2bnBXdUtxaitjOU9SM1JvSndZM0VjbFZVVUpOTzdlSVlmUWNWVC9GWFlxN0ZYWXE3RlhZcTcmI3hBO0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlVrOHBlVFBMbmxIVHBkTjBDMCtwMmMwN1gmI3hBO01rWE41UDNqcXFiRnl4QUNScW9BNkFZcWhkYjBhdzFUVlZpZStTM21IRmhHanI2L3dtdndpdFIwTzlNS291NDh0cXRwQmI2Wk1iRXcmI3hBO0ZtOVFBdXpGaFFsanlCSjkvdXpIejRwVHFqVk1aUnZrcFErWHRYaUJBMVppR0JxREh0eU1uUGxzd1AzSDhOc3FHbnlEK1A4QUZzUkEmI3hBOzk2bzJuK1k0cFQ2TjdGTEV6RjI5VmFOMEpBNlB0VURwVHFhWWZEeWc3UzJXcGQ2ZDVsdGpzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGkmI3hBO3JzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGlyRTlKMWJ6WWZLMm8zMnRlZ2w5SGMzTVZrWXJXV3ovMGVLWXcmI3hBO1J5UERQTmNNR2s0R1JUem9WWmR1dUtzVzB1T3p2SlFsMWJUWGx6SkVHak1ZWjJQTm1SeXg2VlhseURIdmhRbkUrdlhsbGV5UUMvTnYmI3hBO3dlUUczbFV5ZW1LY2xCNHF5OFZGUjhKOE8yWWs5YmppYVBOZ2NvQlhIWDcrM2Q0enFxaVVGL2daWG0rTU0zd0drSThGM0hRVjIzcmkmI3hBO2RiaUJxMU9RTWgwcC9NSzNNRWQyVXViUjRpNzNTZ0tlVlNGQUZWTzZnRS9EMUp6S0JCRnRpZFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXEmI3hBOzdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcWtXbitkUExPcmFKZGF4cHQwTC9BRTYwa2VHZDQxYismI3hBOzhqcHlRQnd0ZnRDaDZlK0twWW5uaTQ5UzNGdHBSa2duVXNSRTRKSHh5QURaZU5lTUxOVERTTFQ2MTF6U2JoVUxPc0VzbkdrVXhWWHEmI3hBOy9RYkVnayt4d1VsZkZyR2l5c1FsMUNTR0sxNUtLa0tITkNldXpkUmpTcTBXcGFkTElzVVZ6RThqMTRJcnFTYUNwb0FmQTF4VkU0cTcmI3hBO0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXF4elF2eSs4cjZCb0YmI3hBOzFvT2oyNzJtbjNrcnp6TDZza3JlbzRWYWhwaklkbGpWUU9sQjg4YlZEMmZreSt0YmlQMGI4SmJwQzBMRll4NmhCa2Q2cVBzcXdEMDUmI3hBO2IvTENxL1Y5RXVWdkVlenNWdTFjS1hlUitJRWdrTGxqUmgzcHNGcCtyTWJOTEtENlJZWVNNdWlGaTBiVUkxY0hSMWQ2QmF0T3hFbjcmI3hBO3ZoOFZYN0xXaDdkQU8rVmpKbS9tb3VYY2lkSTB1N2cxQ0NWdEtTMmloZHdraXlFa0s2R3JrYzI3MEhIdGs0Wk1wTzhka2d5N21VNWsmI3hBO3MzWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcS8vOWs9PC94bXBHSW1nOmltYWdlPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6QWx0PgogICAgICAgICA8L3htcDpUaHVtYm5haWxzPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iPgogICAgICAgICA8ZXhpZjpDb2xvclNwYWNlPjE8L2V4aWY6Q29sb3JTcGFjZT4KICAgICAgICAgPGV4aWY6UGl4ZWxYRGltZW5zaW9uPjgwMDwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj42MDA8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KICAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9qcGVnPC9kYzpmb3JtYXQ+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgICAgICAgICAgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiCiAgICAgICAgICAgIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiPgogICAgICAgICA8eG1wTU06RG9jdW1lbnRJRD54bXAuZGlkOkZDN0YxMTc0MDcyMDY4MTE4MjJBRUIzM0FFNUI5Nzg1PC94bXBNTTpEb2N1bWVudElEPgogICAgICAgICA8eG1wTU06SW5zdGFuY2VJRD54bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE4MjJBRUIzM0FFNUI5Nzg1PC94bXBNTTpJbnN0YW5jZUlEPgogICAgICAgICA8eG1wTU06T3JpZ2luYWxEb2N1bWVudElEPnhtcC5kaWQ6Rjc3RjExNzQwNzIwNjgxMTgyMkFFQjMzQUU1Qjk3ODU8L3htcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOlJlbmRpdGlvbkNsYXNzPnByb29mOnBkZjwveG1wTU06UmVuZGl0aW9uQ2xhc3M+CiAgICAgICAgIDx4bXBNTTpEZXJpdmVkRnJvbSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgIDxzdFJlZjppbnN0YW5jZUlEPnV1aWQ6NWZhM2RmN2YtNDkxYi00MDQ3LTg0ODQtMDM4ODc0ZDhhODczPC9zdFJlZjppbnN0YW5jZUlEPgogICAgICAgICAgICA8c3RSZWY6ZG9jdW1lbnRJRD54bXAuZGlkOkY3N0YxMTc0MDcyMDY4MTE4MjJBRUIzM0FFNUI5Nzg1PC9zdFJlZjpkb2N1bWVudElEPgogICAgICAgICAgICA8c3RSZWY6b3JpZ2luYWxEb2N1bWVudElEPnhtcC5kaWQ6Rjc3RjExNzQwNzIwNjgxMTgyMkFFQjMzQUU1Qjk3ODU8L3N0UmVmOm9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgICAgPHN0UmVmOnJlbmRpdGlvbkNsYXNzPnByb29mOnBkZjwvc3RSZWY6cmVuZGl0aW9uQ2xhc3M+CiAgICAgICAgIDwveG1wTU06RGVyaXZlZEZyb20+CiAgICAgICAgIDx4bXBNTTpIaXN0b3J5PgogICAgICAgICAgICA8cmRmOlNlcT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDpGNzdGMTE3NDA3MjA2ODExODIyQUVCMzNBRTVCOTc4NTwvc3RFdnQ6aW5zdGFuY2VJRD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAxMy0wMy0xMVQwODo1NzowOS0wNDozMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgSWxsdXN0cmF0b3IgQ1M2IChNYWNpbnRvc2gpPC9zdEV2dDpzb2Z0d2FyZUFnZW50PgogICAgICAgICAgICAgICAgICA8c3RFdnQ6Y2hhbmdlZD4vPC9zdEV2dDpjaGFuZ2VkPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDpGQzdGMTE3NDA3MjA2ODExODIyQUVCMzNBRTVCOTc4NTwvc3RFdnQ6aW5zdGFuY2VJRD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAxMy0wMy0xMVQxNDoxNzo1OC0wNDozMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgSWxsdXN0cmF0b3IgQ1M2IChNYWNpbnRvc2gpPC9zdEV2dDpzb2Z0d2FyZUFnZW50PgogICAgICAgICAgICAgICAgICA8c3RFdnQ6Y2hhbmdlZD4vPC9zdEV2dDpjaGFuZ2VkPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6U2VxPgogICAgICAgICA8L3htcE1NOkhpc3Rvcnk+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz7/7gAhQWRvYmUAZMAAAAABAwAQAwIDBgAAVR0AAGIOAACabf/bAIQAAgICAgICAgICAgMCAgIDBAMCAgMEBQQEBAQEBQYFBQUFBQUGBgcHCAcHBgkJCgoJCQwMDAwMDAwMDAwMDAwMDAEDAwMFBAUJBgYJDQsJCw0PDg4ODg8PDAwMDAwPDwwMDAwMDA8MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8IAEQgCLgMZAwERAAIRAQMRAf/EAQUAAQACAgMBAQEAAAAAAAAAAAAHCAYJAwQFAQIKAQEBAAIDAQAAAAAAAAAAAAAAAQMFAgQGBxAAAAYCAQEECQQCAgIDAAAAAQIDBAUGAAcIERAgYBIwUCExEzMUNDdAFRY2sBciIyQJcEEYEQACAQMCAwQEBwgKDA0FAAABAgMRBAUAEiExBhBBURNhcSIUIIGhsTJCFZFSYnIjs3UHMFBgwYKSwnMkdEDRorIzQ5PTNLQ2CLBTY4Ojw6TE1DWFlRbwZIQl1RIAAQMBBAUKAwYGAQUAAAAAAQARAgMhMUFxEFFhgRJg8JGhscHRIjJyINIE4UJSghMzsJKissIjYvHyc9MU/9oADAMBAAIRAxEAAADf4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeQVajESQiTakk9IAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+GCngR7tZOa3oi4AH7M+JMJOJOqSj1QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAV+iPADEStIAAAAP0SUXjqWQAAAAAAdA/R3QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADGCsUADCSuIAAJbPJI6BYI2A1WWLPVqhi79WAAAAAANf8emXtoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACLyvsc5zH08gqkSOWXKWnTMzNqdeaaqo8AueW5qpcW0qDyVD3AAAAADXNHrmwKgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgZHZBcD9naOyVeLQl3qpDFVSczYrQqDFNTYFVgig8X6rVHF4qk81eRbYqcfgvRVhjGSjMRwTSYGZIbAqjIorEYmXlzasSay4tXViSpcVSNqNd81aReCusUbjEiRS9VSuAAAAAAAAAAAAAAAAAAAADyyLzjK6R8ABBh0zapXSNVkWaLy1FpnBqkjZFXtFJI2HVp9i8JL9av4nkulVFYxM2p1ryiIy9NRzFPSwxfqtVcSKXaquUVFNoVVKjyjYZWr+I5Nh9ZeawI2p1rtiXi7tUajsl56AAAAAAAAAAAAAAAAAAAAGOkeggePHABE5gZa8uzVDozwtXWtyNltUoi29RCVXjZBWn2Lwkv1q/jYtU5FOIqwbbq1IRZwunQ1XxJxbetYUbI6mU6xqHi6ZnVa/42h1qtiwZ7RlZAhs2qm0VGJbJqLOVkIAAAAAAAAAAAAAAAAAAAAPKIwBEEYcADACKjtm1GuiRwSUaro2TVn5kZT6IYNkVafYvCS/Wr+Nj9TSU7iqpturUtFmC6NDVlEllvq1dxsaqbjzzUXF3iztamonIwot9VHYyYn0tlUcnOQjFWznNpVAAAAAAAAAAAAAAAAAAAADiIgBHcRmADGiEAWYL4V1CJDW7E1mx2hr3jzTYpWn2Lwkv1q/jY/U0lO4qqbbqoPEHl5qwWKaFhS/8AWryPRLj1XmK8G0qsxKFRW4uGW0rUpHVNqtZeaqonUtRVRYhQ2u0AAAAAAAAAAAAAAAAAAAABFB0jFCGoAHUK7A5jaJWfFYYoqDYBWemuKLy1YM1qRcWpGNcEbC6zQgErTGxSvEKMRF5Ox2j2y29YgUqiLzLi4dTGCLShUbDqzkpJHil9aERlOIwszQuLUvAAAAAAAAAAAAAAAAAAAAAEdHgHnlf4AArydEEnFp6qVEfgGbl/KlUAAAAAAA8/Dx8Lq8Mt2GUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYWYeCvEdYAEJmLgAAFnS7NekAAAVA+d6nPdtnifz/VkDb5+OMz2Waa/TdwCAvJ9GEPL9K9n1TdgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADHSPQQnGNgAiwj4AAyMvfU7AAAAEQed6kv+i7dFflektV73aZV38mE6zDJm77IGGa3DUj57qr1fVN2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPNItBFsYCADBiJAATwXvrIQAAAARIalSaPm+n2O+x2MgbfPi3QxQT5XpcHGTX6budrnajfPdVer6pu4q0PVwHU4PE6vCzft9l1uErz4/X93LyyTu5JO3fZgPyfR5uTJu9lmn03cql4HV5B2+eOdPH7XZ5+928kUaDq2O9lsJL3fZAAAAAAAAAAAAAAAAAAAAA/JD5+TBoigAHlkCHEemXcLM0AAAAAP5xiZCa/m2n2Vey2MgbfPQf5PorafQNr5PX41r8Vrbe/Q9tUb57qrvfUN1r7+RaC8v1LdwJ5Po9/LYm8/1bjfR9vk3eyxRoOpWLw2tup9M3OSd3Jr0+QaC8H1DdV88h0JD3HYmr03c1s/FvO7JvtPooy0fWrx4/X3V+mbkAAAAAAAAAAAAAAAAAAAAARYeceCQbAA9AkmvSJmMjAAAAAB8P4qT+uogL5XpLVe92kgbfPrP+J+cux9N3P09bscvQy8qjfPdVbj6FtaOfLtLb76Jthlmwy6+/kWh2W/a/R/qhrM+Jeb2YfbPSfuqPfL9LY72WwiTz/VkPcdia/TdzXD8Z89se+zehj/UYKzeJ1t1vpm5wrWYMr7+Xx+vxyXu5AAAAAAAAAAAAAAAAAAABHpjpxkAx0QZiWCrPj9gAAAAAA0MGtY/qUIK+U6O1PvNpJG67FIfmGllPe9qwvsO/wDmMS1+Ko/z3U3n+p7vXR8c8/dL6VuJK3fZ4OEpH8x00t+g7VhPX9/r8FM/m+nn/wBb35R3vZoT8n0V8fq28q74XWyDt883+o7ut/4x53Y/9n9FH+owVj8PrLJe02Oc7TP6GblBPlejIW47GbbPMAAAAAAAAAAAAAAAAAABh5hYPPMWMjJgPaAAAAAAABU0xotPrsMW6Lrd7JZ09V3upjkA+S6HidXhMfpO34/W44v0cUyek7nDxkC+T6PNyTp6rvev2OdfvI9DzMHCcPUd3Ju7lgXynR+Exej7fs9jnBnluj6efnIW4zxL5/qyLuOx4/X4Ypr8Uyek7ng9XH6ufn+qxvpY5D2/Y5OQAAAAAAAAAAAAAAAAAAeIRsAZGZ2cwAAAAAAAAOudgAA4OM6/B38tAA6eOfqu1zo6/CcUd3JR1+E4o7uSgAAAAAAAAAAAAAAAAAAAAAAAAADEzzDID3wAAAAAAAACth5JZLDxjnS4Mi7nPO9pmxvp48R1+P3u1z9ns8vOwzD9dilHedjDtdi6WOex2OWRdzJ5HX4Yn0Mfvdrn73b59LFPA6nD1uxy6WLjmuzzRppev6WblluwyxVoetJu77Hl4OOJ9DHn+2zfJO5k5eZh49bhMo7uT9UAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0SEyXDq9LF7vZydvJcN1+HLu/m5KHW4TwOrjyLt5MV6WPMO/lAwzX4cv7+bkoYbr8OX9/N+6xbpYvf7WTy8HHuZL6Wblhuvw5lsM3Uxzxevw9/tc+KOzyvRx8e/l5fQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADEjJzo4ePfyXl5Xx8HDuc+X5TjjvZL5+Kejl5eTg4d3Jy4pOW3p8OPr5+f0/MeTg4ev2Of08vDx7uS8HGctvZ53x8HD2M/Pi4zpY56WbkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOsdA7HGd639VxSIV8jkt4eM7HO8HGclvHJyW/E/Mfu38SfaR+reHjOzzvX4z9H6t4eM5+V45PpzcqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPxJ+rfoB8Pp8PzJ+7R8PoAPh9APh9AB8PoPh9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPkn235ItA+gA+SfbQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/9oACAECAAEFAP8ABadc6518PdfRdc6//JQfoRwPBXT0Afog8Eh2D2B2j6Lr6IPRj4CDvh2h6UPQD6IPXAdg4HcHvB3R7gdwO+HeDB73X1eP6Ae4HdHuB3A74egDudPWA+gD0A9wO6PaPdD0I9geAx/SdO708Fdf0yrhJLEZVqup4Z/cpRw++jnckpeVYKtCTblJ6E21Rq75y8R7bDBN1U6j994ZjI0yT3Lf99A/Yu0AXRrzM7Vl2zIdWVQ++8Bj+ouTMxVoH7HJGRSYpISkrKC7ezEYETLJyKUx9lUPvsmZ9KOBA849KeekIxVs5I4TePEmiZJ9/IncFnGydcm1pHH79FkkjMScmZwacZlhbMm9MqYxSSFnkEBjrA6XQevZ5EIi2goKsvIuwcTUwxPCTJJJL1cP6i4vVDLwP2OWd8Zy8ZvGLZGWfs1mdSXFN9MfZVD75ZUEiMVSvZD91Z5bnTZdvSlxMjaX5nLuMYlZNzFAwV+KMwJaH5nLyOaFat8n2oM30W7F01vGVL7DH6ZUHuWNEqrClmH6v1p0zp+ht/30D9jj/wBjwKxHDn8XjsawLJqpMfZVD76YARZQDZFy8/i8dn8XjsYxbZlj03leAICHZI9SuwEBDLiIfW1kglj7xlS+wyX+/wAnvsaX94IgABKAcqKoKpvX6TQPAVtOUz6vKFOxy2RhkHEBZETpEOU4fEL5powAyqIgD45AOV22WiXcdPtXhQHrhVCny1xhm7iv2JFRIpwMBVkzGtkWZFeuyhHjZRQqZVyqTUggiVFO8CHWoj1Y5Lj/AOfk8P8A4FMMAPbGJwj2wkFIA6ZIJnfnh3gumvqvp+lko0j4n8LZ4jUmyJsVSIqV1TGygp0ggDHQbVgMhXEHyv8ADGeMmgNUnseg9ItSUhFCkolFlHoMiLIkWI6pjc4pUhMBYRTZiCqRFSr1BHzjVTq4yj0GRFU/iENTmhha1Zu2UkGBXqf8LZ5GRCcfkjXkX6gUxmGNWhUEUYoEMUZeYzFkDRJCFKiUpfKHgQxykwq6Zu8dYhMIqQ/adQpMKsmbtOoUmFWIbweu3IsC7QEzN49MS46XEmJsjLYEWniLb4QumZDg3aFUOkkVMrpcxhSjfNgRiWIpCmDtcS4kxMtgRaWIoinjpcSAgxBTDxyQg3WOkYxQMDpkRMWbMggsiVUqjYCmQakRx20IcGzQqhjACCRGxAAyJDCkAIg3bE8gB08Ark6mSDoXFCeYwB0DsUDqVAnQxx6AkkHm7VCeYxQ6B2KF8xgDoGLk6mTHqVyXriAdC4oTqbFQ6lbk6GMUDAAmAA9ypBNgB08BHDqJfdhi+3yDgkHC9epvcQOgiHUCl9vkHBKIYTrhi+3sAeuGL7ew4dRIHQFA64QOgYYvtw3uTDoPgY2B2CHXAHBHADpg4AdghnXB9uAHTBDrgezOuFwQ64A9M6507B9uB7M650zrgj1wA8L9P8JD/9oACAEDAAEFAP8AKNGOBcKuQw+GfjLHV+G6xZddIyYOTlU+pIVkodQva7bEMDD5vhlFESqY/wDmtflKF8xWiYkT7XHy2HzfDcgmIGa/KxVYqRSrLrYoo4RxBcFiuPlsPm44dFRwouVAF0qiYhwOCihUwB0qqJwckBo5MriqpUylcLLCcXKYN3gKCYRAFXqpcRdHMVRR0XG7/rhl1VMM5cJi2cAsHgaQUHzNflY9UE6iaiRCrqpmTYG6KuPlsPmmN5QTMCivx08fnIYkcbqV6qJ1EUgTIIdcaICkD1UTqJEAhMdE+Gqgp5ySWMPlYqAFUx2UDJRw/wDZ4Gf/ADWvysV+Z9Ejn0SOEapkFx8th81x8tqQp1Pokc+iRxJEieKexTtV9inZIfMZh0SksYfKxx83HXyo75mfH6gU3mBRUqfgN+ICq0EBSx8iJTtXhRKAgOdQ6uB6JsPmiHUFCGQURdEUDAEBx8iJTtXZRKA9cAwCL5ASmaLAoQRAAMAuVSlAoSWMB/6scfNx18qOH/sd9fhE6eXFQFUW6nnJ4AWRBUP25PCsCFHDFAwHjiDgRoYi2IlirQqg/tyeJk8hVEiqAaNLhY4oYmkVMDFAwHjiDhY0MSQIlhigYDMC9foRNiaRUwMHUBj0xwjIhBVSBQP25PEW4JYs0KqP7cnhEwKUqHlwU+opp/DKVuBQD2eBREAzzB3hMAYAgPaIgGAYB7REAwDAPg8xQNhidBKmHYc3TAIJs+EGFL0w5AHCk6iAdMOYRwEuufCDCh0w5umAmJs+EGFL0w5umFT64KQYUwhg+3DkAMIQMMUBwS9BKQC4cgDhCdRH/iAEDPKA4H/HClDp4BOHtL7sH39o+4ge0fcUPb2j7w7R9/YcPaX3HwvuwQ9uG9xPeIdc9vYYOvgMQwOwQzpnTAwcAMHADOmCGBgh3BDtHAw2B2CHYOFDwOPaPaHow9IH+F4//9oACAEBAAEFAP8ABZzk9D1qNsnKduks05T3Ii8Typra4RO89XzBo2YiJlHwyYxSFlNiV6POXa7Tzs9j1lyCM9COEtrbIf7DsPcTVURUitr7HhTRHJy/MQiuVcCqWJ3vq6WPGTsJNpeFLvcFpZz23l4ZlV/REOdM8Xf9rV1HT+yP9jVv00lKxcM1j5ONlm3gG5SJoyudzYSPxar3qppHYNuY3XVdzoSfZxzqMdZbksgg4R13ENafvYR6BbLdYLbN8crPN2Olej5LzLx7f+Lku7QuPgHZ0kzCvhItRwjhBTtnmwvITNZ63k9kzcrxYroxchHvIp/muoJCy3khCJkm4dhYIm0117U7DnFFh5GGUuSCV5LZZOPmvrLLV2uQ1UifR8iPypxl/I/gCcm1F1LK3+pguwiqieEkHRcLKm6PUAavOLVhaMpzOTlKBhLZx0Y/V7R7OUFL+IjnGZh9JrlZVNBLj/KqPtvGMUhbbcJq3z/He3S1opd8m3FcphLDOpzFu5GqsatNWexWNWGslgrq2ktyK3wuW22wtJhLbyJvk67S2TsJFWg8krDGO97SLGX2Lxl/I+bM2hC62jLVuTYFsWVVVXUgNh3asLal3uzuy+blsM7NbA443R3ZKpnJa/ykSapW+cpcxFSTaZizGKUuxLrJXS26An5uw683FuRDXiU/f7naFU1FEVK1tvYNVV1XtSN2VGeqplyZpHYskRdE5DJn7lrQBCfg5l/XpirWJjbK/eKs2udVesnUc84rMfiWrNX39K7t7HBM7NBTcQ9gJfSjD9u1ds2T/Z9fcc1CE2i5+3zir/WNv/jLNJakS2E8T1brlJnuzX7LX9t1vKrQt9zkPcV7DeavWpS3Ttf4368jGWz+ObBjF5xl/I7t0gxa3i2PrtZ9LamDYr9rq3XLNrunRUVFRKKyzZbVtw/nFJ5NVr9runHGw/s+xM27YP5JsUxDkHjrYAmdc7dsH8a10UpjG15WwqVK2w+dSGyeM8HT5aVdsGMg23PpB1XXnG+p2htdPVVnARjeywNxbTXcv6Akkc4y3r6KSzkrSghrLxSY+SLfOismWmrwenXzOT1L+lkamwCLq3JOT+h1poH8tuft84q/1jb/AOMs46tiIatzlimUFK0IlseWN0Z9YeKkQirJdmy4lvBX7jL+R9xPFGOsc0DHIsNWY8aIP2jpAzV1xTeHPBchqz+/67g5VeCmbTaW0PRkk13bjf1FRqJ+Llg+js3KmweRppis/wAp2Jm+tOSrqUSVcM14HfGzYHK1yoQUPWrVX7fHeqptIVorsvCAJTPc2AgBmOR793Fv6PbGl2q+yKgneadxsjFI3Xuynv7fr7NHXX+ZUW21lhca9nK2UEE9Bj0205+3zir/AFjb/wCMs4+fijOWWVv+xZbGJ4u08U5ZJN/2bPk0JjYXGX8j7aj1ZTW2cepdCT1hkrJN4eLXWO4W4rRyqNaeNEH7OxwriuT9j2B9foHSVf8A5DsrkNXv3zW+u7B/F7vvCw/yLZXFms/TxeTu29d1uVsGu6BekZ7ixBuMvGvbLr1/rS5yFItvqpdMFkRDp2bAbiKXctyArwHZxsvf7JYcZsWkelyAe/R6rzQ11Go3ns5KSoSGyOPEes92m5+3zir/AFjb/wCMs4+fijOWWVv+xZySpa8NbKtZpWnzte5I69k2WyeSEYtGCUxc4y/kdVJNZPZ1Fd0C16r2hI61l2vIfVbhruDewXNlGxr6Yf0GpoUipZybrX7XchOcScVa/wBCykc3l4yUj14mSEVnK1BrhalTc2JFv4e86U3ixrMenszXajfkDs+u3QaLX3Not3quSSFGQy5oAtBdx+h9Ux7Gzhdm41ndUL5UM5SyxG1RwB6ZqbeEBYIaz7coNXYTkrKXKy6E1e9o8WIAIW/TF5r8/o2hyNEp9rgy2atL6g2ShL67q6lMpecgNeS94gNY6gucrbcsVdiLVEXLjldINyjrTYa62veNcs7c761JOLS/HTWljr8pl0o9fvkRbOOF5hFldb7CRUgdDbMnVdYabgtdE7NvUE2wqglqjZC0hrinp0Wn5vXT9iVs2m9NWZ7aezZ+oYPZCE9oTZcIt/rvYGQeg9mzK2rtQwut0PVdkS+HKZLIC6jO7KIA1kuzWGzpXWssryioZWmx9hymx53tpGvLPf3+udRVjXaHp30vFRZY291CYlPAFsS6H7HqANXvcuSAoz/eABEdY8d5OeGIh4uBj++F027O7E/jvInLjsDcdImYBDf1jhrInv8ArEJpCzWm2wXbtzV9Zkozj4HXYfgCzpCeO7LagKE93NgoAV33avUp+5SmsdFwFGD0NJprmLvuchPyFqv8dz0WSbhNQ115WaJ27GKB6Fx7/IXgCYSBaM7L838r3uX1AVIruay0TP3gKzVYCnxnot1by1lx6pF3/wDc5U225LByK1fvq/6r/HeW+3w1Kh4u77h2SpP2XeWuCUC/RV/iNh/0Pj3+Qs2PtaIoCca55BW9q42nsvXMxDTEfPxdiscPVYpvtbZF/fyyPIOuRuntmT1/NabXC06Jjth7X2Q4mFeQtTba23XHXJw+VcoMrbuzZcGrT9tXGbrllsnIqJT19v8AI+Wf3/Z1pJK7K3fTHus9jM9hRXqs5QOU5DJny+IeeM7kzHhKRq6CzZbIeFlrBIaw48xdeH0n/un3ItO7F48/+nisl11N8cKTpLYmq/x3m7rMvYr1XrHryuwl/tdJlqToCVWY7C2H/Q+Pf5CkXqMZH1l81uGzP55Rs5BTlXnKzxqlVnEJvO2OLDc6VWGlQrSySa6WpKK8ozDeFpcWC71CBQrNZzbEIWp7Do08az1Hk6AddAfjoQAQtLNvC38AAA3HHNZHXXG1VQLn6sl0vgyeWduLmC7kbFPZZdtpmAsSDTjJrpBWuVGtVFr6QRAocwtq/wC3uUnG/bbfe2iuQn5C1X+O8tQFSvBdI6tMH+kNX5B6sodblNh/0Pj3+QtiFUPQ9UQ0HYbx/pDV+f6Q1flYo9XpuWVQW16IcihOy3AdG6JnIqTORZiGvulW6rbWfJ3NAfjrNhfkbNqfjvjd/eVFCJELeUXTWNfoykdZLXD1RP1RZ0gJJYskRdKSj14t52QVQdyWQFPRaoJpppE9Nyy5c7q5O7e13qyxbnuPGTQkPxo0vv1y3c7C1G7buteZvukuoay6p3JBPIZBy3dJ/VtfqNkKkRoPH5QhNhuW6LtvPQ03q660/a9QtzQpgMCDtq6zfFKdQdn1NuGEfQyK6DlJKSjlnW/KO6iLDp+7srZVXjxpHtZRKS3FsyMjm0RG8nTkE/H1QD68zYJy/wCxQEBDapgLrvjiqRO97hM9LraGMzNDkIUhbc0eXd5ruwns9P8AU9sSESdkhFMJRI1CixNB0mPKvGQjaPD9BrHhdpHT90438HaFxYvFypjK7MP/AM3UbI7QFUiXePmDKTaTnHGrvlWnGRmRWn6wqFJUtunoC5yocb6OA1yBTrUTZqnAW9hI8Z4lVWM40wiB6zU4CoMZCPYyrOb431p6sw4zRqatUodXpaT1izkmknx6gxem0S+lDVmpwFQYPmoPmS3HSmOVYLRdZrklbqo1uEZ/+bqNlK19HUULhqOCu0mTjhSSGhIFvCwcdRUIUryti5cVmtpVeJjdbt4psin8FH1NYGxnMb2xdfXeY3boNUv0QO2pnHdXdNWpUpWLXN3V5GPamQfMnXau7aNQQko5ybsXdtWoISUc6N62f1giyhKtICMfXmjM36Nu2f0W70T4NDsr6Pjp5rK19Fi7iKlGnQyelVmpWVYcyxy0aKAI2FLFqT1cYPCREA3fPGLFtHNp6VdOVGNKFchaREFGPZHYpT0qu2BjV3EqYtGiQLGxikcM9KKtCRVWTf46psMqnEyL2NcKpJrpT1aZMD12tsDpyUY0lUHcKkg8ioNhDhYYBg7Thq82fu1yJwsO1hGJE1Y1iudiVKISh4NiZiUpSF9eyMazlWriIUaErLAY2El24KO2BfIzx2gK7tJMqSfY8L5msQ3BN24MJUGDIpnfa7QFZ0kmVFPseIis6TICSeSzUpnjIwmaTaPxciSfDZ47beZ5j8vnZwyHwnThEjhEhnCaZPP5HzQ7gClApfX8uxAXqKxFknafmVQDyo4qh0V+mUwzdUpW/wAUVVg6pNE/KsoXzppIj8T6ZXFUlUytPPiqPlVAeoYU4HxVDoqA9Qx2QDrNyeRF6Tz40L5UcVSAVsXDqizT8ivgRyh8coszFMVuKZiB0LiifnwhugHN1Kkn5cN7SpF6Gw6fQwHDFP8AnhCeQqiYHwgiQBOHRIOmKJgfCG8oCcMKkJh9wKf88J1KUVMBMTD5xDDmEwJE8vgcwdRD3dnQM6B2D7ih0Hs6BnTudA7nQO70Dt6B4G/++vcDuh/gxf/aAAgBAgIGPwD+KNPOQjmQO1fpU6glK2627bd15cmp/TUagDSkziLARJ/4kr9+n0D/ANa/SqVQSwNkYtbnEKNWNeDSDhwH/sUqsq0CI3sA/XAKdSvLi8zCwC4W3Aa/gqfU2iYi9hsLDEHuZD2nk19RXkG4i0cjaetujR+Ud6pe1Tpn70SOkKMJhpOSRv8ABvgreyXYvynu5ORr/dIEciLnztbJUvboNSochiTqCJ+mjGnDWbesgvuihUrGNSGwBh0CJD67n6+OFhF41fZqKreyXYV+U92jhbimbhq2nnahUjKFOJuBF43iZ6WQp/WREgcRY+0EMLNRAwuvUalMvGQcI1KpaI69g2ox+jpgRGJtbM+kZMSjVlVhIRDkAC7+SPapxqRHlAtG3Zbq+xGpVLDrJ1BH/wCWEYQH3jb1mzcIlGpKUagF4AHyxPQhSqDhqYapZajs60TEOQCwdnOAfB9a4ZURTe5wT0GwHbemhTNWq5ctwwjqBNg+y8o1JDhj/wARGQH9x6VwfVMNUhdkR2Nkyf6Kj5MJSYPtAJAbpQ/X64xY74gdRRLNON47xsPIcfTv5ABJttod1S9uiUH8sPKM/vHp7FGlGtTaIb1R344m1VYCrAkxLDiFpAcY60IC6YI6BxdyreyXYV+U9ylOV0QSd1qjU+pkBEycuWFloFuFwX71P+aPioGnUjKQlgQSxBe47AqlM3RII/M/yo0x6YWAbcT02blGlHAW7ZYnngiDcVUjLGZbbEek9qlB/LDyjP7x6exQpAXAPnienRIQsDiQ2Pb1F2VOqbyLcxYetUfz/wCKHuOicYiyMyw2PdoqcWAcZjmymMOA/wB0fHkP+Ud6pe3RU4/xyf8AmLr9v+qXzL9r+qXzIVaUGkLi8jeGxJFxVb2S7CvynuVZvwS7FGlWDxL4kWsTg2pftf1S+Zftf1S+ZS/Rjw8TPaTc7Xk6yqhlhUL/AMxTjTV4vxy7SnGgewdpVJ9p6ZFUPz/4oe46KvvPboq+1T/8Z/uinNyM6dOc4D7wAAOXFKJO4HYozF0gDbtDqJqH1SERvxyGPIMsXaIVJi7DQa8R5J9Usem/pUaVeQjOIZzcQLrcDrdPEgjYuFw+rFVn/AexB/wlGJuIZbYl4nWMPt3hDzCMsYksd2vdo8pBZGsB5J25SxG+9Ro15CM4hnNgkBdbrzvTxLhcIkDLU9vQj9REeSd+yX235uoxfzwDEY2WA7+1GUyABeSpfpCwm/VEWOe3Mso043RAA3KiPd/ihskdFX3nt0VfapbYHtiqvBew6HD9TqHB6WDZNYmCrRFOUoiPBEgxYTslI+aUTeIiwYFQmfUzS9wsPjyBEJylED8JZ87C69dTpj8qEoVKgI1SA/x0GEwDE3gomlMw2eodx615qxI2RbvK4qcXl+I2nwG4I1Kk524AjhFjWAgsvXU6Y/KhTEpSAxkXPTYuCtFxhrGRX+uqQNoEuwxX+ypKWQEfmXBRiwx1nMowmAYm8FE0pmGz1Adh6156pI2AR7TLsTUosTebyd/MIwmAQbwVx0KkqZ6WytB6031H1M5jV/3GXYuCjFhjrOZRi5DghxYQ+IOvUnM6hOY+VCpTqVAQQbxa2BaN2tfpylKId/KWfYbDYvXU6Y/KiITmQcJEEDIABcdSc8gRwhtQIKcTqdMflQouZAOPNaSDr7Mlw0qk4x/CCCBlxRkRuIQIqTiwIsNluJ4gXkMCV+nGUpByXLPbabgMbbXVSMatT/YXNsQ0iX4otEMcLLGwuQHIXzEBMJA7x8XmkBmV5SDkdPmIGaYSB36fMQM00ZA7+R7STBCUtHDG9cRO9Wk9XgrJFtSM8UxuXDG5cMSw7U8iyvPV4JnJzXDG9cRO9Xnq8F6iRtXDG9cdS11YGK4J2jsRBuKHDihM3umkiBrXlRnimlcmhgvMHOs2pyHsZGIjYLcLunciSPV2auQY0EphpOgofASm0kptDoIaToK3JirlarOQ96v+K9X/AMHt/9oACAEDAgY/AP4o1aWTAueTRhE4nV4L1DnuXCZdnghISFvPUjIyFnPUiZF7fgM8Vu5NTkcbtG5RyRGtAG/4JZFbuTglgo5aHK8gAHPncnkxHPJOFLIrdoa8pwQBzzTVA6BFyeSamLFxGQLc9SLi5PJeQADWnJB55BcJsKsTGLKwPLqTmwbG+1NPpX+uNmsrzdg7ltHIfhwvUctBGAsQiJCzaFIcQu1ptalkVuRJTzNjr1DpCDEEuiNSbAIRGgg6+pEYBCOgtmhJR39y36CBgdBdHLw5D7lHLQX1ntV3WfFenrPinAt3qWRW5SyKAlcvT1nxXp6z4o8IZ0X19/wSzOnchzxUd/ct+iWeiWSOXeNDgEjnrIQOtB8S3IPco6OIXHtQjIsQrEylktyZZXK9jq0WLiwKEZFiNDPauMXHtQGITlHh5hADBR39y36JZ6JZI5eCkyDXaJBiQzC6/G85IHHkCxJGSvPV4JwTz3aGNy8pZWy6k4Fqckq89XgmcnNNIKyStLpohMbl5S3WrZLyhMU8SQvPMnnvTRCZXnnuTgnnuTEkZK89XgrCd6ckq89XguG/NNEkDV/1CvITAlECRty8OQ9/J63Q+iz4H02K3Sw+CxOdDHRYnVul9Fmlv4VB/9oACAEBAQY/AP8AgLOfL53IQ43H2/8AhLiY0BJ5KoFSzGnBQCT3akg6U6bN3EhomRyUhjDU7xBHU0PdVwfRrdfdP4a4tu+GBbiGT+O00o/udUzfTGRxrk0Bs5IrtaeJL+7kfEDqOKPqiKxnddxiv4pbUL6DLIgir/D17ziMpZ5W3PDz7OeOdP40bMP3NMzMFVQSzE0AA5knTxQySZKZeB92AMYP84xAP8GugGw0wjrxYSqTT1bR8+vy009g1aATxE1+OLePu6lmgy1pLHDGZZisqVRFFSzCtQAB36nnEzx9P2Ejx4HH8Qqxg0851+/kpU15fR7vgpLDI0UsZDRyISrKRyII4jW6x6yybCgAjupfe0AHglyJVHxDUEeTs8Xm4o+E8skLwTyCn30LiNTX/k/i03250pf2DA+wbGaK7DCnM+b7tTj3cdJEvUq4+dxXyr6Ga3A9crJ5Q/j687DZiyy0PLzbO4jnXhz4xs37lZcZYTFMVbsUdkP+kMp4sSOag8h8fhTtybRttknVbdT6JWCsP4tf2NZI2KSIQyOpoQRxBBHIjUeQtc/nI7Ci+XJeGW4taV9kKLgPGK+jT3d5HFBncXKLfMW8QIQlgTHKgJJCuAeFeYbu/Z2vsvkrXFWSsEa7vJkgiDNwUF5Cq1Pdx0t7ishbZOzckJd2kqTREjmA8ZIP3f3BZK4jbbNIgghI4EGUhCQfEAk/Bv2AJMDwyAD+cVT8jfDiyljjIrDHXKh7W7yEnkCVTxDIgDOVPcdtD3HUdznccrY6ZgiZS0fzrfeeSM1AyE924CvdXtu7/K2qXlp07aC5ht5F3Rm5kcLEXB4EKAzAHvAPdqS2uIUnt5lKSwSKGRlIoVZTUEEdx1150xiF93wt3h0v4bMHhGxe3dVHoQzOF8BokAsQOAHM/d1c5jOX08l0Zna3t2ZglqK8I4U4BAtAOAqaVPHjq8jzVzLfNhb9rOyvpiWdofKSQRs54sULcyeRA7v2RMRJOTY4WxhFtbD6KyXA8yR6ffMCor4AazGFEze4ZDFvcPb1O3z4JYgj05V2uw/cEYluA8kd1E0qJ7VBRhxpw5ka4uV9an97Q2SqSeQrx+525a2VQzzWkyxqfv8AYdvy07JMbaTrYWFjGJstk2UuIkY0VVWo3O5BoKjkT3anGF6gySZpYybd7wwvbO4HBWSOJHUHlXcac6Hlq8xmQt2tb6wmeC7t3+kkkZKsD8Y7Ol8JdR+baXt/F77CSRvgjPmSrUeKKRpI40EccYCoiigUDgAAOQGsjhMnCJ7DJwPBcxnntYcwe4qeIPceOst07kB/ScVcNCXpQSJzjkA8HQhh6D2dZ5Mr/pFxZ2qN4eSsrsB6/MFezre5BqsNpc2Y8B7n7tbkfdjPZNmJI7/E3F1I017DjpkjhmkYgszJJHJtqeezbzOrXCYGyWxx1qDsiBLMzMas7salmY8yfm/ZM1/VrL/V01N+h7r85D+4F7S0cpboSskinjIe/j4fPrJR1psi82v80RJ/J7fYkZPUSNcXDgdzAfvUOqSQhvEqafIa6u7UEkW00kQJ5+wxXj9zXUPTdwVjuc3BDc2DmgLtZ+ZvjrzJ2SFgPBW7Mf1tZQ7bfM0s8uVHBbqJfyTn0yRqR/A9PZjJ6V+zLO8ufVWIwf8AW9uL67s4/ag243NBR9RiWt5TTwYlCT4qO7sluitDlMtczhu8qiRwgVoOAMZ1LPM4jihRnlc8lVRUk+oau76RQZM1bZGWX8EyuJz8oppnY0VQSx9A1d57JXs0kss7SWMRc7baOvsRxAGihQBy5niePHVzDmrl767wV6bSG9lJaR4DGrxh2PFipJFT3U11NnLMgXmOx88tmzCoWbaRGxHeAxBpr/5AuYuxm/N845XznM5etalyan49dP2/T4guOrsnjbe4zN6QHgspXQblVOTOTUgHgopWvLTTZ7N3uWdmD7bmZ3RSKgbUJ2rSppQDnpZ8Fmr3EyK28+6zPGrHh9JQdrVpxBGpun+oRHH1NZRGaK6jUJHeQqQGbYOCutRUDgRxAFCBq5z2duDDaQEJHEgDSzSt9GKJSRuY0+IVJoATqQYS5XpfFq35C2tVV52UHgZZ5FJJ/ECj0HnqOZOuc8zxsGUSZC4kWo8UdypHoI1b2PW9M5iHKxvk441S7gHIOQgVZQO8Ebu/cTwN/k8ZdR3thfWVhNaXURqro1slCP3x3am/Q91+ch7I57xTf5i9DfZeGjYK0m3m8jUOxAeBNDXkAeNJTdZ6fGWLn2MXjWa2hVe5SUO9x+Ox1JNPI000rF5ZXJZmY8SSTxJOo5cN1Lf2yxhQLV5WltyFoAGhk3RmgFBw4d2oun+o4ocT1I4pZyxki3vCBxCBiSkn4JJB7j3dnUttl7mVrfEZCezxdizHyooInKxlE5AuoDE8zXV7h8pdveZHpu4VEmmcvI1rOC0W4txO1ldePdQdmJ6Pwt/LYNewG+zM1u5SRoi5SGLetCASjFgDx4d3O2zGDvJLeSGRGubUMRDcIp4xzIDRlIJHHlzFDrHZazbfaZO2iurZvFJkDr8h0WYhVUVZjwAA5knWTzM97LJaR3Mi4OHe2y3tkakQjHAKSFDMQBVuOre4zlxJeT2V7PZ2l7Md0ksEaoVLsSSxUsVqePDUWJxMMV/1RfReakclTFaxGoWWUAgsWIO1ajxPCm6WXN9SX14soZWtRKY7cK/0lWCPbGARwNF46SWJ2iliYPHIhKsrKaggjiCDqNsf1HdXVsh442/drq3YVJI2SElak1JQqfTqZlgGOzuNCjK4vduWjcBLExoSjEcjxU8D3E/tVcyoaSMAiHwLGlfiHZLDIKpMjI48QwodMjja6Eqy+BHA/ByCqu1ZGWVfTvUMT90nWNzmMl8m/wAXcJcWz925DXaw71YcCO8cNYnqHHNW2ylusoStTG/KSNqd6MCp9I1menLjapyFuRaTMKiK4T24ZOHH2XAJpzFRq7x97C1veWMz293A30kkjYq6n1EU11JkqcLTFLb18DcTo/8A1PZ1HA7r9oYDMXdvKg+tayTyNauOJ4bBs581OstgMgK2mWtnt5WAqULD2XWvejUYekayWEyEfl3uLuJLa4XjTdGxFRXmDzB7xrpCClDNavdMe8+8zSTD5HGusL8MVkjxVxFC45iSdDDGfiZxrGK7qrS2d4sSkgFmERag8TQE/Fq4/m3+Y9nU/wClI/zK66z/AEc/zr2XeVzbyRdM4mQRSxxHa91cEBvJD/VVVILkceIA51AsV6IwxhVdgd7SJ5qE14zsDIT6d1dLa4hXTCZa2W7xsTsXMPtFJIt7cW2sKgmpoRUk8ddI5CFyhjyltHMVNCYppBFKvxo5HZc4WKYnFdLf0SCEH2WuSAbiQjxDex/B9Osf0/h4hLfZCTarNUJGg4vI5ANFRQSf7ekizdtcdSX5UefdzXE1um7v8uO3eOg/GLH06vM/0I86vYo0910/O5lDxKCWNvI3t7lHHaxO7uNeB1N+h7r85Dq5vbqQRW1nE89xKeSxxqWZj6gNZTqG9Zv6ZKRZ27Goht1NIogKkDavOnM1Pfq6yGWkkt+msQ6pdeUdslzMRuEKtx2gChc86EAcTULZw9E4Z4VXaHntI55aUpxmlDyE+ktXV11d0VbNZx2AMuZwgYvEIebTw7iWXZzZa028RSlDFcW8rQzwOskEyEqyOpqrKRxBBFQdYfOSke/7Da5ZRwpcwey5p3B+DgeDas+oIY9tt1LaAysBw95taRv/ANGYz93UOOlk223UdpLZsDSnmoPOiJ9PsFR+N2dUZBHEltDdmysyDVfKtAIQV9DFC3x6AdShIDAMKVBFQfURq0spJA9z09cy2Ei/WEZPmxE+ja+0erXVGQR9lzNaGysyPpebdkQgr6VDlvi0FUFmY0VRxJJ5ADXTuBKBJ7O0Rr4f/cy1ln/u2IHo11pNdkmSLK3FtHU1pFbN5MVPRsQazk+bhtb/AD1ksLYawuwrqIju82aON6hmUhRWns/Hp7K/soL2zkG2S0uI1kiYUpQowIIp6NN1D0bjprvp+8b+l423VpZLKUn6qirGJu4/VPA8Kanzk+Mu8diLSxmt7u5uI3hWV5dhSJQwG4ggMe4UFeY/asU5CZC3qoe3JxHvnaQU8JPbA+43wbO5+rNb7PjjYk/Iw7LzoS/lpbZQteYVmP0blF/KxCv36LuHpU97dlr1ZZQlLDqUbb7aPZS9iABPo8xKN6SGOusckV/0m6tLZW/mEkcj/pRq8vX+haQSTNXwjUsfm1Y3l5cbMXmm9xzbOfZCTMNsrdw8uSjE/e7vHsxvXFnF+RyYFjmSo4CeNawyH8dAV/gjx103jQu37PxdnbkemKFFPj4amtN1Dmsja2m3vIQtcn5YRrpP/wDP/wBQuNXH82/zHs6n/Skf5lddZ/o5/nXsxEqgA3l1ezSekidovmQdnQcoHtuuTVj6FNqR/fHXT5HAjJWhB/55ezPXrsWe8yN1OzHvMkrMT8uurc5JGDNY29rZ2shHIXDSPJQ/80vb1Zi7RQlrb5KZraMCgSOU+YqD0KGoNTfoe6/OQ66zmjO1nx5tyfwbh1hYfGHPZ088agS5Frq7unH1nad0BPqRFHxdl1Y3KeZbXkLwXEf3ySKVYfGDq5tWNWtpXiY8qlGKnh8WurceWJS1v7e4VO4GeJkJ+PyRq8vYY99503MmRiI5mIVjnFfAI24/i6xOata+8Ym7hu4gDSrQuHofQaUOsv1bbSq0MOLa9x0h5O8sdbcfwmZR8eo4Ylae5uZAkaDizu5oB6SSddDTWiAQPho8XdSKOD3FgFDSMfF1kH3NZzpyWQrFmrNbm2Q8jPaNyHgTHIx/g+rXTHS0T8biWTJ3qD72MGGH7paT7mun7SSPzLPHy/aV+O7yrWjgH0NJtX4+y7656WtHyEd2ofO4uEFpkkRQpnjQcXVgBuAFQePEE0SWGSS1ubdqpKhKSIw7wRQgjUafb32zbR0/o2UjW53UK85fZmNQKfT7z38dRQdW9Nm3DUEuRxb71BoBX3eUggVqeEhNO4kcVynTuTiydoTtkMZIeN6V2SRsAyNTuYftXeKOaoH/AIhDH5B2rKBQXNujs3iykp8yj4Nhc09qGcxg+iRan+8HZZZOwmNve4+eO4tJ15pJEwZWHqI1ieo7QBPfoqXVuDXyZ0O2WM9/BgaeIoe/WY6fIUXc0fnYuVqexdQ+1EankGI2sfvSdXDTxNDPeZm7klRxRgYljgKmoHIxH46660ugdrLhryONvB5YmjU8jyLDssfeJC+WwAXHZPcas/lKPKlJPE70pU/fBtZLp3JD+jZGML5gFTHIjB43HEfRZQeYryr2dHYVH4M13e3CfiiOOI/K+ukiPG9H3bG4Grj+bf5j2dT/AKUj/MrrrP8ARz/OvZ05/OX3+uTdnQP/AKr/ANz1gP0ja/nl7OpMdIux7HKXcDL/ADczLw9HDhrq7Bu4E13Ba3tsneVgZ45PzqdvV+QtXElvLkpkhkHJliPlBh6DtqNTfoe6/OQ66xtIVLy/Z0k6ItST7uRNQAVqTs7MRbI4a4ws9zZXajubzWmTh+JKvZkctdsEtcZbS3VwxNPYhQu3H1DU1xJTzJ3aR6cqsan59dTZR0Kx3+RjgiYgjd7tFuJHiKy01d2F0gktr2GSC5jP1o5FKsPjB1mMDdA+dibuW2Zj9YRsQr+phQj166S6eE+6/lyD42+SvO3xlJUWnoEkH3NdOQum+2xkxyd2aVAW0HmJUeBk2L8er+6jTfc9PXEWRipz2KTFKK+ASQsfVrpnOM5jgs76NbxwaUt5vyU3/Ru2uoZUkElripFxdpSpAW1G2SlfGXeeGuoOrJ46SZGZcdYMeYig9uUj0M7KP4PY+EzPU0Nrk4iont0inmEZbksjwxuiHxDEEd+o77KYOzyDXcQkt8xbHypnSQBkcTwlS4oaipI+7qSXpvqS7xrklktb6NLmPiT7IdPKZQKihO48ONa6hseobaMLdqz2N/bv5lvOqEBtjEKaioqGAPEcKEaxeTtLho7OaeODMWtaJNbOwDhhyqoO5T3H9q5oW+jKjIfUwpqh4Ecx2Y26A9lHkic+lwGX+9Pwb7au5otkq+ja43H+LXtn6QyE5XG9SEPjtx9mO+QUAHh5qDb6wo7JIbK3S3jlnmuZEQUDS3EjSyufSzsSddRKDR717S2Q/jXMbN/cqey0trqbysP1Jtx+Q3H2VkY/0eU/iudtTyVmPa9krVXCY22tGWvDfJuuSfXSYD4tYWeJSY8Vb3l1cnwQ27wA/wAeVdXH82/zHs6n/Skf5lddZ/o5/nXs6c/nL7/XJuzoH/1X/uesB+kbX88vYvVdvCfsrqZVE0q8o7yJArqfDeqhx4nd4asOoMNKI72wfcFapSRGFHjkAIqrA0PycdRy5ye46avwo94tZYJrmPf3+XJbo5ZfSyqfRq8w3QS3Et3eK0MnUEyGFIo2qpaBGo5cjkWC7efE8huBG4VWvePHU36HuvzkOpIZkWWKVSksbCqsrChBB5gjV/iHif7Mmdp8HdtUrLauaqNx5sn0W9IryI1LMsLZDCZEKmWxe/aTt+jLETUB1qefAjge4hbibOXFjMVqbGeyuTKDSu0mKOSOvdwempOmul4J7LAysDkb6eiTXew1EYRSdsdQDxNW4VA4g2eLxts95f38qw2ltGKs7uaAf2z3aw/TkJWSSyh3X1wvKW5kO+Z+PGhYmle6g7LHqGGPbb9SWg85gKD3m1pG9Ty4xlPl0sZYmNSWVK8AWoCQPE0GuqOqZEPExYuzenCgpNOK/wCT1kcVdKGtsnbS2twpANUmQo3A+g6yGLuhS5xtzLazilPbhco3A+kaqd89xO/E8Wd3Y/GSSTrp3p/aFlx9mgvKU43ElZJzw8ZGbs6rscmHN2uTuJTK9ayJM5ljkqeYdGDfHqLpLrCSSPFW7E4fMKrSe7q5qYZVUFigJJUgGnKm2lPeV64wYj2ltrX0CyUH/Js4evDlSusVgum3OQtsPPJPc5faUjeRl2COEMAWA41alDw21HHXT+EtojI17exefwqFhRt8zmncqAn9rLyMilJnKgeBNR8h7JnIJNrJHKtPHdsPyMfg3lty94gkjB9LKR2wXdrK0FzayLNbzoaMkiEMrA+IIrrGZxWUX233fMQLQeXdxACTgOQbg6/gkdmBwwfbPlMn7wU++itYmDf3cqdlRwI5HVniuqcrBiOpLCNYZZ72RYorwKKCVJHIXeae0pNa8RUcp7ufqKyyVzGha3xePnjuJ5W+qoWMsFr4tQayGWlge5ymevGkS0gVnYtI1I4Y1ALHaKKo58NXuZz8Ag6gziogtKhmtbVDuCMRUbnb2mHdRRzrogioPMau8fj+m8hmcbJO/wBlZGxge4jeEt7BkaMN5bAEAh6ca8xx09vmUWHMZe6a9u7YMG8lSipHExFQSApJp3mndrO9PtL5H2vZTWqT0qEeRCEYjvAah02G/wDiGRmnEhjS8ihZrRqV9oXNBEFIFeLD7usB01NKs1xjYG97kQkqZppGmlCk0JUO5A9HZirvAW/vuW6fnldbAMFaWC4VRLsLEAsDGpA7xWnGgOGuMr0/f4PD4u7iu8hd5CCS1LLCwk8uNZQrMXI21A4cz2XeDzlot5j7xaSRngysPoujc1ZTxBGppem4x1RiC1YDEyR3cak0AkicqGIrSqE150XuSBOh86ruaBpLC4jT43dFUfGdQZLr5lxuOjIcYKCQPczU47ZZEJSNT+CxbmPZ56suoekcJJkMUbKCynxeOi3yWzW42R7IIxuKFKD2QaUNe7WT6s6ix02IWWyNjjbC6Qxzv5jpI8jRtRkAEYUbhxqeHDsfEZ+1MiKS9neR0We2kIpvicg0PiCCD3g6lkwKRdUY4EmN4GWG5Ve7fDIwqfxGbUkT9DZ4tGxVimOuXUkcODJGVI9INNRhsCcLbOFLXmTdYAoah4x+1LWh5bOHI8dG+Mv2x1HPHsmy0iBViVvpJbpx2g95J3H0Dh2z4y08tczYSreYaSQ7VMqAq0bN3CRCR4VoTy0MavRWWW4L7PNe3dLevj7wwEVPTvprEdPblkuoIzNk514h7mU75SD3gE7V9AHZd9W9L4mfMWGY2yZCzs0Ms8NyAFYiFQXZXpuqoPGtacK43O9TYW4w2Fwky3fk38TQy3E0RrEixOA20OAzEilBTv7Y7l5DiuobSPy7PMRruDICSIpkqN61JpxqO7vBdY8GM3bCuy8xsiyq1K/4tisoNB3pr/YXqH/2y7/zWlSTBjDW5ID3mRlSJV5f4tS8h4GvBPl1LcrN9rdQ3kYjvMs6BAicCYoEqdq1FSSat39wH7Vu3/Hxo/ybf5PZkLdQGeW3kVAfvtp2/L8K/twu1YbiREWlPZDGnydstzbxfaGIvwqZXEs2wOFPsyI1DtdamhpQg0PoE0WKzUt2RwszDAoDfhSecRT0gH1aGWv4lsrW2j8jF4yNi6wRVqasQNzMeLNQV4DkB8A2eAst0EJHvuUnqlrbg/fyUNT4KoLHnSgOlntY/tTPyJtus9cKPM4jisKVIiU+ANT9Zjw/sAvk8naY5FXez3U0cIC1puq5HD06TC4nP2uTyTrI6wWpaVdsVN58xAUpx4e1x7q/uBspgPpB0ZvVQj5z23dsDUW80kQP4jFf3vg3TEUW4SOVPVtCn5VPwwAKk8ABq3zXWyzYbDEh4cOPYvLkDiPMqPyKH0+2fBeDatsVhrCHG460Xbb2kChUWvEnhzJPEk8SeJ4/sGc6N6f6lhtja5C/jtmuLW18qKC2kfaXcW0j8gAOBNSK6/28wX+Rj/8A52jg8t1dbXF2II5/MtLS1ePbJWgrJaRmvDw1js5Y9cYeK0ycImgjnghWQKe5gtgwB4dxOshnr3rTFXVpjUElxDa28LSlSwUlQ9gi8K1NW5ay+W6lyRyOy+FrYkwwwhRHGrvTyY0rUuOdeXwOpOtD71a5y1s2upHilrFM8EYVfMjcNT2VA9kr4+Ooj97j7o/3o/f/AHAhx/iZVZvUQV+cjtvfZ2rNslT07kFT/GB+Djrn600Txn/m2BH9/wDCjxHT2Pkvrp6NKw4RQpWhklkPBFHiefIVPDVvlcr5ee6oUBvfHWtvavz/AKMjDmD/AIxhu8AlSP2L9YfVF7amFcndCHDyNT24ZKSzOO+hfaPiPY/6Otv5eukv6gnznWXw8lNmUs57Uk93moVB+ImusXj8lbNZ5KSS4uL62em5HeVgoNPwAvwOsQeQw943D8GJiPm0n6Ouf5H7gb1D3RF/jT2h83bYXX/HQtHT+bav8v4NvOq1NvcDc3grqwPy0+Db5bLtJgOmH2ul0y/0m7Q8f6OjclI/xjCnGoD8dR4jp3GxY6zQ7pAnGSVzzeWQ1Z2PiTy4DgAP2OX9Yf61+oh030wl7BjorlYJrqae7udxjhhgt0kkdiqMxoOCqzHgDrpjpz9W/REOe/U817aWvVfXWakuMfeyR3EirPcWVvtPlR2ytu/LKWkoRtjFGOXvP1aZafMYSzsoo8Tnbi2ks4MstrtW8mx0dyI5porWWeOKWTywokYLU8DrpL+oJ857JcxmZSIwfLtbWOhlnlIqEjBI495J4Ac9XM/RtlYdM4SKTy48ncqJKMCDtLypJvanPZFQd/Gmo8r1DdY3qbDtIiTTxQp5UZNQFYxRW0i7q8CQRUD1FshYobS8tWEeTxjsGeFyKgggDcrfVagrx7wddY/oa9/MtpP0dc/yOyO18n7Uztym+3xqMFEaGoEkzUO0E8gBU/LqLL2d7iukbK4HmWlvcQoGkjam1trw3UgHhu2158qat8X+sLH22Zs5xvS+gVInlQMavDJGEjJWtCrIDy5VqbLMYq4FzYZCIS28o50PNWHcymoI7jw1PmM3draWUHsgni8jkHbHGo4szU4AevlXVxZ/q76dgsrC3NJMldgSNGCDtMjuREpPMKFY+sV1d5266oxGVtcbC9xd2EMERcxopZzT3OGu0CvB9Za3y+NtYvsiKFmyNrvQO8pYKrRsX4kITUMOXLwlzGcufItkISGJBulmkPERxJUbmNPUOZIGrkdC4qywGHgfyjlbsCTYxI+lJIGVmA47UjNO+vDUmWucpjep7O2QvdW9rBE2xBxLlFgtpCABx2k8DX0iLC5i2TDZ6Qf0baxNvcsOJWMtxVvBSTXuJ5au57K09/vIYJHtLHzBF50qqSkfmNULuNBU8uektbvpC36Ya4BMEl5FNMz7SpJikLJG1AwDUB592lixvTl11f1U9zKLi5WJbbH2qM35JJJQEUkA8qg04ltS5S9szirBFZpUsLexu44lU1LNT3l1AB5seXx6fHdde72BEbyW+bhVljOwFiksY3cSAdpXmaCleOmm/Vx0W0eHP+j5vJ+XE9wvdJCk8kSbT3fS+LUK9TMUElRFDd2Vt7vKVPELLbIm6n4L8j6tTziAWOWxxRMnYhtyjeDtkjJ47GoefEEU9J/atkbkwIPqOmRxRkJVh4EcD2W1wFq0FwFLeCupr8oHwbuxrtaZPyTHudSGWvoqOOpIJ42imibbJG3Agjst8VhcfNk8jdMFhtYFLMePFj3Ko5liQAOJIGrbN9ZiLNZtRvgxQG+ztm7iwI/LOPT7I7gSA37L+rT9Q2Kmd7Ho3HN1N1FBGSVlyeVJgs43TveC2iZlIHK4PxdN9W/rd/WF1p0j+uK/jhysFv0jeWtinT7uqyQ27PNaTyyXMVfyro6KGqqfR8x7rIYzPdWde9XXmDgsL/r/AK5zU+bzM1o0pm93M0gjjSMOoO2ONeXHXSX9QT5z2X2PEv8A+v6fb7Ps4i1EEi089z3Al6gnwUaxeEsusMBHb423SFduQtgGYCrufynNmJY+k66qsI+q8LdTzYu5a1to763d5Jo4zJEqKJCSxdRQDv1a2CORBmrS4t54/qkxRm4UkeI8s0PpPjrrH9DXv5ltJ+jrn+Rq+yVyaW+Pt5bmc+CRIXbn6Bqyy3WF9bW9le3z3uTmvZVjtwkStIkJaQgbfZWMCvLhr/bPBf8AuNt/nNYZ8TnsZlshaZQL5FndQzyLDLDJvYrG7ELuRAT6tdSYeRy8WMu4LiBTx2i6VwwHorDWnifTq5xEUjHG9OMbO3gBO1rj/HyFfvt3sepdYvB2saq9tErX0o5y3LgGWQnvq3LwFB3algmQSQzI0csbcQysKEH1jXUdrfIFe8y0psZA6v5lnEoWBztJoWqxoeI79X9gJScb06xsbOAH2RItPPcj74vVfUo1hcJbxiMWNrGs9BQtMw3SufSzkk9mVjxgNnBJJFkcd5Z2mIygOdlPo7ZA22nIAawGcloZ7+0U3ZXgPPjJjloO4b1PDXRBpxP2kCfV7rq0/rt1/fjRBFQeBB1m7S0iUWmPzUot4No2rGs5KptPAgDhoACgHAAa6jFzGHayhW7tXpxSWJwQR4VBKn0E6zEAYiKTCyu6dxZLm3Cn4gx/a29TxlLj+H7X7/ZkUHNIxKD/ADbBz8g+D5FnCXIp5kp4IgPezf8A0dCLIWRurgU83LhmhKU+qpU8R6DXQknuMxfDgWgluY1j4cwPLhR6H8bTWfTeGtsTDJTzjEpMklOXmSsWd6d24n9lLMQqqKsx4AAa/XL+tLBXb3eHm6nNt03mISWjayxSpYY+ZG4gCWK0WRfXr9V/62YVSObrPBQXOWgi/wAHFkYS1tkIk5+zHdRSIPQNP+jrb+XrpL+oJ857OoxfoXRM5d++JUgsBcvvFRx4iugy9MhlYVVhe3pBB7x+X1/sx/229/z+rXNYXBe5ZOy3+7XPvV1Jt8xGjb2ZJmU1ViOI11j+hr38y2k/R1z/ACNdYrFXf9j3hNPvRCxb5K6xWF6gtPfcffx3C+R5kkVZEheRDuiZG+r46/2Y/wC23v8An9f7Mf8Abb3/AD+r7/43i/s37S8r338vPNv8nfs/w0j0pvblTnrPzXIJaDPXT3AbiardMWr9zSSRsHRwGRxxBB4gjt6m94B8yPNXhmB5ki4cn7ukkjYPHIoZHHIgioI7LUKQWTEW6yAdx82Y8fiI10yk1Q0i3Mqqe5ZLqV1p6wQddEf+pf8AddWn9duv78dnVP6Zn/O9nVv9Qf5xrK/oKf8A1m108srrHHGpaSRiAqqBUkk8AANTZHDdO5nPYqBXf7UtI7eKGRUB3GEXdxbvKOBoUUg91eGrDJ26ulvkbaK6gSUbXCTIHUMKmhAPEV1i5MvK8a5a+isLbYASHlNN7VIoi82Pd4ftSHA/w0SsT4kEr8wHZLBKu6OZGSRfFWFCPuams7hSGjPsPSgde5h6D2pcXoe0s2oUWn5WSvLaDyHpPxajWWAWlqnFLReDN6XPP9/SxxIscaCioooB8X7P1B/uZ/7o1sbTEW8l7hv1m9fhxGLiK2ZrfJFr0b1tMbDUpJKPykx9hODBJZf90P8A3aMgOp+k8tl7fL/rI/Wtd2Pu0OQfFI0Qv5WAkltsZZmWT3WIt5k0km9/bkihh6R/U9hc3c9SQdNi5mvM7dxrC91d3txJdXEiwoWEab5CETcxCgAsxqTObeeOcQ2NvFKY2DbXG4lTStCKjhrpdYJ45Wt7MRTojhijK7KQwB4HhyPZL1PawM+Hz5DzSqCRDdgAOjeG+m8V5ncO7VhgOqMhHisvjYlt4b65YJBcRRjahMp9lXCgA7iK8weNAJrWeO5iJIEsTB1qOYqpI17p7zF70V3C23r5m3x2VrTXWDyMFU4m6QEkD2njKKOPiSBqBXcKZbC6SME03NRWoPTQE6uLS4TzLe6jeGeM/WRwVYfGDpFAZLjE3S3eHvGHsXEKtujfuBBHBwO+o1CyZODF5QqPecTeSLFIrgVbyyxAkXgTVe7mBoMpDKwqrDiCD3jUgtrmK4MLbZRE6vtbwahNDqfqO3hLYfqF/NaZRURXdPyiN4b6bx41Phqw6f6lyEWLzGNiW3hu7phHDcxRgLGfNY7Q4FAQx4niK1oFmt5kuIXrsljYOpoaGhFQaEU09jDf28t7ErNJZpKjSqqMFYlAdwAYgHhz1J1XZwM+HzhU3ciiohuwKMGpyEgG4E8zu1YWb3K/bmEgS1yVqzDzGWIBEnA5lXFKn76o1PfX1zHaWdqhkuLmVgiIi8yzHgNXzYWN/dbyZUiuGU7bexgAjE0g+rUDdT7401YYqyTZaY63jtrZe8JEoVa+mg466JjDgyKMizJXiA3uwBI8DQ09WolFKw5C6RqGvElW4+HBuzqptw2jMz1avDhKa8dAg1B4gjXVpYhR7gwqeHEsoA+M6yCOwVpsJcJECfpMLi3ag+JSddVGw3ecbeMS7a18kzRibl3eWWr6NYpsdt+zzZwGx28vJ8tfLp/BppURQiIAqIooABwAAGusLSDp6+zVjYWTYTB3drJZLFFkAy3FzK3vVzC4KyJEhKqfoMK6w+SuCTfpF7rlVf6Yurc+XLuB5FiN3x/tRZzgcFLox9dCPmPaIr2AShf8G/J19TDiNErd3Sr3LVD8u3SiyszdTx0Jubg7gngTwCj4hXSyNSe675iOC+hR3evn/YP6yOsOgbTN4a2/WvbS2vWXRX2lJLhJ0n8zzClu4MqkmaQr+Vom4hAooB1X1L+qrrXqW26W6vgRMp+r7IjHXdqZYq+Q3vzWYvikO59iecOLEsX1Bjchk8ljrWJ2d1x0yw+buUoVlDpIGWhPCmv/ADXO/wCXtv8Awuor7HZ/qKzuoWVklhu4I29lg1CUtwaVA7+y4sMjaxXtldLsuLWZQ6OvOhU8OfHUs2Eyt5gjIarbuou4U4jgoYpJSlebnRN91hNcQ04RwWSwtWo47mmlFKV4U17ziLF5siUMZyt2/mz7TwIWgVFr37VFdT5bL5vOK02zy7GG5i92h2IE/JRyQyba0qePMnQIy2dBHEET23/hdQYiHI32Uiti5jusjKJp6Md20uFTgK0ApwGvs/P49L6FamCQ1WWFj9aORaMp4CtDQ99RrdiuqbqxiqSY7q2S6NOFAGR4OXHu0rZfqW8yKq9THbQpagrQUU7mnPPmR3eHPRx/T+PSxgch53qXklcCm6R2JZj8dB3U1cY/JWkV9Y3S7Li1mUMjD0g+HMHu1LNhMzd4MSEFLaRBdxJ4hdzRvSn3zn192q5Pqy5u4OH5O1tUtn9PtPJOP7nUiYDGrbzTrtub6RjJPIAa0Z24gV7hQejVxYZC2jvLK6Qx3FrModHU9xB0ch0v1BkOl7kNugCVnWEnmIzvjlApw4yHSR9WfrJzfUVnGQ0ds25dp76Gea5HHhyXX2fgMeljC1DPIKtLMw+tJI1WY8TSpoO6g1eWRuJrUXkEkBurZ/Lmj8xSu+N6Hay1qD3HTz3Gb6gnmkNZJpLm3ZmPiSbYk6tMris91Bb3FpNHLsW6hRJfLYNskCW6lkbkRXiNJirzJ5HF26zCaSTGziCSQBWXy5CyOGQ7qkEcwNf+a53/AC9t/wCF1dR4zMZe+trlFQWV/cJLDFtJO6NEjjCk14nUmTzGazaFlRY7CC5jFtH5a7QY45IZNteJNDzJPfpXTL55HQhkdbi2BBHEEEW2rfAG6usxaW8ckTT5NxcTSxyMzFJG2qGADbQKfRAGmtsF1HmsPiyarhopbea3jBLMViN1BNJGDuPBHH3dWtxBn8xjvdLOWzjht7oNG3minnSLOku+RPqs1aaGHtcle5CBJZZYp70wtMhmYu43RxRhquxarAmp50oB1Ba2fVfUESdSSvc3zxz20Lx3Mjq73EDQ20Zjdtu07fZIP0eApFD5jy+Uip5sh3O20Uqx7ye/9p5NgLPAwlUD0cD8hPwFmut1vbHio+u49APIek6WG3jEUa8lHzk95/sN7RbmJruNd72odTIqmnEpWoHH4W+5uYrdfvpXVB4c2I1shyVrM9K7EmRjT1A/C23N9b27HkssqIfuMRr+i3kFzxp+SkV+I4n6JPbuurqK2XxldUHh9YjWy2v7a4f7yOVHPH0Ant3XVzFbL99K6oPD6xGtltf29w/3kUqOfuKT+27S2UiwljUwuDsr6CK09VNUaSFF7zuY/Jt0ssp96nXirMKKp8QvH5f7EzV5nEnyNp1AJIoc4WL3EcLMdrxseFUDUZQOHdwpW5fIwW+RtcnxXqFYxJOFYmkscpq+x/rrzr6RQw+awngP5S3nhcEcRSqkVB00ELGSPaGVmArx7jTVveXPmSyOA/lV2qKHhy493j2C1sztuJBV5eexTyp6Tprm4mKo59q5kq7sfRU1P3de3NcM3ipQD7hU6/o99cPbbae6SsGWviOAp8WrvIlXW8CbywaqsUWgqDXuHdpYLjckW1mYpQE07qkHSWtonlwoSQCSTUmpNTp7OzkaG3QlZJENGkPfxHIernoS3kvu4biIlG5+PiTwGgRNdBhxDBkHH0expoWvJrtK/kzMQWUeFeZ17pZHbcOKyTcygPKnpOmubiYpG59q4kq7uR4VPH1k6G+a4Zu8goB9zYdOi381zbEUSCajFTXgQ3q7tC2tDS5lFWl57FPh6To3+VeSbzTVELHc/wCEzHjoi2hNpKB7EiszCvdUMT8mjj8jIZoUbYJHO5oyOH0jzXUsMq7opkZJFrSqsKEVHo1btaB9s+/cjkGm3byNPT36iv50d54pqxLWigoQVPDiePp0La8QvGrh02kghgCK/cJ56nt46mOOQojNStAeFaAakNoreZKAJJXapIHLgKD5NXORZXW8VAdwbg23gKg17vDRiudyxJGXOygJoQKVIPjqSOwTYtutIFJLUZ25mvPi1dI9zbreXbAGa6nHmSFuZozV28TwpqOSeATPFE0KmRmb2H+kDUmtfTq7so7Jmht3aUvGIxWN/aBbcykkAFeXdq4kuLOMNlGZpUUbdsRaqopWhA4A8NKiiioAFHoH7fSWd9Cs0Mg4VHFT3Mp7iNXeJeNJY0uNyOy+0rLUEoe7eKV9Q1Y2rcG2tIV8PMYvT5dFvwFGrdfBKdk7niWcgeocB8mkiQUWNQqj1dtwv30bD5NBvwGGpmXgwRtp9NOGodwqqncR+KKj5fgTueJaQ09VaDUcSCixqFA9XbPI3Es5A9Q4D5NRxqKLGoUD0AU7C4HF0Ut6xw/e1AW4kLtJ/F4fvatfwd/y7dKv4Tdk7U5yE/L2XC+KU1I3jER/dLqSF/oyChPh4HQRoTK6LRXUijU5E7iCNJv4PtG8Dxpx0vlmhceXMfGMkH5KaVVFFUAKPAD9wBmoCJgG5d4FD82lkUgAjivgfA6rz4DUY8B2P3e1UH18df6U/wAv9vTN7y5oCaVP9vS7pGYcagkkctSDxU6r6Dp0++BGgAxjJ+sOev8ASn+X+3oMLh2qaUqR+/qTezNypU18dOafW3D4+OgRyPYadxpp+H1qj4+OgfHsr4ADSL8f3TXUXo3fvaA9J7HPix7JB4jTGn1SPlH7hQOAZTUE/LoKVr82jwoKcAK0+XSjsqOY0FavDv0QO/W48zy0w9Gq+js3L69ceB0AAaDVO/v1XvGtrA0HLRpz7tMNVHMa2sDw5HXDidbm5Hnr1d2hwIprlUeOuANfTqvx1OvaU19GtoFB36JPfy/cQPgcuw/A5fB5D4HL4PLt5f8AAiv/2Q==" alt="WindowsTelecom" style="height:120px;width:auto;object-fit:contain;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.3);">
        </div>
        <h1 style="font-family:system-ui,sans-serif;font-size:28px;font-weight:800;color:#fff;margin-top:20px;letter-spacing:2px;">WIN-TEL</h1>
        <p style="font-family:system-ui,sans-serif;font-size:14px;color:#52b788;letter-spacing:4px;margin-top:5px;">AGROMANAGER PRO v4.0</p>
        <div style="margin-top:30px;width:200px;height:3px;background:rgba(82,183,136,0.2);border-radius:3px;overflow:hidden;">
            <div style="height:100%;background:linear-gradient(90deg,#52b788,#d4a373);animation:splashLoad 2s ease-in-out forwards;"></div>
        </div>
        <p style="position:absolute;bottom:30px;font-family:system-ui,sans-serif;font-size:10px;color:rgba(255,255,255,0.5);text-align:center;">漏 2026 WindowsTelecom C.A. | CEO: Joseph Castillo<br>Arquitectos de Infraestructura Digital</p>
    </div>
    <style>
        @keyframes splashFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        @keyframes splashLoad{0%{width:0}100%{width:100%}}
        #splash-screen.hidden{opacity:0;visibility:hidden;pointer-events:none;transition:opacity 0.5s,visibility 0.5s;}
        .wintel-float-tools{position:fixed;bottom:20px;right:20px;display:flex;gap:8px;z-index:9000;}
        .wintel-float-btn{width:48px;height:48px;border-radius:12px;border:none;background:linear-gradient(135deg,#2d6a4f,#0f3629);color:#d8f3dc;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
        .wintel-float-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(45,106,79,0.4);background:linear-gradient(135deg,#52b788,#2d6a4f);}
    </style>

    <!-- Botones flotantes WIN-TEL -->
    <div class="wintel-float-tools">
        <button class="wintel-float-btn" onclick="WintelAssistant.toggle()" title="Asistente WIN-TEL"><i class="fa-solid fa-robot"></i></button>
        <button class="wintel-float-btn" onclick="WintelGlossary.toggle()" title="Glosario Ganadero (F1)"><i class="fa-solid fa-book"></i></button>
        <button class="wintel-float-btn" onclick="WintelTour.start()" title="Tour Guiado"><i class="fa-solid fa-route"></i></button>
    </div>

    <!-- Bot贸n flotante de c谩mara para fotos -->
    <button class="camera-fab" id="cameraFab" onclick="app.openCameraCapture()" title="Tomar foto del potrero">
        <i class="fa-solid fa-camera"></i>
    </button>

    <!-- ============================================
         APLICACIN PRINCIPAL
    ============================================ -->
    <div id="mainApp" style="display:block;">
        <div class="app-layout">
            
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <div class="sidebar-logo-icon">
                            <svg width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M50 10L85 30V70L50 90L15 70V30L50 10Z" fill="#52b788" stroke="#d8f3dc" stroke-width="2"></path>
                                <circle cx="50" cy="50" r="16" fill="#0f3629"></circle>
                                <text x="50" y="56" text-anchor="middle" fill="#d8f3dc" font-size="18"></text>
                            </svg>
                        </div>
                        <div class="sidebar-logo-text">WIN-TEL AGRO</div>
                    </div>
                </div>
                
                <nav class="sidebar-nav">
                    <div class="nav-item active" data-view="dashboard" onclick="app.navigate('dashboard')">
                        <span class="nav-icon"></span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-view="potreros" onclick="app.navigate('potreros')">
                        <span class="nav-icon">猴</span>
                        <span>Gesti贸n de Potreros</span>
                    </div>
                    <div class="nav-item" data-view="mapa" onclick="app.navigate('mapa')">
                        <span class="nav-icon">帮</span>
                        <span>Mapa Satelital</span>
                    </div>
                    <div class="nav-item" data-view="geomatics" onclick="app.navigate('geomatics')">
                        <span class="nav-icon">Л</span>
                        <span>Herramientas Geom谩ticas</span>
                    </div>
                    <div class="nav-item" data-view="movimientos" onclick="app.navigate('movimientos')">
                        <span class="nav-icon"></span>
                        <span>Movimientos</span>
                    </div>
                    <div class="nav-item" data-view="registros" onclick="app.navigate('registros')">
                        <span class="nav-icon"></span>
                        <span>Historial Completo</span>
                    </div>
                    <div class="nav-item" data-view="reportes" onclick="app.navigate('reportes')">
                        <span class="nav-icon"></span>
                        <span>Reportes y An谩lisis</span>
                    </div>
                    <div class="nav-item" data-view="galeria" onclick="app.navigate('galeria')">
                        <span class="nav-icon"></span>
                        <span>Galer铆a de Fotos</span>
                    </div>
                    <div class="nav-item" data-view="prv" onclick="app.navigate('prv')">
                        <span class="nav-icon"></span>
                        <span>Rotaci贸n PRV</span>
                    </div>
                    <div class="nav-item" data-view="reportespdf" onclick="app.navigate('reportespdf')">
                        <span class="nav-icon"></span>
                        <span>Reportes PDF</span>
                    </div>
                    <div class="nav-item" data-view="clima" onclick="app.navigate('clima')">
                        <span class="nav-icon">★</span>
                        <span>Clima</span>
                    </div>
                    <div class="nav-item" data-view="calculadora" onclick="app.navigate('calculadora')">
                        <span class="nav-icon"></span>
                        <span>Carga Animal</span>
                    </div>
                    <div class="nav-item" data-view="inventario" onclick="app.navigate('inventario')">
                        <span class="nav-icon"></span>
                        <span>Inventario Ganado</span>
                    </div>
                    <div class="nav-item" data-view="reproduccion" onclick="app.navigate('reproduccion')">
                        <span class="nav-icon"></span>
                        <span>Reproducci贸n</span>
                    </div>
                    <div class="nav-item" data-view="sanidad" onclick="app.navigate('sanidad')">
                        <span class="nav-icon"></span>
                        <span>Sanidad Avanzada</span>
                    </div>
                    <div class="nav-item" data-view="lecheria" onclick="app.navigate('lecheria')">
                        <span class="nav-icon"></span>
                        <span>Producci贸n Lechera</span>
                    </div>
                    <div class="nav-item" data-view="analytics" onclick="app.navigate('analytics')">
                        <span class="nav-icon"></span>
                        <span>Analytics PRO</span>
                    </div>
                    <div class="nav-item" data-view="economia" onclick="app.navigate('economia')">
                        <span class="nav-icon"></span>
                        <span>Econom铆a Ganadera</span>
                    </div>
                    <div class="nav-item" data-view="autoreportes" onclick="app.navigate('autoreportes')">
                        <span class="nav-icon"></span>
                        <span>Reportes Autom谩ticos</span>
                    </div>
                    <div class="nav-item" data-view="pluviometro" onclick="app.navigate('pluviometro')">
                        <span class="nav-icon">э</span>
                        <span>Pluvi贸metro</span>
                    </div>
                    <div class="nav-item" data-view="insumos" onclick="app.navigate('insumos')">
                        <span class="nav-icon"></span>
                        <span>Insumos / Stock</span>
                    </div>
                    <div class="nav-item" data-view="finanzas" onclick="app.navigate('finanzas')">
                        <span class="nav-icon"></span>
                        <span>Finanzas (Caja Menor)</span>
                    </div>
                    <div class="nav-item" data-view="botia" onclick="app.navigate('botia')">
                        <span class="nav-icon"></span>
                        <span>Asistente IA</span>
                    </div>
                    <div class="nav-item" data-view="exportar" onclick="app.navigate('exportar')">
                        <span class="nav-icon"></span>
                        <span>Exportar Datos</span>
                    </div>
                    <div class="nav-item" data-view="backup" onclick="app.navigate('backup')">
                        <span class="nav-icon"></span>
                        <span>Configuraci贸n y Datos</span>
                    </div>
                    <div class="nav-item" data-view="config" id="configNav" onclick="app.navigate('config')">
                        <span class="nav-icon">锔</span>
                        <span>Configuraci贸n</span>
                    </div>
                </nav>
                
                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Admin</div>
                            <div class="user-status">
                                <span class="status-dot"></span>
                                En l铆nea
                            </div>
                        </div>
                        <button class="logout-btn" onclick="app.logout()" title="Cerrar Sesi贸n"></button>
                    </div>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="main-content">
                <header class="topbar">
                    <h1 class="page-title">
                        <span class="page-title-icon" id="pageTitleIcon"></span>
                        <span id="pageTitle">Panel de Control</span>
                    </h1>
                    <div class="topbar-actions">
                        <!-- Indicador de Estado de Red -->
                        <div class="network-indicator online" id="networkIndicator">
                            <div class="network-dot"></div>
                            <span id="networkText">Conectado</span>
                        </div>
                        <div class="date-display">
                            <span></span>
                            <span id="currentDate">Cargando...</span>
                        </div>
                    </div>
                </header>

                <div class="content-area" id="contentArea">
                    <!-- El contenido din谩mico se carga aqu铆 -->
                </div>
            </main>

        </div>
    </div>

    <!-- ============================================
         MODALES
    ============================================ -->
    
    <!-- Modal Crear/Editar Potrero -->
    <div class="modal-overlay" id="modalPotrero">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>猴</span>
                    <span id="modalPotreroTitle">Nuevo Potrero</span>
                </h3>
                <button class="modal-close" onclick="app.closeModal('modalPotrero')"></button>
            </div>
            <div class="modal-body">
                <form id="formPotrero" onsubmit="app.savePotrero(event)">
                    <input type="hidden" id="potreroEditId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ID del Potrero *</label>
                            <input type="text" id="potreroId" class="form-input" placeholder="Ej: POT-001" required>
                            <span class="form-hint">Identificador 煤nico del potrero</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Superficie (Ha) *</label>
                            <input type="number" id="potreroSuperficie" class="form-input" step="0.01" placeholder="Ej: 5.5" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicaci贸n *</label>
                        <input type="text" id="potreroUbicacion" class="form-input" placeholder="Ej: Loma Norte" required>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Latitud (GPS)</label>
                            <input type="number" id="potreroLatitud" class="form-input" step="0.000001" placeholder="Ej: 8.7832">
                            <span class="form-hint">Opcional - para mapa satelital</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Longitud (GPS)</label>
                            <input type="number" id="potreroLongitud" class="form-input" step="0.000001" placeholder="Ej: -67.9245">
                            <span class="form-hint">Opcional - para mapa satelital</span>
                        </div>
                    </div>
                    <div style="padding: 12px; background: var(--gris-100); border-radius: 8px; font-size: 12px; color: var(--gris-600);">
                         <strong>Tip:</strong> Usa Google Maps para obtener las coordenadas exactas. Click derecho en el potrero  "驴Qu茅 hay aqu铆?"  copiar coordenadas.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('modalPotrero')">Cancelar</button>
                <button class="btn btn-primary" onclick="document.getElementById('formPotrero').requestSubmit()">
                    <span></span> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Entrada -->
    <div class="modal-overlay" id="modalEntrada">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>★</span>
                    <span>Registrar Entrada a Potrero</span>
                </h3>
                <button class="modal-close" onclick="app.closeModal('modalEntrada')"></button>
            </div>
            <div class="modal-body">
                <form id="formEntrada" onsubmit="app.saveEntrada(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Potrero *</label>
                            <select id="entradaPotrero" class="form-select" required onchange="app.updatePotreroInfo('entrada')">
                                <option value="">Seleccionar potrero...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Entrada *</label>
                            <input type="date" id="entradaFecha" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Tipo de Cultivo *</label>
                            <select id="entradaCultivo" class="form-select" required>
                                <option value="">Seleccionar...</option>
                                <option value="Campo Natural">Campo Natural</option>
                                <option value="Campo Natural Mejorado">Campo Natural Mejorado</option>
                                <option value="Verdeo Invierno">Verdeo Invierno</option>
                                <option value="Verdeo Verano">Verdeo Verano</option>
                                <option value="Pradera 1 a帽o">Pradera 1 a帽o</option>
                                <option value="Pradera 2 a帽os">Pradera 2 a帽os</option>
                                <option value="Pradera 3 a帽os">Pradera 3 a帽os</option>
                                <option value="Pradera 4 a帽os">Pradera 4 a帽os</option>
                                <option value="Pradera +5 a帽os">Pradera m谩s de 5 a帽os</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mat. Verde Entrada (kg/ha)</label>
                            <input type="number" id="entradaMatVerde" class="form-input" step="0.01" placeholder="Ej: 2000">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Observaci贸n Est谩ndar</label>
                            <select id="entradaObsEst" class="form-select">
                                <option value="">Ninguna</option>
                                <option value="Lluvia Alta">Lluvia Alta</option>
                                <option value="Lluvia Mediana">Lluvia Mediana</option>
                                <option value="Sin Precipitaciones">Sin Precipitaciones</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observaciones Adicionales</label>
                        <textarea id="entradaObsAd" class="form-textarea" placeholder="Ingrese observaciones adicionales..."></textarea>
                    </div>

                    <div id="entradaPotreroInfo" class="stat-mini hidden">
                        <div class="stat-mini-icon" style="background: var(--verde-claro); color: white;"></div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-label">Informaci贸n del Potrero</div>
                            <div class="stat-mini-value" id="entradaPotreroInfoText">-</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('modalEntrada')">Cancelar</button>
                <button class="btn btn-success" onclick="document.getElementById('formEntrada').requestSubmit()">
                    <span></span> Registrar Entrada
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Salida -->
    <div class="modal-overlay" id="modalSalida">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>猬锔</span>
                    <span>Registrar Salida de Potrero</span>
                </h3>
                <button class="modal-close" onclick="app.closeModal('modalSalida')"></button>
            </div>
            <div class="modal-body">
                <form id="formSalida" onsubmit="app.saveSalida(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Movimiento Activo *</label>
                            <select id="salidaMovimiento" class="form-select" required onchange="app.updateMovimientoInfo()">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Salida *</label>
                            <input type="date" id="salidaFecha" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Mat. Verde Salida (kg/ha)</label>
                            <input type="number" id="salidaMatVerde" class="form-input" step="0.01" placeholder="Ej: 500">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Observaci贸n Est谩ndar</label>
                            <select id="salidaObsEst" class="form-select">
                                <option value="">Ninguna</option>
                                <option value="Lluvia Alta">Lluvia Alta</option>
                                <option value="Lluvia Mediana">Lluvia Mediana</option>
                                <option value="Sin Precipitaciones">Sin Precipitaciones</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observaciones Adicionales</label>
                        <textarea id="salidaObsAd" class="form-textarea" placeholder="Ingrese observaciones adicionales..."></textarea>
                    </div>

                    <div id="salidaMovInfo" class="stat-mini hidden">
                        <div class="stat-mini-icon" style="background: var(--azul); color: white;">癸</div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-label">Informaci贸n del Movimiento</div>
                            <div class="stat-mini-value" id="salidaMovInfoText">-</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('modalSalida')">Cancelar</button>
                <button class="btn btn-success" onclick="document.getElementById('formSalida').requestSubmit()">
                    <span></span> Registrar Salida
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Dibujar Pol铆gono de Potrero -->
    <div class="modal-overlay" id="modalPoligonoMapa">
        <div class="modal" style="max-width: 90%; width: 1200px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>猴</span>
                    <span id="modalPoligonoTitle">Dibujar Pol铆gono del Potrero</span>
                </h3>
                <button class="modal-close" onclick="app.closeModalPoligono()"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div style="padding: 16px; background: var(--verde-muy-claro); border-bottom: 2px solid var(--verde-claro);">
                    <p style="font-size: 13px; margin-bottom: 8px; color: var(--gris-800);">
                        <strong>Instrucciones:</strong>
                    </p>
                    <ol style="font-size: 12px; color: var(--gris-700); padding-left: 20px; margin: 0;">
                        <li>Usa el control de dibujo (esquina superior derecha) para dibujar el pol铆gono</li>
                        <li>Click en los v茅rtices del potrero</li>
                        <li>Doble click para cerrar el pol铆gono</li>
                        <li>El 谩rea se calcular谩 autom谩ticamente</li>
                        <li>Click en "Guardar Pol铆gono" para finalizar</li>
                    </ol>
                </div>
                <div style="height: 500px; position: relative;">
                    <!-- BUSCADOR DE UBICACIONES -->
                    <div class="map-search-container" id="poligonoSearchContainer">
                        <input type="text" class="map-search-input" id="poligonoSearchInput" 
                               placeholder=" Buscar ciudad, localidad o direcci贸n..." 
                               onkeypress="if(event.key==='Enter') app.searchLocationPoligono()">
                        <button class="map-search-btn" onclick="app.searchLocationPoligono()" title="Buscar ubicaci贸n">
                            <i class="fa-solid fa-search"></i>
                        </button>
                        <div class="map-search-results" id="poligonoSearchResults"></div>
                    </div>
                    <div id="mapPoligono" style="width: 100%; height: 100%;"></div>
                </div>
                <div style="padding: 16px; background: var(--gris-100);">
                    <div id="poligonoStats" class="hidden">
                        <div class="stat-mini">
                            <div class="stat-mini-icon" style="background: var(--verde-claro); color: white;"></div>
                            <div class="stat-mini-content">
                                <div class="stat-mini-label">rea Calculada</div>
                                <div class="stat-mini-value" id="poligonoArea">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModalPoligono()">Cancelar</button>
                <button class="btn btn-primary" id="btnGuardarPoligono" onclick="app.guardarPoligonoPotrero()" disabled>
                    <span></span> Guardar Pol铆gono
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT - APLICACIN
    ============================================ -->
    <!-- Chart.js para gr谩ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        // ========================================
        // SISTEMA DE CACH INTELIGENTE
        // ========================================
        const PerformanceCache = {
            cache: new Map(),
            maxAge: 300000, // 5 minutos por defecto
            
            set(key, value, ttl = this.maxAge) {
                this.cache.set(key, {
                    value,
                    expiry: Date.now() + ttl,
                    ttl
                });
            },
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() > item.expiry) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            },
            
            has(key) {
                return this.get(key) !== null;
            },
            
            clear(pattern = null) {
                if (pattern) {
                    for (const key of this.cache.keys()) {
                        if (key.includes(pattern)) {
                            this.cache.delete(key);
                        }
                    }
                } else {
                    this.cache.clear();
                }
            },
            
            getStats() {
                return {
                    size: this.cache.size,
                    keys: Array.from(this.cache.keys())
                };
            }
        };

        // ========================================
        // CONFIGURACIN Y ESTADO GLOBAL
        // ========================================
        const app = {
            // Estado de la aplicaci贸n
            currentUser: null,
            currentView: 'dashboard',
            mapa: null, // Instancia del mapa Leaflet
            drawnItems: null, // Capa para elementos dibujados en el mapa
            mapaPoligono: null, // Mapa para dibujar pol铆gonos de potreros
            drawnItemsPoligono: null, // Capa para pol铆gonos de potreros
            currentPotreroId: null, // ID del potrero actual al dibujar pol铆gono
            currentPolygon: null, // Pol铆gono actual siendo dibujado
            
            // Datos del sistema
            data: {
                usuarios: [
                    { usuario: 'ADMIN', password: '123', rol: 'admin' },
                    { usuario: 'OTRO', password: '1234', rol: 'usuario' }
                ],
                potreros: [],
                movimientos: [],
                fotos: [], // Sistema de fotograf铆as geolocalizadas
                ganado: [], // Inventario de ganado individual
                lluvias: [], // Registro de precipitaciones
                insumos: [], // Inventario de insumos
                movimientosInsumos: [], // Historial de movimientos de insumos
                config: {
                    tiposCultivo: [
                        'Campo Natural',
                        'Campo Natural Mejorado',
                        'Verdeo Invierno',
                        'Verdeo Verano',
                        'Pradera 1 a帽o',
                        'Pradera 2 a帽os',
                        'Pradera 3 a帽os',
                        'Pradera 4 a帽os',
                        'Pradera +5 a帽os',
                        'Otros'
                    ],
                    observacionesEstandar: [
                        'Lluvia Alta',
                        'Lluvia Mediana',
                        'Sin Precipitaciones'
                    ],
                    // PLANTILLAS PARA MOVIMIENTOS RPIDOS
                    templates: {
                        movimientos: [
                            {
                                id: 'template_rotacion_rapida',
                                nombre: ' Rotaci贸n R谩pida PRV',
                                descripcion: 'Movimiento est谩ndar para rotaci贸n de 3 d铆as',
                                cultivo: 'Pradera 1 a帽o',
                                matVerdeEntrada: 2500,
                                obsEstandarEntrada: 'Sin Precipitaciones',
                                tags: ['PRV', 'Rotaci贸n', 'R谩pido']
                            },
                            {
                                id: 'template_descanso_largo',
                                nombre: ' Descanso Prolongado',
                                descripcion: 'Para recuperaci贸n de pasturas (7-10 d铆as)',
                                cultivo: 'Campo Natural Mejorado',
                                matVerdeEntrada: 3000,
                                obsEstandarEntrada: 'Lluvia Mediana',
                                tags: ['Descanso', 'Recuperaci贸n']
                            },
                            {
                                id: 'template_invierno',
                                nombre: '锔 Pastoreo Invernal',
                                descripcion: 'Configuraci贸n para 茅poca de invierno',
                                cultivo: 'Verdeo Invierno',
                                matVerdeEntrada: 1800,
                                obsEstandarEntrada: 'Lluvia Alta',
                                tags: ['Invierno', 'Verdeo']
                            },
                            {
                                id: 'template_verano',
                                nombre: '锔 Pastoreo Estival',
                                descripcion: 'Configuraci贸n para 茅poca de verano',
                                cultivo: 'Verdeo Verano',
                                matVerdeEntrada: 3500,
                                obsEstandarEntrada: 'Sin Precipitaciones',
                                tags: ['Verano', 'Verdeo']
                            },
                            {
                                id: 'template_intensivo',
                                nombre: ' Pastoreo Intensivo',
                                descripcion: 'Alta carga animal, corta duraci贸n',
                                cultivo: 'Pradera 2 a帽os',
                                matVerdeEntrada: 4000,
                                obsEstandarEntrada: 'Sin Precipitaciones',
                                tags: ['Intensivo', 'Alta Carga']
                            }
                        ]
                    },
                    // ETIQUETAS PREDEFINIDAS
                    tags: {
                        categorias: [
                            {
                                nombre: 'Tipo de Uso',
                                color: '#10b981',
                                tags: ['PRV', 'Rotaci贸n', 'Descanso', 'Reserva', 'Cuarentena']
                            },
                            {
                                nombre: 'Condici贸n',
                                color: '#3b82f6',
                                tags: ['Excelente', 'Bueno', 'Regular', 'Necesita Mejora', 'En Recuperaci贸n']
                            },
                            {
                                nombre: 'Infraestructura',
                                color: '#f59e0b',
                                tags: ['Con Bebedero', 'Con Sombra', 'Cerca Nueva', 'Cerca Vieja', 'Sin Cerca']
                            },
                            {
                                nombre: 'Prioridad',
                                color: '#ef4444',
                                tags: ['Alta Prioridad', 'Media Prioridad', 'Baja Prioridad']
                            },
                            {
                                nombre: 'poca',
                                color: '#8b5cf6',
                                tags: ['Verano', 'Invierno', 'Todo el A帽o', 'Sequ铆a']
                            }
                        ]
                    }
                }
            },

            // ========================================
            // INICIALIZACIN
            // ========================================
            init: function() {
                this.loadData();
                this.loadEspeciesConfig();
                this.updateDate();
                setInterval(() => this.updateDate(), 60000);
                
                // Establecer fecha de hoy por defecto
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('entradaFecha').value = today;
                document.getElementById('salidaFecha').value = today;
                
                // Iniciar directamente sin login
                this.currentUser = { usuario: 'ADMIN', rol: 'admin' };
                document.getElementById('userName').textContent = 'ADMIN';
                document.getElementById('userAvatar').textContent = 'A';
                document.getElementById('configNav').classList.remove('hidden');
                
                // ========== SISTEMA DE MONITOREO DE RED ==========
                this.initNetworkMonitor();
                
                // ========== SISTEMA DE FINANZAS ==========
                this.loadFinanzasData();
                
                // ========== NUEVOS SISTEMAS ==========
                
                // Cargar alertas guardadas
                const savedAlerts = localStorage.getItem('nexusAgroAlerts');
                if (savedAlerts) {
                    try {
                        this.alertsSystem.alerts = JSON.parse(savedAlerts);
                    } catch(e) {
                        this.alertsSystem.alerts = [];
                    }
                }
                
                // Cargar historial de cambios
                const savedHistory = localStorage.getItem('nexusAgroHistory');
                if (savedHistory) {
                    try {
                        this.changeHistory.history = JSON.parse(savedHistory);
                    } catch(e) {
                        this.changeHistory.history = [];
                    }
                }
                
                // Inicializar motor de b煤squeda
                this.searchEngine.buildIndex();
                
                // Inicializar sistema de alertas
                this.alertsSystem.init();
                
                // Inicializar atajos de teclado
                this.initKeyboardShortcuts();
                
                // Backup autom谩tico cada 30 minutos
                setInterval(() => this.autoBackup(), 1800000);
                
                // Mostrar indicador de atajos brevemente
                setTimeout(() => this.showShortcutsHint(), 3000);
                
                // Renderizar indicador de plugins
                this.renderPluginsIndicator();
                
                // Inicializar listeners para b煤squeda en mapas
                this.initSearchListeners();
                
                // Navegar al dashboard
                this.navigate('dashboard');
                
                console.log(' WIN-TEL AgroManager PRO v4.0 FULL iniciado');
                console.log(' Atajos: Ctrl+K (B煤squeda) | Ctrl+Z (Deshacer) | F1 (Ayuda)');
                console.log(' M贸dulos v4: Reproducci贸n | Sanidad | Lecher铆a | Analytics');
            },
            
            // Inicializar atajos de teclado globales
            initKeyboardShortcuts: function() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl+K: B煤squeda global
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        this.openGlobalSearch();
                    }
                    
                    // Escape: Cerrar modales/b煤squeda
                    if (e.key === 'Escape') {
                        this.closeGlobalSearch();
                        this.closeAlertCenter();
                        this.closeHistoryPanel();
                    }
                    
                    // Ctrl+Z: Deshacer (fuera de inputs)
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.target.matches('input, textarea')) {
                        e.preventDefault();
                        this.undoLastChange();
                    }
                    
                    // F1: Mostrar atajos
                    if (e.key === 'F1') {
                        e.preventDefault();
                        this.toggleShortcutsHelp();
                    }
                    
                    // Ctrl+E: Exportar r谩pido
                    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                        e.preventDefault();
                        this.navigate('exportar');
                    }
                    
                    // Ctrl+N: Nuevo potrero
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n' && !e.target.matches('input, textarea')) {
                        e.preventDefault();
                        this.openPotreroModal();
                    }
                });
            },
            
            // Mostrar hint de atajos
            showShortcutsHint: function() {
                const hint = document.createElement('div');
                hint.className = 'shortcuts-help active';
                hint.innerHTML = `
                    <div class="shortcuts-help-title">锔 Atajos Disponibles</div>
                    <div class="shortcuts-help-item">
                        <span>B煤squeda global</span>
                        <span class="shortcuts-help-key"><kbd>Ctrl</kbd><kbd>K</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Deshacer cambio</span>
                        <span class="shortcuts-help-key"><kbd>Ctrl</kbd><kbd>Z</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Ver atajos</span>
                        <span class="shortcuts-help-key"><kbd>F1</kbd></span>
                    </div>
                `;
                document.body.appendChild(hint);
                
                setTimeout(() => {
                    hint.classList.remove('active');
                    setTimeout(() => hint.remove(), 300);
                }, 5000);
            },
            
            toggleShortcutsHelp: function() {
                let help = document.getElementById('shortcutsHelp');
                if (help) {
                    help.remove();
                    return;
                }
                
                help = document.createElement('div');
                help.id = 'shortcutsHelp';
                help.className = 'shortcuts-help active';
                help.innerHTML = `
                    <div class="shortcuts-help-title">锔 Atajos de Teclado</div>
                    <div class="shortcuts-help-item">
                        <span>B煤squeda global</span>
                        <span class="shortcuts-help-key"><kbd>Ctrl</kbd><kbd>K</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Deshacer cambio</span>
                        <span class="shortcuts-help-key"><kbd>Ctrl</kbd><kbd>Z</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Exportar datos</span>
                        <span class="shortcuts-help-key"><kbd>Ctrl</kbd><kbd>E</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Nuevo potrero</span>
                        <span class="shortcuts-help-key"><kbd>Ctrl</kbd><kbd>N</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Cerrar modal</span>
                        <span class="shortcuts-help-key"><kbd>Esc</kbd></span>
                    </div>
                    <div class="shortcuts-help-item">
                        <span>Esta ayuda</span>
                        <span class="shortcuts-help-key"><kbd>F1</kbd></span>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px; color: var(--gris-500);">
                        Presiona F1 para cerrar
                    </div>
                `;
                document.body.appendChild(help);
            },
            
            // Auto backup cada 30 minutos
            autoBackup: function() {
                const backupKey = 'nexusAgroAutoBackup';
                const backup = {
                    timestamp: new Date().toISOString(),
                    data: this.data
                };
                
                try {
                    localStorage.setItem(backupKey, JSON.stringify(backup));
                    console.log(' Auto-backup realizado:', backup.timestamp);
                } catch(e) {
                    // Si localStorage est谩 lleno, intentar con sessionStorage
                    try {
                        sessionStorage.setItem(backupKey, JSON.stringify(backup));
                        console.log(' Auto-backup (session) realizado:', backup.timestamp);
                    } catch(e2) {
                        console.warn('锔 No se pudo realizar auto-backup');
                    }
                }
            },

            // ========================================
            // AUTENTICACIN
            // ========================================
            login: function(e) {
                e.preventDefault();
                const usuario = document.getElementById('loginUser').value.toUpperCase();
                const password = document.getElementById('loginPass').value;

                const user = this.data.usuarios.find(u => 
                    u.usuario === usuario && u.password == password
                );

                if (user) {
                    this.currentUser = user;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Actualizar info de usuario
                    document.getElementById('userName').textContent = user.usuario;
                    document.getElementById('userAvatar').textContent = user.usuario[0];
                    
                    // Mostrar configuraci贸n solo para admin
                    if (user.rol === 'admin') {
                        document.getElementById('configNav').classList.remove('hidden');
                    }
                    
                    this.navigate('dashboard');
                    this.notify('success', 'Bienvenido', `Sesi贸n iniciada como ${user.usuario}`);
                } else {
                    this.notify('error', 'Error de Autenticaci贸n', 'Usuario o contrase帽a incorrectos');
                }
            },

            logout: function() {
                if (confirm('驴Est谩 seguro que desea cerrar sesi贸n?')) {
                    this.currentUser = null;
                    location.reload();
                }
            },

            // ========================================
            // NAVEGACIN
            // ========================================
            navigate: function(view) {
                this.currentView = view;
                
                // Actualizar navegaci贸n activa
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
                
                // Renderizar vista
                const views = {
                    'dashboard': this.renderDashboard,
                    'potreros': this.renderPotreros,
                    'mapa': this.renderMapa,
                    'geomatics': this.renderGeomatics,
                    'movimientos': this.renderMovimientos,
                    'registros': this.renderRegistros,
                    'reportes': this.renderReportes,
                    'galeria': this.renderGaleria,
                    'prv': this.renderPRV,
                    'reportespdf': this.renderReportesPDF,
                    'clima': this.renderClima,
                    'calculadora': this.renderCalculadora,
                    'inventario': this.renderInventario,
                    'reproduccion': this.renderReproduccion,
                    'sanidad': this.renderSanidad,
                    'lecheria': this.renderLecheria,
                    'analytics': this.renderAnalytics,
                    'economia': this.renderEconomia,
                    'autoreportes': this.renderAutoReportes,
                    'pluviometro': this.renderPluviometro,
                    'insumos': this.renderInsumos,
                    'finanzas': this.renderFinanzas,
                    'botia': this.renderBotIA,
                    'exportar': this.renderExportar,
                    'backup': this.renderBackup,
                    'config': this.renderConfig
                };

                const titles = {
                    'dashboard': { icon: '', text: 'Panel de Control' },
                    'potreros': { icon: '猴', text: 'Gesti贸n de Potreros' },
                    'mapa': { icon: '帮', text: 'Mapa Satelital' },
                    'geomatics': { icon: 'Л', text: 'Herramientas Geom谩ticas' },
                    'movimientos': { icon: '', text: 'Movimientos de Ganado' },
                    'registros': { icon: '', text: 'Historial Completo' },
                    'reportes': { icon: '', text: 'Reportes y An谩lisis' },
                    'galeria': { icon: '', text: 'Galer铆a de Fotos' },
                    'prv': { icon: '', text: 'Rotaci贸n PRV' },
                    'reportespdf': { icon: '', text: 'Reportes PDF' },
                    'clima': { icon: '★', text: 'Clima y Pron贸stico' },
                    'calculadora': { icon: '', text: 'Calculadora de Carga Animal' },
                    'inventario': { icon: '', text: 'Inventario de Ganado' },
                    'reproduccion': { icon: '', text: 'Gesti贸n Reproductiva' },
                    'sanidad': { icon: '', text: 'Sanidad Avanzada' },
                    'lecheria': { icon: '', text: 'Producci贸n Lechera' },
                    'analytics': { icon: '', text: 'Analytics PRO' },
                    'economia': { icon: '', text: 'Econom铆a Ganadera' },
                    'autoreportes': { icon: '', text: 'Reportes Autom谩ticos' },
                    'pluviometro': { icon: 'э', text: 'Pluvi贸metro' },
                    'insumos': { icon: '', text: 'Gesti贸n de Insumos' },
                    'finanzas': { icon: '', text: 'Finanzas - Caja Menor' },
                    'botia': { icon: '', text: 'Asistente IA' },
                    'exportar': { icon: '', text: 'Exportar Datos' },
                    'backup': { icon: '', text: 'Configuraci贸n y Datos' },
                    'config': { icon: '锔', text: 'Configuraci贸n' }
                };

                document.getElementById('pageTitleIcon').textContent = titles[view].icon;
                document.getElementById('pageTitle').textContent = titles[view].text;

                if (views[view]) {
                    views[view].call(this);
                }
                
                // Mostrar/ocultar bot贸n de c谩mara flotante
                const cameraFab = document.getElementById('cameraFab');
                if (cameraFab) {
                    cameraFab.classList.toggle('visible', view === 'galeria' || view === 'potreros');
                }
            },

            // ========================================
            // VISTAS / RENDERS
            // ========================================
            renderDashboard: function() {
                const stats = this.calculateStats();
                const ocupados = this.data.movimientos.filter(m => m.estado === 'activo');
                
                const html = `
                    <div class="kpi-grid">
                        <div class="kpi-card azul">
                            <div class="kpi-header">
                                <span class="kpi-label">Total Potreros</span>
                                <div class="kpi-icon">猴</div>
                            </div>
                            <div class="kpi-value">${stats.totalPotreros}</div>
                            <div class="kpi-trend neutral">
                                <span></span>
                                <span>Registrados en sistema</span>
                            </div>
                        </div>

                        <div class="kpi-card rojo">
                            <div class="kpi-header">
                                <span class="kpi-label">Ocupados</span>
                                <div class="kpi-icon"></div>
                            </div>
                            <div class="kpi-value">${stats.ocupados}</div>
                            <div class="kpi-trend ${stats.ocupados > 0 ? 'up' : 'neutral'}">
                                <span>${stats.ocupados > 0 ? '' : ''}</span>
                                <span>${((stats.ocupados / (stats.totalPotreros || 1)) * 100).toFixed(1)}% de ocupaci贸n</span>
                            </div>
                        </div>

                        <div class="kpi-card verde">
                            <div class="kpi-header">
                                <span class="kpi-label">Disponibles</span>
                                <div class="kpi-icon"></div>
                            </div>
                            <div class="kpi-value">${stats.libres}</div>
                            <div class="kpi-trend ${stats.libres > 0 ? 'up' : 'down'}">
                                <span>${stats.libres > 0 ? '' : ''}</span>
                                <span>${((stats.libres / (stats.totalPotreros || 1)) * 100).toFixed(1)}% disponibles</span>
                            </div>
                        </div>

                        <div class="kpi-card dorado">
                            <div class="kpi-header">
                                <span class="kpi-label">Superficie Total</span>
                                <div class="kpi-icon"></div>
                            </div>
                            <div class="kpi-value">${stats.superficieTotal.toFixed(1)}</div>
                            <div class="kpi-trend neutral">
                                <span>Ha</span>
                                <span>Hect谩reas totales</span>
                            </div>
                        </div>
                    </div>

                    <!--  ALERTAS SANITARIAS -->
                    ${this.renderAlertasSanitarias()}

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Potreros Ocupados Actualmente
                            </h3>
                            <button class="btn btn-primary btn-small" onclick="app.openModal('modalEntrada')">
                                <span></span> Nueva Entrada
                            </button>
                        </div>
                        ${ocupados.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Potrero</th>
                                            <th>Ubicaci贸n</th>
                                            <th>Cultivo</th>
                                            <th>Superficie</th>
                                            <th>Fecha Entrada</th>
                                            <th>D铆as</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ocupados.map(mov => {
                                            const potrero = this.data.potreros.find(p => p.id === mov.potreroId);
                                            const dias = this.calcularDias(mov.fechaEntrada);
                                            return `
                                                <tr>
                                                    <td><strong>${mov.potreroId}</strong></td>
                                                    <td>${potrero?.ubicacion || '-'}</td>
                                                    <td>${mov.cultivo}</td>
                                                    <td>${potrero?.superficie || 0} Ha</td>
                                                    <td>${this.formatDate(mov.fechaEntrada)}</td>
                                                    <td><strong>${dias}</strong> d铆as</td>
                                                    <td><span class="badge ocupado">Ocupado</span></td>
                                                    <td>
                                                        <button class="btn btn-success btn-small" onclick="app.openSalidaModal(${mov.id})">
                                                            Registrar Salida
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-title">No hay potreros ocupados</div>
                                <div class="empty-state-message">Todos los potreros est谩n disponibles. Registre una nueva entrada de ganado.</div>
                                <button class="btn btn-primary" onclick="app.openModal('modalEntrada')">
                                    <span></span> Registrar Primera Entrada
                                </button>
                            </div>
                        `}
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                ltimos Movimientos
                            </h3>
                        </div>
                        ${this.renderUltimosMovimientos()}
                    </div>

                    <!-- NUEVA SECCIN DE GRFICOS -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                An谩lisis Visual en Tiempo Real
                            </h3>
                            <div class="chart-controls">
                                <select id="chartPeriod" onchange="app.updateDashboardCharts()">
                                    <option value="7">ltimos 7 d铆as</option>
                                    <option value="30" selected>ltimos 30 d铆as</option>
                                    <option value="90">ltimos 90 d铆as</option>
                                </select>
                                <button class="btn btn-secondary btn-small" onclick="app.openAlertCenter()">
                                     Alertas
                                </button>
                            </div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-card">
                                <div class="chart-title"> Estado de Potreros</div>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="occupationChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title"> Cultivos en Uso</div>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="cultivosChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title"> Movimientos por Mes</div>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="movimientosChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title">憋 D铆as de Permanencia</div>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="permanenciaChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Accesos R谩pidos -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Accesos R谩pidos
                            </h3>
                        </div>
                        <div style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <button class="btn btn-primary" onclick="app.openGlobalSearch()" style="padding: 16px;">
                                <span></span> Buscar (Ctrl+K)
                            </button>
                            <button class="btn btn-secondary" onclick="app.openAlertCenter()" style="padding: 16px;">
                                <span></span> Alertas
                            </button>
                            <button class="btn btn-secondary" onclick="app.openHistoryPanel()" style="padding: 16px;">
                                <span></span> Historial
                            </button>
                            <button class="btn btn-secondary" onclick="app.navigate('geomatica')" style="padding: 16px;">
                                <span></span> Geom谩tica
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
                
                // Renderizar gr谩ficos despu茅s de insertar el HTML
                setTimeout(() => this.renderDashboardCharts(), 100);
            },
            
            // Renderizar gr谩ficos del dashboard
            renderDashboardCharts: function() {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js no est谩 cargado');
                    return;
                }
                
                const stats = this.calculateStats();
                const finalizados = this.data.movimientos.filter(m => m.estado === 'finalizado');
                
                // Gr谩fico de ocupaci贸n (Doughnut)
                const ctxOcupacion = document.getElementById('occupationChart');
                if (ctxOcupacion) {
                    new Chart(ctxOcupacion, {
                        type: 'doughnut',
                        data: {
                            labels: ['Ocupados', 'Disponibles'],
                            datasets: [{
                                data: [stats.ocupados, stats.libres],
                                backgroundColor: ['#ef4444', '#10b981'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { padding: 15 } } }
                        }
                    });
                }
                
                // Gr谩fico de cultivos (Pie)
                const cultivosCount = {};
                this.data.movimientos.filter(m => m.estado === 'activo').forEach(m => {
                    cultivosCount[m.cultivo] = (cultivosCount[m.cultivo] || 0) + 1;
                });
                
                const ctxCultivos = document.getElementById('cultivosChart');
                if (ctxCultivos && Object.keys(cultivosCount).length > 0) {
                    new Chart(ctxCultivos, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(cultivosCount),
                            datasets: [{
                                data: Object.values(cultivosCount),
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { padding: 10, font: { size: 10 } } } }
                        }
                    });
                } else if (ctxCultivos) {
                    ctxCultivos.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--gris-500);">Sin cultivos activos</div>';
                }
                
                // Gr谩fico de movimientos por mes (Bar)
                const meses = {};
                const now = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    meses[key] = 0;
                }
                this.data.movimientos.forEach(m => {
                    const fecha = new Date(m.fechaEntrada);
                    const key = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    if (meses.hasOwnProperty(key)) meses[key]++;
                });
                
                const ctxMov = document.getElementById('movimientosChart');
                if (ctxMov) {
                    new Chart(ctxMov, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(meses).map(k => {
                                const [y, m] = k.split('-');
                                return new Date(y, m - 1).toLocaleDateString('es', { month: 'short' });
                            }),
                            datasets: [{
                                label: 'Movimientos',
                                data: Object.values(meses),
                                backgroundColor: '#2d6a4f',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                        }
                    });
                }
                
                // Gr谩fico de permanencia (Line)
                const permanencias = finalizados.slice(-10).map(m => ({
                    potrero: m.potreroId,
                    dias: m.permanencia || 0
                }));
                
                const ctxPerm = document.getElementById('permanenciaChart');
                if (ctxPerm && permanencias.length > 0) {
                    new Chart(ctxPerm, {
                        type: 'line',
                        data: {
                            labels: permanencias.map(p => p.potrero),
                            datasets: [{
                                label: 'D铆as',
                                data: permanencias.map(p => p.dias),
                                borderColor: '#d4a373',
                                backgroundColor: 'rgba(212, 163, 115, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                } else if (ctxPerm) {
                    ctxPerm.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--gris-500);">Sin datos</div>';
                }
            },
            
            updateDashboardCharts: function() {
                // Destruir gr谩ficos y volver a renderizar
                if (typeof Chart !== 'undefined') {
                    Object.values(Chart.instances || {}).forEach(c => c.destroy());
                }
                this.renderDashboardCharts();
            },

            renderPotreros: function() {
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">猴</span>
                                Lista de Potreros
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <input type="file" id="kmlPotreroInput" accept=".kml" style="display: none;" onchange="app.importarPotrerosKML(this)">
                                <button class="btn btn-secondary" onclick="document.getElementById('kmlPotreroInput').click()">
                                    <span></span> Importar KML
                                </button>
                                <button class="btn btn-primary" onclick="app.openPotreroModal()">
                                    <span></span> Nuevo Potrero
                                </button>
                            </div>
                        </div>
                        
                        ${this.data.potreros.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID Potrero</th>
                                            <th>Ubicaci贸n</th>
                                            <th>Superficie (Ha)</th>
                                            <th>GPS</th>
                                            <th>Pol铆gono</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.data.potreros.map(p => {
                                            const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                                            const tieneGPS = p.latitud && p.longitud;
                                            const tienePoligono = p.polygon && p.polygon.length > 0;
                                            const areaCalculada = tienePoligono ? this.calcularAreaPoligono(p.polygon) : null;
                                            
                                            return `
                                                <tr>
                                                    <td><strong>${p.id}</strong></td>
                                                    <td>${p.ubicacion}</td>
                                                    <td>
                                                        ${p.superficie}
                                                        ${areaCalculada ? `<br><small style="color: var(--verde-claro);"> ${areaCalculada.toFixed(2)} Ha (calculado)</small>` : ''}
                                                    </td>
                                                    <td>
                                                        ${tieneGPS ? 
                                                            '<span class="badge libre" title="Tiene coordenadas GPS"> GPS</span>' : 
                                                            '<span class="badge" style="background: rgba(200,200,200,0.2); color: #999;" title="Sin coordenadas GPS">锔 Sin GPS</span>'
                                                        }
                                                    </td>
                                                    <td>
                                                        ${tienePoligono ? 
                                                            '<span class="badge" style="background: rgba(16,185,129,0.2); color: #10b981;" title="Tiene pol铆gono definido"> Pol铆gono</span>' : 
                                                            '<span class="badge" style="background: rgba(200,200,200,0.2); color: #999;" title="Sin pol铆gono">锔 Sin Pol铆gono</span>'
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge ${ocupado ? 'ocupado' : 'libre'}">
                                                            ${ocupado ? 'Ocupado' : 'Libre'}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-secondary btn-small" onclick="app.editPotrero('${p.id}')">
                                                            锔 Editar
                                                        </button>
                                                        ${!tienePoligono ? `
                                                            <button class="btn btn-primary btn-small" onclick="app.dibujarPoligonoPotrero('${p.id}')">
                                                                猴 Dibujar
                                                            </button>
                                                        ` : `
                                                            <button class="btn btn-primary btn-small" onclick="app.verPoligonoPotrero('${p.id}')">
                                                                锔 Ver
                                                            </button>
                                                        `}
                                                        ${!ocupado ? `
                                                            <button class="btn btn-danger btn-small" onclick="app.deletePotrero('${p.id}')">
                                                                锔 Eliminar
                                                            </button>
                                                        ` : ''}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">猴</div>
                                <div class="empty-state-title">No hay potreros registrados</div>
                                <div class="empty-state-message">
                                    Puedes crear potreros manualmente o importarlos desde un archivo KML.
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                                    <button class="btn btn-primary" onclick="app.openPotreroModal()">
                                        <span></span> Crear Primer Potrero
                                    </button>
                                    <button class="btn btn-secondary" onclick="document.getElementById('kmlPotreroInput').click()">
                                        <span></span> Importar desde KML
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>

                    ${this.data.potreros.length > 0 ? `
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"></span>
                                    Gu铆a de Uso
                                </h3>
                            </div>
                            <div style="padding: 20px;">
                                <h4 style="font-weight: 700; margin-bottom: 12px;"> Importar Potreros desde KML</h4>
                                <ol style="font-size: 13px; color: var(--gris-700); line-height: 1.8; padding-left: 20px; margin-bottom: 20px;">
                                    <li>Dise帽a tus potreros en <strong>Google Earth</strong></li>
                                    <li>Dibuja pol铆gonos con los l铆mites de cada potrero</li>
                                    <li>Nombra cada pol铆gono con el ID del potrero (ej: "POT-001")</li>
                                    <li>Exporta como KML: <em>File  Save  Save Place As  KML</em></li>
                                    <li>Importa aqu铆 con el bot贸n " Importar KML"</li>
                                    <li>Los potreros se crear谩n autom谩ticamente con sus pol铆gonos</li>
                                </ol>

                                <h4 style="font-weight: 700; margin-bottom: 12px;">猴 Dibujar Pol铆gono de Potrero</h4>
                                <ol style="font-size: 13px; color: var(--gris-700); line-height: 1.8; padding-left: 20px;">
                                    <li>Crea un potrero manualmente</li>
                                    <li>Click en bot贸n "猴 Dibujar" en la tabla</li>
                                    <li>Se abre un mapa interactivo</li>
                                    <li>Dibuja el pol铆gono del potrero</li>
                                    <li>El 谩rea se calcula autom谩ticamente</li>
                                    <li>Guarda y listo</li>
                                </ol>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },

            renderMapa: function() {
                const potrerosConGPS = this.data.potreros.filter(p => p.latitud && p.longitud);
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">帮</span>
                                Vista Satelital de Potreros
                            </h3>
                            <div class="flex gap-1">
                                <input type="file" id="kmlFileInput" accept=".kml,.kmz" style="display: none;" onchange="app.importKML(this)">
                                <button class="btn btn-primary btn-small" onclick="document.getElementById('kmlFileInput').click()">
                                    <span></span> Importar KML
                                </button>
                                ${potrerosConGPS.length > 0 ? `
                                    <button class="btn btn-secondary btn-small" onclick="app.centrarMapa()">
                                        <span></span> Centrar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="position: relative;">
                            <div class="map-container" style="height: 600px; position: relative;">
                                <!-- BUSCADOR DE UBICACIONES EN MAPA SATELITAL -->
                                <div class="map-search-container" id="mapaSearchContainer">
                                    <input type="text" class="map-search-input" id="mapaSearchInput" 
                                           placeholder=" Buscar ciudad, localidad o direcci贸n..." 
                                           onkeypress="if(event.key==='Enter') app.searchLocationMapa()">
                                    <button class="map-search-btn" onclick="app.searchLocationMapa()" title="Buscar ubicaci贸n">
                                        <i class="fa-solid fa-search"></i>
                                    </button>
                                    <div class="map-search-results" id="mapaSearchResults"></div>
                                </div>
                                <div id="mapView"></div>
                            </div>
                            
                            ${potrerosConGPS.length > 0 ? `
                                <div class="map-legend">
                                    <h4 style="font-weight: 700; margin-bottom: 12px; font-size: 14px;">Leyenda</h4>
                                    <div class="legend-item">
                                        <div class="legend-marker libre"></div>
                                        <span>Potrero Libre</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-marker ocupado"></div>
                                        <span>Potrero Ocupado</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${potrerosConGPS.length > 0 ? `
                            <div style="padding: 20px; background: var(--gris-100); border-radius: 0 0 16px 16px;">
                                <h4 style="font-weight: 700; margin-bottom: 12px;">Potreros en el Mapa (${potrerosConGPS.length})</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                                    ${potrerosConGPS.map(p => {
                                        const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                                        return `
                                            <div class="stat-mini">
                                                <div class="stat-mini-icon" style="background: ${ocupado ? 'var(--rojo)' : 'var(--verde)'}; color: white;">
                                                    ${ocupado ? '' : ''}
                                                </div>
                                                <div class="stat-mini-content">
                                                    <div class="stat-mini-label">${p.ubicacion}</div>
                                                    <div class="stat-mini-value">${p.id}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="padding: 24px;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">猴</div>
                                    <div class="empty-state-title">Sin Coordenadas GPS</div>
                                    <div class="empty-state-message">
                                        Para visualizar potreros en el mapa satelital, tienes dos opciones:
                                    </div>
                                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                                        <button class="btn btn-primary" onclick="app.navigate('potreros')">
                                            <span>猴</span> Agregar GPS a Potreros
                                        </button>
                                        <button class="btn btn-secondary" onclick="document.getElementById('kmlFileInput').click()">
                                            <span></span> Importar KML
                                        </button>
                                    </div>
                                    <div style="margin-top: 24px; padding: 16px; background: var(--verde-muy-claro); border-radius: 10px; font-size: 13px; color: var(--gris-700); text-align: left;">
                                        <strong> 驴C贸mo obtener coordenadas GPS?</strong><br><br>
                                        1. Abre Google Maps<br>
                                        2. Busca la ubicaci贸n del potrero<br>
                                        3. Click derecho en el punto exacto<br>
                                        4. Selecciona "驴Qu茅 hay aqu铆?"<br>
                                        5. Copia las coordenadas que aparecen<br>
                                        6. P茅galas en los campos Latitud y Longitud al editar el potrero
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
                
                // Inicializar mapa siempre (con o sin potreros)
                setTimeout(() => {
                    this.initMapaCompleto();
                }, 100);
            },

            initMapaCompleto: function() {
                // Destruir mapa existente si hay
                if (this.mapa) {
                    this.mapa.remove();
                    this.mapa = null;
                }

                const potrerosConGPS = this.data.potreros.filter(p => p.latitud && p.longitud);
                
                // Centro inicial - Venezuela si no hay potreros
                let centerLat = 8.5;
                let centerLng = -67.5;
                let initialZoom = 7;

                // Si hay potreros con GPS, centrar en ellos
                if (potrerosConGPS.length > 0) {
                    let latSum = 0, lngSum = 0;
                    potrerosConGPS.forEach(p => {
                        latSum += parseFloat(p.latitud);
                        lngSum += parseFloat(p.longitud);
                    });
                    centerLat = latSum / potrerosConGPS.length;
                    centerLng = lngSum / potrerosConGPS.length;
                    initialZoom = 13;
                }

                // Crear mapa con capas base
                this.mapa = L.map('mapView').setView([centerLat, centerLng], initialZoom);

                // Capas satelitales
                const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 19
                });

                const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                });

                const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                });

                // Capa de etiquetas
                const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors, &copy; CARTO',
                    maxZoom: 19
                });

                // Agregar capa por defecto
                googleHybrid.addTo(this.mapa);
                labels.addTo(this.mapa);

                // Control de capas
                const baseMaps = {
                    "帮 Google H铆brido": googleHybrid,
                    "帮 Google Sat茅lite": googleSat,
                    "帮 Esri Sat茅lite": esriSat
                };

                const overlays = {
                    " Etiquetas": labels
                };

                L.control.layers(baseMaps, overlays).addTo(this.mapa);

                // Inicializar capa para elementos dibujados
                if (!this.drawnItems) {
                    this.drawnItems = new L.FeatureGroup();
                }
                this.mapa.addLayer(this.drawnItems);

                // Controles de dibujo
                const drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polygon: {
                            shapeOptions: {
                                color: '#00a67d',
                                weight: 3
                            },
                            allowIntersection: false,
                            showArea: true
                        },
                        polyline: {
                            shapeOptions: {
                                color: '#ffb347',
                                weight: 4
                            }
                        },
                        marker: true,
                        circle: false,
                        rectangle: true,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: this.drawnItems,
                        remove: true
                    }
                });
                this.mapa.addControl(drawControl);

                // Eventos de dibujo
                this.mapa.on(L.Draw.Event.CREATED, (e) => {
                    const layer = e.layer;
                    
                    if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                        // Calcular 谩rea geod茅sica
                        const latlngs = layer.getLatLngs()[0];
                        let area = 0;
                        
                        // Usar f贸rmula de 谩rea geod茅sica simple
                        for (let i = 0; i < latlngs.length; i++) {
                            const j = (i + 1) % latlngs.length;
                            area += latlngs[i].lng * latlngs[j].lat;
                            area -= latlngs[j].lng * latlngs[i].lat;
                        }
                        area = Math.abs(area / 2.0);
                        
                        // Convertir de grados cuadrados a metros cuadrados aproximadamente
                        // Factor aproximado: 1 grado虏  12321 km虏 a latitud 10掳
                        const areaM2 = area * 12321000000 * Math.cos(latlngs[0].lat * Math.PI / 180);
                        const areaHa = (areaM2 / 10000).toFixed(2);
                        
                        layer.bindPopup(`<strong>rea:</strong> ${areaHa} Ha<br><small>(${areaM2.toFixed(0)} m虏)</small>`);
                    }
                    
                    if (e.layerType === 'polyline') {
                        const latlngs = layer.getLatLngs();
                        let totalDist = 0;
                        for (let i = 0; i < latlngs.length - 1; i++) {
                            totalDist += latlngs[i].distanceTo(latlngs[i + 1]);
                        }
                        layer.bindPopup(`<strong>Distancia:</strong> ${totalDist.toFixed(2)} m`);
                    }
                    
                    if (e.layerType === 'marker') {
                        const latlng = layer.getLatLng();
                        layer.bindPopup(`<strong>Punto GPS</strong><br>Lat: ${latlng.lat.toFixed(6)}<br>Lng: ${latlng.lng.toFixed(6)}`);
                    }
                    
                    this.drawnItems.addLayer(layer);
                });

                // Agregar marcadores y pol铆gonos de potreros si existen
                if (potrerosConGPS.length > 0) {
                    potrerosConGPS.forEach(p => {
                        const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                        const iconColor = ocupado ? '#ef4444' : '#10b981';
                        
                        // Si tiene pol铆gono, dibujarlo
                        if (p.polygon && p.polygon.length > 0) {
                            const polygon = L.polygon(p.polygon, {
                                color: iconColor,
                                weight: 3,
                                fillOpacity: 0.2,
                                fillColor: iconColor
                            }).addTo(this.mapa);
                            
                            // Popup para el pol铆gono
                            let popupContent = `
                                <div class="popup-content">
                                    <div class="popup-title">${p.id}</div>
                                    <div class="popup-info"><strong> Ubicaci贸n:</strong> ${p.ubicacion}</div>
                                    <div class="popup-info"><strong> Superficie:</strong> ${p.superficie} Ha</div>
                                    <div class="popup-info"><strong> V茅rtices:</strong> ${p.polygon.length}</div>
                            `;
                            
                            if (ocupado) {
                                const dias = this.calcularDias(ocupado.fechaEntrada);
                                popupContent += `
                                    <div class="popup-info"><strong> Cultivo:</strong> ${ocupado.cultivo}</div>
                                    <div class="popup-info"><strong> Entrada:</strong> ${this.formatDate(ocupado.fechaEntrada)}</div>
                                    <div class="popup-info"><strong>憋 D铆as:</strong> ${dias} d铆as</div>
                                    <span class="popup-badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">OCUPADO</span>
                                `;
                            } else {
                                popupContent += `
                                    <span class="popup-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">DISPONIBLE</span>
                                `;
                            }
                            
                            popupContent += `</div>`;
                            polygon.bindPopup(popupContent);
                        }
                        
                        // Siempre agregar marcador en el centro (incluso si tiene pol铆gono)
                        const icon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                background: ${iconColor};
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                border: 4px solid white;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 16px;
                                color: white;
                                font-weight: bold;
                            ">${ocupado ? '' : ''}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });

                        const marker = L.marker([p.latitud, p.longitud], { icon: icon }).addTo(this.mapa);

                        let popupContent = `
                            <div class="popup-content">
                                <div class="popup-title">${p.id}</div>
                                <div class="popup-info"><strong> Ubicaci贸n:</strong> ${p.ubicacion}</div>
                                <div class="popup-info"><strong> Superficie:</strong> ${p.superficie} Ha</div>
                        `;
                        
                        if (p.polygon && p.polygon.length > 0) {
                            popupContent += `<div class="popup-info"><strong> Pol铆gono:</strong> ${p.polygon.length} v茅rtices</div>`;
                        }

                        if (ocupado) {
                            const dias = this.calcularDias(ocupado.fechaEntrada);
                            popupContent += `
                                <div class="popup-info"><strong> Cultivo:</strong> ${ocupado.cultivo}</div>
                                <div class="popup-info"><strong> Entrada:</strong> ${this.formatDate(ocupado.fechaEntrada)}</div>
                                <div class="popup-info"><strong>憋 D铆as:</strong> ${dias} d铆as</div>
                                <span class="popup-badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">OCUPADO</span>
                            `;
                        } else {
                            popupContent += `
                                <span class="popup-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">DISPONIBLE</span>
                            `;
                        }

                        popupContent += `</div>`;
                        marker.bindPopup(popupContent);
                    });

                    // Ajustar vista para mostrar todos los potreros
                    if (potrerosConGPS.length > 1) {
                        const bounds = L.latLngBounds(potrerosConGPS.map(p => [p.latitud, p.longitud]));
                        this.mapa.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            },

            importKML: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const kmlText = e.target.result;
                        const parser = new DOMParser();
                        const kml = parser.parseFromString(kmlText, 'text/xml');
                        
                        // Parsear coordenadas de placemarks
                        const placemarks = kml.getElementsByTagName('Placemark');
                        let featuresAdded = 0;
                        
                        for (let i = 0; i < placemarks.length; i++) {
                            const placemark = placemarks[i];
                            
                            // Intentar obtener el nombre
                            const nameEl = placemark.getElementsByTagName('name')[0];
                            const nombre = nameEl ? nameEl.textContent : `Elemento ${i+1}`;
                            
                            const coords = placemark.getElementsByTagName('coordinates')[0];
                            
                            if (!coords) continue;
                            
                            const coordsText = coords.textContent.trim();
                            const points = coordsText.split(/\s+/);
                            const latlngs = [];
                            
                            points.forEach(point => {
                                const parts = point.split(',');
                                if (parts.length >= 2) {
                                    const lng = parseFloat(parts[0]);
                                    const lat = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        latlngs.push([lat, lng]);
                                    }
                                }
                            });
                            
                            if (latlngs.length > 0) {
                                let layer;
                                
                                // Determinar si es pol铆gono o l铆nea
                                if (latlngs.length > 2 && latlngs[0][0] === latlngs[latlngs.length-1][0] && 
                                    latlngs[0][1] === latlngs[latlngs.length-1][1]) {
                                    // Es un pol铆gono
                                    layer = L.polygon(latlngs, {
                                        color: '#00a67d',
                                        weight: 3,
                                        fillOpacity: 0.2
                                    });
                                    
                                    // Calcular 谩rea aproximada
                                    let area = 0;
                                    for (let k = 0; k < latlngs.length - 1; k++) {
                                        const j = (k + 1) % latlngs.length;
                                        area += latlngs[k][1] * latlngs[j][0];
                                        area -= latlngs[j][1] * latlngs[k][0];
                                    }
                                    area = Math.abs(area / 2.0);
                                    const areaM2 = area * 12321000000 * Math.cos(latlngs[0][0] * Math.PI / 180);
                                    const areaHa = (areaM2 / 10000).toFixed(2);
                                    
                                    layer.bindPopup(`<strong>${nombre}</strong><br>rea: ${areaHa} Ha`);
                                } else {
                                    // Es una l铆nea
                                    layer = L.polyline(latlngs, {
                                        color: '#ffb347',
                                        weight: 4
                                    });
                                    
                                    let totalDist = 0;
                                    for (let j = 0; j < latlngs.length - 1; j++) {
                                        totalDist += L.latLng(latlngs[j]).distanceTo(L.latLng(latlngs[j + 1]));
                                    }
                                    layer.bindPopup(`<strong>${nombre}</strong><br>Distancia: ${totalDist.toFixed(2)} m`);
                                }
                                
                                this.drawnItems.addLayer(layer);
                                featuresAdded++;
                            }
                        }
                        
                        if (featuresAdded > 0) {
                            this.notify('success', 'KML Importado', `${featuresAdded} elemento(s) agregado(s) al mapa`);
                            this.mapa.fitBounds(this.drawnItems.getBounds());
                        } else {
                            this.notify('warning', 'Sin Datos', 'No se encontraron elementos v谩lidos en el KML');
                        }
                        
                    } catch (error) {
                        console.error('Error importando KML:', error);
                        this.notify('error', 'Error de Importaci贸n', 'El archivo KML no pudo ser procesado correctamente');
                    }
                };
                
                reader.readAsText(file);
                input.value = ''; // Reset input
            },

            centrarMapa: function() {
                if (this.mapa) {
                    const potrerosConGPS = this.data.potreros.filter(p => p.latitud && p.longitud);
                    if (potrerosConGPS.length > 0) {
                        const bounds = L.latLngBounds(potrerosConGPS.map(p => [p.latitud, p.longitud]));
                        this.mapa.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            },

            renderGeomatics: function() {
                const potrerosConGPS = this.data.potreros.filter(p => p.latitud && p.longitud);
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">Л</span>
                                WIN-TEL GEOMATICS PRO v26
                            </h3>
                        </div>
                        
                        <div style="padding: 24px;">
                            <div style="background: linear-gradient(135deg, #0a0f1c 0%, #151921 100%); padding: 32px; border-radius: 16px; text-align: center; color: white; margin-bottom: 32px; border: 1px solid rgba(16, 211, 147, 0.3);">
                                <div style="font-size: 56px; margin-bottom: 16px;">猴</div>
                                <h2 style="font-size: 28px; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, #10d393, #34eab0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">WIN-TEL GEOMATICS PRO</h2>
                                <p style="font-size: 14px; color: #94a3b8; margin-bottom: 24px;">Sistema Profesional de Geom谩tica y Topograf铆a Integrado</p>
                                
                                <button class="btn" style="background: linear-gradient(135deg, #10d393, #059669); padding: 18px 40px; font-size: 16px; border-radius: 12px;" onclick="app.openGeomaticsFullscreen()">
                                    <span style="font-size: 20px;"></span> ABRIR GEOMATICS PRO
                                </button>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; border-left: 4px solid #10d393;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">锔</div>
                                    <h4 style="font-weight: 700; margin-bottom: 8px;">Subdivisi贸n Inteligente</h4>
                                    <p style="font-size: 12px; color: var(--gris-600);">PRV paralelas, grilla, bisecci贸n, divisi贸n radial y OMEGA SLICER con preview en tiempo real</p>
                                </div>

                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">М</div>
                                    <h4 style="font-weight: 700; margin-bottom: 8px;">Topograf铆a Profesional</h4>
                                    <p style="font-size: 12px; color: var(--gris-600);">UTM/Geogr谩ficas, rumbos, azimuts, v茅rtices, distancias y c谩lculo de cercas</p>
                                </div>

                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                                    <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                    <h4 style="font-weight: 700; margin-bottom: 8px;">An谩lisis Solar</h4>
                                    <p style="font-size: 12px; color: var(--gris-600);">Trayectoria del sol, sombras y orientaci贸n 贸ptima de construcciones</p>
                                </div>

                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">帮</div>
                                    <h4 style="font-weight: 700; margin-bottom: 8px;">OMEGA SAT</h4>
                                    <p style="font-size: 12px; color: var(--gris-600);">Im谩genes satelitales Sentinel-2 con filtro de nubes</p>
                                </div>

                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                                    <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                    <h4 style="font-weight: 700; margin-bottom: 8px;">OMEGA RADAR</h4>
                                    <p style="font-size: 12px; color: var(--gris-600);">Escaneo de servicios urbanos cercanos v铆a OpenStreetMap</p>
                                </div>

                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; border-left: 4px solid #06b6d4;">
                                    <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                    <h4 style="font-weight: 700; margin-bottom: 8px;">Multi-Exportaci贸n</h4>
                                    <p style="font-size: 12px; color: var(--gris-600);">PDF, DXF, KML, GeoJSON, CSV, GPX y Memorial Descriptivo</p>
                                </div>
                            </div>

                            ${potrerosConGPS.length > 0 ? `
                                <div style="background: var(--verde-muy-claro); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid var(--verde-claro);">
                                    <h4 style="font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span></span>
                                        <span>Potreros con Coordenadas GPS (${potrerosConGPS.length})</span>
                                    </h4>
                                    <p style="font-size: 13px; color: var(--gris-700); margin-bottom: 16px;">
                                        Puedes exportar tus potreros como GeoJSON e importarlos en Geomatics PRO para an谩lisis avanzado.
                                    </p>
                                    <button class="btn btn-success" onclick="app.exportPotrerosToGeoJSON()">
                                        <span></span> Exportar Potreros como GeoJSON
                                    </button>
                                </div>
                            ` : `
                                <div style="background: var(--gris-100); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                    <p style="font-size: 13px; color: var(--gris-600);">
                                         <strong>Tip:</strong> Agrega coordenadas GPS a tus potreros para exportarlos y analizarlos en Geomatics PRO.
                                    </p>
                                </div>
                            `}

                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="app.openGeomaticsFullscreen()" style="flex: 1; min-width: 200px;">
                                    <span>ワ</span> Abrir en Pantalla Completa
                                </button>
                                <button class="btn btn-secondary" onclick="app.openGeomaticsNewTab()" style="flex: 1; min-width: 200px;">
                                    <span></span> Abrir en Nueva Pesta帽a
                                </button>
                                <button class="btn btn-secondary" onclick="app.downloadGeomaticsGuide()" style="flex: 1; min-width: 200px;">
                                    <span></span> Descargar Gu铆a
                                </button>
                            </div>

                            <div style="margin-top: 32px; padding: 20px; background: linear-gradient(135deg, rgba(16, 211, 147, 0.05), rgba(59, 130, 246, 0.05)); border-radius: 12px; border: 1px solid rgba(16, 211, 147, 0.2);">
                                <h4 style="font-weight: 700; margin-bottom: 12px; color: #10d393;"> Casos de Uso para Ganader铆a</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; font-size: 13px; color: var(--gris-700);">
                                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                                        <span></span>
                                        <span><strong>Subdivisi贸n PRV:</strong> Divide potreros grandes en parcelas exactas para rotaci贸n</span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                                        <span></span>
                                        <span><strong>C谩lculo de Cercas:</strong> Metros de alambre y cantidad de postes necesarios</span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                                        <span></span>
                                        <span><strong>Divisi贸n Radial:</strong> Parcelas en forma de "quesitos" para pastoreo rotativo</span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                                        <span></span>
                                        <span><strong>An谩lisis Solar:</strong> Orientaci贸n 贸ptima para construcciones y bebederos</span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                                        <span></span>
                                        <span><strong>Buffer de Protecci贸n:</strong> Zonas de exclusi贸n cerca de cuerpos de agua</span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                                        <span></span>
                                        <span><strong>Exportaci贸n CAD:</strong> Exporta dise帽os a DXF para AutoCAD</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },

            // Abrir Geomatics en pantalla completa dentro de Nexus Agro
            openGeomaticsFullscreen: function() {
                // Crear contenedor fullscreen con iframe
                const container = document.createElement('div');
                container.className = 'geomatics-fullscreen';
                container.id = 'geomaticsFullscreen';
                
                container.innerHTML = `
                    <div class="geomatics-toolbar">
                        <div class="geomatics-toolbar-left">
                            <div class="geomatics-toolbar-logo">
                                <div class="geomatics-toolbar-logo-icon">Л</div>
                                <div>
                                    <div class="geomatics-toolbar-title">WIN-TEL GEOMATICS PRO</div>
                                    <div class="geomatics-toolbar-subtitle">Sistema Profesional de Geom谩tica</div>
                                </div>
                            </div>
                            <div class="geomatics-toolbar-badge">v26 INTEGRADO</div>
                        </div>
                        <button class="geomatics-close-btn" onclick="app.closeGeomaticsFullscreen()">
                            <span></span> Volver a Nexus Agro
                        </button>
                    </div>
                    <div class="geomatics-iframe-container">
                        <div class="geomatics-loading" id="geomaticsLoading">
                            <div class="geomatics-spinner"></div>
                            <div class="geomatics-loading-text">Cargando WIN-TEL GEOMATICS PRO...</div>
                        </div>
                        <iframe 
                            class="geomatics-iframe" 
                            id="geomaticsIframe"
                            src="Wintel-Geomatics-Pro-v25-Chatbot.html"
                            onload="app.onGeomaticsLoad()"
                            onerror="app.onGeomaticsError()"
                        ></iframe>
                    </div>
                `;
                
                document.body.appendChild(container);
                
                // Prevenir scroll del body
                document.body.style.overflow = 'hidden';
                
                this.notify('success', 'Geomatics PRO', 'Cargando sistema geom谩tico...');
            },
            
            // Cerrar Geomatics fullscreen
            closeGeomaticsFullscreen: function() {
                const container = document.getElementById('geomaticsFullscreen');
                if (container) {
                    container.remove();
                    document.body.style.overflow = '';
                    this.notify('info', 'Geomatics Cerrado', 'Has vuelto a Nexus Agro');
                }
            },
            
            // Callback cuando el iframe carga
            onGeomaticsLoad: function() {
                const loading = document.getElementById('geomaticsLoading');
                if (loading) {
                    loading.style.display = 'none';
                }
            },
            
            // Callback si hay error al cargar
            onGeomaticsError: function() {
                const loading = document.getElementById('geomaticsLoading');
                if (loading) {
                    loading.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 16px;">锔</div>
                        <div style="color: #f87171; font-size: 16px; font-weight: 700; margin-bottom: 8px;">Error al cargar Geomatics</div>
                        <div style="color: #94a3b8; font-size: 13px; margin-bottom: 20px;">
                            Aseg煤rate de que el archivo <strong>Wintel-Geomatics-Pro-v25-Chatbot.html</strong><br>
                            est茅 en la misma carpeta que Nexus Agro
                        </div>
                        <button class="btn" style="background: linear-gradient(135deg, #10d393, #059669);" onclick="app.closeGeomaticsFullscreen()">
                            Volver a Nexus Agro
                        </button>
                    `;
                }
            },
            
            // Abrir Geomatics en nueva pesta帽a
            openGeomaticsNewTab: function() {
                const win = window.open('Wintel-Geomatics-Pro-v25-Chatbot.html', '_blank');
                
                if (!win) {
                    this.notify('error', 'Ventana Bloqueada', 'Tu navegador bloque贸 la ventana emergente. Permite ventanas emergentes para este sitio.');
                } else {
                    this.notify('success', 'Abriendo Geomatics', 'WIN-TEL GEOMATICS PRO se abri贸 en nueva pesta帽a');
                }
            },

            openGeomatics: function() {
                // Funci贸n legacy - redirige a fullscreen
                this.openGeomaticsFullscreen();
            },

            exportPotrerosToGeoJSON: function() {
                const potrerosConGPS = this.data.potreros.filter(p => p.latitud && p.longitud);
                
                if (potrerosConGPS.length === 0) {
                    this.notify('warning', 'Sin Datos GPS', 'No hay potreros con coordenadas GPS para exportar');
                    return;
                }

                const geojson = {
                    type: "FeatureCollection",
                    features: potrerosConGPS.map(p => ({
                        type: "Feature",
                        properties: {
                            id: p.id,
                            nombre: p.id,
                            ubicacion: p.ubicacion,
                            superficie: p.superficie,
                            estado: this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo') ? 'ocupado' : 'libre'
                        },
                        geometry: {
                            type: "Point",
                            coordinates: [parseFloat(p.longitud), parseFloat(p.latitud)]
                        }
                    }))
                };

                const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'potreros_nexus_agro.geojson';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.notify('success', 'Exportado', 'Archivo GeoJSON descargado. Ahora puedes importarlo en WIN-TEL GEOMATICS PRO');
            },

            downloadGeomaticsGuide: function() {
                const guide = `# GUA DE USO: WIN-TEL GEOMATICS PRO v26
# Integrado con NEXUS AGRO v3.0

## ACCESO AL SISTEMA

Desde Nexus Agro puedes acceder a Geomatics PRO de dos formas:

1. **Pantalla Completa (Recomendado)**: Se abre dentro de Nexus Agro en un iframe fullscreen
2. **Nueva Pesta帽a**: Se abre en una pesta帽a separada del navegador

### REQUISITO IMPORTANTE:
El archivo "Wintel-Geomatics-Pro-v25-Chatbot.html" debe estar en la misma carpeta que Nexus Agro.

---

## CARACTERSTICAS PRINCIPALES:

### 1. SUBDIVISIN DE TERRENOS
   - PRV Paralelas: Divisi贸n con l铆neas paralelas
   - Grilla: Divisi贸n en cuadr铆cula con vialidades
   - Bisecci贸n: Corte en 谩rea espec铆fica
   - OMEGA SLICER: Divisi贸n din谩mica con preview en tiempo real

### 2. DIVISIN RADIAL
   - Crear parcelas en forma de "quesitos"
   - Ideal para pastoreo rotativo
   - Hub central ajustable

### 3. HERRAMIENTAS TOPOGRFICAS
   - Tabla de v茅rtices (Lat/Lon y UTM)
   - C谩lculo de rumbos y azimuts
   - Distancias geod茅sicas exactas
   - Buffer de protecci贸n
   - C谩lculo de cercas y postes

### 4. ANLISIS SOLAR
   - Trayectoria del sol
   - An谩lisis por fecha y hora
   - Orientaci贸n 贸ptima

### 5. OMEGA RADAR
   - Escaneo de servicios urbanos cercanos
   - Educaci贸n, salud, comercio, parques
   - Datos de OpenStreetMap

### 6. OMEGA SAT
   - B煤squeda de im谩genes Sentinel-2
   - Filtro por cobertura de nubes
   - Visor integrado

### 7. MEMORIAL DESCRIPTIVO
   - Generaci贸n autom谩tica de memorial
   - Formato profesional para agrimensura
   - Exportaci贸n a PDF

### 8. EXPORTACIN
   - PDF con planos
   - DXF para AutoCAD
   - KML para Google Earth
   - GeoJSON para QGIS
   - CSV para Excel
   - GPX para GPS

---

## WORKFLOW RECOMENDADO PARA GANADERA:

1. Exporta tus potreros desde NEXUS AGRO como GeoJSON
2. Abre WIN-TEL GEOMATICS PRO (bot贸n "Pantalla Completa")
3. Importa el GeoJSON en Geomatics
4. Usa las herramientas de subdivisi贸n seg煤n necesites
5. Calcula botalones y cercas
6. Exporta el resultado final (PDF, DXF, KML)
7. Cierra Geomatics para volver a Nexus Agro

---

## ATAJOS DE TECLADO:

- Ctrl+Z: Deshacer
- Ctrl+Y: Rehacer
- ESC: Cerrar paneles

---

## TIPS:

- El sistema guarda autom谩ticamente tu proyecto
- Puedes cambiar entre tema oscuro y pastel
- Las coordenadas se muestran en tiempo real
- Todas las medidas usan el elipsoide WGS84
- Para Venezuela occidental usa zona UTM 19N

---

漏 2026 WindowsTelecom C.A. - Arquitectos de Infraestructura Digital
CEO: Joseph Castillo | Valencia, Carabobo, Venezuela
 windowstelecom@gmail.com |  +58 412-4060610
Sistema integrado NEXUS AGRO v4.0 + WIN-TEL GEOMATICS PRO v26`;

                const blob = new Blob([guide], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'guia_geomatics_nexus_agro_v3.md';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.notify('success', 'Gu铆a Descargada', 'Archivo de gu铆a guardado exitosamente');
            },

            renderMovimientos: function() {
                const html = `
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-success" onclick="app.openModal('modalEntrada')">
                            <span>★</span> Registrar Entrada
                        </button>
                        <button class="btn btn-primary" onclick="app.openModal('modalSalida')">
                            <span>猬锔</span> Registrar Salida
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Movimientos Activos
                            </h3>
                        </div>
                        ${this.renderMovimientosActivos()}
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Historial Reciente
                            </h3>
                        </div>
                        ${this.renderUltimosMovimientos()}
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },

            renderRegistros: function() {
                const finalizados = this.data.movimientos
                    .filter(m => m.estado === 'finalizado')
                    .sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida));

                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Historial Completo de Movimientos
                            </h3>
                            <button class="btn btn-primary btn-small" onclick="app.navigate('exportar')">
                                <span></span> Exportar
                            </button>
                        </div>
                        
                        ${finalizados.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Potrero</th>
                                            <th>Cultivo</th>
                                            <th>F. Entrada</th>
                                            <th>F. Salida</th>
                                            <th>Permanencia</th>
                                            <th>Mat. Verde Entrada</th>
                                            <th>Mat. Verde Salida</th>
                                            <th>Consumo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${finalizados.map(mov => {
                                            const consumo = (mov.matVerdeEntrada || 0) - (mov.matVerdeSalida || 0);
                                            return `
                                                <tr>
                                                    <td><strong>${mov.potreroId}</strong></td>
                                                    <td>${mov.cultivo}</td>
                                                    <td>${this.formatDate(mov.fechaEntrada)}</td>
                                                    <td>${this.formatDate(mov.fechaSalida)}</td>
                                                    <td><strong>${mov.permanencia}</strong> d铆as</td>
                                                    <td>${mov.matVerdeEntrada || '-'}</td>
                                                    <td>${mov.matVerdeSalida || '-'}</td>
                                                    <td>${consumo > 0 ? consumo.toFixed(0) : '-'} kg/ha</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-title">No hay registros hist贸ricos</div>
                                <div class="empty-state-message">Cuando complete movimientos, aparecer谩n aqu铆.</div>
                            </div>
                        `}
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },

            renderReportes: function() {
                const stats = this.calculateAdvancedStats();
                
                const html = `
                    <div class="kpi-grid">
                        <div class="kpi-card azul">
                            <div class="kpi-header">
                                <span class="kpi-label">Movimientos Totales</span>
                                <div class="kpi-icon"></div>
                            </div>
                            <div class="kpi-value">${stats.totalMovimientos}</div>
                        </div>
                        <div class="kpi-card verde">
                            <div class="kpi-header">
                                <span class="kpi-label">Prom. Permanencia</span>
                                <div class="kpi-icon">憋</div>
                            </div>
                            <div class="kpi-value">${stats.promedioPermanencia}</div>
                            <div class="kpi-trend neutral">d铆as</div>
                        </div>
                        <div class="kpi-card dorado">
                            <div class="kpi-header">
                                <span class="kpi-label">Consumo Promedio</span>
                                <div class="kpi-icon"></div>
                            </div>
                            <div class="kpi-value">${stats.consumoPromedio}</div>
                            <div class="kpi-trend neutral">kg/ha</div>
                        </div>
                        <div class="kpi-card rojo">
                            <div class="kpi-header">
                                <span class="kpi-label">Tasa de Uso</span>
                                <div class="kpi-icon"></div>
                            </div>
                            <div class="kpi-value">${stats.tasaUso}%</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                An谩lisis por Potrero
                            </h3>
                        </div>
                        ${this.renderAnalisisPorPotrero()}
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                An谩lisis por Tipo de Cultivo
                            </h3>
                        </div>
                        ${this.renderAnalisisPorCultivo()}
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },

            // ========================================
            //  SISTEMA DE FOTOGRAFAS GEOLOCALIZADAS
            // ========================================
            
            // ========================================
            //  SISTEMA DE ROTACIN INTELIGENTE PRV
            // ========================================
            
            // Configuraci贸n PRV por defecto
            prvConfig: {
                diasOcupacion: 3,        // D铆as que el ganado ocupa un potrero
                diasDescanso: 30,        // D铆as de descanso entre ocupaciones
                diasAlerta: 7,           // D铆as antes de vencer el descanso para alertar
                numPotreros: 0,          // Se calcula autom谩ticamente
                cicloRotacion: 0         // Se calcula: diasOcupacion * numPotreros
            },
            
            prvCurrentTab: 'gantt',
            prvCalendarMonth: new Date(),
            prvPlanificaciones: [],
            
            // ========================================
            //  GENERADOR DE REPORTES PDF PROFESIONALES
            // ========================================
            
            selectedReportType: 'mensual',
            reportConfig: {
                incluirResumen: true,
                incluirPotreros: true,
                incluirMovimientos: true,
                incluirGraficos: true,
                incluirPRV: true,
                incluirFotos: false,
                periodo: 'mensual',
                fechaInicio: null,
                fechaFin: null
            },
            reportHistory: [],
            
            // ========================================
            // ★ SISTEMA DE CLIMA EN TIEMPO REAL
            // ========================================
            
            weatherData: null,
            weatherForecast: null,
            weatherLocation: null,
            weatherHistory: [],
            
            // ========================================
            //  CALCULADORA DE CARGA ANIMAL
            // ========================================
            
            calcCurrentTab: 'carga',
            calcData: {
                // Categor铆as de ganado con equivalencia UGM
                categorias: {
                    vacas: { nombre: 'Vacas adultas', ugm: 1.0, cantidad: 0, pesoPromedio: 450 },
                    toros: { nombre: 'Toros', ugm: 1.3, cantidad: 0, pesoPromedio: 600 },
                    novillos: { nombre: 'Novillos (1-2 a帽os)', ugm: 0.7, cantidad: 0, pesoPromedio: 300 },
                    novillas: { nombre: 'Novillas (1-2 a帽os)', ugm: 0.7, cantidad: 0, pesoPromedio: 280 },
                    terneros: { nombre: 'Terneros (<1 a帽o)', ugm: 0.4, cantidad: 0, pesoPromedio: 150 },
                    terneras: { nombre: 'Terneras (<1 a帽o)', ugm: 0.35, cantidad: 0, pesoPromedio: 130 }
                },
                // Par谩metros de pastura
                superficie: 0, // hect谩reas
                produccionMS: 3000, // kg MS/ha/a帽o
                utilizacion: 60, // % de utilizaci贸n
                consumoMS: 2.5, // % del peso vivo
                // poca
                epoca: 'lluvias' // lluvias o seca
            },
            
            // ========================================
            //  INVENTARIO DE GANADO
            // ========================================
            
            ganadoViewMode: 'tabla', // tabla o cards
            ganadoFilter: {
                categoria: '',
                estado: '',
                potrero: '',
                busqueda: '',
                especie: ''
            },
            
            // Configuraci贸n de ESPECIES
            especiesConfig: {
                bovinos: { 
                    nombre: 'Bovinos', 
                    emoji: '', 
                    enabled: true,
                    color: '#92400e',
                    categorias: ['vaca', 'toro', 'novillo', 'novilla', 'ternero', 'ternera']
                },
                ovinos: { 
                    nombre: 'Ovinos', 
                    emoji: '', 
                    enabled: true,
                    color: '#6b7280',
                    categorias: ['oveja', 'carnero', 'cordero', 'cordera', 'borrego']
                },
                caprinos: { 
                    nombre: 'Caprinos', 
                    emoji: '', 
                    enabled: true,
                    color: '#c2410c',
                    categorias: ['cabra', 'chivo', 'cabrito', 'cabrita']
                },
                equinos: { 
                    nombre: 'Equinos', 
                    emoji: '', 
                    enabled: false,
                    color: '#3b82f6',
                    categorias: ['yegua', 'caballo', 'potro', 'potra', 'burro', 'mula']
                },
                porcinos: { 
                    nombre: 'Porcinos', 
                    emoji: '', 
                    enabled: false,
                    color: '#ec4899',
                    categorias: ['cerda', 'verraco', 'lechon', 'cerdo_engorde']
                },
                aves: { 
                    nombre: 'Aves', 
                    emoji: '', 
                    enabled: false,
                    color: '#eab308',
                    categorias: ['gallina', 'gallo', 'pollo', 'pato', 'pavo']
                }
            },
            
            // Configuraci贸n de categor铆as por especie con UGM
            ganadoCategorias: {
                // BOVINOS
                vaca: { nombre: 'Vaca', emoji: '', ugm: 1.0, color: '#fef3c7', especie: 'bovinos' },
                toro: { nombre: 'Toro', emoji: '', ugm: 1.3, color: '#fee2e2', especie: 'bovinos' },
                novillo: { nombre: 'Novillo', emoji: '', ugm: 0.7, color: '#dbeafe', especie: 'bovinos' },
                novilla: { nombre: 'Novilla', emoji: '', ugm: 0.7, color: '#fce7f3', especie: 'bovinos' },
                ternero: { nombre: 'Ternero', emoji: '', ugm: 0.4, color: '#d1fae5', especie: 'bovinos' },
                ternera: { nombre: 'Ternera', emoji: '', ugm: 0.35, color: '#ede9fe', especie: 'bovinos' },
                // OVINOS
                oveja: { nombre: 'Oveja', emoji: '', ugm: 0.15, color: '#f3f4f6', especie: 'ovinos' },
                carnero: { nombre: 'Carnero', emoji: '', ugm: 0.18, color: '#e5e7eb', especie: 'ovinos' },
                cordero: { nombre: 'Cordero', emoji: '', ugm: 0.08, color: '#f9fafb', especie: 'ovinos' },
                cordera: { nombre: 'Cordera', emoji: '', ugm: 0.07, color: '#f9fafb', especie: 'ovinos' },
                borrego: { nombre: 'Borrego', emoji: '', ugm: 0.12, color: '#f3f4f6', especie: 'ovinos' },
                // CAPRINOS
                cabra: { nombre: 'Cabra', emoji: '', ugm: 0.12, color: '#ffedd5', especie: 'caprinos' },
                chivo: { nombre: 'Chivo', emoji: '', ugm: 0.15, color: '#fed7aa', especie: 'caprinos' },
                cabrito: { nombre: 'Cabrito', emoji: '', ugm: 0.06, color: '#fef3c7', especie: 'caprinos' },
                cabrita: { nombre: 'Cabrita', emoji: '', ugm: 0.05, color: '#fef3c7', especie: 'caprinos' },
                // EQUINOS
                yegua: { nombre: 'Yegua', emoji: '', ugm: 1.0, color: '#dbeafe', especie: 'equinos' },
                caballo: { nombre: 'Caballo', emoji: '', ugm: 1.2, color: '#bfdbfe', especie: 'equinos' },
                potro: { nombre: 'Potro', emoji: '', ugm: 0.6, color: '#e0f2fe', especie: 'equinos' },
                potra: { nombre: 'Potra', emoji: '', ugm: 0.55, color: '#e0f2fe', especie: 'equinos' },
                burro: { nombre: 'Burro', emoji: '', ugm: 0.5, color: '#f3f4f6', especie: 'equinos' },
                mula: { nombre: 'Mula', emoji: '', ugm: 0.8, color: '#e5e7eb', especie: 'equinos' },
                // PORCINOS
                cerda: { nombre: 'Cerda', emoji: '', ugm: 0.3, color: '#fce7f3', especie: 'porcinos' },
                verraco: { nombre: 'Verraco', emoji: '', ugm: 0.4, color: '#fbcfe8', especie: 'porcinos' },
                lechon: { nombre: 'Lech贸n', emoji: '', ugm: 0.05, color: '#fdf2f8', especie: 'porcinos' },
                cerdo_engorde: { nombre: 'Cerdo Engorde', emoji: '', ugm: 0.2, color: '#fce7f3', especie: 'porcinos' },
                // AVES
                gallina: { nombre: 'Gallina', emoji: '', ugm: 0.01, color: '#fef9c3', especie: 'aves' },
                gallo: { nombre: 'Gallo', emoji: '', ugm: 0.012, color: '#fef08a', especie: 'aves' },
                pollo: { nombre: 'Pollo', emoji: '', ugm: 0.008, color: '#fef9c3', especie: 'aves' },
                pato: { nombre: 'Pato', emoji: '', ugm: 0.01, color: '#e0f2fe', especie: 'aves' },
                pavo: { nombre: 'Pavo', emoji: '', ugm: 0.02, color: '#fef3c7', especie: 'aves' }
            },
            
            ganadoEstados: {
                sano: { nombre: 'Sano', emoji: '', color: '#d1fae5' },
                observacion: { nombre: 'En Observaci贸n', emoji: '锔', color: '#fef3c7' },
                tratamiento: { nombre: 'En Tratamiento', emoji: '', color: '#fee2e2' },
                prenada: { nombre: 'Pre帽ada', emoji: 'ぐ', color: '#fce7f3' }
            },
            
            // ========================================
            //  SISTEMA DE REPORTES AUTOMTICOS
            // ========================================
            
            autoReportConfig: {
                enabled: false,
                dayOfWeek: 6, // 0=Dom, 1=Lun... 6=S谩b
                hour: 8,
                minute: 0,
                recipients: [],
                content: {
                    resumenGeneral: true,
                    movimientos: true,
                    estadoPotreros: true,
                    climaSemana: true,
                    alertasPRV: true,
                    inventarioGanado: true
                }
            },
            autoReportHistory: [],
            autoReportTimer: null,
            
            // ========================================
            // э SISTEMA DE PLUVIMETRO / LLUVIAS
            // ========================================
            
            // ========================================
            //  GESTIN DE INSUMOS / STOCK
            // ========================================
            
            insumosCategoriaFiltro: '',
            insumosViewMode: 'cards',
            
            // Categor铆as de insumos predefinidas
            insumosCategorias: {
                alimentos: { nombre: 'Alimentos', emoji: '', color: '#fef3c7' },
                medicamentos: { nombre: 'Medicamentos', emoji: '', color: '#fee2e2' },
                combustibles: { nombre: 'Combustibles', emoji: '', color: '#fce7f3' },
                fertilizantes: { nombre: 'Fertilizantes', emoji: 'И', color: '#d1fae5' },
                semillas: { nombre: 'Semillas', emoji: '', color: '#e0f2fe' },
                herbicidas: { nombre: 'Herbicidas', emoji: 'Т', color: '#fef9c3' },
                herramientas: { nombre: 'Herramientas', emoji: '', color: '#e5e7eb' },
                otros: { nombre: 'Otros', emoji: '', color: '#f3f4f6' }
            },
            
            // Unidades de medida
            insumosUnidades: ['kg', 'L', 'unidad', 'bolsa', 'saco', 'gal贸n', 'rollo', 'fardo', 'dosis', 'ml', 'g'],
            
            // ========================================
            //  BOT WHATSAPP CON IA
            // ========================================
            
            botMessages: [],
            botIsTyping: false,
            
            renderBotIA: function() {
                // Cargar historial de mensajes
                this.loadBotMessages();
                
                const html = `
                    <div class="bot-container">
                        <!-- Chat principal -->
                        <div class="bot-chat">
                            <div class="bot-chat-header">
                                <div class="bot-avatar"></div>
                                <div class="bot-info">
                                    <div class="bot-name">WIN-TEL Asistente IA</div>
                                    <div class="bot-status">
                                        <div class="bot-status-dot"></div>
                                        En l铆nea - Listo para ayudarte
                                    </div>
                                </div>
                                <button class="btn btn-small" style="background: rgba(255,255,255,0.2); color: white;" onclick="app.clearBotHistory()">
                                    锔 Limpiar
                                </button>
                            </div>
                            
                            <div class="bot-chat-messages" id="botMessages">
                                ${this.renderBotMessages()}
                            </div>
                            
                            <div class="bot-quick-actions">
                                <button class="bot-quick-btn" onclick="app.sendBotMessage('驴Cu谩ntas pre帽adas tengo?')">ぐ Pre帽adas</button>
                                <button class="bot-quick-btn" onclick="app.sendBotMessage('驴Producci贸n de hoy?')"> Leche hoy</button>
                                <button class="bot-quick-btn" onclick="app.sendBotMessage('驴Vacunas vencidas?')"> Vacunas</button>
                                <button class="bot-quick-btn" onclick="app.sendBotMessage('驴Pr贸ximos partos?')"> Partos</button>
                                <button class="bot-quick-btn" onclick="app.sendBotMessage('Dame un resumen')"> Resumen</button>
                            </div>
                            
                            <div class="bot-chat-input">
                                <input type="text" class="bot-input-field" id="botInput" 
                                       placeholder="Escribe tu consulta..." 
                                       onkeypress="if(event.key === 'Enter') app.sendBotMessage()">
                                <button class="bot-send-btn" onclick="app.sendBotMessage()">
                                    
                                </button>
                            </div>
                        </div>
                        
                        <!-- Panel lateral de comandos -->
                        <div class="bot-sidebar">
                            <div class="bot-sidebar-header">
                                <div class="bot-sidebar-title"> Consultas y Comandos</div>
                            </div>
                            <div class="bot-sidebar-content">
                                <div class="bot-command-group">
                                    <div class="bot-command-group-title"> Reproducci贸n</div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Cu谩ntas pre帽adas tengo?')">
                                        <div class="bot-command-text">驴Cu谩ntas pre帽adas?</div>
                                        <div class="bot-command-desc">Estado de gestaci贸n del hato</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Pr贸ximos partos?')">
                                        <div class="bot-command-text">驴Pr贸ximos partos?</div>
                                        <div class="bot-command-desc">Cuenta regresiva de partos</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Hembras vac铆as para servir?')">
                                        <div class="bot-command-text">驴Vac铆as para servir?</div>
                                        <div class="bot-command-desc">Listas para inseminaci贸n</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Estado reproductivo')">
                                        <div class="bot-command-text">Estado reproductivo</div>
                                        <div class="bot-command-desc">Resumen completo</div>
                                    </div>
                                </div>
                                
                                <div class="bot-command-group">
                                    <div class="bot-command-group-title"> Lecher铆a</div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Producci贸n de hoy?')">
                                        <div class="bot-command-text">驴Producci贸n de hoy?</div>
                                        <div class="bot-command-desc">Litros del d铆a</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Mejor vaca lechera?')">
                                        <div class="bot-command-text">驴Top vacas lecheras?</div>
                                        <div class="bot-command-desc">Ranking de producci贸n</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Cu谩ntas vacas lactando?')">
                                        <div class="bot-command-text">驴Vacas lactando?</div>
                                        <div class="bot-command-desc">En orde帽o activo</div>
                                    </div>
                                </div>
                                
                                <div class="bot-command-group">
                                    <div class="bot-command-group-title"> Sanidad</div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Vacunas vencidas?')">
                                        <div class="bot-command-text">驴Vacunas vencidas?</div>
                                        <div class="bot-command-desc">Alertas sanitarias</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Animales en tratamiento?')">
                                        <div class="bot-command-text">驴En tratamiento?</div>
                                        <div class="bot-command-desc">Salud del hato</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Estado sanitario')">
                                        <div class="bot-command-text">Estado sanitario</div>
                                        <div class="bot-command-desc">Resumen de sanidad</div>
                                    </div>
                                </div>
                                
                                <div class="bot-command-group">
                                    <div class="bot-command-group-title"> Ganado</div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Cu谩ntos animales tengo?')">
                                        <div class="bot-command-text">驴Total de animales?</div>
                                        <div class="bot-command-desc">Inventario completo</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Buscar vaca ')">
                                        <div class="bot-command-text">Buscar animal...</div>
                                        <div class="bot-command-desc">Por n煤mero de ID</div>
                                    </div>
                                </div>
                                
                                <div class="bot-command-group">
                                    <div class="bot-command-group-title"> Comandos R谩pidos</div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Registrar celo vaca ')">
                                        <div class="bot-command-text">Registrar celo</div>
                                        <div class="bot-command-desc">Agregar "vaca [ID]"</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Registrar servicio vaca ')">
                                        <div class="bot-command-text">Registrar servicio</div>
                                        <div class="bot-command-desc">Agregar "vaca [ID]"</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Registrar parto vaca ')">
                                        <div class="bot-command-text">Registrar parto</div>
                                        <div class="bot-command-desc">Agregar "vaca [ID]"</div>
                                    </div>
                                </div>
                                
                                <div class="bot-command-group">
                                    <div class="bot-command-group-title"> Reportes</div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('Dame un resumen completo')">
                                        <div class="bot-command-text">Resumen general</div>
                                        <div class="bot-command-desc">Estado de la finca</div>
                                    </div>
                                    <div class="bot-command-item" onclick="app.sendBotMessage('驴Cu谩l es la carga animal?')">
                                        <div class="bot-command-text">Carga animal</div>
                                        <div class="bot-command-desc">UGM por hect谩rea</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
                this.scrollBotToBottom();
            },
            
            renderBotMessages: function() {
                if (this.botMessages.length === 0) {
                    return `
                        <div class="bot-message received">
                            <div class="bot-message-text">隆Hola!  Soy el asistente IA de WIN-TEL AgroManager v4.0

Ahora puedo ayudarte con:

 *Reproducci贸n*: pre帽adas, partos, vac铆as
 *Lecher铆a*: producci贸n, ranking
 *Sanidad*: vacunas, tratamientos
 *Ganado*: buscar, inventario

 *Comandos r谩pidos:*
 "Registrar celo vaca 125"
 "Registrar parto vaca 88"
 "Buscar vaca 200"

隆Preg煤ntame lo que necesites! </div>
                            <div class="bot-message-time">${new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    `;
                }
                
                return this.botMessages.map(msg => `
                    <div class="bot-message ${msg.type}">
                        <div class="bot-message-text">${msg.text}</div>
                        ${msg.data ? this.renderBotDataCard(msg.data) : ''}
                        <div class="bot-message-time">${msg.time}</div>
                    </div>
                `).join('');
            },
            
            renderBotDataCard: function(data) {
                if (!data || Object.keys(data).length === 0) return '';
                
                return `
                    <div class="bot-data-card">
                        ${Object.entries(data).map(([label, value]) => `
                            <div class="bot-data-row">
                                <span class="bot-data-label">${label}</span>
                                <span class="bot-data-value">${value}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            
            sendBotMessage: function(text = null) {
                const input = document.getElementById('botInput');
                const message = text || input?.value?.trim();
                
                if (!message) return;
                
                // Agregar mensaje del usuario
                this.botMessages.push({
                    type: 'sent',
                    text: message,
                    time: new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })
                });
                
                if (input) input.value = '';
                
                // Mostrar mensajes y typing
                this.updateBotUI();
                this.showBotTyping();
                
                // Procesar respuesta con delay para simular IA
                setTimeout(() => {
                    const response = this.processBotQuery(message);
                    this.hideBotTyping();
                    
                    this.botMessages.push({
                        type: 'received',
                        text: response.text,
                        data: response.data,
                        time: new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })
                    });
                    
                    this.saveBotMessages();
                    this.updateBotUI();
                    this.scrollBotToBottom();
                }, 800 + Math.random() * 700);
            },
            
            processBotQuery: function(query) {
                const q = query.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                // ===== GANADO =====
                if (q.includes('animal') || q.includes('cabeza') || q.includes('ganado') || q.includes('cuantos') && (q.includes('tengo') || q.includes('hay'))) {
                    const stats = this.calcularEstadisticasGanado();
                    const especiesActivas = Object.entries(this.especiesConfig).filter(([k, v]) => v.enabled);
                    
                    let detalleEspecies = '';
                    especiesActivas.forEach(([key, esp]) => {
                        const count = this.calcularEstadisticasEspecie(key).total;
                        if (count > 0) {
                            detalleEspecies += ` ${esp.emoji} ${esp.nombre}: ${count}\n`;
                        }
                    });
                    
                    return {
                        text: ` *Inventario de Ganado*\n\nTienes un total de *${stats.totalCabezas} animales* registrados.\n\n${detalleEspecies}\nEquivalente a *${stats.totalUGM.toFixed(1)} UGM* con un peso total de *${stats.pesoTotal.toLocaleString()} kg*.`,
                        data: {
                            'Total Cabezas': stats.totalCabezas,
                            'Total UGM': stats.totalUGM.toFixed(1),
                            'Peso Total': stats.pesoTotal.toLocaleString() + ' kg',
                            'En Tratamiento': stats.enTratamiento
                        }
                    };
                }
                
                // Vacas espec铆ficamente
                if (q.includes('vaca')) {
                    const vacas = (this.data.ganado || []).filter(a => a.categoria === 'vaca').length;
                    return {
                        text: ` Tienes *${vacas} vacas* registradas en el sistema.`,
                        data: { 'Vacas': vacas }
                    };
                }
                
                // Tratamiento
                if (q.includes('tratamiento') || q.includes('enferm') || q.includes('salud')) {
                    const enTratamiento = (this.data.ganado || []).filter(a => a.estado === 'tratamiento');
                    if (enTratamiento.length === 0) {
                        return { text: ' 隆Excelente! No hay animales en tratamiento actualmente. Todos est谩n sanos.' };
                    }
                    return {
                        text: ` Hay *${enTratamiento.length} animales* en tratamiento:\n\n${enTratamiento.slice(0, 5).map(a => ` ${a.id} (${a.categoria})`).join('\n')}`,
                        data: { 'En Tratamiento': enTratamiento.length }
                    };
                }
                
                // ===== POTREROS =====
                if (q.includes('potrero') || q.includes('lote')) {
                    const ocupados = this.data.movimientos.filter(m => m.estado === 'activo').length;
                    const total = this.data.potreros.length;
                    const disponibles = total - ocupados;
                    
                    return {
                        text: `猴 *Estado de Potreros*\n\nDe *${total} potreros* en total:\n ${ocupados} ocupados\n ${disponibles} disponibles`,
                        data: {
                            'Total Potreros': total,
                            'Ocupados': ocupados,
                            'Disponibles': disponibles
                        }
                    };
                }
                
                // Rotaci贸n PRV
                if (q.includes('rotar') || q.includes('rotacion') || q.includes('prv')) {
                    this.loadPRVConfig();
                    const alertas = [];
                    
                    this.data.movimientos.filter(m => m.estado === 'activo').forEach(m => {
                        const dias = Math.floor((new Date() - new Date(m.fechaEntrada)) / (1000 * 60 * 60 * 24));
                        if (dias >= this.prvConfig.diasOcupacion) {
                            alertas.push({ potrero: m.potreroId, dias });
                        }
                    });
                    
                    if (alertas.length === 0) {
                        return { text: ' No hay potreros que necesiten rotaci贸n urgente. Todo est谩 al d铆a.' };
                    }
                    
                    return {
                        text: `锔 *Alertas de Rotaci贸n PRV*\n\nHay *${alertas.length} potreros* que exceden el tiempo de ocupaci贸n:\n\n${alertas.map(a => ` ${a.potrero}: ${a.dias} d铆as`).join('\n')}\n\n_Considera mover el ganado para permitir la recuperaci贸n._`,
                        data: { 'Potreros a Rotar': alertas.length }
                    };
                }
                
                // ===== LLUVIAS =====
                if (q.includes('lluv') || q.includes('precipit') || q.includes('agua')) {
                    const stats = this.calcularEstadisticasLluvias();
                    
                    let periodo = 'este mes';
                    let valor = stats.mes;
                    
                    if (q.includes('semana')) {
                        periodo = 'esta semana';
                        valor = stats.semana;
                    } else if (q.includes('hoy')) {
                        periodo = 'hoy';
                        valor = stats.hoy;
                    } else if (q.includes('ano') || q.includes('a帽o')) {
                        periodo = 'este a帽o';
                        valor = stats.anio;
                    }
                    
                    return {
                        text: `э *Precipitaciones ${periodo}*\n\nHan ca铆do *${valor.toFixed(1)} mm* ${periodo}.\n\n D铆as con lluvia (mes): ${stats.diasConLluvia}\n M谩ximo evento: ${stats.maxEvento.toFixed(1)} mm`,
                        data: {
                            'Lluvia': valor.toFixed(1) + ' mm',
                            'D铆as con lluvia': stats.diasConLluvia,
                            'M谩ximo evento': stats.maxEvento.toFixed(1) + ' mm'
                        }
                    };
                }
                
                // ===== INSUMOS =====
                if (q.includes('insumo') || q.includes('stock') || q.includes('inventario') && !q.includes('ganado')) {
                    const stats = this.calcularEstadisticasInsumos();
                    const alertas = this.getAlertasStockBajo();
                    
                    if (q.includes('bajo') || q.includes('alerta') || q.includes('faltan')) {
                        if (alertas.length === 0) {
                            return { text: ' 隆Todo bien! No hay insumos con stock bajo actualmente.' };
                        }
                        return {
                            text: `锔 *Insumos con Stock Bajo*\n\nHay *${alertas.length} insumos* que necesitan reposici贸n:\n\n${alertas.slice(0, 5).map(a => ` ${a.nombre}: ${a.cantidad} ${a.unidad}`).join('\n')}`,
                            data: { 'Stock Bajo': alertas.length }
                        };
                    }
                    
                    return {
                        text: ` *Inventario de Insumos*\n\nTienes *${stats.totalInsumos} insumos* registrados con un valor total de *$${stats.valorTotal.toLocaleString()}*.\n\n Con stock bajo: ${stats.stockBajo}\n Sin stock: ${stats.sinStock}`,
                        data: {
                            'Total Insumos': stats.totalInsumos,
                            'Valor Total': '$' + stats.valorTotal.toLocaleString(),
                            'Stock Bajo': stats.stockBajo,
                            'Sin Stock': stats.sinStock
                        }
                    };
                }
                
                // Buscar insumo espec铆fico
                if (q.includes('gasoil') || q.includes('diesel')) {
                    return this.buscarInsumoBot('gasoil');
                }
                if (q.includes('sal')) {
                    return this.buscarInsumoBot('sal');
                }
                
                // ===== CARGA ANIMAL =====
                if (q.includes('carga') && q.includes('animal') || q.includes('ugm/ha') || q.includes('ugm por')) {
                    this.loadCalcData();
                    const resultados = this.calcularCargaAnimal();
                    
                    return {
                        text: ` *Carga Animal Actual*\n\nTu carga actual es de *${resultados.cargaActual.toFixed(2)} UGM/Ha*.\n\nEstado: ${resultados.estadoIcon} ${resultados.estadoTitulo}\n${resultados.estadoMensaje}`,
                        data: {
                            'Carga': resultados.cargaActual.toFixed(2) + ' UGM/Ha',
                            'Total UGM': resultados.totalUGM.toFixed(1),
                            'Superficie': this.calcData.superficie + ' Ha'
                        }
                    };
                }
                
                // ===== RESUMEN GENERAL =====
                if (q.includes('resumen') || q.includes('estado') || q.includes('general') || q.includes('como esta')) {
                    const ganadoStats = this.calcularEstadisticasGanado();
                    const insumoStats = this.calcularEstadisticasInsumos();
                    const lluviaStats = this.calcularEstadisticasLluvias();
                    const ocupados = this.data.movimientos.filter(m => m.estado === 'activo').length;
                    
                    return {
                        text: ` *RESUMEN DE LA FINCA*\n\n *Ganado*\n ${ganadoStats.totalCabezas} cabezas (${ganadoStats.totalUGM.toFixed(1)} UGM)\n ${ganadoStats.enTratamiento} en tratamiento\n\n猴 *Potreros*\n ${this.data.potreros.length} totales, ${ocupados} ocupados\n\nэ *Lluvias del Mes*\n ${lluviaStats.mes.toFixed(1)} mm acumulados\n\n *Insumos*\n ${insumoStats.totalInsumos} registrados\n ${insumoStats.stockBajo} con stock bajo`,
                        data: {
                            'Animales': ganadoStats.totalCabezas,
                            'Potreros': this.data.potreros.length,
                            'Lluvia Mes': lluviaStats.mes.toFixed(1) + ' mm',
                            'Insumos': insumoStats.totalInsumos
                        }
                    };
                }
                
                // ===== AYUDA =====
                if (q.includes('ayuda') || q.includes('help') || q.includes('que puedes')) {
                    return {
                        text: ` *WIN-TEL Asistente IA v4.0*\n\nPuedo ayudarte con:\n\n *Ganado*\n 驴Cu谩ntos animales tengo?\n 驴D贸nde est谩 la vaca 125?\n Buscar [ID animal]\n\n *Reproducci贸n*\n 驴Cu谩ntas pre帽adas?\n 驴Pr贸ximos partos?\n 驴Vac铆as para servir?\n\n *Sanidad*\n 驴Vacunas vencidas?\n 驴Animales en tratamiento?\n\n *Lecher铆a*\n 驴Producci贸n de hoy?\n 驴Mejor vaca lechera?\n\n猴 *Potreros*\n 驴Potreros ocupados?\n 驴Qu茅 debo rotar?\n\n *Reportes*\n Dame un resumen\n Estado reproductivo\n\n *Comandos r谩pidos*\n "Registrar celo vaca 125"\n "Registrar parto vaca 88"`
                    };
                }
                
                // =====  REPRODUCCIN =====
                if (q.includes('pre帽ada') || q.includes('prenada') || q.includes('gestacion') || q.includes('embarazada')) {
                    const ganado = this.data.ganado || [];
                    const pre帽adas = ganado.filter(a => a.estadoRepro === 'pre帽ada');
                    const hembras = ganado.filter(a => { const c = this.ganadoCategorias[a.categoria]; return c && c.sexo === 'H'; });
                    const tasa = hembras.length > 0 ? ((pre帽adas.length / hembras.length) * 100).toFixed(1) : 0;
                    
                    if (pre帽adas.length === 0) {
                        return { text: ` No hay animales registrados como pre帽adas actualmente.\n\n_Tip: Registra diagn贸sticos de pre帽ez en el m贸dulo de Reproducci贸n._` };
                    }
                    
                    // Calcular pr贸ximos partos
                    const conFecha = pre帽adas.filter(p => p.fechaServicio).map(p => {
                        const diasPre帽ez = Math.floor((new Date() - new Date(p.fechaServicio)) / 86400000);
                        const diasParaParto = 283 - diasPre帽ez;
                        return { ...p, diasPre帽ez, diasParaParto };
                    }).sort((a, b) => a.diasParaParto - b.diasParaParto);
                    
                    let proximosText = '';
                    if (conFecha.length > 0) {
                        const proximos = conFecha.filter(p => p.diasParaParto > 0 && p.diasParaParto <= 60);
                        if (proximos.length > 0) {
                            proximosText = `\n\n *Pr贸ximos partos (60 d铆as):*\n${proximos.slice(0, 5).map(p => ` ${p.id}: ${p.diasParaParto} d铆as`).join('\n')}`;
                        }
                    }
                    
                    return {
                        text: ` *Estado Reproductivo*\n\nTienes *${pre帽adas.length} animales pre帽adas* de ${hembras.length} hembras.\n\n Tasa de pre帽ez: *${tasa}%*${proximosText}`,
                        data: {
                            'Pre帽adas': pre帽adas.length,
                            'Total Hembras': hembras.length,
                            'Tasa Pre帽ez': tasa + '%'
                        }
                    };
                }
                
                if (q.includes('parto') && (q.includes('proximo') || q.includes('cuando') || q.includes('fecha'))) {
                    const ganado = this.data.ganado || [];
                    const pre帽adas = ganado.filter(a => a.estadoRepro === 'pre帽ada' && a.fechaServicio);
                    
                    if (pre帽adas.length === 0) {
                        return { text: ` No hay partos programados. No se encontraron animales pre帽adas con fecha de servicio registrada.` };
                    }
                    
                    const partos = pre帽adas.map(p => {
                        const fechaParto = new Date(new Date(p.fechaServicio).getTime() + 283 * 86400000);
                        const diasPara = Math.ceil((fechaParto - new Date()) / 86400000);
                        return { id: p.id, nombre: p.nombre, diasPara, fecha: fechaParto };
                    }).filter(p => p.diasPara > 0).sort((a, b) => a.diasPara - b.diasPara);
                    
                    if (partos.length === 0) {
                        return { text: ` Todas las fechas de parto calculadas ya pasaron. Revisa los registros.` };
                    }
                    
                    return {
                        text: ` *Pr贸ximos Partos*\n\n${partos.slice(0, 8).map(p => ` *${p.id}* ${p.nombre ? '('+p.nombre+')' : ''}: ${p.diasPara} d铆as (${p.fecha.toLocaleDateString('es')})`).join('\n')}\n\n_Total: ${partos.length} partos esperados_`,
                        data: { 'Partos Esperados': partos.length, 'M谩s Pr贸ximo': partos[0].diasPara + ' d铆as' }
                    };
                }
                
                if (q.includes('vacia') || (q.includes('servir') && !q.includes('insumo')) || q.includes('inseminar')) {
                    const ganado = this.data.ganado || [];
                    const vacias = ganado.filter(a => {
                        const c = this.ganadoCategorias[a.categoria];
                        return c && c.sexo === 'H' && (!a.estadoRepro || a.estadoRepro === 'vacia');
                    });
                    
                    if (vacias.length === 0) {
                        return { text: ` 隆Excelente! No hay hembras vac铆as. Todas est谩n pre帽adas, lactando o en otro estado.` };
                    }
                    
                    return {
                        text: ` *Hembras Vac铆as (para servir)*\n\nHay *${vacias.length} hembras* listas para servicio:\n\n${vacias.slice(0, 10).map(v => ` ${v.id} - ${v.nombre || v.categoria}`).join('\n')}${vacias.length > 10 ? `\n\n_...y ${vacias.length - 10} m谩s_` : ''}`,
                        data: { 'Vac铆as': vacias.length }
                    };
                }
                
                if (q.includes('lactando') || q.includes('lactancia') || (q.includes('orde帽o') && !q.includes('litro'))) {
                    const ganado = this.data.ganado || [];
                    const lactando = ganado.filter(a => a.estadoRepro === 'lactando');
                    
                    return {
                        text: ` Hay *${lactando.length} vacas en lactancia* actualmente.\n\n${lactando.length > 0 ? lactando.slice(0, 8).map(v => ` ${v.id} - ${v.nombre || ''}`).join('\n') : '_Ninguna vaca marcada como lactando_'}`,
                        data: { 'En Lactancia': lactando.length }
                    };
                }
                
                if (q.includes('estado reproductivo') || q.includes('reproduccion') || q.includes('fertilidad')) {
                    const ganado = this.data.ganado || [];
                    const hembras = ganado.filter(a => { const c = this.ganadoCategorias[a.categoria]; return c && c.sexo === 'H'; });
                    const estados = { pre帽ada: 0, vacia: 0, lactando: 0, seca: 0, servida: 0 };
                    hembras.forEach(h => { estados[h.estadoRepro || 'vacia']++; });
                    
                    return {
                        text: ` *Resumen Reproductivo*\n\nDe *${hembras.length} hembras*:\n\nぐ Pre帽adas: ${estados.pre帽ada}\n Vac铆as: ${estados.vacia}\n Lactando: ${estados.lactando}\n Secas: ${estados.seca}\n Servidas: ${estados.servida}`,
                        data: {
                            'Pre帽adas': estados.pre帽ada,
                            'Vac铆as': estados.vacia,
                            'Lactando': estados.lactando
                        }
                    };
                }
                
                // =====  SANIDAD =====
                if (q.includes('vacuna') && (q.includes('vencida') || q.includes('pendiente') || q.includes('atrasada'))) {
                    const alertas = this.getAlertasVacunacion();
                    
                    if (alertas.vencidas.length === 0) {
                        return { text: ` 隆Excelente! No hay vacunaciones vencidas. Tu hato est谩 al d铆a.` };
                    }
                    
                    return {
                        text: ` *Vacunaciones Vencidas*\n\nHay *${alertas.vencidas.length} animales* con vacunas vencidas:\n\n${alertas.vencidas.slice(0, 8).map(a => ` ${a.id}: vencida hace ${a.diasVencido} d铆as`).join('\n')}${alertas.vencidas.length > 8 ? `\n\n_...y ${alertas.vencidas.length - 8} m谩s_` : ''}\n\n锔 _Programa una jornada de vacunaci贸n urgente._`,
                        data: { 'Vencidas': alertas.vencidas.length, 'Pr贸ximas (7d)': alertas.proximas.length }
                    };
                }
                
                if (q.includes('sanidad') || q.includes('salud del hato') || q.includes('estado sanitario')) {
                    const eventosSanidad = this.data.eventosSanidad || [];
                    const alertas = this.getAlertasVacunacion();
                    const enTratamiento = (this.data.ganado || []).filter(a => a.estado === 'tratamiento').length;
                    const ultimoMes = eventosSanidad.filter(e => {
                        const fecha = new Date(e.fecha);
                        const hace30 = new Date(Date.now() - 30 * 86400000);
                        return fecha >= hace30;
                    });
                    
                    return {
                        text: ` *Estado Sanitario del Hato*\n\n Vacunas vencidas: ${alertas.vencidas.length}\n锔 Pr贸ximas (7 d铆as): ${alertas.proximas.length}\n En tratamiento: ${enTratamiento}\n Eventos (煤ltimo mes): ${ultimoMes.length}`,
                        data: {
                            'Vacunas Vencidas': alertas.vencidas.length,
                            'En Tratamiento': enTratamiento,
                            'Eventos Mes': ultimoMes.length
                        }
                    };
                }
                
                // =====  LECHERA =====
                if (q.includes('produccion') && (q.includes('hoy') || q.includes('leche') || q.includes('litro'))) {
                    const registros = this.data.registrosLeche || [];
                    const hoy = new Date().toISOString().split('T')[0];
                    const prodHoy = registros.filter(r => r.fecha === hoy).reduce((sum, r) => sum + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                    const vacasOrde帽o = (this.data.ganado || []).filter(a => a.estadoRepro === 'lactando').length;
                    const promedio = vacasOrde帽o > 0 ? (prodHoy / vacasOrde帽o).toFixed(1) : 0;
                    
                    if (prodHoy === 0) {
                        return { text: ` No hay producci贸n registrada hoy.\n\n_Registra el orde帽o en el m贸dulo de Lecher铆a._` };
                    }
                    
                    return {
                        text: ` *Producci贸n de Hoy*\n\n Total: *${prodHoy.toFixed(1)} litros*\n Vacas en orde帽o: ${vacasOrde帽o}\n Promedio/vaca: ${promedio} Lt`,
                        data: {
                            'Litros Hoy': prodHoy.toFixed(1),
                            'Vacas Orde帽o': vacasOrde帽o,
                            'Lt/Vaca': promedio
                        }
                    };
                }
                
                if (q.includes('mejor vaca') || q.includes('top') && q.includes('leche') || q.includes('ranking') && q.includes('leche')) {
                    const registros = this.data.registrosLeche || [];
                    const hace7 = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
                    
                    const porVaca = {};
                    registros.filter(r => r.fecha >= hace7).forEach(r => {
                        if (!porVaca[r.animalId]) porVaca[r.animalId] = 0;
                        porVaca[r.animalId] += (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0);
                    });
                    
                    const ranking = Object.entries(porVaca).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    
                    if (ranking.length === 0) {
                        return { text: ` No hay datos de producci贸n en los 煤ltimos 7 d铆as.` };
                    }
                    
                    return {
                        text: ` *Top 5 Vacas Lecheras (7 d铆as)*\n\n${ranking.map((r, i) => `${i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : ''} ${r[0]}: ${r[1].toFixed(1)} Lt`).join('\n')}`,
                        data: { 'Mejor Vaca': ranking[0][0], 'Producci贸n': ranking[0][1].toFixed(1) + ' Lt' }
                    };
                }
                
                // ===== BUSCAR ANIMAL ESPECFICO =====
                if (q.includes('donde esta') || q.includes('buscar') || q.includes('encuentra')) {
                    const match = q.match(/(\d+)/);
                    if (match) {
                        const id = match[1];
                        const animal = (this.data.ganado || []).find(a => a.id.includes(id));
                        
                        if (!animal) {
                            return { text: ` No encontr茅 ning煤n animal con ID "${id}".` };
                        }
                        
                        const cat = this.ganadoCategorias[animal.categoria] || {};
                        const estadoRepro = animal.estadoRepro ? { pre帽ada: 'ぐ Pre帽ada', vacia: ' Vac铆a', lactando: ' Lactando', seca: ' Seca', servida: ' Servida' }[animal.estadoRepro] : '';
                        
                        return {
                            text: ` *Animal ${animal.id}*\n\n Nombre: ${animal.nombre || 'Sin nombre'}\n Categor铆a: ${cat.emoji || ''} ${cat.nombre || animal.categoria}\n锔 Peso: ${animal.peso || 0} kg\n Potrero: ${animal.potreroActual || 'Sin asignar'}\n${estadoRepro ? ' Estado: ' + estadoRepro : ''}\n Pr贸x. vacuna: ${animal.proximaVacunacion || 'No programada'}`,
                            data: {
                                'ID': animal.id,
                                'Peso': (animal.peso || 0) + ' kg',
                                'Potrero': animal.potreroActual || '-'
                            }
                        };
                    }
                }
                
                // ===== COMANDOS DE ACCIN =====
                if (q.includes('registrar celo') || q.includes('registro celo')) {
                    const match = q.match(/(\d+)/);
                    if (match) {
                        const id = match[1];
                        const animal = (this.data.ganado || []).find(a => a.id.includes(id));
                        if (animal) {
                            animal.ultimoCelo = new Date().toISOString().split('T')[0];
                            if (!this.data.eventosReproductivos) this.data.eventosReproductivos = [];
                            this.data.eventosReproductivos.push({
                                id: 'EVT-' + Date.now(),
                                animalId: animal.id,
                                tipo: 'celo',
                                fecha: new Date().toISOString().split('T')[0],
                                observaciones: 'Registrado por BotIA',
                                fechaRegistro: new Date().toISOString()
                            });
                            this.saveData();
                            return { text: ` *Celo registrado*\n\n Animal: ${animal.id}\n Fecha: Hoy\n\n_El celo ha sido guardado correctamente._` };
                        }
                        return { text: ` No encontr茅 el animal ${id}. Verifica el n煤mero.` };
                    }
                    return { text: ` Para registrar un celo escribe:\n"Registrar celo vaca 125"` };
                }
                
                if (q.includes('registrar parto')) {
                    const match = q.match(/(\d+)/);
                    if (match) {
                        const id = match[1];
                        const animal = (this.data.ganado || []).find(a => a.id.includes(id));
                        if (animal) {
                            animal.estadoRepro = 'lactando';
                            animal.fechaUltimoParto = new Date().toISOString().split('T')[0];
                            animal.numPartos = (animal.numPartos || 0) + 1;
                            animal.fechaServicio = null;
                            if (!this.data.eventosReproductivos) this.data.eventosReproductivos = [];
                            this.data.eventosReproductivos.push({
                                id: 'EVT-' + Date.now(),
                                animalId: animal.id,
                                tipo: 'parto',
                                fecha: new Date().toISOString().split('T')[0],
                                observaciones: 'Registrado por BotIA',
                                fechaRegistro: new Date().toISOString()
                            });
                            this.saveData();
                            return { text: ` *Parto registrado*\n\n Animal: ${animal.id}\n Fecha: Hoy\n Estado: Lactando\n\n_Parto #${animal.numPartos} guardado correctamente._` };
                        }
                        return { text: ` No encontr茅 el animal ${id}. Verifica el n煤mero.` };
                    }
                    return { text: ` Para registrar un parto escribe:\n"Registrar parto vaca 88"` };
                }
                
                if (q.includes('registrar servicio') || q.includes('inseminar') || q.includes('servir vaca')) {
                    const match = q.match(/(\d+)/);
                    if (match) {
                        const id = match[1];
                        const animal = (this.data.ganado || []).find(a => a.id.includes(id));
                        if (animal) {
                            animal.estadoRepro = 'servida';
                            animal.fechaServicio = new Date().toISOString().split('T')[0];
                            if (!this.data.eventosReproductivos) this.data.eventosReproductivos = [];
                            this.data.eventosReproductivos.push({
                                id: 'EVT-' + Date.now(),
                                animalId: animal.id,
                                tipo: 'servicio',
                                fecha: new Date().toISOString().split('T')[0],
                                observaciones: 'Registrado por BotIA',
                                fechaRegistro: new Date().toISOString()
                            });
                            this.saveData();
                            return { text: ` *Servicio registrado*\n\n Animal: ${animal.id}\n Fecha: Hoy\n Parto esperado: ${new Date(Date.now() + 283 * 86400000).toLocaleDateString('es')}\n\n_Recuerda hacer diagn贸stico en 30-45 d铆as._` };
                        }
                        return { text: ` No encontr茅 el animal ${id}. Verifica el n煤mero.` };
                    }
                    return { text: ` Para registrar un servicio escribe:\n"Registrar servicio vaca 125"\no\n"Inseminar vaca 125"` };
                }
                
                if (q.includes('registrar leche') || q.includes('registrar orde帽o') || q.includes('produccion vaca')) {
                    const matchId = q.match(/vaca\s*(\d+)/i) || q.match(/(\d+)\s*litro/i);
                    const matchLitros = q.match(/(\d+(?:\.\d+)?)\s*(?:litro|lt|l)/i);
                    
                    if (matchId && matchLitros) {
                        const id = matchId[1];
                        const litros = parseFloat(matchLitros[1]);
                        const animal = (this.data.ganado || []).find(a => a.id.includes(id));
                        
                        if (animal) {
                            const hoy = new Date().toISOString().split('T')[0];
                            if (!this.data.registrosLeche) this.data.registrosLeche = [];
                            let registro = this.data.registrosLeche.find(r => r.animalId === animal.id && r.fecha === hoy);
                            if (!registro) {
                                registro = { id: 'LECHE-' + Date.now(), animalId: animal.id, fecha: hoy, litrosAM: 0, litrosPM: 0 };
                                this.data.registrosLeche.push(registro);
                            }
                            const turno = new Date().getHours() < 12 ? 'AM' : 'PM';
                            registro[turno === 'AM' ? 'litrosAM' : 'litrosPM'] = litros;
                            this.saveData();
                            return { text: ` *Orde帽o registrado*\n\n Animal: ${animal.id}\n Litros: ${litros} (${turno})\n Fecha: Hoy` };
                        }
                        return { text: ` No encontr茅 el animal ${id}.` };
                    }
                    return { text: ` Para registrar orde帽o escribe:\n"Registrar leche vaca 125 8.5 litros"` };
                }
                
                // Respuesta por defecto mejorada
                return {
                    text: ` No entend铆 tu consulta.\n\n*Prueba preguntar:*\n 驴Cu谩ntas pre帽adas tengo?\n 驴Vacunas vencidas?\n 驴Producci贸n de hoy?\n Buscar vaca 125\n\n*O comandos:*\n Registrar celo vaca 125\n Registrar parto vaca 88\n\nEscribe "ayuda" para ver todo.`
                };
            },
            
            buscarInsumoBot: function(busqueda) {
                const insumo = (this.data.insumos || []).find(i => 
                    i.nombre.toLowerCase().includes(busqueda.toLowerCase())
                );
                
                if (!insumo) {
                    return { text: ` No encontr茅 ning煤n insumo con "${busqueda}" en el nombre.` };
                }
                
                const nivel = this.calcularNivelStock(insumo);
                return {
                    text: ` *${insumo.nombre}*\n\nStock actual: *${insumo.cantidad} ${insumo.unidad}*\nNivel: ${nivel.texto}\nValor: $${((insumo.cantidad || 0) * (insumo.precioUnitario || 0)).toLocaleString()}`,
                    data: {
                        'Stock': insumo.cantidad + ' ' + insumo.unidad,
                        'M铆nimo': (insumo.stockMinimo || 0) + ' ' + insumo.unidad,
                        'Precio Unit.': '$' + (insumo.precioUnitario || 0).toLocaleString()
                    }
                };
            },
            
            showBotTyping: function() {
                const container = document.getElementById('botMessages');
                if (!container) return;
                
                const typing = document.createElement('div');
                typing.className = 'bot-typing';
                typing.id = 'botTyping';
                typing.innerHTML = `
                    <div class="bot-typing-dot"></div>
                    <div class="bot-typing-dot"></div>
                    <div class="bot-typing-dot"></div>
                `;
                container.appendChild(typing);
                this.scrollBotToBottom();
            },
            
            hideBotTyping: function() {
                const typing = document.getElementById('botTyping');
                if (typing) typing.remove();
            },
            
            updateBotUI: function() {
                const container = document.getElementById('botMessages');
                if (container) {
                    container.innerHTML = this.renderBotMessages();
                }
            },
            
            scrollBotToBottom: function() {
                const container = document.getElementById('botMessages');
                if (container) {
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 50);
                }
            },
            
            loadBotMessages: function() {
                const saved = localStorage.getItem('nexusAgroBotMessages');
                if (saved) {
                    this.botMessages = JSON.parse(saved);
                }
            },
            
            saveBotMessages: function() {
                // Mantener solo 煤ltimos 50 mensajes
                if (this.botMessages.length > 50) {
                    this.botMessages = this.botMessages.slice(-50);
                }
                localStorage.setItem('nexusAgroBotMessages', JSON.stringify(this.botMessages));
            },
            
            clearBotHistory: function() {
                if (confirm('驴Limpiar historial de conversaci贸n?')) {
                    this.botMessages = [];
                    localStorage.removeItem('nexusAgroBotMessages');
                    this.navigate('botia');
                }
            },

            renderInsumos: function() {
                const stats = this.calcularEstadisticasInsumos();
                const insumosFiltrados = this.filtrarInsumos();
                const alertasStock = this.getAlertasStockBajo();
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Gesti贸n de Insumos y Stock
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="app.openNuevoInsumoModal()">
                                    <span></span> Nuevo Insumo
                                </button>
                                <button class="btn btn-secondary" onclick="app.openMovimientoInsumoModal()">
                                    <span></span> Registrar Movimiento
                                </button>
                                <button class="btn btn-secondary" onclick="app.exportarInsumos()">
                                    <span></span> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Estad铆sticas -->
                            <div class="insumos-dashboard">
                                <div class="insumo-stat-card">
                                    <div class="insumo-stat-icon"></div>
                                    <div class="insumo-stat-info">
                                        <div class="insumo-stat-value">${stats.totalInsumos}</div>
                                        <div class="insumo-stat-label">Total Insumos</div>
                                    </div>
                                </div>
                                <div class="insumo-stat-card">
                                    <div class="insumo-stat-icon"></div>
                                    <div class="insumo-stat-info">
                                        <div class="insumo-stat-value">$${stats.valorTotal.toLocaleString()}</div>
                                        <div class="insumo-stat-label">Valor en Stock</div>
                                    </div>
                                </div>
                                <div class="insumo-stat-card warning">
                                    <div class="insumo-stat-icon">锔</div>
                                    <div class="insumo-stat-info">
                                        <div class="insumo-stat-value">${stats.stockBajo}</div>
                                        <div class="insumo-stat-label">Stock Bajo</div>
                                    </div>
                                </div>
                                <div class="insumo-stat-card danger">
                                    <div class="insumo-stat-icon"></div>
                                    <div class="insumo-stat-info">
                                        <div class="insumo-stat-value">${stats.sinStock}</div>
                                        <div class="insumo-stat-label">Sin Stock</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alertas de stock bajo -->
                            ${alertasStock.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    ${alertasStock.slice(0, 3).map(a => `
                                        <div class="alerta-stock">
                                            <div class="alerta-stock-icon">锔</div>
                                            <div class="alerta-stock-info">
                                                <div class="alerta-stock-titulo">${a.nombre}</div>
                                                <div class="alerta-stock-mensaje">Stock actual: ${a.cantidad} ${a.unidad} (m铆nimo: ${a.stockMinimo})</div>
                                            </div>
                                            <button class="btn btn-small" onclick="app.openMovimientoInsumoModal('${a.id}', 'entrada')">
                                                 Reponer
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <!-- Filtros por categor铆a -->
                            <div class="insumos-categorias">
                                <button class="insumo-categoria-btn ${!this.insumosCategoriaFiltro ? 'active' : ''}" 
                                        onclick="app.filtrarInsumosPorCategoria('')">
                                     Todos
                                    <span class="insumo-categoria-count">${(this.data.insumos || []).length}</span>
                                </button>
                                ${Object.entries(this.insumosCategorias).map(([key, cat]) => {
                                    const count = (this.data.insumos || []).filter(i => i.categoria === key).length;
                                    if (count === 0) return '';
                                    return `
                                        <button class="insumo-categoria-btn ${this.insumosCategoriaFiltro === key ? 'active' : ''}" 
                                                onclick="app.filtrarInsumosPorCategoria('${key}')">
                                            ${cat.emoji} ${cat.nombre}
                                            <span class="insumo-categoria-count">${count}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Vista toggle -->
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                                <div class="ganado-view-tabs">
                                    <button class="ganado-view-tab ${this.insumosViewMode === 'cards' ? 'active' : ''}" 
                                            onclick="app.setInsumosViewMode('cards')">
                                         Cards
                                    </button>
                                    <button class="ganado-view-tab ${this.insumosViewMode === 'tabla' ? 'active' : ''}" 
                                            onclick="app.setInsumosViewMode('tabla')">
                                         Tabla
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de insumos -->
                            <div id="insumosListContainer">
                                ${this.renderInsumosList(insumosFiltrados)}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            renderInsumosList: function(insumos) {
                if (!insumos || insumos.length === 0) {
                    return `
                        <div style="text-align: center; padding: 60px; color: var(--gris-500);">
                            <div style="font-size: 64px; margin-bottom: 16px;"></div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No hay insumos registrados</div>
                            <div style="font-size: 14px; margin-bottom: 24px;">Comienza agregando tu primer insumo al inventario</div>
                            <button class="btn btn-primary" onclick="app.openNuevoInsumoModal()">
                                 Agregar Primer Insumo
                            </button>
                        </div>
                    `;
                }
                
                if (this.insumosViewMode === 'tabla') {
                    return this.renderInsumosTabla(insumos);
                }
                return this.renderInsumosCards(insumos);
            },
            
            renderInsumosCards: function(insumos) {
                return `
                    <div class="insumos-cards-grid">
                        ${insumos.map(insumo => {
                            const cat = this.insumosCategorias[insumo.categoria] || {};
                            const nivelStock = this.calcularNivelStock(insumo);
                            
                            return `
                                <div class="insumo-card">
                                    <div class="insumo-card-header">
                                        <div class="insumo-card-icon" style="background: ${cat.color || '#f3f4f6'};">
                                            ${cat.emoji || ''}
                                        </div>
                                        <div class="insumo-card-titulo">
                                            <div class="insumo-card-nombre">${insumo.nombre}</div>
                                            <div class="insumo-card-categoria">${cat.nombre || insumo.categoria}</div>
                                        </div>
                                        <span class="stock-nivel ${nivelStock.clase}">${nivelStock.texto}</span>
                                    </div>
                                    <div class="insumo-card-body">
                                        <div class="insumo-card-stock">
                                            <div class="insumo-card-stock-value" style="color: ${nivelStock.color};">
                                                ${insumo.cantidad}
                                            </div>
                                            <div class="insumo-card-stock-unit">${insumo.unidad}</div>
                                        </div>
                                        <div class="stock-bar">
                                            <div class="stock-bar-fill ${nivelStock.clase}" style="width: ${nivelStock.porcentaje}%;"></div>
                                        </div>
                                        <div class="insumo-card-meta" style="margin-top: 12px;">
                                            <div class="insumo-card-meta-item">
                                                <div style="font-weight: 600;">$${(insumo.precioUnitario || 0).toLocaleString()}</div>
                                                <div style="font-size: 10px; color: var(--gris-500);">Precio/unidad</div>
                                            </div>
                                            <div class="insumo-card-meta-item">
                                                <div style="font-weight: 600;">$${((insumo.cantidad || 0) * (insumo.precioUnitario || 0)).toLocaleString()}</div>
                                                <div style="font-size: 10px; color: var(--gris-500);">Valor total</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="insumo-card-footer">
                                        <button class="insumo-card-btn entrada" onclick="app.openMovimientoInsumoModal('${insumo.id}', 'entrada')">
                                             Entrada
                                        </button>
                                        <button class="insumo-card-btn salida" onclick="app.openMovimientoInsumoModal('${insumo.id}', 'salida')">
                                             Salida
                                        </button>
                                        <button class="insumo-card-btn" style="background: var(--gris-100);" onclick="app.editarInsumo('${insumo.id}')">
                                            锔
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            renderInsumosTabla: function(insumos) {
                return `
                    <div class="insumos-table-container">
                        <table class="insumos-table">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Categor铆a</th>
                                    <th>Stock</th>
                                    <th>M铆nimo</th>
                                    <th>Nivel</th>
                                    <th>Precio Unit.</th>
                                    <th>Valor Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${insumos.map(insumo => {
                                    const cat = this.insumosCategorias[insumo.categoria] || {};
                                    const nivelStock = this.calcularNivelStock(insumo);
                                    const valorTotal = (insumo.cantidad || 0) * (insumo.precioUnitario || 0);
                                    
                                    return `
                                        <tr>
                                            <td>
                                                <strong>${insumo.nombre}</strong>
                                                ${insumo.descripcion ? `<br><small style="color: var(--gris-500);">${insumo.descripcion}</small>` : ''}
                                            </td>
                                            <td>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    ${cat.emoji || ''} ${cat.nombre || insumo.categoria}
                                                </span>
                                            </td>
                                            <td><strong>${insumo.cantidad}</strong> ${insumo.unidad}</td>
                                            <td>${insumo.stockMinimo || 0} ${insumo.unidad}</td>
                                            <td>
                                                <span class="stock-nivel ${nivelStock.clase}">${nivelStock.texto}</span>
                                            </td>
                                            <td>$${(insumo.precioUnitario || 0).toLocaleString()}</td>
                                            <td><strong>$${valorTotal.toLocaleString()}</strong></td>
                                            <td>
                                                <div class="ganado-actions">
                                                    <button class="ganado-action-btn" style="background: #d1fae5; color: #065f46;" 
                                                            onclick="app.openMovimientoInsumoModal('${insumo.id}', 'entrada')" title="Entrada">
                                                        
                                                    </button>
                                                    <button class="ganado-action-btn" style="background: #fee2e2; color: #991b1b;" 
                                                            onclick="app.openMovimientoInsumoModal('${insumo.id}', 'salida')" title="Salida">
                                                        
                                                    </button>
                                                    <button class="ganado-action-btn edit" onclick="app.editarInsumo('${insumo.id}')" title="Editar">
                                                        锔
                                                    </button>
                                                    <button class="ganado-action-btn delete" onclick="app.eliminarInsumo('${insumo.id}')" title="Eliminar">
                                                        锔
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            // Modal nuevo/editar insumo
            openNuevoInsumoModal: function(insumoId = null) {
                const insumo = insumoId ? (this.data.insumos || []).find(i => i.id === insumoId) : null;
                const isEdit = !!insumo;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalInsumo';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 550px;">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <span>${isEdit ? '锔' : ''}</span>
                                ${isEdit ? 'Editar Insumo' : 'Nuevo Insumo'}
                            </h3>
                            <button class="modal-close" onclick="document.getElementById('modalInsumo').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Nombre del Insumo *</label>
                                <input type="text" class="form-input" id="insumoNombre" 
                                       value="${insumo?.nombre || ''}" 
                                       placeholder="Ej: Gasoil, Sal Mineral, Ivermectina">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Categor铆a *</label>
                                    <select class="form-select" id="insumoCategoria">
                                        ${Object.entries(this.insumosCategorias).map(([k, v]) => 
                                            `<option value="${k}" ${insumo?.categoria === k ? 'selected' : ''}>${v.emoji} ${v.nombre}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Unidad de Medida *</label>
                                    <select class="form-select" id="insumoUnidad">
                                        ${this.insumosUnidades.map(u => 
                                            `<option value="${u}" ${insumo?.unidad === u ? 'selected' : ''}>${u}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Cantidad Actual</label>
                                    <input type="number" class="form-input" id="insumoCantidad" 
                                           value="${insumo?.cantidad || 0}" min="0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Stock M铆nimo (alerta)</label>
                                    <input type="number" class="form-input" id="insumoStockMinimo" 
                                           value="${insumo?.stockMinimo || 0}" min="0" step="0.1">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Precio Unitario ($)</label>
                                    <input type="number" class="form-input" id="insumoPrecio" 
                                           value="${insumo?.precioUnitario || 0}" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ubicaci贸n/Almac茅n</label>
                                    <input type="text" class="form-input" id="insumoUbicacion" 
                                           value="${insumo?.ubicacion || ''}" 
                                           placeholder="Ej: Bodega Principal">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Descripci贸n / Notas</label>
                                <textarea class="form-input" id="insumoDescripcion" rows="2" 
                                          placeholder="Detalles adicionales...">${insumo?.descripcion || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalInsumo').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.guardarInsumo(${isEdit ? `'${insumo.id}'` : 'null'})">
                                <span></span> ${isEdit ? 'Actualizar' : 'Guardar'}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            guardarInsumo: function(editId) {
                const nombre = document.getElementById('insumoNombre').value.trim();
                const categoria = document.getElementById('insumoCategoria').value;
                const unidad = document.getElementById('insumoUnidad').value;
                const cantidad = parseFloat(document.getElementById('insumoCantidad').value) || 0;
                const stockMinimo = parseFloat(document.getElementById('insumoStockMinimo').value) || 0;
                const precioUnitario = parseFloat(document.getElementById('insumoPrecio').value) || 0;
                const ubicacion = document.getElementById('insumoUbicacion').value.trim();
                const descripcion = document.getElementById('insumoDescripcion').value.trim();
                
                if (!nombre) {
                    this.notify('warning', 'Nombre requerido', 'Ingresa el nombre del insumo');
                    return;
                }
                
                if (!this.data.insumos) this.data.insumos = [];
                
                const insumo = {
                    id: editId || `insumo_${Date.now()}`,
                    nombre,
                    categoria,
                    unidad,
                    cantidad,
                    stockMinimo,
                    precioUnitario,
                    ubicacion,
                    descripcion,
                    fechaActualizacion: new Date().toISOString()
                };
                
                if (editId) {
                    const index = this.data.insumos.findIndex(i => i.id === editId);
                    if (index >= 0) {
                        insumo.fechaCreacion = this.data.insumos[index].fechaCreacion;
                        this.data.insumos[index] = insumo;
                    }
                    this.notify('success', 'Insumo actualizado', `${nombre} actualizado correctamente`);
                } else {
                    insumo.fechaCreacion = new Date().toISOString();
                    this.data.insumos.push(insumo);
                    this.notify('success', 'Insumo agregado', `${nombre} agregado al inventario`);
                }
                
                this.saveData();
                document.getElementById('modalInsumo').remove();
                this.navigate('insumos');
            },
            
            editarInsumo: function(id) {
                this.openNuevoInsumoModal(id);
            },
            
            eliminarInsumo: function(id) {
                const insumo = (this.data.insumos || []).find(i => i.id === id);
                if (!insumo) return;
                
                if (confirm(`驴Eliminar "${insumo.nombre}" del inventario?\n\nEsta acci贸n no se puede deshacer.`)) {
                    this.data.insumos = this.data.insumos.filter(i => i.id !== id);
                    this.saveData();
                    this.notify('success', 'Insumo eliminado', `${insumo.nombre} ha sido eliminado`);
                    this.navigate('insumos');
                }
            },
            
            // Modal movimiento de insumo (entrada/salida)
            openMovimientoInsumoModal: function(insumoId = '', tipo = 'entrada') {
                const insumos = this.data.insumos || [];
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalMovInsumo';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header" style="background: ${tipo === 'entrada' ? 'linear-gradient(135deg, #10b981, #34d399)' : 'linear-gradient(135deg, #ef4444, #f87171)'}; color: white;">
                            <h3 class="modal-title" style="color: white;">
                                <span>${tipo === 'entrada' ? '' : ''}</span>
                                ${tipo === 'entrada' ? 'Entrada de Insumo' : 'Salida de Insumo'}
                            </h3>
                            <button class="modal-close" style="color: white;" onclick="document.getElementById('modalMovInsumo').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Insumo *</label>
                                <select class="form-select" id="movInsumoId">
                                    <option value="">Seleccionar insumo...</option>
                                    ${insumos.map(i => {
                                        const cat = this.insumosCategorias[i.categoria] || {};
                                        return `<option value="${i.id}" ${i.id === insumoId ? 'selected' : ''}>${cat.emoji || ''} ${i.nombre} (Stock: ${i.cantidad} ${i.unidad})</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Movimiento</label>
                                <div style="display: flex; gap: 12px;">
                                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; background: ${tipo === 'entrada' ? '#d1fae5' : 'var(--gris-100)'}; border-radius: 8px; cursor: pointer; border: 2px solid ${tipo === 'entrada' ? '#10b981' : 'transparent'};">
                                        <input type="radio" name="tipoMov" value="entrada" ${tipo === 'entrada' ? 'checked' : ''} onchange="app.updateTipoMovimiento('entrada')">
                                        <span> Entrada</span>
                                    </label>
                                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; background: ${tipo === 'salida' ? '#fee2e2' : 'var(--gris-100)'}; border-radius: 8px; cursor: pointer; border: 2px solid ${tipo === 'salida' ? '#ef4444' : 'transparent'};">
                                        <input type="radio" name="tipoMov" value="salida" ${tipo === 'salida' ? 'checked' : ''} onchange="app.updateTipoMovimiento('salida')">
                                        <span> Salida</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Cantidad *</label>
                                    <input type="number" class="form-input" id="movCantidad" min="0.1" step="0.1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" class="form-input" id="movFecha" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Motivo / Descripci贸n</label>
                                <input type="text" class="form-input" id="movMotivo" 
                                       placeholder="Ej: Compra proveedor, Uso en potrero 3, etc.">
                            </div>
                            
                            ${tipo === 'entrada' ? `
                                <div class="form-group">
                                    <label class="form-label">Costo Total (opcional)</label>
                                    <input type="number" class="form-input" id="movCosto" min="0" step="0.01" placeholder="0.00">
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalMovInsumo').remove()">Cancelar</button>
                            <button class="btn btn-primary" style="background: ${tipo === 'entrada' ? '#10b981' : '#ef4444'};" 
                                    onclick="app.guardarMovimientoInsumo()">
                                <span>${tipo === 'entrada' ? '' : ''}</span> Registrar ${tipo === 'entrada' ? 'Entrada' : 'Salida'}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            updateTipoMovimiento: function(tipo) {
                document.getElementById('modalMovInsumo').remove();
                const insumoId = document.getElementById('movInsumoId')?.value || '';
                this.openMovimientoInsumoModal(insumoId, tipo);
            },
            
            guardarMovimientoInsumo: function() {
                const insumoId = document.getElementById('movInsumoId').value;
                const tipo = document.querySelector('input[name="tipoMov"]:checked').value;
                const cantidad = parseFloat(document.getElementById('movCantidad').value);
                const fecha = document.getElementById('movFecha').value;
                const motivo = document.getElementById('movMotivo').value.trim();
                const costoEl = document.getElementById('movCosto');
                const costo = costoEl ? parseFloat(costoEl.value) || 0 : 0;
                
                if (!insumoId) {
                    this.notify('warning', 'Selecciona un insumo', 'Debes seleccionar el insumo');
                    return;
                }
                
                if (!cantidad || cantidad <= 0) {
                    this.notify('warning', 'Cantidad inv谩lida', 'Ingresa una cantidad v谩lida');
                    return;
                }
                
                const insumo = this.data.insumos.find(i => i.id === insumoId);
                if (!insumo) return;
                
                // Validar stock suficiente para salida
                if (tipo === 'salida' && cantidad > insumo.cantidad) {
                    this.notify('error', 'Stock insuficiente', `Solo hay ${insumo.cantidad} ${insumo.unidad} disponibles`);
                    return;
                }
                
                // Actualizar stock
                if (tipo === 'entrada') {
                    insumo.cantidad += cantidad;
                    // Actualizar precio si se proporcion贸 costo
                    if (costo > 0) {
                        insumo.precioUnitario = costo / cantidad;
                    }
                } else {
                    insumo.cantidad -= cantidad;
                }
                
                insumo.fechaActualizacion = new Date().toISOString();
                
                // Registrar movimiento
                if (!this.data.movimientosInsumos) this.data.movimientosInsumos = [];
                
                this.data.movimientosInsumos.unshift({
                    id: `movins_${Date.now()}`,
                    insumoId,
                    insumoNombre: insumo.nombre,
                    tipo,
                    cantidad,
                    unidad: insumo.unidad,
                    fecha,
                    motivo,
                    costo: tipo === 'entrada' ? costo : 0,
                    stockResultante: insumo.cantidad,
                    creadoEn: new Date().toISOString()
                });
                
                this.saveData();
                document.getElementById('modalMovInsumo').remove();
                
                this.notify('success', 
                    tipo === 'entrada' ? 'Entrada registrada' : 'Salida registrada',
                    `${cantidad} ${insumo.unidad} de ${insumo.nombre}. Stock actual: ${insumo.cantidad}`
                );
                
                this.navigate('insumos');
            },
            
            // Funciones auxiliares
            calcularEstadisticasInsumos: function() {
                const insumos = this.data.insumos || [];
                
                let valorTotal = 0;
                let stockBajo = 0;
                let sinStock = 0;
                
                insumos.forEach(i => {
                    valorTotal += (i.cantidad || 0) * (i.precioUnitario || 0);
                    
                    if (i.cantidad === 0) {
                        sinStock++;
                    } else if (i.stockMinimo && i.cantidad <= i.stockMinimo) {
                        stockBajo++;
                    }
                });
                
                return {
                    totalInsumos: insumos.length,
                    valorTotal,
                    stockBajo,
                    sinStock
                };
            },
            
            calcularNivelStock: function(insumo) {
                const cantidad = insumo.cantidad || 0;
                const minimo = insumo.stockMinimo || 0;
                
                if (cantidad === 0) {
                    return { texto: 'Sin Stock', clase: 'bajo', color: '#ef4444', porcentaje: 0 };
                }
                
                if (minimo === 0) {
                    return { texto: 'OK', clase: 'alto', color: '#10b981', porcentaje: 100 };
                }
                
                const ratio = cantidad / minimo;
                
                if (ratio <= 1) {
                    return { texto: 'Bajo', clase: 'bajo', color: '#ef4444', porcentaje: Math.min(100, ratio * 50) };
                } else if (ratio <= 2) {
                    return { texto: 'Medio', clase: 'medio', color: '#f59e0b', porcentaje: 50 + (ratio - 1) * 25 };
                } else {
                    return { texto: 'Alto', clase: 'alto', color: '#10b981', porcentaje: Math.min(100, 75 + (ratio - 2) * 12.5) };
                }
            },
            
            getAlertasStockBajo: function() {
                return (this.data.insumos || []).filter(i => {
                    return i.stockMinimo && i.cantidad <= i.stockMinimo;
                });
            },
            
            filtrarInsumos: function() {
                let insumos = this.data.insumos || [];
                
                if (this.insumosCategoriaFiltro) {
                    insumos = insumos.filter(i => i.categoria === this.insumosCategoriaFiltro);
                }
                
                return insumos;
            },
            
            filtrarInsumosPorCategoria: function(categoria) {
                this.insumosCategoriaFiltro = categoria;
                this.navigate('insumos');
            },
            
            setInsumosViewMode: function(mode) {
                this.insumosViewMode = mode;
                document.getElementById('insumosListContainer').innerHTML = this.renderInsumosList(this.filtrarInsumos());
            },
            
            exportarInsumos: function() {
                const insumos = this.data.insumos || [];
                if (insumos.length === 0) {
                    this.notify('warning', 'Sin datos', 'No hay insumos para exportar');
                    return;
                }
                
                let csv = 'Nombre,Categor铆a,Cantidad,Unidad,Stock M铆nimo,Precio Unitario,Valor Total,Ubicaci贸n\n';
                
                insumos.forEach(i => {
                    const cat = this.insumosCategorias[i.categoria]?.nombre || i.categoria;
                    const valorTotal = (i.cantidad || 0) * (i.precioUnitario || 0);
                    csv += `"${i.nombre}","${cat}",${i.cantidad},"${i.unidad}",${i.stockMinimo || 0},${i.precioUnitario || 0},${valorTotal},"${i.ubicacion || ''}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `insumos_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                this.notify('success', 'Exportado', `${insumos.length} insumos exportados a CSV`);
            },

            renderPluviometro: function() {
                const stats = this.calcularEstadisticasLluvias();
                const ultimosRegistros = (this.data.lluvias || []).slice(0, 10);
                const hoy = new Date();
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">э</span>
                                Pluvi贸metro - Registro de Lluvias
                            </h3>
                            <button class="btn btn-secondary" onclick="app.exportarLluvias()">
                                <span></span> Exportar
                            </button>
                        </div>
                        
                        <div style="padding: 20px;">
                            <div class="lluvia-dashboard">
                                <!-- Panel de registro -->
                                <div class="lluvia-registro-card">
                                    <div class="lluvia-registro-title"> Registrar Precipitaci贸n</div>
                                    <div class="lluvia-registro-fecha">
                                        <input type="date" id="lluviaFecha" value="${hoy.toISOString().split('T')[0]}" 
                                               style="background: transparent; border: none; color: white; font-size: 18px; font-weight: 700;">
                                    </div>
                                    
                                    <div class="lluvia-input-container">
                                        <span style="font-size: 32px;"></span>
                                        <input type="number" class="lluvia-input" id="lluviaMm" 
                                               placeholder="0" min="0" step="0.5" max="500">
                                        <span class="lluvia-unit">mm</span>
                                    </div>
                                    
                                    <div class="lluvia-quick-btns">
                                        <button class="lluvia-quick-btn" onclick="document.getElementById('lluviaMm').value = 5">5mm</button>
                                        <button class="lluvia-quick-btn" onclick="document.getElementById('lluviaMm').value = 10">10mm</button>
                                        <button class="lluvia-quick-btn" onclick="document.getElementById('lluviaMm').value = 20">20mm</button>
                                        <button class="lluvia-quick-btn" onclick="document.getElementById('lluviaMm').value = 30">30mm</button>
                                        <button class="lluvia-quick-btn" onclick="document.getElementById('lluviaMm').value = 50">50mm</button>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <input type="text" id="lluviaNotas" placeholder="Notas (opcional): tormenta, llovizna, etc." 
                                               style="width: 100%; padding: 10px; border: none; border-radius: 8px; background: rgba(255,255,255,0.2); color: white; font-size: 13px;">
                                    </div>
                                    
                                    <button class="lluvia-save-btn" onclick="app.guardarLluvia()">
                                         Guardar Registro
                                    </button>
                                </div>
                                
                                <!-- Panel de acumulados -->
                                <div class="lluvia-acumulados">
                                    <div class="lluvia-acumulados-title">
                                        <span></span> Acumulados de Precipitaci贸n
                                    </div>
                                    
                                    <div class="lluvia-stats-grid">
                                        <div class="lluvia-stat-card">
                                            <div class="lluvia-stat-value">${stats.hoy.toFixed(1)}</div>
                                            <div class="lluvia-stat-label">mm Hoy</div>
                                        </div>
                                        <div class="lluvia-stat-card">
                                            <div class="lluvia-stat-value">${stats.semana.toFixed(1)}</div>
                                            <div class="lluvia-stat-label">mm Esta Semana</div>
                                        </div>
                                        <div class="lluvia-stat-card mes">
                                            <div class="lluvia-stat-value">${stats.mes.toFixed(1)}</div>
                                            <div class="lluvia-stat-label">mm Este Mes</div>
                                        </div>
                                        <div class="lluvia-stat-card">
                                            <div class="lluvia-stat-value">${stats.anio.toFixed(1)}</div>
                                            <div class="lluvia-stat-label">mm Este A帽o</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Estad铆sticas adicionales -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
                                        <div style="text-align: center; padding: 12px; background: var(--gris-100); border-radius: 8px;">
                                            <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${stats.diasConLluvia}</div>
                                            <div style="font-size: 10px; color: var(--gris-500);">D铆as con lluvia (mes)</div>
                                        </div>
                                        <div style="text-align: center; padding: 12px; background: var(--gris-100); border-radius: 8px;">
                                            <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${stats.promedioEvento.toFixed(1)}</div>
                                            <div style="font-size: 10px; color: var(--gris-500);">mm Prom. por evento</div>
                                        </div>
                                        <div style="text-align: center; padding: 12px; background: var(--gris-100); border-radius: 8px;">
                                            <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${stats.maxEvento.toFixed(1)}</div>
                                            <div style="font-size: 10px; color: var(--gris-500);">mm M谩x. registrado</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Gr谩fico 煤ltimos 14 d铆as -->
                                    <div class="lluvia-chart-container">
                                        <div class="lluvia-chart-title"> ltimos 14 d铆as</div>
                                        <div class="lluvia-bars">
                                            ${this.renderLluviasBars()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Comparativa mensual del a帽o -->
                            <div class="lluvia-acumulados" style="margin-bottom: 24px;">
                                <div class="lluvia-acumulados-title">
                                    <span></span> Acumulado Mensual ${hoy.getFullYear()}
                                </div>
                                <div class="lluvia-comparativa">
                                    ${this.renderComparativaMensual()}
                                </div>
                            </div>
                            
                            <!-- Historial de registros -->
                            <div class="lluvia-historial">
                                <div class="lluvia-historial-header">
                                    <div class="lluvia-historial-title">
                                        <span></span> Historial de Registros
                                    </div>
                                    <select class="form-select" style="width: auto;" onchange="app.filterLluviasHistorial(this.value)">
                                        <option value="todos">Todos</option>
                                        <option value="semana">Esta semana</option>
                                        <option value="mes">Este mes</option>
                                        <option value="anio">Este a帽o</option>
                                    </select>
                                </div>
                                
                                <div class="lluvia-historial-list" id="lluviasHistorialList">
                                    ${this.renderLluviasHistorial(ultimosRegistros)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            guardarLluvia: function() {
                const fecha = document.getElementById('lluviaFecha').value;
                const mm = parseFloat(document.getElementById('lluviaMm').value);
                const notas = document.getElementById('lluviaNotas').value.trim();
                
                if (!fecha) {
                    this.notify('warning', 'Fecha requerida', 'Selecciona una fecha');
                    return;
                }
                
                if (isNaN(mm) || mm < 0) {
                    this.notify('warning', 'Cantidad inv谩lida', 'Ingresa una cantidad v谩lida en mm');
                    return;
                }
                
                if (!this.data.lluvias) this.data.lluvias = [];
                
                // Verificar si ya existe registro para esa fecha
                const existente = this.data.lluvias.findIndex(l => l.fecha === fecha);
                
                if (existente >= 0) {
                    // Actualizar existente
                    this.data.lluvias[existente].mm += mm;
                    this.data.lluvias[existente].notas = notas || this.data.lluvias[existente].notas;
                    this.data.lluvias[existente].actualizadoEn = new Date().toISOString();
                    this.notify('success', 'Registro actualizado', `${fecha}: ${this.data.lluvias[existente].mm} mm total`);
                } else {
                    // Nuevo registro
                    this.data.lluvias.unshift({
                        id: `lluvia_${Date.now()}`,
                        fecha,
                        mm,
                        notas,
                        creadoEn: new Date().toISOString()
                    });
                    this.notify('success', 'Lluvia registrada', `${mm} mm el ${new Date(fecha + 'T12:00:00').toLocaleDateString('es', { weekday: 'short', day: 'numeric', month: 'short' })}`);
                }
                
                // Ordenar por fecha descendente
                this.data.lluvias.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
                this.saveData();
                this.navigate('pluviometro');
            },
            
            eliminarLluvia: function(id) {
                const lluvia = this.data.lluvias.find(l => l.id === id);
                if (!lluvia) return;
                
                if (confirm(`驴Eliminar registro de ${lluvia.mm} mm del ${lluvia.fecha}?`)) {
                    this.data.lluvias = this.data.lluvias.filter(l => l.id !== id);
                    this.saveData();
                    this.notify('success', 'Registro eliminado', 'El registro ha sido eliminado');
                    this.navigate('pluviometro');
                }
            },
            
            calcularEstadisticasLluvias: function() {
                const lluvias = this.data.lluvias || [];
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                
                const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                const inicioAnio = new Date(hoy.getFullYear(), 0, 1);
                
                let lluviaHoy = 0;
                let lluviaSemana = 0;
                let lluviaMes = 0;
                let lluviaAnio = 0;
                let diasConLluviaMes = 0;
                let maxEvento = 0;
                let totalEventos = 0;
                let sumaEventos = 0;
                
                lluvias.forEach(l => {
                    const fecha = new Date(l.fecha + 'T12:00:00');
                    fecha.setHours(0, 0, 0, 0);
                    
                    if (fecha.getTime() === hoy.getTime()) {
                        lluviaHoy += l.mm;
                    }
                    
                    if (fecha >= inicioSemana) {
                        lluviaSemana += l.mm;
                    }
                    
                    if (fecha >= inicioMes) {
                        lluviaMes += l.mm;
                        if (l.mm > 0) diasConLluviaMes++;
                    }
                    
                    if (fecha >= inicioAnio) {
                        lluviaAnio += l.mm;
                    }
                    
                    if (l.mm > maxEvento) maxEvento = l.mm;
                    if (l.mm > 0) {
                        totalEventos++;
                        sumaEventos += l.mm;
                    }
                });
                
                return {
                    hoy: lluviaHoy,
                    semana: lluviaSemana,
                    mes: lluviaMes,
                    anio: lluviaAnio,
                    diasConLluvia: diasConLluviaMes,
                    maxEvento,
                    promedioEvento: totalEventos > 0 ? sumaEventos / totalEventos : 0
                };
            },
            
            renderLluviasBars: function() {
                const lluvias = this.data.lluvias || [];
                const hoy = new Date();
                const dias = [];
                
                // Generar 煤ltimos 14 d铆as
                for (let i = 13; i >= 0; i--) {
                    const fecha = new Date(hoy);
                    fecha.setDate(fecha.getDate() - i);
                    const fechaStr = fecha.toISOString().split('T')[0];
                    
                    const registro = lluvias.find(l => l.fecha === fechaStr);
                    dias.push({
                        fecha: fechaStr,
                        dia: fecha.getDate(),
                        diaSemana: fecha.toLocaleDateString('es', { weekday: 'short' }).substring(0, 2),
                        mm: registro ? registro.mm : 0
                    });
                }
                
                const maxMm = Math.max(...dias.map(d => d.mm), 10);
                
                return dias.map(d => {
                    const altura = d.mm > 0 ? Math.max(10, (d.mm / maxMm) * 100) : 0;
                    return `
                        <div class="lluvia-bar-container">
                            <div class="lluvia-bar" style="height: ${altura}%;" title="${d.fecha}: ${d.mm} mm">
                                ${d.mm > 0 ? `<span class="lluvia-bar-value">${d.mm}</span>` : ''}
                            </div>
                            <div class="lluvia-bar-label">${d.dia}<br>${d.diaSemana}</div>
                        </div>
                    `;
                }).join('');
            },
            
            renderComparativaMensual: function() {
                const lluvias = this.data.lluvias || [];
                const hoy = new Date();
                const anioActual = hoy.getFullYear();
                const mesActual = hoy.getMonth();
                
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const acumuladosPorMes = new Array(12).fill(0);
                
                lluvias.forEach(l => {
                    const fecha = new Date(l.fecha + 'T12:00:00');
                    if (fecha.getFullYear() === anioActual) {
                        acumuladosPorMes[fecha.getMonth()] += l.mm;
                    }
                });
                
                const maxMes = Math.max(...acumuladosPorMes, 1);
                
                return meses.map((mes, i) => {
                    const valor = acumuladosPorMes[i];
                    let intensidad = '';
                    if (valor > maxMes * 0.75) intensidad = 'intensidad-muy-alta';
                    else if (valor > maxMes * 0.5) intensidad = 'intensidad-alta';
                    else if (valor > maxMes * 0.25) intensidad = 'intensidad-media';
                    else if (valor > 0) intensidad = 'intensidad-baja';
                    
                    return `
                        <div class="lluvia-mes-card ${i === mesActual ? 'actual' : ''} ${intensidad}" 
                             onclick="app.verDetalleMes(${i})" title="${meses[i]}: ${valor.toFixed(1)} mm">
                            <div class="lluvia-mes-nombre">${mes}</div>
                            <div class="lluvia-mes-valor">${valor.toFixed(0)}</div>
                        </div>
                    `;
                }).join('');
            },
            
            renderLluviasHistorial: function(registros) {
                if (!registros || registros.length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: var(--gris-500);">
                            <div style="font-size: 48px; margin-bottom: 12px;">わ</div>
                            <div>No hay registros de lluvia</div>
                            <div style="font-size: 13px; margin-top: 8px;">Comienza registrando la primera precipitaci贸n</div>
                        </div>
                    `;
                }
                
                return registros.map(l => {
                    const fecha = new Date(l.fecha + 'T12:00:00');
                    const fechaFormateada = fecha.toLocaleDateString('es', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long',
                        year: 'numeric'
                    });
                    
                    let intensidadIcon = 'э';
                    if (l.mm >= 50) intensidadIcon = '锔';
                    else if (l.mm >= 20) intensidadIcon = 'э';
                    else if (l.mm >= 5) intensidadIcon = '锔';
                    else if (l.mm > 0) intensidadIcon = '';
                    else intensidadIcon = 'わ';
                    
                    return `
                        <div class="lluvia-historial-item">
                            <div class="lluvia-historial-icon">${intensidadIcon}</div>
                            <div class="lluvia-historial-info">
                                <div class="lluvia-historial-fecha">${fechaFormateada}</div>
                                <div class="lluvia-historial-notas">${l.notas || 'Sin notas'}</div>
                            </div>
                            <div class="lluvia-historial-valor">
                                ${l.mm}<span> mm</span>
                            </div>
                            <div class="lluvia-historial-actions">
                                <button class="ganado-action-btn delete" onclick="event.stopPropagation(); app.eliminarLluvia('${l.id}')" title="Eliminar">
                                    锔
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            filterLluviasHistorial: function(periodo) {
                let registros = this.data.lluvias || [];
                const hoy = new Date();
                
                switch (periodo) {
                    case 'semana':
                        const inicioSemana = new Date(hoy);
                        inicioSemana.setDate(hoy.getDate() - 7);
                        registros = registros.filter(l => new Date(l.fecha) >= inicioSemana);
                        break;
                    case 'mes':
                        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                        registros = registros.filter(l => new Date(l.fecha) >= inicioMes);
                        break;
                    case 'anio':
                        const inicioAnio = new Date(hoy.getFullYear(), 0, 1);
                        registros = registros.filter(l => new Date(l.fecha) >= inicioAnio);
                        break;
                }
                
                document.getElementById('lluviasHistorialList').innerHTML = this.renderLluviasHistorial(registros.slice(0, 20));
            },
            
            verDetalleMes: function(mesIndex) {
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const anio = new Date().getFullYear();
                
                const registrosMes = (this.data.lluvias || []).filter(l => {
                    const fecha = new Date(l.fecha + 'T12:00:00');
                    return fecha.getFullYear() === anio && fecha.getMonth() === mesIndex;
                });
                
                const total = registrosMes.reduce((sum, l) => sum + l.mm, 0);
                const dias = registrosMes.length;
                
                let mensaje = `${meses[mesIndex]} ${anio}\n\n`;
                mensaje += ` Total: ${total.toFixed(1)} mm\n`;
                mensaje += ` D铆as con lluvia: ${dias}\n`;
                
                if (registrosMes.length > 0) {
                    mensaje += `\nRegistros:\n`;
                    registrosMes.slice(0, 5).forEach(l => {
                        mensaje += ` ${new Date(l.fecha).getDate()}/${mesIndex + 1}: ${l.mm} mm\n`;
                    });
                    if (registrosMes.length > 5) {
                        mensaje += `...y ${registrosMes.length - 5} m谩s`;
                    }
                }
                
                this.notify('info', `э ${meses[mesIndex]}`, mensaje);
            },
            
            exportarLluvias: function() {
                const lluvias = this.data.lluvias || [];
                if (lluvias.length === 0) {
                    this.notify('warning', 'Sin datos', 'No hay registros de lluvia para exportar');
                    return;
                }
                
                let csv = 'Fecha,Mil铆metros,Notas\n';
                lluvias.forEach(l => {
                    csv += `"${l.fecha}",${l.mm},"${l.notas || ''}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `lluvias_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                this.notify('success', 'Exportado', `${lluvias.length} registros exportados a CSV`);
            },

            renderAutoReportes: function() {
                this.loadAutoReportConfig();
                const countdown = this.calcularCountdown();
                
                const html = `
                    <div class="auto-report-container">
                        <div class="auto-report-header">
                            <h3> Reportes Autom谩ticos</h3>
                            <p>Recibe res煤menes semanales de tu operaci贸n ganadera</p>
                            <div class="auto-report-status">
                                <div class="auto-report-status-dot ${this.autoReportConfig.enabled ? 'active' : 'inactive'}"></div>
                                <span>${this.autoReportConfig.enabled ? 'Sistema Activo' : 'Sistema Desactivado'}</span>
                            </div>
                        </div>
                        
                        <div class="auto-report-config">
                            <!-- Countdown -->
                            ${this.autoReportConfig.enabled ? `
                                <div class="next-report-countdown">
                                    <div class="countdown-label"> Pr贸ximo reporte en</div>
                                    <div class="countdown-value" id="countdownValue">${countdown.texto}</div>
                                    <div class="countdown-detail">${this.getDayName(this.autoReportConfig.dayOfWeek)} a las ${String(this.autoReportConfig.hour).padStart(2, '0')}:${String(this.autoReportConfig.minute).padStart(2, '0')}</div>
                                </div>
                            ` : ''}
                            
                            <!-- Activar/Desactivar -->
                            <div class="auto-report-section">
                                <div class="auto-report-section-title">
                                    <span></span> Estado del Sistema
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--gris-100); border-radius: 10px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">Reportes Autom谩ticos</div>
                                        <div style="font-size: 12px; color: var(--gris-500);">
                                            ${this.autoReportConfig.enabled ? 'Recibir谩s reportes cada semana' : 'Activa para recibir reportes semanales'}
                                        </div>
                                    </div>
                                    <div class="recipient-toggle ${this.autoReportConfig.enabled ? 'active' : ''}" 
                                         onclick="app.toggleAutoReport()"></div>
                                </div>
                            </div>
                            
                            <!-- Programaci贸n -->
                            <div class="auto-report-section">
                                <div class="auto-report-section-title">
                                    <span></span> D铆a de Env铆o
                                </div>
                                <div class="schedule-grid">
                                    ${['Dom', 'Lun', 'Mar', 'Mi茅', 'Jue', 'Vie', 'S谩b'].map((day, i) => `
                                        <div class="schedule-day ${this.autoReportConfig.dayOfWeek === i ? 'selected' : ''}" 
                                             onclick="app.setAutoReportDay(${i})">
                                            <div class="schedule-day-name">${day}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="auto-report-section-title" style="margin-top: 16px;">
                                    <span></span> Hora de Env铆o
                                </div>
                                <div class="time-picker-container">
                                    <div class="time-picker">
                                        <input type="number" id="autoReportHour" value="${this.autoReportConfig.hour}" 
                                               min="0" max="23" onchange="app.setAutoReportTime()">
                                        <span style="font-size: 24px; color: var(--gris-400);">:</span>
                                        <input type="number" id="autoReportMinute" value="${String(this.autoReportConfig.minute).padStart(2, '0')}" 
                                               min="0" max="59" step="15" onchange="app.setAutoReportTime()">
                                    </div>
                                    <div class="time-picker-label">
                                        Hora local (formato 24h)
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Destinatarios -->
                            <div class="auto-report-section">
                                <div class="auto-report-section-title">
                                    <span></span> Destinatarios
                                </div>
                                <div class="recipients-list">
                                    ${this.autoReportConfig.recipients.length > 0 ? 
                                        this.autoReportConfig.recipients.map((r, i) => `
                                            <div class="recipient-item">
                                                <div class="recipient-icon ${r.type}">
                                                    ${r.type === 'whatsapp' ? '<i class="fab fa-whatsapp"></i>' : ''}
                                                </div>
                                                <div class="recipient-info">
                                                    <div class="recipient-name">${r.name}</div>
                                                    <div class="recipient-contact">${r.contact}</div>
                                                </div>
                                                <button class="btn btn-small" style="background: #fee2e2; color: #dc2626;" 
                                                        onclick="app.removeRecipient(${i})">
                                                    锔
                                                </button>
                                            </div>
                                        `).join('') 
                                    : '<div style="text-align: center; padding: 20px; color: var(--gris-500);">No hay destinatarios configurados</div>'}
                                    
                                    <div class="add-recipient-btn" onclick="app.openAddRecipientModal()">
                                        <span></span> Agregar Destinatario
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contenido -->
                            <div class="auto-report-section">
                                <div class="auto-report-section-title">
                                    <span></span> Contenido del Reporte
                                </div>
                                <div class="content-checklist">
                                    <label class="content-check-item ${this.autoReportConfig.content.resumenGeneral ? 'checked' : ''}">
                                        <input type="checkbox" ${this.autoReportConfig.content.resumenGeneral ? 'checked' : ''} 
                                               onchange="app.toggleReportContent('resumenGeneral')">
                                        <span> Resumen General</span>
                                    </label>
                                    <label class="content-check-item ${this.autoReportConfig.content.movimientos ? 'checked' : ''}">
                                        <input type="checkbox" ${this.autoReportConfig.content.movimientos ? 'checked' : ''} 
                                               onchange="app.toggleReportContent('movimientos')">
                                        <span> Movimientos de Ganado</span>
                                    </label>
                                    <label class="content-check-item ${this.autoReportConfig.content.estadoPotreros ? 'checked' : ''}">
                                        <input type="checkbox" ${this.autoReportConfig.content.estadoPotreros ? 'checked' : ''} 
                                               onchange="app.toggleReportContent('estadoPotreros')">
                                        <span>猴 Estado de Potreros</span>
                                    </label>
                                    <label class="content-check-item ${this.autoReportConfig.content.climaSemana ? 'checked' : ''}">
                                        <input type="checkbox" ${this.autoReportConfig.content.climaSemana ? 'checked' : ''} 
                                               onchange="app.toggleReportContent('climaSemana')">
                                        <span>★ Resumen Clim谩tico</span>
                                    </label>
                                    <label class="content-check-item ${this.autoReportConfig.content.alertasPRV ? 'checked' : ''}">
                                        <input type="checkbox" ${this.autoReportConfig.content.alertasPRV ? 'checked' : ''} 
                                               onchange="app.toggleReportContent('alertasPRV')">
                                        <span> Alertas PRV</span>
                                    </label>
                                    <label class="content-check-item ${this.autoReportConfig.content.inventarioGanado ? 'checked' : ''}">
                                        <input type="checkbox" ${this.autoReportConfig.content.inventarioGanado ? 'checked' : ''} 
                                               onchange="app.toggleReportContent('inventarioGanado')">
                                        <span> Inventario de Ganado</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Acciones -->
                            <div style="display: flex; gap: 12px; justify-content: center; padding-top: 16px; border-top: 1px solid var(--gris-200);">
                                <button class="btn btn-secondary" onclick="app.previewAutoReport()">
                                    锔 Vista Previa
                                </button>
                                <button class="btn btn-primary" onclick="app.sendTestReport()">
                                     Enviar Ahora (Test)
                                </button>
                            </div>
                            
                            <!-- Historial -->
                            ${this.autoReportHistory.length > 0 ? `
                                <div class="auto-report-section" style="margin-top: 24px;">
                                    <div class="auto-report-section-title">
                                        <span></span> Historial de Env铆os
                                    </div>
                                    <div class="report-history-list">
                                        ${this.autoReportHistory.slice(0, 5).map(h => `
                                            <div class="report-history-item">
                                                <div class="report-history-icon"></div>
                                                <div class="report-history-info">
                                                    <div class="report-history-title">Reporte Semanal</div>
                                                    <div class="report-history-meta">
                                                        <span> ${new Date(h.fecha).toLocaleDateString('es', { weekday: 'short', day: 'numeric', month: 'short' })}</span>
                                                        <span> ${h.recipients} destinatario(s)</span>
                                                    </div>
                                                </div>
                                                <div class="report-history-status ${h.status}">${h.status === 'sent' ? ' Enviado' : ' Pendiente'}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
                
                // Iniciar contador
                if (this.autoReportConfig.enabled) {
                    this.startCountdownTimer();
                }
            },
            
            loadAutoReportConfig: function() {
                const saved = localStorage.getItem('nexusAgroAutoReport');
                if (saved) {
                    this.autoReportConfig = { ...this.autoReportConfig, ...JSON.parse(saved) };
                }
                
                const history = localStorage.getItem('nexusAgroAutoReportHistory');
                if (history) {
                    this.autoReportHistory = JSON.parse(history);
                }
            },
            
            saveAutoReportConfig: function() {
                localStorage.setItem('nexusAgroAutoReport', JSON.stringify(this.autoReportConfig));
            },
            
            toggleAutoReport: function() {
                this.autoReportConfig.enabled = !this.autoReportConfig.enabled;
                this.saveAutoReportConfig();
                
                if (this.autoReportConfig.enabled) {
                    this.scheduleAutoReport();
                    this.notify('success', 'Reportes Activados', `Recibir谩s reportes cada ${this.getDayName(this.autoReportConfig.dayOfWeek)}`);
                } else {
                    this.cancelScheduledReport();
                    this.notify('info', 'Reportes Desactivados', 'No recibir谩s m谩s reportes autom谩ticos');
                }
                
                this.navigate('autoreportes');
            },
            
            setAutoReportDay: function(day) {
                this.autoReportConfig.dayOfWeek = day;
                this.saveAutoReportConfig();
                this.navigate('autoreportes');
            },
            
            setAutoReportTime: function() {
                this.autoReportConfig.hour = parseInt(document.getElementById('autoReportHour').value) || 8;
                this.autoReportConfig.minute = parseInt(document.getElementById('autoReportMinute').value) || 0;
                this.saveAutoReportConfig();
            },
            
            toggleReportContent: function(key) {
                this.autoReportConfig.content[key] = !this.autoReportConfig.content[key];
                this.saveAutoReportConfig();
            },
            
            getDayName: function(day) {
                const days = ['Domingo', 'Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado'];
                return days[day];
            },
            
            calcularCountdown: function() {
                const now = new Date();
                const target = new Date();
                
                // Establecer el d铆a objetivo
                const daysUntil = (this.autoReportConfig.dayOfWeek - now.getDay() + 7) % 7;
                target.setDate(now.getDate() + (daysUntil === 0 ? 7 : daysUntil));
                target.setHours(this.autoReportConfig.hour, this.autoReportConfig.minute, 0, 0);
                
                // Si es hoy pero ya pas贸 la hora, ir a la pr贸xima semana
                if (daysUntil === 0 && now > target) {
                    target.setDate(target.getDate() + 7);
                }
                
                const diff = target - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                let texto = '';
                if (days > 0) texto += `${days}d `;
                if (hours > 0 || days > 0) texto += `${hours}h `;
                texto += `${minutes}m`;
                
                return { dias: days, horas: hours, minutos: minutes, texto, target };
            },
            
            startCountdownTimer: function() {
                if (this.autoReportTimer) clearInterval(this.autoReportTimer);
                
                this.autoReportTimer = setInterval(() => {
                    const countdown = this.calcularCountdown();
                    const el = document.getElementById('countdownValue');
                    if (el) {
                        el.textContent = countdown.texto;
                    }
                    
                    // Verificar si es hora de enviar
                    if (countdown.dias === 0 && countdown.horas === 0 && countdown.minutos === 0) {
                        this.executeAutoReport();
                    }
                }, 60000); // Actualizar cada minuto
            },
            
            scheduleAutoReport: function() {
                this.startCountdownTimer();
            },
            
            cancelScheduledReport: function() {
                if (this.autoReportTimer) {
                    clearInterval(this.autoReportTimer);
                    this.autoReportTimer = null;
                }
            },
            
            // Modal agregar destinatario
            openAddRecipientModal: function() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalRecipient';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span></span> Agregar Destinatario</h3>
                            <button class="modal-close" onclick="document.getElementById('modalRecipient').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Tipo de Env铆o</label>
                                <div style="display: flex; gap: 12px;">
                                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 16px; background: var(--gris-100); border-radius: 10px; cursor: pointer; border: 2px solid transparent;" class="recipient-type-option" data-type="whatsapp">
                                        <input type="radio" name="recipientType" value="whatsapp" checked onchange="app.updateRecipientType(this.value)">
                                        <span style="font-size: 24px;"><i class="fab fa-whatsapp" style="color: #25D366;"></i></span>
                                        <span>WhatsApp</span>
                                    </label>
                                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 16px; background: var(--gris-100); border-radius: 10px; cursor: pointer; border: 2px solid transparent;" class="recipient-type-option" data-type="email">
                                        <input type="radio" name="recipientType" value="email" onchange="app.updateRecipientType(this.value)">
                                        <span style="font-size: 24px;"></span>
                                        <span>Email</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-input" id="recipientName" placeholder="Ej: Juan P茅rez">
                            </div>
                            <div class="form-group">
                                <label class="form-label" id="recipientContactLabel">N煤mero de WhatsApp</label>
                                <input type="text" class="form-input" id="recipientContact" placeholder="+58 412-000-0000">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalRecipient').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.addRecipient()">
                                <span></span> Agregar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            updateRecipientType: function(type) {
                const label = document.getElementById('recipientContactLabel');
                const input = document.getElementById('recipientContact');
                
                if (type === 'whatsapp') {
                    label.textContent = 'N煤mero de WhatsApp';
                    input.placeholder = '+58 412-000-0000';
                } else {
                    label.textContent = 'Correo Electr贸nico';
                    input.placeholder = 'ejemplo@correo.com';
                }
            },
            
            addRecipient: function() {
                const type = document.querySelector('input[name="recipientType"]:checked').value;
                const name = document.getElementById('recipientName').value.trim();
                const contact = document.getElementById('recipientContact').value.trim();
                
                if (!name || !contact) {
                    this.notify('warning', 'Datos incompletos', 'Ingresa nombre y contacto');
                    return;
                }
                
                this.autoReportConfig.recipients.push({ type, name, contact });
                this.saveAutoReportConfig();
                document.getElementById('modalRecipient').remove();
                this.notify('success', 'Destinatario agregado', `${name} recibir谩 los reportes`);
                this.navigate('autoreportes');
            },
            
            removeRecipient: function(index) {
                const recipient = this.autoReportConfig.recipients[index];
                if (confirm(`驴Eliminar a ${recipient.name} de los destinatarios?`)) {
                    this.autoReportConfig.recipients.splice(index, 1);
                    this.saveAutoReportConfig();
                    this.navigate('autoreportes');
                }
            },
            
            // Generar contenido del reporte
            generateWeeklyReportContent: function() {
                const nombreFinca = localStorage.getItem('reportNombreFinca') || 'Mi Finca';
                const fechaHoy = new Date();
                const fechaInicio = new Date(fechaHoy);
                fechaInicio.setDate(fechaInicio.getDate() - 7);
                
                let reporte = ` *REPORTE SEMANAL*\n`;
                reporte += ` ${nombreFinca}\n`;
                reporte += ` ${fechaInicio.toLocaleDateString('es')} - ${fechaHoy.toLocaleDateString('es')}\n`;
                reporte += `\n\n`;
                
                // Resumen General
                if (this.autoReportConfig.content.resumenGeneral) {
                    const stats = this.calculateStats();
                    reporte += ` *RESUMEN GENERAL*\n`;
                    reporte += ` Potreros: ${stats.totalPotreros} (${stats.ocupados} ocupados)\n`;
                    reporte += ` Superficie: ${stats.superficieTotal.toFixed(1)} Ha\n`;
                    reporte += ` Utilizaci贸n: ${stats.totalPotreros > 0 ? ((stats.ocupados / stats.totalPotreros) * 100).toFixed(0) : 0}%\n\n`;
                }
                
                // Movimientos de la semana
                if (this.autoReportConfig.content.movimientos) {
                    const movsSemanales = this.data.movimientos.filter(m => {
                        const fecha = new Date(m.fechaEntrada);
                        return fecha >= fechaInicio;
                    });
                    
                    reporte += ` *MOVIMIENTOS (${movsSemanales.length})*\n`;
                    if (movsSemanales.length > 0) {
                        movsSemanales.slice(0, 5).forEach(m => {
                            reporte += ` ${m.potreroId}: ${m.cultivo} (${new Date(m.fechaEntrada).toLocaleDateString('es')})\n`;
                        });
                        if (movsSemanales.length > 5) {
                            reporte += `  _...y ${movsSemanales.length - 5} m谩s_\n`;
                        }
                    } else {
                        reporte += ` Sin movimientos esta semana\n`;
                    }
                    reporte += `\n`;
                }
                
                // Estado de Potreros
                if (this.autoReportConfig.content.estadoPotreros) {
                    const ocupados = this.data.movimientos.filter(m => m.estado === 'activo');
                    reporte += `猴 *POTREROS OCUPADOS (${ocupados.length})*\n`;
                    ocupados.forEach(m => {
                        const dias = Math.floor((new Date() - new Date(m.fechaEntrada)) / (1000 * 60 * 60 * 24));
                        reporte += ` ${m.potreroId}: ${dias} d铆as\n`;
                    });
                    reporte += `\n`;
                }
                
                // Alertas PRV
                if (this.autoReportConfig.content.alertasPRV) {
                    this.loadPRVConfig();
                    const alertas = [];
                    
                    this.data.movimientos.filter(m => m.estado === 'activo').forEach(m => {
                        const dias = Math.floor((new Date() - new Date(m.fechaEntrada)) / (1000 * 60 * 60 * 24));
                        if (dias >= this.prvConfig.diasOcupacion) {
                            alertas.push(`锔 ${m.potreroId}: ${dias} d铆as (excede ocupaci贸n)`);
                        }
                    });
                    
                    if (alertas.length > 0) {
                        reporte += ` *ALERTAS PRV*\n`;
                        alertas.forEach(a => reporte += `${a}\n`);
                        reporte += `\n`;
                    }
                }
                
                // Inventario
                if (this.autoReportConfig.content.inventarioGanado) {
                    const ganadoStats = this.calcularEstadisticasGanado();
                    reporte += ` *INVENTARIO*\n`;
                    reporte += ` Total: ${ganadoStats.totalCabezas} cabezas\n`;
                    reporte += ` UGM: ${ganadoStats.totalUGM.toFixed(1)}\n`;
                    reporte += ` En tratamiento: ${ganadoStats.enTratamiento}\n\n`;
                }
                
                reporte += `\n`;
                reporte += `_Generado por WIN-TEL AgroManager PRO_\n`;
                reporte += ` +58 412-406-0610`;
                
                return reporte;
            },
            
            // Enviar reporte
            sendTestReport: function() {
                if (this.autoReportConfig.recipients.length === 0) {
                    this.notify('warning', 'Sin destinatarios', 'Agrega al menos un destinatario');
                    return;
                }
                
                const reporte = this.generateWeeklyReportContent();
                
                // Enviar por WhatsApp a cada destinatario
                this.autoReportConfig.recipients.forEach(r => {
                    if (r.type === 'whatsapp') {
                        const numero = r.contact.replace(/[^0-9]/g, '');
                        const url = `https://wa.me/${numero}?text=${encodeURIComponent(reporte)}`;
                        window.open(url, '_blank');
                    } else {
                        const subject = encodeURIComponent(`Reporte Semanal - ${localStorage.getItem('reportNombreFinca') || 'Mi Finca'}`);
                        const body = encodeURIComponent(reporte.replace(/\*/g, '').replace(/_/g, ''));
                        window.location.href = `mailto:${r.contact}?subject=${subject}&body=${body}`;
                    }
                });
                
                // Guardar en historial
                this.autoReportHistory.unshift({
                    fecha: new Date().toISOString(),
                    recipients: this.autoReportConfig.recipients.length,
                    status: 'sent'
                });
                this.autoReportHistory = this.autoReportHistory.slice(0, 20);
                localStorage.setItem('nexusAgroAutoReportHistory', JSON.stringify(this.autoReportHistory));
                
                this.notify('success', 'Reporte Enviado', `Enviado a ${this.autoReportConfig.recipients.length} destinatario(s)`);
                this.navigate('autoreportes');
            },
            
            executeAutoReport: function() {
                // Esta funci贸n se ejecutar铆a autom谩ticamente
                // Como es una app web, simularemos con notificaci贸n
                this.sendTestReport();
            },
            
            previewAutoReport: function() {
                const reporte = this.generateWeeklyReportContent();
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalPreviewReport';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span>锔</span> Vista Previa del Reporte</h3>
                            <button class="modal-close" onclick="document.getElementById('modalPreviewReport').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #dcf8c6; padding: 16px; border-radius: 12px; font-family: monospace; white-space: pre-wrap; font-size: 13px; max-height: 400px; overflow-y: auto;">
${reporte}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalPreviewReport').remove()">Cerrar</button>
                            <button class="btn btn-primary" onclick="document.getElementById('modalPreviewReport').remove(); app.sendTestReport();">
                                 Enviar Ahora
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },

            renderInventario: function() {
                const stats = this.calcularEstadisticasGanado();
                const ganadoFiltrado = this.filtrarGanado();
                const especiesActivas = Object.entries(this.especiesConfig).filter(([k, v]) => v.enabled);
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Inventario de Ganado Multi-especie
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="app.openConfigEspecies()">
                                    <span>锔</span> Especies
                                </button>
                                <button class="btn btn-primary" onclick="app.openNuevoAnimalModal()">
                                    <span></span> Nuevo Animal
                                </button>
                                <button class="btn btn-secondary" onclick="app.exportarInventario()">
                                    <span></span> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Estad铆sticas generales -->
                            <div class="ganado-stats-grid">
                                <div class="ganado-stat-card">
                                    <div class="ganado-stat-value">${stats.totalCabezas}</div>
                                    <div class="ganado-stat-label">Total Cabezas</div>
                                </div>
                                <div class="ganado-stat-card info">
                                    <div class="ganado-stat-value">${stats.totalUGM.toFixed(1)}</div>
                                    <div class="ganado-stat-label">Total UGM</div>
                                </div>
                                <div class="ganado-stat-card">
                                    <div class="ganado-stat-value">${stats.pesoTotal.toLocaleString()}</div>
                                    <div class="ganado-stat-label">Peso Total (kg)</div>
                                </div>
                                <div class="ganado-stat-card warning">
                                    <div class="ganado-stat-value">${stats.enTratamiento}</div>
                                    <div class="ganado-stat-label">En Tratamiento</div>
                                </div>
                            </div>
                            
                            <!-- Resumen por especie -->
                            <div class="especies-resumen-grid">
                                ${especiesActivas.map(([especieKey, especie]) => {
                                    const statsEspecie = this.calcularEstadisticasEspecie(especieKey);
                                    return `
                                        <div class="especie-resumen-card" onclick="app.updateGanadoFilter('especie', '${especieKey}')">
                                            <div class="especie-resumen-header ${especieKey}">
                                                <div class="especie-resumen-icon">${especie.emoji}</div>
                                                <div class="especie-resumen-titulo">
                                                    <div class="especie-resumen-nombre">${especie.nombre}</div>
                                                    <div class="especie-resumen-subtitulo">${statsEspecie.categorias} categor铆as</div>
                                                </div>
                                                <div style="font-size: 32px; font-weight: 700;">${statsEspecie.total}</div>
                                            </div>
                                            <div class="especie-resumen-body">
                                                <div class="especie-stats-row">
                                                    <span class="especie-stats-label">UGM Total</span>
                                                    <span class="especie-stats-value">${statsEspecie.ugm.toFixed(2)}</span>
                                                </div>
                                                <div class="especie-stats-row">
                                                    <span class="especie-stats-label">Peso Total</span>
                                                    <span class="especie-stats-value">${statsEspecie.peso.toLocaleString()} kg</span>
                                                </div>
                                                <div class="especie-stats-row">
                                                    <span class="especie-stats-label">En Tratamiento</span>
                                                    <span class="especie-stats-value">${statsEspecie.enTratamiento}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Tabs de especie -->
                            <div class="especies-tabs">
                                <div class="especie-tab ${!this.ganadoFilter.especie ? 'active' : ''}" 
                                     onclick="app.updateGanadoFilter('especie', '')">
                                    <div class="especie-tab-icon"></div>
                                    <div class="especie-tab-info">
                                        <div class="especie-tab-nombre">Todos</div>
                                        <div class="especie-tab-count">${stats.totalCabezas} animales</div>
                                    </div>
                                </div>
                                ${especiesActivas.map(([key, esp]) => {
                                    const count = this.calcularEstadisticasEspecie(key).total;
                                    return `
                                        <div class="especie-tab ${this.ganadoFilter.especie === key ? 'active' : ''}" 
                                             onclick="app.updateGanadoFilter('especie', '${key}')">
                                            <div class="especie-tab-icon">${esp.emoji}</div>
                                            <div class="especie-tab-info">
                                                <div class="especie-tab-nombre">${esp.nombre}</div>
                                                <div class="especie-tab-count">${count} animales</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Resumen por categor铆a de la especie seleccionada -->
                            ${this.renderResumenCategorias()}
                            
                            <!-- Filtros -->
                            <div class="ganado-filters">
                                <input type="text" class="ganado-search" placeholder=" Buscar por ID o nombre..." 
                                       value="${this.ganadoFilter.busqueda}"
                                       oninput="app.updateGanadoFilter('busqueda', this.value)">
                                
                                <div class="ganado-filter-group">
                                    <label class="ganado-filter-label">Categor铆a:</label>
                                    <select class="form-select" onchange="app.updateGanadoFilter('categoria', this.value)">
                                        <option value="">Todas</option>
                                        ${this.getCategoriasDisponibles().map(([k, v]) => 
                                            `<option value="${k}" ${this.ganadoFilter.categoria === k ? 'selected' : ''}>${v.emoji} ${v.nombre}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div class="ganado-filter-group">
                                    <label class="ganado-filter-label">Estado:</label>
                                    <select class="form-select" onchange="app.updateGanadoFilter('estado', this.value)">
                                        <option value="">Todos</option>
                                        ${Object.entries(this.ganadoEstados).map(([k, v]) => 
                                            `<option value="${k}" ${this.ganadoFilter.estado === k ? 'selected' : ''}>${v.emoji} ${v.nombre}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div class="ganado-filter-group">
                                    <label class="ganado-filter-label">Potrero:</label>
                                    <select class="form-select" onchange="app.updateGanadoFilter('potrero', this.value)">
                                        <option value="">Todos</option>
                                        <option value="sin_asignar" ${this.ganadoFilter.potrero === 'sin_asignar' ? 'selected' : ''}>Sin asignar</option>
                                        ${this.data.potreros.map(p => 
                                            `<option value="${p.id}" ${this.ganadoFilter.potrero === p.id ? 'selected' : ''}>${p.id}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <!-- Tabs de vista -->
                                <div class="ganado-view-tabs" style="margin-left: auto;">
                                    <button class="ganado-view-tab ${this.ganadoViewMode === 'tabla' ? 'active' : ''}" 
                                            onclick="app.setGanadoViewMode('tabla')">
                                         Tabla
                                    </button>
                                    <button class="ganado-view-tab ${this.ganadoViewMode === 'cards' ? 'active' : ''}" 
                                            onclick="app.setGanadoViewMode('cards')">
                                         Cards
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de ganado -->
                            <div id="ganadoListContainer">
                                ${this.renderGanadoList(ganadoFiltrado)}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            // Obtener categor铆as disponibles seg煤n especie seleccionada
            getCategoriasDisponibles: function() {
                const especieFiltro = this.ganadoFilter.especie;
                
                return Object.entries(this.ganadoCategorias).filter(([key, cat]) => {
                    if (!especieFiltro) {
                        // Mostrar solo categor铆as de especies habilitadas
                        return this.especiesConfig[cat.especie]?.enabled;
                    }
                    return cat.especie === especieFiltro;
                });
            },
            
            // Render resumen de categor铆as
            renderResumenCategorias: function() {
                const especieFiltro = this.ganadoFilter.especie;
                const categorias = this.getCategoriasDisponibles();
                const stats = this.calcularEstadisticasGanado();
                
                if (categorias.length === 0) return '';
                
                return `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        ${categorias.slice(0, 8).map(([key, cat]) => {
                            const cantidad = stats.porCategoria[key] || 0;
                            const pesoPromedio = stats.pesoPorCategoria[key] || 0;
                            return `
                                <div class="ganado-resumen-categoria" onclick="app.updateGanadoFilter('categoria', '${key}')" 
                                     style="cursor: pointer; ${this.ganadoFilter.categoria === key ? 'border: 2px solid var(--verde-medio);' : ''}">
                                    <div class="ganado-resumen-icon" style="background: ${cat.color};">
                                        ${cat.emoji}
                                    </div>
                                    <div class="ganado-resumen-info">
                                        <div class="ganado-resumen-nombre">${cat.nombre}${cantidad !== 1 ? 's' : ''}</div>
                                        <div class="ganado-resumen-detalles">
                                            ${pesoPromedio > 0 ? `${pesoPromedio.toFixed(0)} kg prom.` : 'UGM: ' + cat.ugm}
                                        </div>
                                    </div>
                                    <div class="ganado-resumen-cantidad">${cantidad}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            // Calcular estad铆sticas por especie
            calcularEstadisticasEspecie: function(especieKey) {
                const ganado = this.data.ganado || [];
                const categoriasEspecie = Object.entries(this.ganadoCategorias)
                    .filter(([k, v]) => v.especie === especieKey)
                    .map(([k]) => k);
                
                let total = 0;
                let ugm = 0;
                let peso = 0;
                let enTratamiento = 0;
                
                ganado.forEach(animal => {
                    if (categoriasEspecie.includes(animal.categoria)) {
                        total++;
                        const cat = this.ganadoCategorias[animal.categoria];
                        if (cat) ugm += cat.ugm;
                        peso += animal.peso || 0;
                        if (animal.estado === 'tratamiento') enTratamiento++;
                    }
                });
                
                return {
                    total,
                    ugm,
                    peso,
                    enTratamiento,
                    categorias: categoriasEspecie.length
                };
            },
            
            // Modal configuraci贸n de especies
            openConfigEspecies: function() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalConfigEspecies';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span>锔</span> Configurar Especies</h3>
                            <button class="modal-close" onclick="document.getElementById('modalConfigEspecies').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 20px; color: var(--gris-600);">
                                Activa o desactiva las especies seg煤n las que manejes en tu finca. Las especies desactivadas no aparecer谩n en los formularios ni estad铆sticas.
                            </p>
                            
                            <div class="especies-config-grid">
                                ${Object.entries(this.especiesConfig).map(([key, especie]) => {
                                    const stats = this.calcularEstadisticasEspecie(key);
                                    return `
                                        <div class="especie-config-card">
                                            <div class="especie-config-header">
                                                <div class="especie-config-icon">${especie.emoji}</div>
                                                <div class="especie-config-titulo">
                                                    <div class="especie-config-nombre">${especie.nombre}</div>
                                                    <div class="especie-config-desc">${stats.total} registrados  ${especie.categorias.length} categor铆as</div>
                                                </div>
                                                <div class="especie-toggle ${especie.enabled ? 'active' : ''}" 
                                                     onclick="app.toggleEspecie('${key}')"></div>
                                            </div>
                                            <div style="font-size: 12px; color: var(--gris-500);">
                                                Categor铆as: ${especie.categorias.slice(0, 4).map(c => this.ganadoCategorias[c]?.nombre || c).join(', ')}${especie.categorias.length > 4 ? '...' : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="document.getElementById('modalConfigEspecies').remove(); app.navigate('inventario');">
                                 Listo
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            toggleEspecie: function(especieKey) {
                this.especiesConfig[especieKey].enabled = !this.especiesConfig[especieKey].enabled;
                this.saveEspeciesConfig();
                
                // Actualizar toggle visual
                const modal = document.getElementById('modalConfigEspecies');
                if (modal) {
                    modal.remove();
                    this.openConfigEspecies();
                }
            },
            
            saveEspeciesConfig: function() {
                const config = {};
                Object.entries(this.especiesConfig).forEach(([k, v]) => {
                    config[k] = { enabled: v.enabled };
                });
                localStorage.setItem('nexusAgroEspeciesConfig', JSON.stringify(config));
            },
            
            loadEspeciesConfig: function() {
                const saved = localStorage.getItem('nexusAgroEspeciesConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    Object.entries(config).forEach(([k, v]) => {
                        if (this.especiesConfig[k]) {
                            this.especiesConfig[k].enabled = v.enabled;
                        }
                    });
                }
            },
            
            renderGanadoList: function(ganado) {
                if (!ganado || ganado.length === 0) {
                    return `
                        <div style="text-align: center; padding: 60px; color: var(--gris-500);">
                            <div style="font-size: 64px; margin-bottom: 16px;"></div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No hay animales registrados</div>
                            <div style="font-size: 14px; margin-bottom: 24px;">Comienza agregando tu primer animal al inventario</div>
                            <button class="btn btn-primary" onclick="app.openNuevoAnimalModal()">
                                 Agregar Primer Animal
                            </button>
                        </div>
                    `;
                }
                
                if (this.ganadoViewMode === 'cards') {
                    return this.renderGanadoCards(ganado);
                }
                return this.renderGanadoTabla(ganado);
            },
            
            renderGanadoTabla: function(ganado) {
                return `
                    <div class="ganado-table-container">
                        <table class="ganado-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Especie</th>
                                    <th>Categor铆a</th>
                                    <th>Peso (kg)</th>
                                    <th>Edad</th>
                                    <th>Estado</th>
                                    <th>Potrero</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ganado.map(animal => {
                                    const cat = this.ganadoCategorias[animal.categoria] || {};
                                    const est = this.ganadoEstados[animal.estado] || {};
                                    const especie = this.especiesConfig[cat.especie] || {};
                                    return `
                                        <tr onclick="app.verDetalleAnimal('${animal.id}')" style="cursor: pointer;">
                                            <td><strong>${animal.id}</strong></td>
                                            <td>${animal.nombre || '-'}</td>
                                            <td>
                                                <span class="especie-badge ${cat.especie || ''}">
                                                    ${especie.emoji || ''} ${especie.nombre || 'Bovino'}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="ganado-categoria-badge ${animal.categoria}">
                                                    ${cat.emoji || ''} ${cat.nombre || animal.categoria}
                                                </span>
                                            </td>
                                            <td><strong>${animal.peso || 0}</strong></td>
                                            <td>${this.calcularEdad(animal.fechaNacimiento)}</td>
                                            <td>
                                                <span class="ganado-estado ${animal.estado}">
                                                    ${est.emoji || ''} ${est.nombre || animal.estado}
                                                </span>
                                            </td>
                                            <td>${animal.potreroActual || '-'}</td>
                                            <td onclick="event.stopPropagation();">
                                                <div class="ganado-actions">
                                                    <button class="ganado-action-btn weight" onclick="app.registrarPeso('${animal.id}')" title="Registrar peso">
                                                        锔
                                                    </button>
                                                    <button class="ganado-action-btn edit" onclick="app.editarAnimal('${animal.id}')" title="Editar">
                                                        锔
                                                    </button>
                                                    <button class="ganado-action-btn delete" onclick="app.eliminarAnimal('${animal.id}')" title="Eliminar">
                                                        锔
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: var(--gris-500);">
                        Mostrando ${ganado.length} de ${this.data.ganado?.length || 0} animales
                    </div>
                `;
            },
            
            renderGanadoCards: function(ganado) {
                return `
                    <div class="ganado-cards-grid">
                        ${ganado.map(animal => {
                            const cat = this.ganadoCategorias[animal.categoria] || {};
                            const est = this.ganadoEstados[animal.estado] || {};
                            return `
                                <div class="ganado-card" onclick="app.verDetalleAnimal('${animal.id}')">
                                    <div class="ganado-card-header">
                                        <div>
                                            <div class="ganado-card-id">${animal.id}</div>
                                            <div style="font-size: 12px; opacity: 0.9;">${animal.nombre || 'Sin nombre'}</div>
                                        </div>
                                        <div class="ganado-card-categoria">${cat.emoji || ''}</div>
                                    </div>
                                    <div class="ganado-card-body">
                                        <div class="ganado-card-info">
                                            <div class="ganado-card-info-item">
                                                <div class="ganado-card-info-value">${animal.peso || 0}</div>
                                                <div class="ganado-card-info-label">Peso (kg)</div>
                                            </div>
                                            <div class="ganado-card-info-item">
                                                <div class="ganado-card-info-value">${this.calcularEdad(animal.fechaNacimiento)}</div>
                                                <div class="ganado-card-info-label">Edad</div>
                                            </div>
                                        </div>
                                        <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                                            <span class="ganado-estado ${animal.estado}">
                                                ${est.emoji || ''} ${est.nombre || animal.estado}
                                            </span>
                                            <span style="font-size: 12px; color: var(--gris-500);">
                                                ${animal.potreroActual || 'Sin asignar'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            // ========================================
            //  MDULO REPRODUCCIN v4.0
            // ========================================
            renderReproduccion: function() {
                const ganado = this.data.ganado || [];
                const hembras = ganado.filter(a => {
                    const cat = this.ganadoCategorias[a.categoria];
                    return cat && (cat.sexo === 'H' || a.categoria === 'vaca' || a.categoria === 'novilla' || a.categoria === 'vaquilla');
                });
                const pre帽adas = hembras.filter(h => h.estadoRepro === 'pre帽ada').length;
                const vacias = hembras.filter(h => h.estadoRepro === 'vacia' || !h.estadoRepro).length;
                const lactando = hembras.filter(h => h.estadoRepro === 'lactando').length;
                
                const proximosPartos = hembras.filter(h => h.fechaServicio && h.estadoRepro === 'pre帽ada').map(h => {
                    const fechaParto = new Date(new Date(h.fechaServicio).getTime() + (283 * 24 * 60 * 60 * 1000));
                    return { ...h, diasParaParto: Math.ceil((fechaParto - new Date()) / 86400000) };
                }).filter(h => h.diasParaParto > 0 && h.diasParaParto <= 60).sort((a, b) => a.diasParaParto - b.diasParaParto);

                document.getElementById('contentArea').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><span class="card-title-icon"></span> Gesti贸n Reproductiva</h3>
                            <button class="btn btn-success" onclick="app.openEventoReproModal()"><span></span> Registrar Evento</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="kpi-grid" style="margin-bottom: 24px;">
                                <div class="kpi-card verde"><div class="kpi-header"><span class="kpi-label">Hembras</span><div class="kpi-icon"></div></div><div class="kpi-value">${hembras.length}</div></div>
                                <div class="kpi-card azul"><div class="kpi-header"><span class="kpi-label">Pre帽adas</span><div class="kpi-icon">ぐ</div></div><div class="kpi-value">${pre帽adas}</div><div class="kpi-trend positive">${hembras.length > 0 ? ((pre帽adas/hembras.length)*100).toFixed(0) : 0}%</div></div>
                                <div class="kpi-card amarillo"><div class="kpi-header"><span class="kpi-label">Vac铆as</span><div class="kpi-icon"></div></div><div class="kpi-value">${vacias}</div></div>
                                <div class="kpi-card dorado"><div class="kpi-header"><span class="kpi-label">Lactando</span><div class="kpi-icon"></div></div><div class="kpi-value">${lactando}</div></div>
                            </div>
                            ${proximosPartos.length > 0 ? `<div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #fbbf24; border-radius: 16px; padding: 20px; margin-bottom: 24px;"><h4 style="color: #92400e; margin-bottom: 12px;"> Pr贸ximos Partos (60 d铆as)</h4><div style="display: flex; gap: 12px; flex-wrap: wrap;">${proximosPartos.slice(0,6).map(h => `<div style="background: white; padding: 12px; border-radius: 10px; text-align: center; min-width: 100px; cursor: pointer;" onclick="app.verDetalleAnimal('${h.id}')"><div style="font-weight: 700;">${h.id}</div><div style="font-size: 11px; color: #666;">${h.nombre || ''}</div><div style="font-size: 28px; font-weight: 800; color: #d97706; margin-top: 8px;">${h.diasParaParto}</div><div style="font-size: 10px;">d铆as</div></div>`).join('')}</div></div>` : ''}
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 24px;">
                                <button class="btn btn-secondary" onclick="app.openEventoReproModal('celo')"><span></span> Celo</button>
                                <button class="btn btn-secondary" onclick="app.openEventoReproModal('servicio')"><span></span> Servicio</button>
                                <button class="btn btn-secondary" onclick="app.openEventoReproModal('diagnostico')"><span></span> Diagn贸stico</button>
                                <button class="btn btn-secondary" onclick="app.openEventoReproModal('parto')"><span></span> Parto</button>
                                <button class="btn btn-secondary" onclick="app.openEventoReproModal('secado')"><span></span> Secado</button>
                            </div>
                            <div class="card" style="box-shadow: none; border: 1px solid var(--gris-200);">
                                <div class="card-header" style="background: var(--gris-100);"><h4> Estado Reproductivo del Hato</h4></div>
                                <div style="max-height: 350px; overflow-y: auto;">
                                    <table class="ganado-table"><thead><tr><th>ID</th><th>Nombre</th><th>Estado</th><th>ltimo Servicio</th><th>D铆as</th><th></th></tr></thead>
                                    <tbody>${hembras.map(h => {
                                        const dias = h.fechaServicio && h.estadoRepro === 'pre帽ada' ? Math.floor((new Date() - new Date(h.fechaServicio)) / 86400000) : '-';
                                        const emojis = {pre帽ada:'ぐ',vacia:'',lactando:'',seca:'',servida:''};
                                        const nombres = {pre帽ada:'Pre帽ada',vacia:'Vac铆a',lactando:'Lactando',seca:'Seca',servida:'Servida'};
                                        return `<tr><td><strong>${h.id}</strong></td><td>${h.nombre || '-'}</td><td><span class="ganado-estado ${h.estadoRepro || 'vacia'}">${emojis[h.estadoRepro] || ''} ${nombres[h.estadoRepro] || 'Sin definir'}</span></td><td>${h.fechaServicio ? new Date(h.fechaServicio).toLocaleDateString('es') : '-'}</td><td>${dias}</td><td><button class="ganado-action-btn edit" onclick="app.verHistorialRepro('${h.id}')"></button></td></tr>`;
                                    }).join('')}</tbody></table>
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            openEventoReproModal: function(tipo = null, animalId = null) {
                const hembras = (this.data.ganado || []).filter(a => { const c = this.ganadoCategorias[a.categoria]; return c && (c.sexo === 'H' || a.categoria === 'vaca' || a.categoria === 'novilla'); });
                const modal = document.createElement('div'); modal.className = 'modal-overlay active'; modal.id = 'modalEventoRepro';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `<div class="modal" style="max-width: 480px;"><div class="modal-header"><h3 class="modal-title"><span></span> Evento Reproductivo</h3><button class="modal-close" onclick="document.getElementById('modalEventoRepro').remove()"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Animal *</label><select class="form-input" id="reproAnimalId"><option value="">Seleccionar...</option>${hembras.map(h => `<option value="${h.id}" ${animalId === h.id ? 'selected' : ''}>${h.id} - ${h.nombre || ''}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Evento *</label><select class="form-input" id="reproTipo" onchange="app.toggleReproFields()"><option value="">Seleccionar...</option><option value="celo" ${tipo==='celo'?'selected':''}> Celo</option><option value="servicio" ${tipo==='servicio'?'selected':''}> Servicio/IA</option><option value="diagnostico" ${tipo==='diagnostico'?'selected':''}> Diagn贸stico</option><option value="parto" ${tipo==='parto'?'selected':''}> Parto</option><option value="secado" ${tipo==='secado'?'selected':''}> Secado</option></select></div><div class="form-group"><label class="form-label">Fecha *</label><input type="date" class="form-input" id="reproFecha" value="${new Date().toISOString().split('T')[0]}"></div><div id="reproFieldsServicio" style="display:none;"><div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="reproTipoServ"><option value="ia">Inseminaci贸n Artificial</option><option value="monta">Monta Natural</option></select></div><div class="form-group"><label class="form-label">Toro/Semen</label><input class="form-input" id="reproToro" placeholder="ID toro o pajuela"></div></div><div id="reproFieldsDiag" style="display:none;"><div class="form-group"><label class="form-label">Resultado</label><select class="form-input" id="reproDiag"><option value="positivo"> Pre帽ada</option><option value="negativo"> Vac铆a</option></select></div></div><div id="reproFieldsParto" style="display:none;"><div class="form-group"><label class="form-label">Cr铆a</label><select class="form-input" id="reproCria"><option value="vivo">Vivo</option><option value="muerto">Muerto</option></select></div><div class="form-group"><label class="form-label">Sexo</label><select class="form-input" id="reproSexo"><option value="macho">Macho</option><option value="hembra">Hembra</option></select></div></div><div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="reproObs" rows="2"></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('modalEventoRepro').remove()">Cancelar</button><button class="btn btn-success" onclick="app.guardarEventoRepro()"> Guardar</button></div></div>`;
                document.body.appendChild(modal);
                if(tipo) this.toggleReproFields();
            },

            toggleReproFields: function() { const t = document.getElementById('reproTipo')?.value; if(document.getElementById('reproFieldsServicio')) document.getElementById('reproFieldsServicio').style.display = t==='servicio'?'block':'none'; if(document.getElementById('reproFieldsDiag')) document.getElementById('reproFieldsDiag').style.display = t==='diagnostico'?'block':'none'; if(document.getElementById('reproFieldsParto')) document.getElementById('reproFieldsParto').style.display = t==='parto'?'block':'none'; },

            guardarEventoRepro: function() {
                const animalId = document.getElementById('reproAnimalId').value, tipo = document.getElementById('reproTipo').value, fecha = document.getElementById('reproFecha').value;
                if (!animalId || !tipo || !fecha) { this.notify('error', 'Error', 'Completa los campos obligatorios'); return; }
                const animal = this.data.ganado.find(a => a.id === animalId); if (!animal) return;
                const evento = { id: 'EVT-' + Date.now(), animalId, tipo, fecha, observaciones: document.getElementById('reproObs').value, fechaRegistro: new Date().toISOString() };
                if (tipo === 'servicio') { evento.tipoServicio = document.getElementById('reproTipoServ').value; evento.toro = document.getElementById('reproToro').value; animal.estadoRepro = 'servida'; animal.fechaServicio = fecha; }
                if (tipo === 'diagnostico') { evento.resultado = document.getElementById('reproDiag').value; animal.estadoRepro = evento.resultado === 'positivo' ? 'pre帽ada' : 'vacia'; if (evento.resultado === 'negativo') animal.fechaServicio = null; }
                if (tipo === 'parto') { evento.criaEstado = document.getElementById('reproCria').value; evento.criaSexo = document.getElementById('reproSexo').value; animal.estadoRepro = 'lactando'; animal.fechaUltimoParto = fecha; animal.fechaServicio = null; animal.numPartos = (animal.numPartos || 0) + 1; }
                if (tipo === 'secado') animal.estadoRepro = 'seca';
                if (tipo === 'celo') animal.ultimoCelo = fecha;
                if (!this.data.eventosReproductivos) this.data.eventosReproductivos = [];
                this.data.eventosReproductivos.push(evento);
                this.saveData(); document.getElementById('modalEventoRepro').remove(); this.notify('success', 'Registrado', `${tipo} guardado para ${animalId}`); this.renderReproduccion();
            },

            verHistorialRepro: function(animalId) {
                const eventos = (this.data.eventosReproductivos || []).filter(e => e.animalId === animalId);
                const animal = this.data.ganado.find(a => a.id === animalId);
                const modal = document.createElement('div'); modal.className = 'modal-overlay active'; modal.id = 'modalHistRepro';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                const emojis = {celo:'',servicio:'',diagnostico:'',parto:'',secado:''};
                modal.innerHTML = `<div class="modal" style="max-width: 500px;"><div class="modal-header"><h3 class="modal-title"> Historial - ${animalId}</h3><button class="modal-close" onclick="document.getElementById('modalHistRepro').remove()"></button></div><div class="modal-body"><div style="display:flex;gap:12px;margin-bottom:20px;"><div style="flex:1;text-align:center;padding:12px;background:var(--gris-100);border-radius:10px;"><div style="font-size:24px;font-weight:800;color:var(--verde-medio);">${animal?.numPartos||0}</div><div style="font-size:10px;color:var(--gris-500);">PARTOS</div></div><div style="flex:1;text-align:center;padding:12px;background:var(--gris-100);border-radius:10px;"><div style="font-size:24px;font-weight:800;color:var(--azul);">${eventos.filter(e=>e.tipo==='servicio').length}</div><div style="font-size:10px;color:var(--gris-500);">SERVICIOS</div></div></div><div class="repro-timeline" style="max-height:300px;overflow-y:auto;">${eventos.length===0?'<p style="text-align:center;color:var(--gris-500);padding:20px;">Sin eventos registrados</p>':eventos.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(e=>`<div class="repro-event ${e.tipo}"><div class="repro-event-header"><div class="repro-event-type">${emojis[e.tipo]||''} ${e.tipo.toUpperCase()}</div><div class="repro-event-date">${new Date(e.fecha).toLocaleDateString('es')}</div></div><div class="repro-event-detail">${e.observaciones||'-'}</div></div>`).join('')}</div></div><div class="modal-footer"><button class="btn btn-success" onclick="document.getElementById('modalHistRepro').remove();app.openEventoReproModal(null,'${animalId}');"> Agregar Evento</button></div></div>`;
                document.body.appendChild(modal);
            },

            // ========================================
            //  MDULO SANIDAD AVANZADA v4.0
            // ========================================
            renderSanidad: function() {
                const eventosSanidad = this.data.eventosSanidad || [];
                const alertasVac = this.getAlertasVacunacion();
                document.getElementById('contentArea').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><span class="card-title-icon"></span> Sanidad Avanzada</h3>
                            <button class="btn btn-success" onclick="app.openEventoSanidadModal()"><span></span> Registrar Evento</button>
                        </div>
                        <div style="padding: 20px;">
                            ${alertasVac.vencidas.length > 0 ? `<div class="alerta-sanitaria-card" style="margin-bottom:20px;"><div class="alerta-sanitaria-header"><div class="alerta-sanitaria-icon"></div><div><div class="alerta-sanitaria-title">隆Vacunaciones Vencidas!</div><div class="alerta-sanitaria-subtitle">${alertasVac.vencidas.length} animales requieren atenci贸n</div></div></div><div class="alerta-sanitaria-list">${alertasVac.vencidas.slice(0,5).map(a=>`<div class="alerta-sanitaria-item" onclick="app.verDetalleAnimal('${a.id}')" style="cursor:pointer;"><div class="alerta-sanitaria-animal"><div class="alerta-sanitaria-animal-icon"></div><div><div class="alerta-sanitaria-animal-id">${a.id}</div><div class="alerta-sanitaria-animal-nombre">${a.nombre||''}</div></div></div><div class="alerta-sanitaria-fecha"><div class="alerta-sanitaria-fecha-valor vencida">${a.diasVencido} d铆as</div></div></div>`).join('')}</div></div>` : alertasVac.proximas.length > 0 ? `<div class="alerta-sanitaria-card warning" style="margin-bottom:20px;"><div class="alerta-sanitaria-header"><div class="alerta-sanitaria-icon">锔</div><div><div class="alerta-sanitaria-title">Vacunaciones Pr贸ximas</div><div class="alerta-sanitaria-subtitle">${alertasVac.proximas.length} en los pr贸ximos 7 d铆as</div></div></div></div>` : ''}
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 24px;">
                                <button class="btn btn-secondary" onclick="app.openEventoSanidadModal('vacuna')" style="padding: 14px; flex-direction: column; gap: 6px;"><span style="font-size: 22px;"></span><span>Vacunaci贸n</span></button>
                                <button class="btn btn-secondary" onclick="app.openEventoSanidadModal('desparasitacion')" style="padding: 14px; flex-direction: column; gap: 6px;"><span style="font-size: 22px;"></span><span>Desparasitar</span></button>
                                <button class="btn btn-secondary" onclick="app.openEventoSanidadModal('tratamiento')" style="padding: 14px; flex-direction: column; gap: 6px;"><span style="font-size: 22px;">┖</span><span>Tratamiento</span></button>
                                <button class="btn btn-secondary" onclick="app.openEventoSanidadModal('vitaminas')" style="padding: 14px; flex-direction: column; gap: 6px;"><span style="font-size: 22px;">И</span><span>Vitaminas</span></button>
                                <button class="btn btn-secondary" onclick="app.openEventoSanidadModal('muerte')" style="padding: 14px; flex-direction: column; gap: 6px;"><span style="font-size: 22px;">帮</span><span>Baja</span></button>
                            </div>
                            <div class="card" style="box-shadow: none; border: 1px solid var(--gris-200);">
                                <div class="card-header" style="background: var(--gris-100);"><h4> ltimos Eventos de Sanidad</h4></div>
                                <div class="historial-clinico" style="padding: 16px;">
                                    ${eventosSanidad.length === 0 ? '<div style="text-align:center;padding:40px;color:var(--gris-500);"><div style="font-size:48px;margin-bottom:16px;"></div><p>No hay eventos registrados</p></div>' : eventosSanidad.slice(-15).reverse().map(e => {
                                        const iconos = {vacuna:'',desparasitacion:'',tratamiento:'┖',vitaminas:'И',muerte:'帮',enfermedad:''};
                                        return `<div class="historial-item ${e.tipo}"><div class="historial-icon">${iconos[e.tipo]||''}</div><div class="historial-content"><div class="historial-title">${e.descripcion||e.tipo}</div><div class="historial-meta"><span> ${e.animalId}</span><span> ${new Date(e.fecha).toLocaleDateString('es')}</span>${e.producto?`<span> ${e.producto}</span>`:''}</div></div></div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            openEventoSanidadModal: function(tipo = null) {
                const ganado = this.data.ganado || [];
                const modal = document.createElement('div'); modal.className = 'modal-overlay active'; modal.id = 'modalSanidad';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `<div class="modal" style="max-width: 480px;"><div class="modal-header"><h3 class="modal-title"><span></span> Evento de Sanidad</h3><button class="modal-close" onclick="document.getElementById('modalSanidad').remove()"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Aplicar a:</label><div style="display:flex;gap:8px;margin-bottom:12px;"><button class="btn btn-primary" onclick="app.toggleSanidadModo('multiple')" id="btnSanMulti" style="flex:1;"> M煤ltiples</button><button class="btn btn-secondary" onclick="app.toggleSanidadModo('individual')" id="btnSanInd" style="flex:1;"> Individual</button></div></div><div id="sanIndiv" style="display:none;"><div class="form-group"><label class="form-label">Animal</label><select class="form-input" id="sanAnimalId"><option value="">Seleccionar...</option>${ganado.map(a=>`<option value="${a.id}">${a.id} - ${a.nombre||''}</option>`).join('')}</select></div></div><div id="sanMulti"><div class="form-group"><label class="form-label">Categor铆a</label><select class="form-input" id="sanCat"><option value="todos">Todos los animales</option><option value="vacas">Vacas</option><option value="novillas">Novillas</option><option value="terneros">Terneros</option><option value="toros">Toros</option></select></div></div><div class="form-group"><label class="form-label">Tipo de Evento *</label><select class="form-input" id="sanTipo"><option value="">Seleccionar...</option><option value="vacuna" ${tipo==='vacuna'?'selected':''}> Vacunaci贸n</option><option value="desparasitacion" ${tipo==='desparasitacion'?'selected':''}> Desparasitaci贸n</option><option value="vitaminas" ${tipo==='vitaminas'?'selected':''}>И Vitaminas</option><option value="tratamiento" ${tipo==='tratamiento'?'selected':''}>┖ Tratamiento</option><option value="muerte" ${tipo==='muerte'?'selected':''}>帮 Muerte/Baja</option></select></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"><div class="form-group"><label class="form-label">Fecha *</label><input type="date" class="form-input" id="sanFecha" value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label class="form-label">Pr贸xima Aplicaci贸n</label><input type="date" class="form-input" id="sanProx"></div></div><div class="form-group"><label class="form-label">Producto / Medicamento</label><input class="form-input" id="sanProd" placeholder="Ej: Ivermectina, Aftosan..."></div><div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="sanObs" rows="2"></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('modalSanidad').remove()">Cancelar</button><button class="btn btn-success" onclick="app.guardarEventoSanidad()"> Guardar</button></div></div>`;
                document.body.appendChild(modal);
            },

            toggleSanidadModo: function(modo) { document.getElementById('sanIndiv').style.display = modo==='individual'?'block':'none'; document.getElementById('sanMulti').style.display = modo==='multiple'?'block':'none'; document.getElementById('btnSanInd').className = `btn ${modo==='individual'?'btn-primary':'btn-secondary'}`; document.getElementById('btnSanMulti').className = `btn ${modo==='multiple'?'btn-primary':'btn-secondary'}`; },

            guardarEventoSanidad: function() {
                const tipo = document.getElementById('sanTipo').value, fecha = document.getElementById('sanFecha').value;
                if (!tipo || !fecha) { this.notify('error', 'Error', 'Selecciona tipo y fecha'); return; }
                const esInd = document.getElementById('sanIndiv').style.display !== 'none';
                let animales = [];
                if (esInd) { const id = document.getElementById('sanAnimalId').value; if (!id) { this.notify('error', 'Error', 'Selecciona un animal'); return; } animales = [id]; }
                else { const cat = document.getElementById('sanCat').value; animales = cat === 'todos' ? this.data.ganado.map(a => a.id) : this.data.ganado.filter(a => a.categoria === cat).map(a => a.id); }
                if (animales.length === 0) { this.notify('warning', 'Sin Animales', 'No hay animales en esa categor铆a'); return; }
                if (!this.data.eventosSanidad) this.data.eventosSanidad = [];
                const base = { tipo, fecha, producto: document.getElementById('sanProd').value, proximaAplicacion: document.getElementById('sanProx').value, observaciones: document.getElementById('sanObs').value };
                animales.forEach(id => {
                    this.data.eventosSanidad.push({ ...base, id: 'SAN-' + Date.now() + Math.random().toString(36).substr(2,4), animalId: id, descripcion: `${tipo} - ${base.producto || 'Sin especificar'}`, fechaRegistro: new Date().toISOString() });
                    if (base.proximaAplicacion) { const a = this.data.ganado.find(x => x.id === id); if (a) a.proximaVacunacion = base.proximaAplicacion; }
                    if (tipo === 'muerte') { const a = this.data.ganado.find(x => x.id === id); if (a) { a.estado = 'baja'; a.fechaBaja = fecha; } }
                });
                this.saveData(); document.getElementById('modalSanidad').remove(); this.notify('success', 'Registrado', `${tipo} aplicado a ${animales.length} animal(es)`); this.renderSanidad();
            },

            // ========================================
            //  MDULO LECHERA v4.0
            // ========================================
            renderLecheria: function() {
                const ganado = this.data.ganado || [];
                const registrosLeche = this.data.registrosLeche || [];
                const vacasOrde帽o = ganado.filter(a => a.estadoRepro === 'lactando' || (a.categoria === 'vaca' && a.estado === 'produccion'));
                const hoy = new Date().toISOString().split('T')[0];
                const produccionHoy = registrosLeche.filter(r => r.fecha === hoy).reduce((sum, r) => sum + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                const hace7Dias = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const produccion7d = registrosLeche.filter(r => r.fecha >= hace7Dias).reduce((sum, r) => sum + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                const promedioDiario = (produccion7d / 7).toFixed(1);
                const promedioVaca = vacasOrde帽o.length > 0 ? (produccionHoy / vacasOrde帽o.length).toFixed(1) : '0.0';
                
                // Generar barras de producci贸n
                let barrasHTML = '';
                for (let i = 13; i >= 0; i--) {
                    const fecha = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                    const fechaStr = fecha.toISOString().split('T')[0];
                    const prod = registrosLeche.filter(r => r.fecha === fechaStr).reduce((sum, r) => sum + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                    const maxProd = Math.max(...Array.from({length: 14}, (_, j) => {
                        const f = new Date(Date.now() - j * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                        return registrosLeche.filter(r => r.fecha === f).reduce((s, r) => s + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                    }), 1);
                    barrasHTML += `<div class="lactancia-bar" style="height: ${(prod / maxProd) * 100}%;" title="${prod.toFixed(1)} Lt"><div class="lactancia-bar-label">${fecha.getDate()}</div></div>`;
                }

                document.getElementById('contentArea').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><span class="card-title-icon"></span> Producci贸n Lechera</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="lecheria-stats">
                                <div class="lecheria-stat"><div class="lecheria-stat-icon"></div><div class="lecheria-stat-value">${produccionHoy.toFixed(1)}</div><div class="lecheria-stat-label">Litros Hoy</div></div>
                                <div class="lecheria-stat"><div class="lecheria-stat-icon"></div><div class="lecheria-stat-value">${promedioDiario}</div><div class="lecheria-stat-label">Promedio 7d</div></div>
                                <div class="lecheria-stat"><div class="lecheria-stat-icon"></div><div class="lecheria-stat-value">${vacasOrde帽o.length}</div><div class="lecheria-stat-label">Vacas Orde帽o</div></div>
                                <div class="lecheria-stat"><div class="lecheria-stat-icon"></div><div class="lecheria-stat-value">${promedioVaca}</div><div class="lecheria-stat-label">Lt/Vaca/D铆a</div></div>
                            </div>
                            <div class="lactancia-chart"><div class="lactancia-chart-title"><span></span> Producci贸n ltimos 14 D铆as</div><div class="lactancia-bars">${barrasHTML}</div></div>
                            <div class="card" style="box-shadow: none; border: 1px solid var(--gris-200);">
                                <div class="card-header" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe);"><h4 style="color: #0369a1;"><span></span> Registro R谩pido - ${new Date().toLocaleDateString('es', {weekday: 'long', day: 'numeric', month: 'short'})}</h4></div>
                                <div class="orde帽o-registro" style="padding: 16px;">
                                    ${vacasOrde帽o.length === 0 ? '<div style="text-align:center;padding:40px;color:var(--gris-500);grid-column:1/-1;"><div style="font-size:48px;margin-bottom:16px;"></div><p>No hay vacas en orde帽o</p><p style="font-size:12px;">Marca el estado "Lactando" en Reproducci贸n</p></div>' : vacasOrde帽o.map(vaca => {
                                        const regHoy = registrosLeche.find(r => r.animalId === vaca.id && r.fecha === hoy) || {};
                                        const totalHoy = ((parseFloat(regHoy.litrosAM) || 0) + (parseFloat(regHoy.litrosPM) || 0)).toFixed(1);
                                        return `<div class="orde帽o-card"><div class="orde帽o-card-header"><div class="orde帽o-animal"><div class="orde帽o-animal-icon"></div><div><div style="font-weight:700;">${vaca.id}</div><div style="font-size:11px;color:var(--gris-500);">${vaca.nombre||''}</div></div></div><div style="text-align:right;"><div style="font-size:18px;font-weight:800;color:var(--azul);">${totalHoy} Lt</div><div style="font-size:10px;color:var(--gris-500);">HOY</div></div></div><div class="orde帽o-inputs"><div class="orde帽o-input-group"><label> AM</label><input type="number" step="0.1" min="0" placeholder="0.0" value="${regHoy.litrosAM||''}" onchange="app.guardarOrde帽oRapido('${vaca.id}','AM',this.value)"></div><div class="orde帽o-input-group"><label> PM</label><input type="number" step="0.1" min="0" placeholder="0.0" value="${regHoy.litrosPM||''}" onchange="app.guardarOrde帽oRapido('${vaca.id}','PM',this.value)"></div></div></div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            guardarOrde帽oRapido: function(animalId, turno, litros) {
                const hoy = new Date().toISOString().split('T')[0];
                if (!this.data.registrosLeche) this.data.registrosLeche = [];
                let registro = this.data.registrosLeche.find(r => r.animalId === animalId && r.fecha === hoy);
                if (!registro) { registro = { id: 'LECHE-' + Date.now(), animalId, fecha: hoy, litrosAM: 0, litrosPM: 0 }; this.data.registrosLeche.push(registro); }
                registro[turno === 'AM' ? 'litrosAM' : 'litrosPM'] = parseFloat(litros) || 0;
                this.saveData();
                this.notify('success', 'Guardado', `${litros} Lt registrados para ${animalId}`);
            },

            // ========================================
            //  MDULO ANALYTICS PRO v4.0
            // ========================================
            renderAnalytics: function() {
                const ganado = this.data.ganado || [];
                const registrosLeche = this.data.registrosLeche || [];
                const eventosSanidad = this.data.eventosSanidad || [];
                const totalAnimales = ganado.length;
                const animalesActivos = ganado.filter(a => a.estado !== 'baja' && a.estado !== 'vendido').length;
                const hembrasAptas = ganado.filter(a => { const c = this.ganadoCategorias[a.categoria]; return c && c.sexo === 'H'; });
                const pre帽adas = hembrasAptas.filter(h => h.estadoRepro === 'pre帽ada').length;
                const tasaPre帽ez = hembrasAptas.length > 0 ? ((pre帽adas / hembrasAptas.length) * 100).toFixed(1) : 0;
                const hace30Dias = new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0];
                const produccion30d = registrosLeche.filter(r => r.fecha >= hace30Dias).reduce((sum, r) => sum + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                const animalesConHistorial = ganado.filter(a => a.historialPeso && a.historialPeso.length >= 2);
                let gdpPromedio = 0;
                if (animalesConHistorial.length > 0) {
                    const gdps = animalesConHistorial.map(a => this.calcularGananciaPeso(a)).filter(g => g !== null);
                    gdpPromedio = gdps.length > 0 ? (gdps.reduce((s, g) => s + g, 0) / gdps.length * 1000).toFixed(0) : 0;
                }
                const hace1A帽o = new Date(Date.now() - 365 * 86400000).toISOString().split('T')[0];
                const muertes = eventosSanidad.filter(e => e.tipo === 'muerte' && e.fecha >= hace1A帽o).length;
                const tasaMortalidad = totalAnimales > 0 ? ((muertes / totalAnimales) * 100).toFixed(2) : 0;
                const pesoPromedio = ganado.length > 0 ? (ganado.reduce((s, a) => s + (parseFloat(a.peso) || 0), 0) / ganado.length).toFixed(0) : 0;
                const pesoTotal = ganado.reduce((s, a) => s + (parseFloat(a.peso) || 0), 0);
                
                // Mini chart
                let miniChartHTML = '';
                for (let i = 13; i >= 0; i--) {
                    const fecha = new Date(Date.now() - i * 86400000).toISOString().split('T')[0];
                    const prod = registrosLeche.filter(r => r.fecha === fecha).reduce((sum, r) => sum + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                    const max = Math.max(...Array.from({length: 14}, (_, j) => {
                        const f = new Date(Date.now() - j * 86400000).toISOString().split('T')[0];
                        return registrosLeche.filter(r => r.fecha === f).reduce((s, r) => s + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                    }), 1);
                    miniChartHTML += `<div class="analytics-mini-bar" style="height: ${(prod / max) * 100}%;"></div>`;
                }

                document.getElementById('contentArea').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><span class="card-title-icon"></span> Analytics PRO</h3>
                            <button class="btn btn-secondary" onclick="app.notify('info','Pr贸ximamente','Exportaci贸n en desarrollo')"><span></span> Exportar</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="analytics-grid">
                                <div class="analytics-card">
                                    <div class="analytics-card-header"><div class="analytics-card-title"><span></span> Inventario</div></div>
                                    <div class="analytics-kpi-big">${animalesActivos}</div><div class="analytics-kpi-label">Animales Activos</div>
                                    <div class="analytics-comparison">
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${ganado.filter(a=>a.categoria==='vaca').length}</div><div class="analytics-comparison-label">Vacas</div></div>
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${ganado.filter(a=>a.categoria==='novilla'||a.categoria==='vaquilla').length}</div><div class="analytics-comparison-label">Novillas</div></div>
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${ganado.filter(a=>a.categoria==='ternero'||a.categoria==='ternera').length}</div><div class="analytics-comparison-label">Terneros</div></div>
                                    </div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-card-header"><div class="analytics-card-title"><span></span> Reproducci贸n</div><span class="analytics-card-badge ${parseFloat(tasaPre帽ez)>=50?'up':'down'}">${tasaPre帽ez}%</span></div>
                                    <div class="analytics-kpi-big">${pre帽adas}</div><div class="analytics-kpi-label">Hembras Pre帽adas</div>
                                    <div class="analytics-comparison">
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${hembrasAptas.length}</div><div class="analytics-comparison-label">Aptas</div></div>
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${hembrasAptas.filter(h=>!h.estadoRepro||h.estadoRepro==='vacia').length}</div><div class="analytics-comparison-label">Vac铆as</div></div>
                                    </div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-card-header"><div class="analytics-card-title"><span></span> Lecher铆a 30d</div></div>
                                    <div class="analytics-kpi-big">${produccion30d.toFixed(0)}</div><div class="analytics-kpi-label">Litros Totales</div>
                                    <div class="analytics-mini-chart">${miniChartHTML}</div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-card-header"><div class="analytics-card-title"><span></span> GDP Promedio</div><span class="analytics-card-badge ${parseFloat(gdpPromedio)>=500?'up':'down'}">${gdpPromedio>=500?'ptimo':'Mejorar'}</span></div>
                                    <div class="analytics-kpi-big">${gdpPromedio}</div><div class="analytics-kpi-label">Gramos/d铆a</div>
                                    <div style="margin-top:12px;padding:10px;background:var(--gris-100);border-radius:8px;font-size:11px;color:var(--gris-600);">Meta: 500-800 g/d铆a</div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-card-header"><div class="analytics-card-title"><span></span> Sanidad</div><span class="analytics-card-badge ${parseFloat(tasaMortalidad)<=2?'up':'down'}">${tasaMortalidad}%</span></div>
                                    <div class="analytics-kpi-big">${eventosSanidad.length}</div><div class="analytics-kpi-label">Eventos Registrados</div>
                                    <div class="analytics-comparison">
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${eventosSanidad.filter(e=>e.tipo==='vacuna').length}</div><div class="analytics-comparison-label">Vacunas</div></div>
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${muertes}</div><div class="analytics-comparison-label">Muertes</div></div>
                                    </div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-card-header"><div class="analytics-card-title"><span>锔</span> Peso</div></div>
                                    <div class="analytics-kpi-big">${pesoPromedio}</div><div class="analytics-kpi-label">Kg Promedio</div>
                                    <div class="analytics-comparison">
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${Math.max(...ganado.map(a=>parseFloat(a.peso)||0),0)}</div><div class="analytics-comparison-label">M谩x</div></div>
                                        <div class="analytics-comparison-item"><div class="analytics-comparison-value">${pesoTotal.toFixed(0)}</div><div class="analytics-comparison-label">Total Kg</div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="box-shadow:none;border:1px solid var(--gris-200);margin-top:24px;">
                                <div class="card-header" style="background:var(--gris-100);"><h4><span></span> Distribuci贸n por Categor铆a</h4></div>
                                <div style="padding:20px;display:flex;gap:12px;flex-wrap:wrap;">
                                    ${Object.entries(this.ganadoCategorias).map(([key, cat]) => {
                                        const cantidad = ganado.filter(a => a.categoria === key).length;
                                        const pct = totalAnimales > 0 ? ((cantidad / totalAnimales) * 100).toFixed(1) : 0;
                                        return cantidad > 0 ? `<div style="flex:1;min-width:90px;background:var(--gris-100);border-radius:12px;padding:16px;text-align:center;"><div style="font-size:24px;">${cat.emoji}</div><div style="font-size:20px;font-weight:800;color:var(--verde-medio);">${cantidad}</div><div style="font-size:10px;color:var(--gris-500);">${cat.nombre}</div><div style="font-size:9px;color:var(--gris-400);">${pct}%</div></div>` : '';
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            // ========================================
            //  MDULO ECONOMA GANADERA v4.0
            // ========================================
            renderEconomia: function() {
                const ganado = this.data.ganado || [];
                const preciosKg = this.data.preciosKg || this.getPreciosDefault();
                
                // Calcular valorizaci贸n del hato
                let valorizacionTotal = 0;
                const valorizacionPorCategoria = {};
                
                ganado.forEach(animal => {
                    const cat = animal.categoria || 'otro';
                    const peso = parseFloat(animal.peso) || 0;
                    const precioKg = preciosKg[cat] || preciosKg.default || 2;
                    const valor = peso * precioKg;
                    
                    if (!valorizacionPorCategoria[cat]) {
                        valorizacionPorCategoria[cat] = { cantidad: 0, pesoTotal: 0, valor: 0 };
                    }
                    valorizacionPorCategoria[cat].cantidad++;
                    valorizacionPorCategoria[cat].pesoTotal += peso;
                    valorizacionPorCategoria[cat].valor += valor;
                    valorizacionTotal += valor;
                });
                
                // Calcular costos mensuales estimados
                const costosConfig = this.data.costosConfig || this.getCostosDefault();
                const costoMensual = this.calcularCostosMensuales(ganado.length, costosConfig);
                
                // Producci贸n de leche (ingresos)
                const registrosLeche = this.data.registrosLeche || [];
                const hace30 = new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0];
                const produccion30d = registrosLeche.filter(r => r.fecha >= hace30).reduce((s, r) => s + (parseFloat(r.litrosAM) || 0) + (parseFloat(r.litrosPM) || 0), 0);
                const precioLeche = costosConfig.precioLeche || 0.5;
                const ingresoLeche = produccion30d * precioLeche;
                
                // Margen operativo
                const margenOperativo = ingresoLeche - costoMensual;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><span class="card-title-icon"></span> Econom铆a Ganadera</h3>
                            <button class="btn btn-secondary" onclick="app.openConfigPreciosModal()"><span>锔</span> Configurar Precios</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="economia-summary">
                                <div class="economia-card">
                                    <div class="economia-value">$${this.formatMoney(valorizacionTotal)}</div>
                                    <div class="economia-label">Valorizaci贸n del Hato</div>
                                    <div class="economia-trend up"> ${ganado.length} cabezas</div>
                                </div>
                                <div class="economia-card green">
                                    <div class="economia-value">$${this.formatMoney(ingresoLeche)}</div>
                                    <div class="economia-label">Ingreso Leche (30d)</div>
                                    <div class="economia-trend up">${produccion30d.toFixed(0)} Lt</div>
                                </div>
                                <div class="economia-card blue">
                                    <div class="economia-value">$${this.formatMoney(costoMensual)}</div>
                                    <div class="economia-label">Costos Mensuales Est.</div>
                                    <div class="economia-trend ${costoMensual > ingresoLeche ? 'down' : 'up'}">$${(costoMensual / Math.max(ganado.length, 1)).toFixed(2)}/animal</div>
                                </div>
                                <div class="economia-card ${margenOperativo >= 0 ? 'green' : ''}" style="${margenOperativo < 0 ? 'background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #ef4444;' : ''}">
                                    <div class="economia-value" style="${margenOperativo < 0 ? 'color: #dc2626;' : ''}">${margenOperativo >= 0 ? '+' : ''}$${this.formatMoney(margenOperativo)}</div>
                                    <div class="economia-label">Margen Operativo</div>
                                    <div class="economia-trend ${margenOperativo >= 0 ? 'up' : 'down'}">${margenOperativo >= 0 ? ' Rentable' : '锔 Revisar costos'}</div>
                                </div>
                            </div>

                            <div class="card" style="box-shadow: none; border: 1px solid var(--gris-200); margin-bottom: 20px;">
                                <div class="card-header" style="background: var(--gris-100);">
                                    <h4><span></span> Valorizaci贸n por Categor铆a</h4>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table class="valorizacion-table">
                                        <thead>
                                            <tr>
                                                <th>Categor铆a</th>
                                                <th>Cantidad</th>
                                                <th>Peso Total</th>
                                                <th>Precio/Kg</th>
                                                <th>Valor Total</th>
                                                <th>% del Hato</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(valorizacionPorCategoria).map(([cat, data]) => {
                                                const catInfo = this.ganadoCategorias[cat] || { emoji: '', nombre: cat };
                                                const pct = valorizacionTotal > 0 ? ((data.valor / valorizacionTotal) * 100).toFixed(1) : 0;
                                                return `
                                                    <tr>
                                                        <td><span style="font-size: 18px;">${catInfo.emoji}</span> ${catInfo.nombre}</td>
                                                        <td><strong>${data.cantidad}</strong></td>
                                                        <td>${data.pesoTotal.toLocaleString()} kg</td>
                                                        <td>
                                                            <input type="number" class="precio-input" value="${preciosKg[cat] || preciosKg.default || 2}" 
                                                                   onchange="app.updatePrecioCategoria('${cat}', this.value)" step="0.1" min="0">
                                                        </td>
                                                        <td><strong style="color: var(--verde-medio);">$${this.formatMoney(data.valor)}</strong></td>
                                                        <td>
                                                            <div style="background: var(--gris-200); border-radius: 10px; height: 8px; width: 100px;">
                                                                <div style="background: var(--verde); border-radius: 10px; height: 100%; width: ${pct}%;"></div>
                                                            </div>
                                                            <span style="font-size: 11px;">${pct}%</span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: var(--verde-muy-claro); font-weight: 700;">
                                                <td>TOTAL</td>
                                                <td>${ganado.length}</td>
                                                <td>${ganado.reduce((s, a) => s + (parseFloat(a.peso) || 0), 0).toLocaleString()} kg</td>
                                                <td>-</td>
                                                <td style="color: var(--verde-medio); font-size: 18px;">$${this.formatMoney(valorizacionTotal)}</td>
                                                <td>100%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div class="card" style="box-shadow: none; border: 1px solid var(--gris-200);">
                                    <div class="card-header" style="background: var(--gris-100);">
                                        <h4><span></span> Estructura de Costos</h4>
                                    </div>
                                    <div style="padding: 16px;">
                                        ${this.renderCostosDetalle(costosConfig, ganado.length)}
                                    </div>
                                </div>
                                
                                <div class="card" style="box-shadow: none; border: 1px solid var(--gris-200);">
                                    <div class="card-header" style="background: var(--gris-100);">
                                        <h4><span></span> Top 5 Animales por Valor</h4>
                                    </div>
                                    <div style="padding: 16px;">
                                        ${ganado.sort((a, b) => {
                                            const va = (parseFloat(a.peso) || 0) * (preciosKg[a.categoria] || 2);
                                            const vb = (parseFloat(b.peso) || 0) * (preciosKg[b.categoria] || 2);
                                            return vb - va;
                                        }).slice(0, 5).map((a, i) => {
                                            const valor = (parseFloat(a.peso) || 0) * (preciosKg[a.categoria] || 2);
                                            return `
                                                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: ${i === 0 ? '#fef3c7' : 'var(--gris-100)'}; border-radius: 10px; margin-bottom: 8px;">
                                                    <div style="font-size: 20px;">${i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : ''}</div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 700;">${a.id}</div>
                                                        <div style="font-size: 11px; color: #666;">${a.peso || 0} kg</div>
                                                    </div>
                                                    <div style="font-weight: 700; color: var(--verde-medio);">$${this.formatMoney(valor)}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            getPreciosDefault: function() {
                return { vaca: 2.5, toro: 2.8, novilla: 2.3, novillo: 2.6, ternero: 3.0, ternera: 2.8, becerro: 3.2, becerra: 3.0, default: 2.5 };
            },

            getCostosDefault: function() {
                return { alimentacion: 15, sanidad: 5, manoObra: 200, mantenimiento: 100, servicios: 50, otros: 30, precioLeche: 0.5 };
            },

            calcularCostosMensuales: function(numAnimales, config) {
                const alimentacion = (config.alimentacion || 15) * numAnimales;
                const sanidad = (config.sanidad || 5) * numAnimales;
                const fijos = (config.manoObra || 200) + (config.mantenimiento || 100) + (config.servicios || 50) + (config.otros || 30);
                return alimentacion + sanidad + fijos;
            },

            renderCostosDetalle: function(config, numAnimales) {
                const items = [
                    { icon: '', nombre: 'Alimentaci贸n', valor: (config.alimentacion || 15) * numAnimales, tipo: 'variable' },
                    { icon: '', nombre: 'Sanidad', valor: (config.sanidad || 5) * numAnimales, tipo: 'variable' },
                    { icon: '', nombre: 'Mano de Obra', valor: config.manoObra || 200, tipo: 'fijo' },
                    { icon: '', nombre: 'Mantenimiento', valor: config.mantenimiento || 100, tipo: 'fijo' },
                    { icon: '', nombre: 'Servicios', valor: config.servicios || 50, tipo: 'fijo' },
                    { icon: '', nombre: 'Otros', valor: config.otros || 30, tipo: 'fijo' }
                ];
                const total = items.reduce((s, i) => s + i.valor, 0);
                
                return items.map(item => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--gris-200);">
                        <div style="font-size: 20px;">${item.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${item.nombre}</div>
                            <div style="font-size: 10px; color: #888;">${item.tipo === 'variable' ? 'Variable' : 'Fijo'}</div>
                        </div>
                        <div style="font-weight: 700;">$${this.formatMoney(item.valor)}</div>
                        <div style="font-size: 10px; color: #888;">${((item.valor / total) * 100).toFixed(0)}%</div>
                    </div>
                `).join('') + `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; font-weight: 700; background: var(--verde-muy-claro); margin: 8px -16px -16px; padding: 12px 16px; border-radius: 0 0 12px 12px;">
                        <div style="font-size: 20px;"></div>
                        <div style="flex: 1;">TOTAL MENSUAL</div>
                        <div style="color: var(--verde-medio); font-size: 18px;">$${this.formatMoney(total)}</div>
                    </div>
                `;
            },

            updatePrecioCategoria: function(categoria, precio) {
                if (!this.data.preciosKg) this.data.preciosKg = this.getPreciosDefault();
                this.data.preciosKg[categoria] = parseFloat(precio) || 0;
                this.saveData();
                this.renderEconomia();
            },

            openConfigPreciosModal: function() {
                const config = this.data.costosConfig || this.getCostosDefault();
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalConfigPrecios';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span>锔</span> Configurar Costos</h3>
                            <button class="modal-close" onclick="document.getElementById('modalConfigPrecios').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <h4 style="margin-bottom: 12px;"> Costos Variables (por animal/mes)</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                                <div class="form-group"><label class="form-label"> Alimentaci贸n</label><input type="number" class="form-input" id="costoAlim" value="${config.alimentacion || 15}" step="0.5"></div>
                                <div class="form-group"><label class="form-label"> Sanidad</label><input type="number" class="form-input" id="costoSan" value="${config.sanidad || 5}" step="0.5"></div>
                            </div>
                            <h4 style="margin-bottom: 12px;"> Costos Fijos (mensuales)</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                                <div class="form-group"><label class="form-label"> Mano de Obra</label><input type="number" class="form-input" id="costoMO" value="${config.manoObra || 200}"></div>
                                <div class="form-group"><label class="form-label"> Mantenimiento</label><input type="number" class="form-input" id="costoMant" value="${config.mantenimiento || 100}"></div>
                                <div class="form-group"><label class="form-label"> Servicios</label><input type="number" class="form-input" id="costoServ" value="${config.servicios || 50}"></div>
                                <div class="form-group"><label class="form-label"> Otros</label><input type="number" class="form-input" id="costoOtros" value="${config.otros || 30}"></div>
                            </div>
                            <h4 style="margin-bottom: 12px;"> Precio de Venta</h4>
                            <div class="form-group"><label class="form-label">Precio por Litro de Leche ($)</label><input type="number" class="form-input" id="precioLeche" value="${config.precioLeche || 0.5}" step="0.05"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalConfigPrecios').remove()">Cancelar</button>
                            <button class="btn btn-success" onclick="app.guardarConfigCostos()"> Guardar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            guardarConfigCostos: function() {
                this.data.costosConfig = {
                    alimentacion: parseFloat(document.getElementById('costoAlim').value) || 15,
                    sanidad: parseFloat(document.getElementById('costoSan').value) || 5,
                    manoObra: parseFloat(document.getElementById('costoMO').value) || 200,
                    mantenimiento: parseFloat(document.getElementById('costoMant').value) || 100,
                    servicios: parseFloat(document.getElementById('costoServ').value) || 50,
                    otros: parseFloat(document.getElementById('costoOtros').value) || 30,
                    precioLeche: parseFloat(document.getElementById('precioLeche').value) || 0.5
                };
                this.saveData();
                document.getElementById('modalConfigPrecios').remove();
                this.notify('success', 'Guardado', 'Configuraci贸n de costos actualizada');
                this.renderEconomia();
            },

            formatMoney: function(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toFixed(2);
            },

            // ========================================
            //  GALERA DE FOTOS POR ANIMAL v4.0
            // ========================================
            openGaleriaAnimal: function(animalId) {
                const animal = this.data.ganado.find(a => a.id === animalId);
                if (!animal) return;
                
                const fotos = animal.fotos || [];
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalGaleria';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span></span> Galer铆a - ${animal.id} ${animal.nombre ? '(' + animal.nombre + ')' : ''}</h3>
                            <button class="modal-close" onclick="document.getElementById('modalGaleria').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="galeria-animal" id="galeriaContainer">
                                <div class="galeria-thumb galeria-add" onclick="document.getElementById('inputFotoAnimal').click()">
                                    <div class="galeria-add-icon"></div>
                                    <div class="galeria-add-text">Agregar Foto</div>
                                </div>
                                ${fotos.map((foto, idx) => `
                                    <div class="galeria-thumb" onclick="app.verFotoGrande('${animalId}', ${idx})">
                                        <img src="${foto.data}" alt="Foto ${idx + 1}">
                                        <div class="galeria-thumb-overlay">
                                            ${foto.fecha ? new Date(foto.fecha).toLocaleDateString('es') : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="file" id="inputFotoAnimal" accept="image/*" style="display: none;" onchange="app.agregarFotoAnimal('${animalId}', this)">
                            ${fotos.length === 0 ? '<p style="text-align: center; color: #888; margin-top: 20px;">No hay fotos. 隆Agrega la primera!</p>' : ''}
                        </div>
                        <div class="modal-footer">
                            <span style="font-size: 12px; color: #888;">${fotos.length} foto(s)</span>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalGaleria').remove()">Cerrar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            agregarFotoAnimal: function(animalId, input) {
                if (!input.files || !input.files[0]) return;
                
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const animal = this.data.ganado.find(a => a.id === animalId);
                    if (!animal) return;
                    
                    if (!animal.fotos) animal.fotos = [];
                    
                    // Comprimir imagen si es muy grande
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                        
                        animal.fotos.push({
                            id: 'FOTO-' + Date.now(),
                            data: compressedData,
                            fecha: new Date().toISOString(),
                            nota: ''
                        });
                        
                        // Establecer como foto principal si es la primera
                        if (animal.fotos.length === 1) {
                            animal.fotoPrincipal = compressedData;
                        }
                        
                        this.saveData();
                        this.notify('success', 'Foto agregada', 'La foto se guard贸 correctamente');
                        document.getElementById('modalGaleria').remove();
                        this.openGaleriaAnimal(animalId);
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            },

            verFotoGrande: function(animalId, idx) {
                const animal = this.data.ganado.find(a => a.id === animalId);
                if (!animal || !animal.fotos || !animal.fotos[idx]) return;
                
                const foto = animal.fotos[idx];
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalFotoGrande';
                modal.style.background = 'rgba(0,0,0,0.9)';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                        <img src="${foto.data}" class="galeria-modal-img" alt="Foto">
                        <div style="margin-top: 16px; display: flex; gap: 12px;">
                            <button class="btn btn-secondary" onclick="app.setFotoPrincipal('${animalId}', ${idx})">猸 Foto Principal</button>
                            <button class="btn btn-secondary" style="background: #dc2626;" onclick="app.eliminarFoto('${animalId}', ${idx})">锔 Eliminar</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalFotoGrande').remove()">锔 Cerrar</button>
                        </div>
                        <div style="color: white; margin-top: 12px; font-size: 12px;">
                            ${foto.fecha ? new Date(foto.fecha).toLocaleString('es') : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            setFotoPrincipal: function(animalId, idx) {
                const animal = this.data.ganado.find(a => a.id === animalId);
                if (animal && animal.fotos && animal.fotos[idx]) {
                    animal.fotoPrincipal = animal.fotos[idx].data;
                    this.saveData();
                    this.notify('success', 'Actualizado', 'Foto principal establecida');
                    document.getElementById('modalFotoGrande').remove();
                }
            },

            eliminarFoto: function(animalId, idx) {
                if (!confirm('驴Eliminar esta foto?')) return;
                const animal = this.data.ganado.find(a => a.id === animalId);
                if (animal && animal.fotos) {
                    animal.fotos.splice(idx, 1);
                    this.saveData();
                    this.notify('success', 'Eliminada', 'Foto eliminada');
                    document.getElementById('modalFotoGrande').remove();
                    document.getElementById('modalGaleria').remove();
                    this.openGaleriaAnimal(animalId);
                }
            },
            
            // Modal nuevo animal
            openNuevoAnimalModal: function(animalId = null) {
                const animal = animalId ? this.data.ganado.find(a => a.id === animalId) : null;
                const isEdit = !!animal;
                
                // Obtener especie del animal o la filtrada actualmente
                let especieSeleccionada = animal ? (this.ganadoCategorias[animal.categoria]?.especie || 'bovinos') : (this.ganadoFilter.especie || 'bovinos');
                
                const especiesActivas = Object.entries(this.especiesConfig).filter(([k, v]) => v.enabled);
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalAnimal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 650px;">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <span>${isEdit ? '锔' : ''}</span>
                                ${isEdit ? 'Editar Animal' : 'Nuevo Animal'}
                            </h3>
                            <button class="modal-close" onclick="document.getElementById('modalAnimal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Selector de especie -->
                            <div class="form-group">
                                <label class="form-label">Especie *</label>
                                <div class="especie-selector" id="especieSelector">
                                    ${especiesActivas.map(([key, esp]) => `
                                        <div class="especie-option ${especieSeleccionada === key ? 'selected' : ''}" 
                                             onclick="app.selectEspecieModal('${key}')" data-especie="${key}">
                                            <div class="especie-option-icon">${esp.emoji}</div>
                                            <div class="especie-option-nombre">${esp.nombre}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">ID / N煤mero *</label>
                                    <input type="text" class="form-input" id="animalId" 
                                           value="${animal?.id || ''}" 
                                           ${isEdit ? 'readonly style="background: var(--gris-100);"' : ''}
                                           placeholder="Ej: 001, A-15, etc.">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nombre (opcional)</label>
                                    <input type="text" class="form-input" id="animalNombre" 
                                           value="${animal?.nombre || ''}" 
                                           placeholder="Ej: Lucera, Manchas">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Categor铆a *</label>
                                    <select class="form-select" id="animalCategoria">
                                        ${this.getCategoriasParaEspecie(especieSeleccionada).map(([k, v]) => 
                                            `<option value="${k}" ${animal?.categoria === k ? 'selected' : ''}>${v.emoji} ${v.nombre}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Estado de Salud *</label>
                                    <select class="form-select" id="animalEstado">
                                        ${Object.entries(this.ganadoEstados).map(([k, v]) => 
                                            `<option value="${k}" ${animal?.estado === k ? 'selected' : ''}>${v.emoji} ${v.nombre}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Peso Actual (kg)</label>
                                    <input type="number" class="form-input" id="animalPeso" 
                                           value="${animal?.peso || ''}" 
                                           placeholder="Ej: 450" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" class="form-input" id="animalFechaNac" 
                                           value="${animal?.fechaNacimiento || ''}">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Raza</label>
                                    <input type="text" class="form-input" id="animalRaza" 
                                           value="${animal?.raza || ''}" 
                                           placeholder="Ej: Brahman, Holstein, Pelibuey">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Potrero Actual</label>
                                    <select class="form-select" id="animalPotrero">
                                        <option value="">Sin asignar</option>
                                        ${this.data.potreros.map(p => 
                                            `<option value="${p.id}" ${animal?.potreroActual === p.id ? 'selected' : ''}>${p.id} - ${p.ubicacion}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ID Madre/Padre</label>
                                <input type="text" class="form-input" id="animalMadre" 
                                       value="${animal?.madre || ''}" 
                                       placeholder="ID del progenitor">
                            </div>
                            
                            <div class="form-group" style="background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 16px; border-radius: 12px; border: 1px solid #fca5a5;">
                                <label class="form-label" style="color: #dc2626; display: flex; align-items: center; gap: 8px;">
                                    <span></span> Pr贸xima Vacunaci贸n
                                </label>
                                <input type="date" class="form-input" id="animalProximaVacunacion" 
                                       value="${animal?.proximaVacunacion || ''}"
                                       style="border-color: #fca5a5;">
                                <span class="form-hint" style="color: #dc2626;">Recibir谩s alertas cuando est茅 pr贸xima a vencer</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Observaciones</label>
                                <textarea class="form-input" id="animalObs" rows="2" 
                                          placeholder="Notas adicionales...">${animal?.observaciones || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalAnimal').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.guardarAnimal(${isEdit ? `'${animal.id}'` : 'null'})">
                                <span></span> ${isEdit ? 'Actualizar' : 'Guardar'}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            // Seleccionar especie en modal
            selectEspecieModal: function(especieKey) {
                // Actualizar visual
                document.querySelectorAll('.especie-option').forEach(el => {
                    el.classList.remove('selected');
                    if (el.dataset.especie === especieKey) {
                        el.classList.add('selected');
                    }
                });
                
                // Actualizar categor铆as disponibles
                const select = document.getElementById('animalCategoria');
                const categorias = this.getCategoriasParaEspecie(especieKey);
                
                select.innerHTML = categorias.map(([k, v]) => 
                    `<option value="${k}">${v.emoji} ${v.nombre}</option>`
                ).join('');
            },
            
            // Obtener categor铆as para una especie
            getCategoriasParaEspecie: function(especieKey) {
                return Object.entries(this.ganadoCategorias).filter(([k, v]) => v.especie === especieKey);
            },
            
            guardarAnimal: function(editId) {
                const id = document.getElementById('animalId').value.trim();
                const nombre = document.getElementById('animalNombre').value.trim();
                const categoria = document.getElementById('animalCategoria').value;
                const estado = document.getElementById('animalEstado').value;
                const peso = parseFloat(document.getElementById('animalPeso').value) || 0;
                const fechaNacimiento = document.getElementById('animalFechaNac').value;
                const raza = document.getElementById('animalRaza').value.trim();
                const potreroActual = document.getElementById('animalPotrero').value;
                const madre = document.getElementById('animalMadre').value.trim();
                const proximaVacunacion = document.getElementById('animalProximaVacunacion').value;
                const observaciones = document.getElementById('animalObs').value.trim();
                
                if (!id) {
                    this.notify('warning', 'ID requerido', 'Ingresa un ID para el animal');
                    return;
                }
                
                // Verificar ID 煤nico (solo si es nuevo)
                if (!editId && this.data.ganado.find(a => a.id === id)) {
                    this.notify('warning', 'ID duplicado', 'Ya existe un animal con ese ID');
                    return;
                }
                
                const animal = {
                    id,
                    nombre,
                    categoria,
                    estado,
                    peso,
                    fechaNacimiento,
                    raza,
                    potreroActual,
                    madre,
                    proximaVacunacion,
                    observaciones,
                    historialPeso: [],
                    fechaRegistro: editId ? undefined : new Date().toISOString(),
                    fechaActualizacion: new Date().toISOString()
                };
                
                // Agregar peso al historial si hay peso
                if (peso > 0) {
                    animal.historialPeso = [{
                        fecha: new Date().toISOString(),
                        peso
                    }];
                }
                
                if (!this.data.ganado) this.data.ganado = [];
                
                if (editId) {
                    // Editar existente
                    const index = this.data.ganado.findIndex(a => a.id === editId);
                    if (index >= 0) {
                        // Preservar historial de peso
                        animal.historialPeso = this.data.ganado[index].historialPeso || [];
                        animal.fechaRegistro = this.data.ganado[index].fechaRegistro;
                        // Preservar proximaVacunacion si no se modific贸
                        if (!animal.proximaVacunacion && this.data.ganado[index].proximaVacunacion) {
                            animal.proximaVacunacion = this.data.ganado[index].proximaVacunacion;
                        }
                        this.data.ganado[index] = animal;
                    }
                    this.notify('success', 'Animal actualizado', `${id} actualizado correctamente`);
                } else {
                    // Nuevo
                    this.data.ganado.push(animal);
                    this.notify('success', 'Animal registrado', `${id} agregado al inventario`);
                }
                
                this.saveData();
                document.getElementById('modalAnimal').remove();
                this.navigate('inventario');
                
                // Actualizar calculadora de carga
                this.sincronizarCalculadora();
            },
            
            editarAnimal: function(id) {
                this.openNuevoAnimalModal(id);
            },
            
            eliminarAnimal: function(id) {
                const animal = this.data.ganado.find(a => a.id === id);
                if (!animal) return;
                
                if (confirm(`驴Eliminar el animal ${id} (${animal.nombre || 'sin nombre'})?\n\nEsta acci贸n no se puede deshacer.`)) {
                    this.data.ganado = this.data.ganado.filter(a => a.id !== id);
                    this.saveData();
                    this.notify('success', 'Animal eliminado', `${id} ha sido eliminado del inventario`);
                    this.navigate('inventario');
                    this.sincronizarCalculadora();
                }
            },
            
            // Registrar peso
            registrarPeso: function(id) {
                const animal = this.data.ganado.find(a => a.id === id);
                if (!animal) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalPeso';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span>锔</span> Registrar Peso - ${id}</h3>
                            <button class="modal-close" onclick="document.getElementById('modalPeso').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Peso Actual: ${animal.peso || 0} kg</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nuevo Peso (kg) *</label>
                                <input type="number" class="form-input" id="nuevoPeso" 
                                       placeholder="Ingresa el nuevo peso" min="0" autofocus>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Pesaje</label>
                                <input type="date" class="form-input" id="fechaPeso" 
                                       value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            
                            ${animal.historialPeso && animal.historialPeso.length > 0 ? `
                                <div style="margin-top: 16px;">
                                    <label class="form-label">Historial de Peso</label>
                                    <div class="peso-history">
                                        ${animal.historialPeso.slice(-5).reverse().map(h => `
                                            <div class="peso-history-item">
                                                <div class="peso-history-value">${h.peso} kg</div>
                                                <div class="peso-history-date">${new Date(h.fecha).toLocaleDateString('es')}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalPeso').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.guardarPeso('${id}')">
                                <span></span> Guardar Peso
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            guardarPeso: function(id) {
                const peso = parseFloat(document.getElementById('nuevoPeso').value);
                const fecha = document.getElementById('fechaPeso').value;
                
                if (!peso || peso <= 0) {
                    this.notify('warning', 'Peso inv谩lido', 'Ingresa un peso v谩lido');
                    return;
                }
                
                const animal = this.data.ganado.find(a => a.id === id);
                if (!animal) return;
                
                if (!animal.historialPeso) animal.historialPeso = [];
                
                animal.historialPeso.push({
                    fecha: fecha || new Date().toISOString(),
                    peso
                });
                
                animal.peso = peso;
                animal.fechaActualizacion = new Date().toISOString();
                
                this.saveData();
                document.getElementById('modalPeso').remove();
                this.notify('success', 'Peso registrado', `Nuevo peso de ${id}: ${peso} kg`);
                this.navigate('inventario');
            },
            
            // Ver detalle
            verDetalleAnimal: function(id) {
                const animal = this.data.ganado.find(a => a.id === id);
                if (!animal) return;
                
                const cat = this.ganadoCategorias[animal.categoria] || {};
                const est = this.ganadoEstados[animal.estado] || {};
                const gananciaPromedio = this.calcularGananciaPeso(animal);
                
                // Generar contenido QR
                const qrContent = `ID: ${animal.id} | Nombre: ${animal.nombre || 'N/A'} | Raza: ${animal.raza || 'N/A'} | Estado: ${est.nombre || animal.estado} | Peso: ${animal.peso || 0}kg`;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalDetalle';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 750px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, var(--verde-medio), var(--verde-claro)); color: white;">
                            <h3 class="modal-title" style="color: white;">
                                <span>${cat.emoji || ''}</span> ${animal.id} - ${animal.nombre || 'Sin nombre'}
                            </h3>
                            <button class="modal-close" onclick="document.getElementById('modalDetalle').remove()" style="color: white;"></button>
                        </div>
                        <div class="modal-body">
                            <!-- TABS DE NAVEGACIN -->
                            <div class="animal-detail-tabs">
                                <button class="animal-detail-tab active" onclick="app.switchAnimalTab('info')">
                                    <span></span> Informaci贸n
                                </button>
                                <button class="animal-detail-tab" onclick="app.switchAnimalTab('identity')">
                                    <span></span> Identidad Digital
                                </button>
                            </div>
                            
                            <!-- TAB: INFORMACIN GENERAL -->
                            <div class="animal-detail-content active" id="tabInfo">
                                <div class="ganado-detail-grid">
                                    <div class="ganado-detail-section">
                                        <h4> Informaci贸n General</h4>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">ID</span>
                                            <span class="ganado-detail-value">${animal.id}</span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Nombre</span>
                                            <span class="ganado-detail-value">${animal.nombre || '-'}</span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Categor铆a</span>
                                            <span class="ganado-detail-value">${cat.emoji} ${cat.nombre}</span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Raza</span>
                                            <span class="ganado-detail-value">${animal.raza || '-'}</span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Edad</span>
                                            <span class="ganado-detail-value">${this.calcularEdad(animal.fechaNacimiento)}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="ganado-detail-section">
                                        <h4> Estado Actual</h4>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Peso</span>
                                            <span class="ganado-detail-value">${animal.peso || 0} kg</span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">UGM</span>
                                            <span class="ganado-detail-value">${cat.ugm || 1}</span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Estado</span>
                                            <span class="ganado-detail-value">
                                                <span class="ganado-estado ${animal.estado}">${est.emoji} ${est.nombre}</span>
                                            </span>
                                        </div>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">Potrero</span>
                                            <span class="ganado-detail-value">${animal.potreroActual || 'Sin asignar'}</span>
                                        </div>
                                        ${animal.proximaVacunacion ? `
                                            <div class="ganado-detail-row" style="background: ${this.isVacunacionProxima(animal.proximaVacunacion) ? '#fef2f2' : '#f0fdf4'}; border-radius: 8px; padding: 8px;">
                                                <span class="ganado-detail-label"> Pr贸x. Vacunaci贸n</span>
                                                <span class="ganado-detail-value" style="color: ${this.isVacunacionProxima(animal.proximaVacunacion) ? '#dc2626' : '#16a34a'};">
                                                    ${new Date(animal.proximaVacunacion).toLocaleDateString('es')}
                                                </span>
                                            </div>
                                        ` : ''}
                                        ${gananciaPromedio !== null ? `
                                            <div class="ganado-detail-row">
                                                <span class="ganado-detail-label">Ganancia Diaria</span>
                                                <span class="ganado-detail-value" style="color: ${gananciaPromedio >= 0 ? 'var(--verde)' : 'var(--rojo)'};">
                                                    ${gananciaPromedio >= 0 ? '+' : ''}${gananciaPromedio.toFixed(2)} kg/d铆a
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                ${animal.madre ? `
                                    <div class="ganado-detail-section" style="margin-top: 16px;">
                                        <h4> Genealog铆a</h4>
                                        <div class="ganado-detail-row">
                                            <span class="ganado-detail-label">ID Madre</span>
                                            <span class="ganado-detail-value">${animal.madre}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${animal.historialPeso && animal.historialPeso.length > 0 ? `
                                    <div class="ganado-detail-section" style="margin-top: 16px;">
                                        <h4>锔 Historial de Peso</h4>
                                        <div class="peso-history">
                                            ${animal.historialPeso.slice(-8).reverse().map(h => `
                                                <div class="peso-history-item">
                                                    <div class="peso-history-value">${h.peso} kg</div>
                                                    <div class="peso-history-date">${new Date(h.fecha).toLocaleDateString('es')}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${animal.observaciones ? `
                                    <div class="ganado-detail-section" style="margin-top: 16px;">
                                        <h4> Observaciones</h4>
                                        <p style="font-size: 13px; color: var(--gris-700);">${animal.observaciones}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- TAB: IDENTIDAD DIGITAL -->
                            <div class="animal-detail-content" id="tabIdentity">
                                <div class="identity-section">
                                    <div class="identity-header">
                                        <div class="identity-badge"></div>
                                        <div>
                                            <div class="identity-title">C茅dula Digital del Animal</div>
                                            <div class="identity-subtitle">C贸digo QR 煤nico para trazabilidad</div>
                                        </div>
                                    </div>
                                    
                                    <div class="identity-content">
                                        <div class="qr-container">
                                            <div class="qr-code-wrapper" id="qrCodeContainer_${animal.id}">
                                                <!-- El QR se genera din谩micamente -->
                                            </div>
                                            <div class="qr-label">Escanea con cualquier lector QR</div>
                                        </div>
                                        
                                        <div class="identity-info">
                                            <div class="identity-data-row">
                                                <div class="identity-data-icon">凤</div>
                                                <div>
                                                    <div class="identity-data-label">Identificaci贸n</div>
                                                    <div class="identity-data-value">${animal.id}</div>
                                                </div>
                                            </div>
                                            <div class="identity-data-row">
                                                <div class="identity-data-icon">${cat.emoji || ''}</div>
                                                <div>
                                                    <div class="identity-data-label">Nombre</div>
                                                    <div class="identity-data-value">${animal.nombre || 'Sin nombre'}</div>
                                                </div>
                                            </div>
                                            <div class="identity-data-row">
                                                <div class="identity-data-icon">К</div>
                                                <div>
                                                    <div class="identity-data-label">Raza</div>
                                                    <div class="identity-data-value">${animal.raza || 'No especificada'}</div>
                                                </div>
                                            </div>
                                            <div class="identity-data-row">
                                                <div class="identity-data-icon">锔</div>
                                                <div>
                                                    <div class="identity-data-label">Peso Actual</div>
                                                    <div class="identity-data-value">${animal.peso || 0} kg</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="print-cedula-btn" onclick="app.imprimirCedulaAnimal('${animal.id}')">
                                        <span>锔</span> Imprimir Ficha / Descargar PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalDetalle').remove()">Cerrar</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalDetalle').remove(); app.openGaleriaAnimal('${animal.id}')">
                                 Galer铆a
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalDetalle').remove(); app.registrarPeso('${animal.id}')">
                                锔 Registrar Peso
                            </button>
                            <button class="btn btn-primary" onclick="document.getElementById('modalDetalle').remove(); app.editarAnimal('${animal.id}')">
                                锔 Editar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Generar QR despu茅s de agregar el modal al DOM
                setTimeout(() => {
                    this.generarQRAnimal(animal.id, qrContent);
                }, 100);
            },
            
            // Cambiar pesta帽a en modal de detalle animal
            switchAnimalTab: function(tabName) {
                // Desactivar todas las pesta帽as y contenidos
                document.querySelectorAll('.animal-detail-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.animal-detail-content').forEach(content => content.classList.remove('active'));
                
                // Activar la pesta帽a seleccionada
                if (tabName === 'info') {
                    document.querySelector('.animal-detail-tab:nth-child(1)').classList.add('active');
                    document.getElementById('tabInfo').classList.add('active');
                } else if (tabName === 'identity') {
                    document.querySelector('.animal-detail-tab:nth-child(2)').classList.add('active');
                    document.getElementById('tabIdentity').classList.add('active');
                }
            },
            
            // Generar c贸digo QR para un animal
            generarQRAnimal: function(animalId, contenido) {
                const container = document.getElementById(`qrCodeContainer_${animalId}`);
                if (!container) return;
                
                // Limpiar contenedor
                container.innerHTML = '';
                
                // Verificar si QRCode est谩 disponible
                if (typeof QRCode !== 'undefined') {
                    new QRCode(container, {
                        text: contenido,
                        width: 150,
                        height: 150,
                        colorDark: "#0f3629",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gris-500); font-size: 12px;">Error: Librer铆a QR no disponible</div>';
                }
            },
            
            // Verificar si la vacunaci贸n est谩 pr贸xima (7 d铆as o menos) o vencida
            isVacunacionProxima: function(fecha) {
                if (!fecha) return false;
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaVac = new Date(fecha);
                fechaVac.setHours(0, 0, 0, 0);
                const diffDias = Math.floor((fechaVac - hoy) / (1000 * 60 * 60 * 24));
                return diffDias <= 7;
            },
            
            // Obtener alertas de vacunaci贸n
            getAlertasVacunacion: function() {
                const ganado = this.data.ganado || [];
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                const alertas = {
                    vencidas: [],
                    proximas: []
                };
                
                ganado.forEach(animal => {
                    if (!animal.proximaVacunacion) return;
                    
                    const fechaVac = new Date(animal.proximaVacunacion);
                    fechaVac.setHours(0, 0, 0, 0);
                    const diffDias = Math.floor((fechaVac - hoy) / (1000 * 60 * 60 * 24));
                    
                    if (diffDias < 0) {
                        alertas.vencidas.push({
                            ...animal,
                            diasVencido: Math.abs(diffDias)
                        });
                    } else if (diffDias <= 7) {
                        alertas.proximas.push({
                            ...animal,
                            diasRestantes: diffDias
                        });
                    }
                });
                
                // Ordenar por urgencia
                alertas.vencidas.sort((a, b) => b.diasVencido - a.diasVencido);
                alertas.proximas.sort((a, b) => a.diasRestantes - b.diasRestantes);
                
                return alertas;
            },
            
            // Imprimir c茅dula del animal como PDF
            imprimirCedulaAnimal: function(animalId) {
                const animal = this.data.ganado.find(a => a.id === animalId);
                if (!animal) return;
                
                const cat = this.ganadoCategorias[animal.categoria] || {};
                const est = this.ganadoEstados[animal.estado] || {};
                
                // Crear modal con vista previa
                const modal = document.createElement('div');
                modal.className = 'cedula-modal-overlay';
                modal.id = 'modalCedula';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="cedula-modal-content">
                        <div class="cedula-modal-header">
                            <h3><span></span> Vista Previa de C茅dula</h3>
                            <button class="cedula-modal-close" onclick="document.getElementById('modalCedula').remove()"></button>
                        </div>
                        <div class="cedula-modal-body">
                            <div class="cedula-preview" id="cedulaPreview">
                                <div class="cedula-header">
                                    <div class="cedula-logo">
                                        <div class="cedula-logo-icon"></div>
                                        <div>
                                            <div class="cedula-logo-text">NEXUS AGRO</div>
                                            <div class="cedula-logo-sub">Trazabilidad Ganadera</div>
                                        </div>
                                    </div>
                                    <div class="cedula-tipo">CDULA DIGITAL</div>
                                </div>
                                
                                <div class="cedula-body">
                                    <div class="cedula-qr-section">
                                        <div class="cedula-qr-box" id="cedulaQR_${animal.id}">
                                            <!-- QR se genera aqu铆 -->
                                        </div>
                                    </div>
                                    <div class="cedula-info-section">
                                        <div class="cedula-id-big">${animal.id}</div>
                                        <div class="cedula-nombre">${animal.nombre || 'Sin nombre'}</div>
                                        <div class="cedula-detail">
                                            <span class="cedula-detail-icon">К</span>
                                            <span><strong>Raza:</strong> ${animal.raza || 'N/A'}</span>
                                        </div>
                                        <div class="cedula-detail">
                                            <span class="cedula-detail-icon">${cat.emoji || ''}</span>
                                            <span><strong>Categor铆a:</strong> ${cat.nombre || 'N/A'}</span>
                                        </div>
                                        <div class="cedula-detail">
                                            <span class="cedula-detail-icon">锔</span>
                                            <span><strong>Peso:</strong> ${animal.peso || 0} kg</span>
                                        </div>
                                        <div class="cedula-detail">
                                            <span class="cedula-detail-icon">${est.emoji || 'わ'}</span>
                                            <span><strong>Estado:</strong> ${est.nombre || animal.estado}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="cedula-footer">
                                    <div class="cedula-fecha">Emitido: ${new Date().toLocaleDateString('es')}</div>
                                    <div class="cedula-validez"> Verificado</div>
                                </div>
                            </div>
                        </div>
                        <div class="cedula-modal-actions">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalCedula').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.descargarCedulaPDF('${animal.id}')">
                                <span></span> Descargar PDF
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Generar QR para la c茅dula
                const qrContent = `ID: ${animal.id} | Nombre: ${animal.nombre || 'N/A'} | Raza: ${animal.raza || 'N/A'} | Estado: ${est.nombre || animal.estado} | Peso: ${animal.peso || 0}kg`;
                
                setTimeout(() => {
                    const qrContainer = document.getElementById(`cedulaQR_${animal.id}`);
                    if (qrContainer && typeof QRCode !== 'undefined') {
                        new QRCode(qrContainer, {
                            text: qrContent,
                            width: 120,
                            height: 120,
                            colorDark: "#0f3629",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                }, 100);
            },
            
            // Descargar c茅dula como PDF
            descargarCedulaPDF: function(animalId) {
                const animal = this.data.ganado.find(a => a.id === animalId);
                if (!animal) return;
                
                const cat = this.ganadoCategorias[animal.categoria] || {};
                const est = this.ganadoEstados[animal.estado] || {};
                
                // Obtener el QR como imagen
                const qrContainer = document.getElementById(`cedulaQR_${animalId}`);
                const qrImg = qrContainer ? qrContainer.querySelector('img') || qrContainer.querySelector('canvas') : null;
                
                // Crear PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: [90, 55] // Tama帽o tarjeta de presentaci贸n
                });
                
                // Fondo
                doc.setFillColor(240, 253, 244);
                doc.rect(0, 0, 90, 55, 'F');
                
                // Borde
                doc.setDrawColor(82, 183, 136);
                doc.setLineWidth(1);
                doc.rect(2, 2, 86, 51, 'S');
                
                // Logo/T铆tulo
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(15, 54, 41);
                doc.text(' NEXUS AGRO', 5, 8);
                
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('C茅dula Digital de Trazabilidad', 5, 12);
                
                // QR (si est谩 disponible)
                if (qrImg) {
                    try {
                        const qrData = qrImg.tagName === 'CANVAS' ? qrImg.toDataURL('image/png') : qrImg.src;
                        doc.addImage(qrData, 'PNG', 5, 16, 28, 28);
                    } catch(e) {
                        doc.setFontSize(8);
                        doc.text('QR', 15, 30);
                    }
                }
                
                // Informaci贸n del animal
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(15, 54, 41);
                doc.text(animal.id, 38, 22);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50, 50, 50);
                doc.text(animal.nombre || 'Sin nombre', 38, 27);
                
                doc.setFontSize(7);
                doc.setTextColor(80, 80, 80);
                doc.text(`Raza: ${animal.raza || 'N/A'}`, 38, 33);
                doc.text(`Categor铆a: ${cat.nombre || 'N/A'}`, 38, 38);
                doc.text(`Peso: ${animal.peso || 0} kg`, 38, 43);
                doc.text(`Estado: ${est.nombre || animal.estado}`, 38, 48);
                
                // Footer
                doc.setFontSize(5);
                doc.setTextColor(150, 150, 150);
                doc.text(`Emitido: ${new Date().toLocaleDateString('es')}`, 5, 52);
                doc.text('WIN-TEL AgroManager PRO', 60, 52);
                
                // Descargar
                doc.save(`Cedula_${animal.id}_${animal.nombre || 'Animal'}.pdf`);
                
                this.notify('success', 'PDF Generado', `C茅dula de ${animal.id} descargada`);
                document.getElementById('modalCedula')?.remove();
            },
            
            // Renderizar alertas sanitarias para el dashboard
            renderAlertasSanitarias: function() {
                const alertas = this.getAlertasVacunacion();
                const totalAlertas = alertas.vencidas.length + alertas.proximas.length;
                
                // Si no hay ganado o alertas, no mostrar nada
                if (!this.data.ganado || this.data.ganado.length === 0) {
                    return '';
                }
                
                // Si todo est谩 bien
                if (totalAlertas === 0) {
                    return `
                        <div class="alerta-sanitaria-card ok">
                            <div class="alerta-sanitaria-header">
                                <div class="alerta-sanitaria-icon"></div>
                                <div>
                                    <div class="alerta-sanitaria-title">Control Sanitario al D铆a</div>
                                    <div class="alerta-sanitaria-subtitle">No hay vacunaciones pendientes en los pr贸ximos 7 d铆as</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Si hay alertas vencidas (CRTICO)
                if (alertas.vencidas.length > 0) {
                    return `
                        <div class="alerta-sanitaria-card">
                            <div class="alerta-sanitaria-header">
                                <div class="alerta-sanitaria-icon"></div>
                                <div>
                                    <div class="alerta-sanitaria-title">隆Alerta Sanitaria Cr铆tica!</div>
                                    <div class="alerta-sanitaria-subtitle">${alertas.vencidas.length} vacunaci贸n(es) vencida(s) - Acci贸n inmediata requerida</div>
                                </div>
                            </div>
                            <div class="alerta-sanitaria-list">
                                ${alertas.vencidas.slice(0, 5).map(a => {
                                    const cat = this.ganadoCategorias[a.categoria] || {};
                                    return `
                                        <div class="alerta-sanitaria-item" onclick="app.verDetalleAnimal('${a.id}')" style="cursor: pointer;">
                                            <div class="alerta-sanitaria-animal">
                                                <div class="alerta-sanitaria-animal-icon">${cat.emoji || ''}</div>
                                                <div>
                                                    <div class="alerta-sanitaria-animal-id">${a.id}</div>
                                                    <div class="alerta-sanitaria-animal-nombre">${a.nombre || 'Sin nombre'}</div>
                                                </div>
                                            </div>
                                            <div class="alerta-sanitaria-fecha">
                                                <div class="alerta-sanitaria-fecha-label">Vencida hace</div>
                                                <div class="alerta-sanitaria-fecha-valor vencida">${a.diasVencido} d铆a(s)</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${alertas.vencidas.length > 5 ? `
                                    <div style="text-align: center; padding: 10px; color: var(--gris-600); font-size: 12px;">
                                        Y ${alertas.vencidas.length - 5} m谩s...
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Si solo hay alertas pr贸ximas (WARNING)
                return `
                    <div class="alerta-sanitaria-card warning">
                        <div class="alerta-sanitaria-header">
                            <div class="alerta-sanitaria-icon">锔</div>
                            <div>
                                <div class="alerta-sanitaria-title">Vacunaciones Pr贸ximas</div>
                                <div class="alerta-sanitaria-subtitle">${alertas.proximas.length} animal(es) requieren vacunaci贸n en los pr贸ximos 7 d铆as</div>
                            </div>
                        </div>
                        <div class="alerta-sanitaria-list">
                            ${alertas.proximas.slice(0, 5).map(a => {
                                const cat = this.ganadoCategorias[a.categoria] || {};
                                return `
                                    <div class="alerta-sanitaria-item" onclick="app.verDetalleAnimal('${a.id}')" style="cursor: pointer;">
                                        <div class="alerta-sanitaria-animal">
                                            <div class="alerta-sanitaria-animal-icon">${cat.emoji || ''}</div>
                                            <div>
                                                <div class="alerta-sanitaria-animal-id">${a.id}</div>
                                                <div class="alerta-sanitaria-animal-nombre">${a.nombre || 'Sin nombre'}</div>
                                            </div>
                                        </div>
                                        <div class="alerta-sanitaria-fecha">
                                            <div class="alerta-sanitaria-fecha-label">Faltan</div>
                                            <div class="alerta-sanitaria-fecha-valor proxima">${a.diasRestantes === 0 ? 'HOY' : a.diasRestantes + ' d铆a(s)'}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${alertas.proximas.length > 5 ? `
                                <div style="text-align: center; padding: 10px; color: var(--gris-600); font-size: 12px;">
                                    Y ${alertas.proximas.length - 5} m谩s...
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },
            
            // Funciones auxiliares
            calcularEdad: function(fechaNacimiento) {
                if (!fechaNacimiento) return '-';
                
                const nacimiento = new Date(fechaNacimiento);
                const hoy = new Date();
                const meses = (hoy.getFullYear() - nacimiento.getFullYear()) * 12 + (hoy.getMonth() - nacimiento.getMonth());
                
                if (meses < 12) {
                    return `${meses} meses`;
                } else {
                    const a帽os = Math.floor(meses / 12);
                    const mesesRestantes = meses % 12;
                    return mesesRestantes > 0 ? `${a帽os}a ${mesesRestantes}m` : `${a帽os} a帽os`;
                }
            },
            
            calcularGananciaPeso: function(animal) {
                if (!animal.historialPeso || animal.historialPeso.length < 2) return null;
                
                const historial = animal.historialPeso.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                const primero = historial[0];
                const ultimo = historial[historial.length - 1];
                
                const dias = Math.floor((new Date(ultimo.fecha) - new Date(primero.fecha)) / (1000 * 60 * 60 * 24));
                if (dias <= 0) return null;
                
                return (ultimo.peso - primero.peso) / dias;
            },
            
            calcularEstadisticasGanado: function() {
                const ganado = this.data.ganado || [];
                const stats = {
                    totalCabezas: ganado.length,
                    totalUGM: 0,
                    pesoTotal: 0,
                    enTratamiento: 0,
                    porCategoria: {},
                    pesoPorCategoria: {}
                };
                
                // Inicializar categor铆as
                Object.keys(this.ganadoCategorias).forEach(k => {
                    stats.porCategoria[k] = 0;
                    stats.pesoPorCategoria[k] = { total: 0, count: 0 };
                });
                
                ganado.forEach(animal => {
                    const cat = this.ganadoCategorias[animal.categoria];
                    if (cat) {
                        stats.totalUGM += cat.ugm;
                        stats.porCategoria[animal.categoria]++;
                        if (animal.peso) {
                            stats.pesoPorCategoria[animal.categoria].total += animal.peso;
                            stats.pesoPorCategoria[animal.categoria].count++;
                        }
                    }
                    
                    stats.pesoTotal += animal.peso || 0;
                    
                    if (animal.estado === 'tratamiento') {
                        stats.enTratamiento++;
                    }
                });
                
                // Calcular promedios
                Object.keys(stats.pesoPorCategoria).forEach(k => {
                    const data = stats.pesoPorCategoria[k];
                    stats.pesoPorCategoria[k] = data.count > 0 ? data.total / data.count : 0;
                });
                
                return stats;
            },
            
            filtrarGanado: function() {
                let ganado = this.data.ganado || [];
                
                // Filtrar por especie
                if (this.ganadoFilter.especie) {
                    const categoriasEspecie = Object.entries(this.ganadoCategorias)
                        .filter(([k, v]) => v.especie === this.ganadoFilter.especie)
                        .map(([k]) => k);
                    ganado = ganado.filter(a => categoriasEspecie.includes(a.categoria));
                } else {
                    // Mostrar solo especies habilitadas
                    const categoriasHabilitadas = Object.entries(this.ganadoCategorias)
                        .filter(([k, v]) => this.especiesConfig[v.especie]?.enabled)
                        .map(([k]) => k);
                    ganado = ganado.filter(a => categoriasHabilitadas.includes(a.categoria));
                }
                
                if (this.ganadoFilter.categoria) {
                    ganado = ganado.filter(a => a.categoria === this.ganadoFilter.categoria);
                }
                
                if (this.ganadoFilter.estado) {
                    ganado = ganado.filter(a => a.estado === this.ganadoFilter.estado);
                }
                
                if (this.ganadoFilter.potrero) {
                    if (this.ganadoFilter.potrero === 'sin_asignar') {
                        ganado = ganado.filter(a => !a.potreroActual);
                    } else {
                        ganado = ganado.filter(a => a.potreroActual === this.ganadoFilter.potrero);
                    }
                }
                
                if (this.ganadoFilter.busqueda) {
                    const busqueda = this.ganadoFilter.busqueda.toLowerCase();
                    ganado = ganado.filter(a => 
                        a.id.toLowerCase().includes(busqueda) || 
                        (a.nombre && a.nombre.toLowerCase().includes(busqueda))
                    );
                }
                
                return ganado;
            },
            
            updateGanadoFilter: function(key, value) {
                this.ganadoFilter[key] = value;
                document.getElementById('ganadoListContainer').innerHTML = this.renderGanadoList(this.filtrarGanado());
            },
            
            setGanadoViewMode: function(mode) {
                this.ganadoViewMode = mode;
                this.navigate('inventario');
            },
            
            sincronizarCalculadora: function() {
                // Sincronizar con la calculadora de carga animal
                const stats = this.calcularEstadisticasGanado();
                Object.keys(this.calcData.categorias).forEach(key => {
                    this.calcData.categorias[key].cantidad = stats.porCategoria[key] || 0;
                });
                this.saveCalcData();
            },
            
            exportarInventario: function() {
                const ganado = this.data.ganado || [];
                if (ganado.length === 0) {
                    this.notify('warning', 'Sin datos', 'No hay animales para exportar');
                    return;
                }
                
                let csv = 'ID,Nombre,Categor铆a,Peso,Edad,Estado,Potrero,Raza,Madre,Observaciones\n';
                
                ganado.forEach(a => {
                    csv += `"${a.id}","${a.nombre || ''}","${a.categoria}",${a.peso || 0},"${this.calcularEdad(a.fechaNacimiento)}","${a.estado}","${a.potreroActual || ''}","${a.raza || ''}","${a.madre || ''}","${a.observaciones || ''}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `inventario_ganado_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                this.notify('success', 'Exportado', `${ganado.length} animales exportados a CSV`);
            },

            renderCalculadora: function() {
                // Cargar datos guardados
                this.loadCalcData();
                
                // Calcular superficie total de potreros
                const superficieTotal = this.data.potreros.reduce((sum, p) => sum + (parseFloat(p.superficie) || 0), 0);
                if (this.calcData.superficie === 0) {
                    this.calcData.superficie = superficieTotal;
                }
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Calculadora de Carga Animal
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="app.resetCalcData()">
                                     Reiniciar
                                </button>
                                <button class="btn btn-primary" onclick="app.exportCalcReport()">
                                     Exportar
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Tabs -->
                            <div class="calc-tabs">
                                <button class="calc-tab ${this.calcCurrentTab === 'carga' ? 'active' : ''}" onclick="app.switchCalcTab('carga')">
                                     Carga Animal
                                </button>
                                <button class="calc-tab ${this.calcCurrentTab === 'balance' ? 'active' : ''}" onclick="app.switchCalcTab('balance')">
                                    锔 Balance Forrajero
                                </button>
                                <button class="calc-tab ${this.calcCurrentTab === 'capacidad' ? 'active' : ''}" onclick="app.switchCalcTab('capacidad')">
                                     Capacidad ptima
                                </button>
                                <button class="calc-tab ${this.calcCurrentTab === 'referencia' ? 'active' : ''}" onclick="app.switchCalcTab('referencia')">
                                     Referencia
                                </button>
                            </div>
                            
                            <!-- Contenido -->
                            <div id="calcTabContent">
                                ${this.renderCalcTabContent()}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            switchCalcTab: function(tab) {
                this.calcCurrentTab = tab;
                document.querySelectorAll('.calc-tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('calcTabContent').innerHTML = this.renderCalcTabContent();
            },
            
            renderCalcTabContent: function() {
                switch (this.calcCurrentTab) {
                    case 'carga': return this.renderCargaAnimal();
                    case 'balance': return this.renderBalanceForrajero();
                    case 'capacidad': return this.renderCapacidadOptima();
                    case 'referencia': return this.renderReferencia();
                    default: return this.renderCargaAnimal();
                }
            },
            
            // Tab 1: Carga Animal
            renderCargaAnimal: function() {
                const resultados = this.calcularCargaAnimal();
                
                return `
                    <div class="calc-container">
                        <!-- Panel de entrada -->
                        <div class="calc-panel">
                            <div class="calc-panel-title">
                                <span></span> Inventario de Ganado
                            </div>
                            
                            <div class="calc-input-group">
                                <div class="calc-input-label">
                                    <label>Superficie Total (Ha)</label>
                                    <span class="calc-help" title="rea total disponible para pastoreo">癸</span>
                                </div>
                                <input type="number" class="calc-input" id="calcSuperficie" 
                                       value="${this.calcData.superficie}" 
                                       onchange="app.updateCalcSuperficie(this.value)" 
                                       min="0" step="0.1">
                            </div>
                            
                            <table class="calc-categories-table">
                                <thead>
                                    <tr>
                                        <th>Categor铆a</th>
                                        <th>UGM</th>
                                        <th>Cantidad</th>
                                        <th>Total UGM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(this.calcData.categorias).map(([key, cat]) => `
                                        <tr>
                                            <td>${cat.nombre}</td>
                                            <td>${cat.ugm}</td>
                                            <td>
                                                <input type="number" value="${cat.cantidad}" min="0" 
                                                       onchange="app.updateCalcCategoria('${key}', this.value)">
                                            </td>
                                            <td><strong>${(cat.cantidad * cat.ugm).toFixed(1)}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: var(--verde-muy-claro);">
                                        <td colspan="2"><strong>TOTAL</strong></td>
                                        <td><strong>${resultados.totalCabezas}</strong></td>
                                        <td><strong>${resultados.totalUGM.toFixed(1)} UGM</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Panel de resultados -->
                        <div class="calc-results">
                            <div class="calc-results-title"> Resultados de Carga</div>
                            
                            <div class="calc-result-main">
                                <div class="calc-result-value">${resultados.cargaActual.toFixed(2)}</div>
                                <div class="calc-result-unit">UGM / Hect谩rea</div>
                                <div class="calc-result-label">Carga Animal Actual</div>
                            </div>
                            
                            <div class="calc-results-grid">
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${resultados.totalUGM.toFixed(1)}</div>
                                    <div class="calc-result-item-label">Total UGM</div>
                                </div>
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${resultados.totalCabezas}</div>
                                    <div class="calc-result-item-label">Total Cabezas</div>
                                </div>
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${resultados.pesoTotal.toFixed(0)}</div>
                                    <div class="calc-result-item-label">Peso Total (kg)</div>
                                </div>
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${resultados.hasPorUGM.toFixed(2)}</div>
                                    <div class="calc-result-item-label">Ha por UGM</div>
                                </div>
                            </div>
                            
                            <div class="calc-status ${resultados.estado}">
                                <div class="calc-status-icon">${resultados.estadoIcon}</div>
                                <div class="calc-status-text">
                                    <div class="calc-status-title">${resultados.estadoTitulo}</div>
                                    <div class="calc-status-message">${resultados.estadoMensaje}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recomendaciones -->
                    <div class="calc-recommendations">
                        <div class="calc-panel-title" style="border: none; padding: 0; margin-bottom: 12px;">
                            <span></span> Recomendaciones
                        </div>
                        ${resultados.recomendaciones.map(r => `
                            <div class="calc-recommendation-item">
                                <div class="calc-recommendation-icon">${r.icon}</div>
                                <div class="calc-recommendation-text">${r.texto}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            
            // Tab 2: Balance Forrajero
            renderBalanceForrajero: function() {
                const balance = this.calcularBalanceForrajero();
                
                return `
                    <div class="calc-container">
                        <!-- Panel de par谩metros -->
                        <div class="calc-panel">
                            <div class="calc-panel-title">
                                <span></span> Par谩metros de Pastura
                            </div>
                            
                            <div class="calc-input-group">
                                <div class="calc-input-label">
                                    <label>Producci贸n de Materia Seca</label>
                                    <span class="calc-help" title="kg MS/ha/a帽o">癸</span>
                                </div>
                                <input type="number" class="calc-input" id="calcProduccionMS" 
                                       value="${this.calcData.produccionMS}" 
                                       onchange="app.updateCalcParam('produccionMS', this.value)" 
                                       min="0" step="100">
                                <div style="font-size: 11px; color: var(--gris-500); margin-top: 4px;">
                                    kg MS/ha/a帽o (t铆pico: 2000-5000)
                                </div>
                            </div>
                            
                            <div class="calc-input-group">
                                <div class="calc-input-label">
                                    <label>Porcentaje de Utilizaci贸n</label>
                                    <span class="calc-help" title="% del forraje que se aprovecha">癸</span>
                                </div>
                                <input type="range" class="calc-input" id="calcUtilizacion" 
                                       value="${this.calcData.utilizacion}" 
                                       onchange="app.updateCalcParam('utilizacion', this.value); document.getElementById('utilizacionVal').textContent = this.value + '%'"
                                       min="40" max="80" step="5" style="padding: 8px;">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--gris-500);">
                                    <span>40% (Conservador)</span>
                                    <span id="utilizacionVal" style="font-weight: 700; color: var(--verde-medio);">${this.calcData.utilizacion}%</span>
                                    <span>80% (Intensivo)</span>
                                </div>
                            </div>
                            
                            <div class="calc-input-group">
                                <div class="calc-input-label">
                                    <label>Consumo MS (% Peso Vivo)</label>
                                </div>
                                <input type="number" class="calc-input" id="calcConsumoMS" 
                                       value="${this.calcData.consumoMS}" 
                                       onchange="app.updateCalcParam('consumoMS', this.value)" 
                                       min="1.5" max="4" step="0.1">
                                <div style="font-size: 11px; color: var(--gris-500); margin-top: 4px;">
                                    T铆pico: 2.0-3.0% del peso vivo
                                </div>
                            </div>
                            
                            <div class="calc-input-group">
                                <div class="calc-input-label">
                                    <label>poca del A帽o</label>
                                </div>
                                <select class="calc-select" id="calcEpoca" onchange="app.updateCalcParam('epoca', this.value)">
                                    <option value="lluvias" ${this.calcData.epoca === 'lluvias' ? 'selected' : ''}>э poca de Lluvias</option>
                                    <option value="seca" ${this.calcData.epoca === 'seca' ? 'selected' : ''}>锔 poca Seca</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Panel de resultados -->
                        <div class="calc-results">
                            <div class="calc-results-title">锔 Balance Forrajero</div>
                            
                            <div class="calc-results-grid" style="margin-bottom: 20px;">
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${balance.ofertaTotal.toFixed(0)}</div>
                                    <div class="calc-result-item-label">Oferta (kg MS/a帽o)</div>
                                </div>
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${balance.demandaTotal.toFixed(0)}</div>
                                    <div class="calc-result-item-label">Demanda (kg MS/a帽o)</div>
                                </div>
                            </div>
                            
                            <!-- Barra de balance -->
                            <div class="balance-bar-container">
                                <div class="balance-bar-labels">
                                    <span>D茅ficit</span>
                                    <span>Equilibrio</span>
                                    <span>Excedente</span>
                                </div>
                                <div class="balance-bar">
                                    <div class="balance-bar-fill ${balance.estadoBalance}" 
                                         style="width: ${Math.min(100, balance.porcentajeCobertura)}%"></div>
                                </div>
                            </div>
                            
                            <div class="calc-result-main" style="background: ${balance.balanceColor};">
                                <div class="calc-result-value" style="font-size: 36px;">
                                    ${balance.balanceNeto >= 0 ? '+' : ''}${balance.balanceNeto.toFixed(0)}
                                </div>
                                <div class="calc-result-unit">kg MS/a帽o</div>
                                <div class="calc-result-label">Balance Neto</div>
                            </div>
                            
                            <div class="calc-results-grid">
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${balance.porcentajeCobertura.toFixed(0)}%</div>
                                    <div class="calc-result-item-label">Cobertura de Demanda</div>
                                </div>
                                <div class="calc-result-item">
                                    <div class="calc-result-item-value">${balance.diasAutonomia.toFixed(0)}</div>
                                    <div class="calc-result-item-label">D铆as de Autonom铆a</div>
                                </div>
                            </div>
                            
                            <div class="calc-status ${balance.estado}">
                                <div class="calc-status-icon">${balance.estadoIcon}</div>
                                <div class="calc-status-text">
                                    <div class="calc-status-title">${balance.estadoTitulo}</div>
                                    <div class="calc-status-message">${balance.estadoMensaje}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            // Tab 3: Capacidad ptima
            renderCapacidadOptima: function() {
                const capacidad = this.calcularCapacidadOptima();
                const resultados = this.calcularCargaAnimal();
                
                return `
                    <div class="calc-info-cards">
                        <div class="calc-info-card">
                            <div class="calc-info-card-title">Capacidad ptima</div>
                            <div class="calc-info-card-value">${capacidad.ugmOptimo.toFixed(1)}</div>
                            <div class="calc-info-card-unit">UGM totales</div>
                        </div>
                        <div class="calc-info-card">
                            <div class="calc-info-card-title">Carga Recomendada</div>
                            <div class="calc-info-card-value">${capacidad.cargaOptima.toFixed(2)}</div>
                            <div class="calc-info-card-unit">UGM/Ha</div>
                        </div>
                        <div class="calc-info-card">
                            <div class="calc-info-card-title">Tu Carga Actual</div>
                            <div class="calc-info-card-value">${resultados.cargaActual.toFixed(2)}</div>
                            <div class="calc-info-card-unit">UGM/Ha</div>
                        </div>
                        <div class="calc-info-card" style="border-color: ${capacidad.diferencia >= 0 ? 'var(--verde-claro)' : 'var(--rojo)'};">
                            <div class="calc-info-card-title">Diferencia</div>
                            <div class="calc-info-card-value" style="color: ${capacidad.diferencia >= 0 ? 'var(--verde)' : 'var(--rojo)'};">
                                ${capacidad.diferencia >= 0 ? '+' : ''}${capacidad.diferencia.toFixed(1)}
                            </div>
                            <div class="calc-info-card-unit">UGM ${capacidad.diferencia >= 0 ? 'disponibles' : 'excedentes'}</div>
                        </div>
                    </div>
                    
                    <div class="calc-container">
                        <div class="calc-panel">
                            <div class="calc-panel-title">
                                <span></span> Capacidad por Categor铆a
                            </div>
                            <p style="font-size: 13px; color: var(--gris-600); margin-bottom: 16px;">
                                N煤mero m谩ximo de animales por categor铆a que podr铆as mantener (excluyendo otras categor铆as):
                            </p>
                            
                            <table class="calc-categories-table">
                                <thead>
                                    <tr>
                                        <th>Categor铆a</th>
                                        <th>UGM c/u</th>
                                        <th>M谩x. Animales</th>
                                        <th>Tienes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(this.calcData.categorias).map(([key, cat]) => {
                                        const maxAnimales = Math.floor(capacidad.ugmOptimo / cat.ugm);
                                        return `
                                            <tr>
                                                <td>${cat.nombre}</td>
                                                <td>${cat.ugm}</td>
                                                <td><strong>${maxAnimales}</strong></td>
                                                <td>${cat.cantidad}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="calc-panel">
                            <div class="calc-panel-title">
                                <span></span> Escenarios de Carga
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${[
                                    { nombre: 'Conservador', factor: 0.7, desc: 'M谩xima recuperaci贸n de pasturas' },
                                    { nombre: 'Moderado', factor: 0.85, desc: 'Balance producci贸n/conservaci贸n' },
                                    { nombre: 'ptimo', factor: 1.0, desc: 'M谩xima eficiencia sostenible' },
                                    { nombre: 'Intensivo', factor: 1.15, desc: 'Requiere suplementaci贸n' }
                                ].map(esc => {
                                    const ugm = capacidad.ugmOptimo * esc.factor;
                                    const carga = capacidad.cargaOptima * esc.factor;
                                    const esActual = Math.abs(resultados.cargaActual - carga) < 0.1;
                                    
                                    return `
                                        <div style="display: flex; align-items: center; gap: 16px; padding: 12px; background: ${esActual ? 'var(--verde-muy-claro)' : 'var(--gris-100)'}; border-radius: 10px; ${esActual ? 'border: 2px solid var(--verde-claro);' : ''}">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-size: 14px;">${esc.nombre} ${esActual ? ' Tu nivel' : ''}</div>
                                                <div style="font-size: 12px; color: var(--gris-600);">${esc.desc}</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 18px; font-weight: 700; color: var(--verde-medio);">${ugm.toFixed(1)} UGM</div>
                                                <div style="font-size: 12px; color: var(--gris-500);">${carga.toFixed(2)} UGM/Ha</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="calc-recommendations">
                        <div class="calc-panel-title" style="border: none; padding: 0; margin-bottom: 12px;">
                            <span></span> Plan de Acci贸n
                        </div>
                        ${capacidad.planAccion.map(a => `
                            <div class="calc-recommendation-item">
                                <div class="calc-recommendation-icon">${a.icon}</div>
                                <div class="calc-recommendation-text"><strong>${a.titulo}:</strong> ${a.texto}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            
            // Tab 4: Referencia
            renderReferencia: function() {
                return `
                    <div class="calc-container">
                        <div class="calc-panel">
                            <div class="calc-panel-title">
                                <span></span> 驴Qu茅 es UGM?
                            </div>
                            <p style="font-size: 14px; color: var(--gris-700); line-height: 1.6; margin-bottom: 16px;">
                                La <strong>Unidad de Ganado Mayor (UGM)</strong> es una medida est谩ndar que permite comparar 
                                diferentes tipos y categor铆as de animales. Se basa en los requerimientos nutricionales 
                                de una vaca adulta de 450 kg como referencia (1 UGM).
                            </p>
                            
                            <table class="calc-categories-table">
                                <thead>
                                    <tr>
                                        <th>Categor铆a</th>
                                        <th>Equivalencia UGM</th>
                                        <th>Peso Referencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Vaca adulta (450 kg)</td><td><strong>1.00</strong></td><td>450 kg</td></tr>
                                    <tr><td>Toro adulto</td><td><strong>1.30</strong></td><td>600 kg</td></tr>
                                    <tr><td>Novillo/Novilla (1-2 a帽os)</td><td><strong>0.70</strong></td><td>280-300 kg</td></tr>
                                    <tr><td>Ternero/a (< 1 a帽o)</td><td><strong>0.35-0.40</strong></td><td>130-150 kg</td></tr>
                                    <tr><td>Caballo adulto</td><td><strong>1.00</strong></td><td>450 kg</td></tr>
                                    <tr><td>Oveja adulta</td><td><strong>0.15</strong></td><td>50 kg</td></tr>
                                    <tr><td>Cabra adulta</td><td><strong>0.12</strong></td><td>40 kg</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="calc-panel">
                            <div class="calc-panel-title">
                                <span></span> Valores de Referencia Venezuela
                            </div>
                            
                            <h4 style="font-size: 14px; color: var(--gris-800); margin-bottom: 12px;">Producci贸n de Pasturas (kg MS/ha/a帽o)</h4>
                            <table class="calc-categories-table">
                                <thead>
                                    <tr>
                                        <th>Tipo de Pastura</th>
                                        <th>poca Lluviosa</th>
                                        <th>poca Seca</th>
                                        <th>Promedio Anual</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Brachiaria brizantha</td><td>3,500</td><td>1,200</td><td>4,700</td></tr>
                                    <tr><td>Brachiaria decumbens</td><td>3,000</td><td>1,000</td><td>4,000</td></tr>
                                    <tr><td>Estrella (Cynodon)</td><td>4,000</td><td>1,500</td><td>5,500</td></tr>
                                    <tr><td>Guinea (Panicum)</td><td>3,200</td><td>800</td><td>4,000</td></tr>
                                    <tr><td>Pastura Natural</td><td>1,500</td><td>500</td><td>2,000</td></tr>
                                </tbody>
                            </table>
                            
                            <h4 style="font-size: 14px; color: var(--gris-800); margin: 20px 0 12px;">Carga Recomendada por Regi贸n</h4>
                            <table class="calc-categories-table">
                                <thead>
                                    <tr>
                                        <th>Regi贸n</th>
                                        <th>UGM/Ha (Lluvias)</th>
                                        <th>UGM/Ha (Seca)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Llanos Centrales</td><td>1.0 - 1.5</td><td>0.5 - 0.8</td></tr>
                                    <tr><td>Llanos Occidentales</td><td>1.2 - 1.8</td><td>0.6 - 1.0</td></tr>
                                    <tr><td>Regi贸n Andina</td><td>1.5 - 2.5</td><td>1.0 - 1.5</td></tr>
                                    <tr><td>Zulia / Sur del Lago</td><td>1.5 - 2.0</td><td>0.8 - 1.2</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="calc-recommendations">
                        <div class="calc-panel-title" style="border: none; padding: 0; margin-bottom: 12px;">
                            <span></span> F贸rmulas Utilizadas
                        </div>
                        <div style="font-family: monospace; background: var(--gris-100); padding: 16px; border-radius: 8px; font-size: 13px;">
                            <p><strong>Carga Animal:</strong> UGM Total 梅 Superficie (Ha)</p>
                            <p><strong>Oferta Forrajera:</strong> Producci贸n MS  Superficie  (Utilizaci贸n/100)</p>
                            <p><strong>Demanda:</strong> Peso Total  (Consumo%/100)  365 d铆as</p>
                            <p><strong>Balance:</strong> Oferta - Demanda</p>
                            <p><strong>Capacidad ptima:</strong> Oferta 梅 (Peso UGM  Consumo%  365)</p>
                        </div>
                    </div>
                `;
            },
            
            // Funciones de c谩lculo
            calcularCargaAnimal: function() {
                let totalUGM = 0;
                let totalCabezas = 0;
                let pesoTotal = 0;
                
                Object.values(this.calcData.categorias).forEach(cat => {
                    totalUGM += cat.cantidad * cat.ugm;
                    totalCabezas += cat.cantidad;
                    pesoTotal += cat.cantidad * cat.pesoPromedio;
                });
                
                const superficie = this.calcData.superficie || 1;
                const cargaActual = totalUGM / superficie;
                const hasPorUGM = superficie / (totalUGM || 1);
                
                // Determinar estado
                let estado, estadoIcon, estadoTitulo, estadoMensaje;
                const cargaRef = this.calcData.epoca === 'lluvias' ? 1.2 : 0.7;
                
                if (cargaActual === 0) {
                    estado = 'moderado';
                    estadoIcon = '';
                    estadoTitulo = 'Sin datos';
                    estadoMensaje = 'Ingresa el inventario de ganado para calcular';
                } else if (cargaActual <= cargaRef * 0.7) {
                    estado = 'optimo';
                    estadoIcon = '';
                    estadoTitulo = 'Carga Baja';
                    estadoMensaje = 'Hay capacidad para aumentar el hato';
                } else if (cargaActual <= cargaRef * 1.1) {
                    estado = 'optimo';
                    estadoIcon = '';
                    estadoTitulo = 'Carga ptima';
                    estadoMensaje = 'El nivel de carga es adecuado para la superficie';
                } else if (cargaActual <= cargaRef * 1.3) {
                    estado = 'moderado';
                    estadoIcon = '锔';
                    estadoTitulo = 'Carga Alta';
                    estadoMensaje = 'Monitorear estado de pasturas, considerar suplementaci贸n';
                } else {
                    estado = 'critico';
                    estadoIcon = '';
                    estadoTitulo = 'Sobrecarga';
                    estadoMensaje = 'Riesgo de degradaci贸n de pasturas. Reducir carga o suplementar.';
                }
                
                // Generar recomendaciones
                const recomendaciones = [];
                if (cargaActual > cargaRef * 1.1) {
                    recomendaciones.push({
                        icon: '',
                        texto: `Considere reducir la carga en ${((cargaActual - cargaRef) * superficie).toFixed(1)} UGM para alcanzar el nivel 贸ptimo.`
                    });
                }
                if (this.calcData.epoca === 'seca') {
                    recomendaciones.push({
                        icon: '锔',
                        texto: 'En 茅poca seca, la producci贸n de pasto disminuye 60-70%. Considere suplementaci贸n con heno o concentrado.'
                    });
                }
                if (totalCabezas > 0 && superficie > 0) {
                    recomendaciones.push({
                        icon: '',
                        texto: `Cada animal dispone de ${(superficie / totalCabezas).toFixed(2)} Ha en promedio.`
                    });
                }
                if (recomendaciones.length === 0) {
                    recomendaciones.push({
                        icon: '',
                        texto: 'Ingresa los datos de tu inventario para obtener recomendaciones personalizadas.'
                    });
                }
                
                return {
                    totalUGM,
                    totalCabezas,
                    pesoTotal,
                    cargaActual,
                    hasPorUGM,
                    estado,
                    estadoIcon,
                    estadoTitulo,
                    estadoMensaje,
                    recomendaciones
                };
            },
            
            calcularBalanceForrajero: function() {
                const resultados = this.calcularCargaAnimal();
                const superficie = this.calcData.superficie || 1;
                
                // Factor de 茅poca
                const factorEpoca = this.calcData.epoca === 'lluvias' ? 1.0 : 0.4;
                
                // Oferta: Producci贸n  Superficie  Utilizaci贸n  Factor 茅poca
                const produccionAnual = this.calcData.produccionMS * factorEpoca;
                const ofertaTotal = produccionAnual * superficie * (this.calcData.utilizacion / 100);
                
                // Demanda: Peso total  % consumo  365
                const demandaDiaria = resultados.pesoTotal * (this.calcData.consumoMS / 100);
                const demandaTotal = demandaDiaria * 365;
                
                // Balance
                const balanceNeto = ofertaTotal - demandaTotal;
                const porcentajeCobertura = demandaTotal > 0 ? (ofertaTotal / demandaTotal) * 100 : 0;
                const diasAutonomia = demandaDiaria > 0 ? ofertaTotal / demandaDiaria : 0;
                
                // Estado
                let estado, estadoIcon, estadoTitulo, estadoMensaje, estadoBalance, balanceColor;
                
                if (demandaTotal === 0) {
                    estado = 'moderado';
                    estadoIcon = '';
                    estadoTitulo = 'Sin datos';
                    estadoMensaje = 'Ingresa el inventario de ganado';
                    estadoBalance = 'equilibrio';
                    balanceColor = 'rgba(255,255,255,0.2)';
                } else if (porcentajeCobertura >= 100) {
                    estado = 'optimo';
                    estadoIcon = '';
                    estadoTitulo = 'Balance Positivo';
                    estadoMensaje = `Excedente de ${balanceNeto.toFixed(0)} kg MS. Posibilidad de henificar o aumentar carga.`;
                    estadoBalance = 'excedente';
                    balanceColor = 'rgba(16, 185, 129, 0.3)';
                } else if (porcentajeCobertura >= 80) {
                    estado = 'moderado';
                    estadoIcon = '锔';
                    estadoTitulo = 'Balance Ajustado';
                    estadoMensaje = 'D茅ficit menor. Monitorear y considerar suplementaci贸n estrat茅gica.';
                    estadoBalance = 'equilibrio';
                    balanceColor = 'rgba(245, 158, 11, 0.3)';
                } else {
                    estado = 'critico';
                    estadoIcon = '';
                    estadoTitulo = 'D茅ficit Forrajero';
                    estadoMensaje = `Faltan ${Math.abs(balanceNeto).toFixed(0)} kg MS. Suplementaci贸n obligatoria o reducir carga.`;
                    estadoBalance = 'deficit';
                    balanceColor = 'rgba(239, 68, 68, 0.3)';
                }
                
                return {
                    ofertaTotal,
                    demandaTotal,
                    balanceNeto,
                    porcentajeCobertura,
                    diasAutonomia,
                    estado,
                    estadoIcon,
                    estadoTitulo,
                    estadoMensaje,
                    estadoBalance,
                    balanceColor
                };
            },
            
            calcularCapacidadOptima: function() {
                const superficie = this.calcData.superficie || 1;
                const factorEpoca = this.calcData.epoca === 'lluvias' ? 1.0 : 0.4;
                
                // Oferta disponible
                const produccionAnual = this.calcData.produccionMS * factorEpoca;
                const ofertaTotal = produccionAnual * superficie * (this.calcData.utilizacion / 100);
                
                // Consumo de 1 UGM (450 kg) por a帽o
                const consumoUGM = 450 * (this.calcData.consumoMS / 100) * 365;
                
                // Capacidad 贸ptima
                const ugmOptimo = ofertaTotal / consumoUGM;
                const cargaOptima = ugmOptimo / superficie;
                
                // Comparar con actual
                const resultados = this.calcularCargaAnimal();
                const diferencia = ugmOptimo - resultados.totalUGM;
                
                // Plan de acci贸n
                const planAccion = [];
                
                if (diferencia > 5) {
                    planAccion.push({
                        icon: '',
                        titulo: 'Potencial de crecimiento',
                        texto: `Puedes agregar hasta ${diferencia.toFixed(0)} UGM adicionales (equivalente a ${Math.floor(diferencia)} vacas adultas).`
                    });
                } else if (diferencia < -5) {
                    planAccion.push({
                        icon: '',
                        titulo: 'Reducir carga',
                        texto: `Deber铆as reducir ${Math.abs(diferencia).toFixed(0)} UGM para alcanzar el equilibrio sostenible.`
                    });
                } else {
                    planAccion.push({
                        icon: '',
                        titulo: 'Carga equilibrada',
                        texto: 'Tu carga actual est谩 cerca del 贸ptimo. Mant茅n el monitoreo de las pasturas.'
                    });
                }
                
                if (this.calcData.epoca === 'seca') {
                    planAccion.push({
                        icon: '',
                        titulo: 'poca seca',
                        texto: 'Considera hacer reservas de forraje (heno/ensilaje) durante lluvias para 茅poca seca.'
                    });
                }
                
                planAccion.push({
                    icon: '',
                    titulo: 'Rotaci贸n PRV',
                    texto: `Con ${this.data.potreros.length} potreros puedes implementar rotaci贸n cada ${Math.ceil(30 / this.data.potreros.length)} d铆as.`
                });
                
                return {
                    ugmOptimo,
                    cargaOptima,
                    diferencia,
                    planAccion
                };
            },
            
            // Funciones de actualizaci贸n
            updateCalcCategoria: function(key, value) {
                this.calcData.categorias[key].cantidad = parseInt(value) || 0;
                this.saveCalcData();
                document.getElementById('calcTabContent').innerHTML = this.renderCalcTabContent();
            },
            
            updateCalcSuperficie: function(value) {
                this.calcData.superficie = parseFloat(value) || 0;
                this.saveCalcData();
                document.getElementById('calcTabContent').innerHTML = this.renderCalcTabContent();
            },
            
            updateCalcParam: function(param, value) {
                if (param === 'epoca') {
                    this.calcData[param] = value;
                } else {
                    this.calcData[param] = parseFloat(value) || 0;
                }
                this.saveCalcData();
                document.getElementById('calcTabContent').innerHTML = this.renderCalcTabContent();
            },
            
            // Persistencia
            loadCalcData: function() {
                const saved = localStorage.getItem('nexusAgroCalcData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.calcData = { ...this.calcData, ...parsed };
                    // Restaurar categor铆as
                    if (parsed.categorias) {
                        Object.keys(parsed.categorias).forEach(key => {
                            if (this.calcData.categorias[key]) {
                                this.calcData.categorias[key].cantidad = parsed.categorias[key].cantidad || 0;
                            }
                        });
                    }
                }
            },
            
            saveCalcData: function() {
                localStorage.setItem('nexusAgroCalcData', JSON.stringify(this.calcData));
            },
            
            resetCalcData: function() {
                if (confirm('驴Reiniciar todos los datos de la calculadora?')) {
                    Object.keys(this.calcData.categorias).forEach(key => {
                        this.calcData.categorias[key].cantidad = 0;
                    });
                    this.calcData.superficie = this.data.potreros.reduce((sum, p) => sum + (parseFloat(p.superficie) || 0), 0);
                    this.calcData.produccionMS = 3000;
                    this.calcData.utilizacion = 60;
                    this.calcData.consumoMS = 2.5;
                    this.calcData.epoca = 'lluvias';
                    this.saveCalcData();
                    this.navigate('calculadora');
                    this.notify('success', 'Datos reiniciados', 'La calculadora ha sido reiniciada');
                }
            },
            
            exportCalcReport: function() {
                const resultados = this.calcularCargaAnimal();
                const balance = this.calcularBalanceForrajero();
                const capacidad = this.calcularCapacidadOptima();
                
                let reporte = `REPORTE DE CARGA ANIMAL\n`;
                reporte += `========================\n`;
                reporte += `Fecha: ${new Date().toLocaleDateString('es')}\n`;
                reporte += `poca: ${this.calcData.epoca === 'lluvias' ? 'Lluviosa' : 'Seca'}\n\n`;
                
                reporte += `INVENTARIO\n`;
                reporte += `Superficie: ${this.calcData.superficie} Ha\n`;
                Object.values(this.calcData.categorias).forEach(cat => {
                    if (cat.cantidad > 0) {
                        reporte += `${cat.nombre}: ${cat.cantidad} (${(cat.cantidad * cat.ugm).toFixed(1)} UGM)\n`;
                    }
                });
                reporte += `\nTOTAL: ${resultados.totalCabezas} cabezas = ${resultados.totalUGM.toFixed(1)} UGM\n`;
                
                reporte += `\nCARGA ANIMAL\n`;
                reporte += `Carga actual: ${resultados.cargaActual.toFixed(2)} UGM/Ha\n`;
                reporte += `Estado: ${resultados.estadoTitulo}\n`;
                
                reporte += `\nBALANCE FORRAJERO\n`;
                reporte += `Oferta: ${balance.ofertaTotal.toFixed(0)} kg MS/a帽o\n`;
                reporte += `Demanda: ${balance.demandaTotal.toFixed(0)} kg MS/a帽o\n`;
                reporte += `Balance: ${balance.balanceNeto >= 0 ? '+' : ''}${balance.balanceNeto.toFixed(0)} kg MS\n`;
                
                reporte += `\nCAPACIDAD PTIMA\n`;
                reporte += `UGM Recomendado: ${capacidad.ugmOptimo.toFixed(1)}\n`;
                reporte += `Diferencia: ${capacidad.diferencia >= 0 ? '+' : ''}${capacidad.diferencia.toFixed(1)} UGM\n`;
                
                reporte += `\n---\nGenerado por WIN-TEL AgroManager PRO`;
                
                navigator.clipboard.writeText(reporte).then(() => {
                    this.notify('success', 'Reporte copiado', 'El reporte ha sido copiado al portapapeles');
                });
            },

            renderClima: function() {
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">★</span>
                                Clima y Pron贸stico para tu Finca
                            </h3>
                            <button class="btn btn-secondary" onclick="app.refreshWeather()">
                                <span></span> Actualizar
                            </button>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Selector de ubicaci贸n -->
                            <div class="weather-location-selector">
                                <button class="weather-location-btn ${!this.weatherLocation ? 'active' : ''}" onclick="app.useGPSLocation()">
                                     Usar mi ubicaci贸n GPS
                                </button>
                                <button class="weather-location-btn ${this.weatherLocation === 'valencia' ? 'active' : ''}" onclick="app.setWeatherLocation('valencia', 10.1579, -67.9972)">
                                    锔 Valencia, Carabobo
                                </button>
                                <button class="weather-location-btn ${this.weatherLocation === 'caracas' ? 'active' : ''}" onclick="app.setWeatherLocation('caracas', 10.4806, -66.9036)">
                                    锔 Caracas
                                </button>
                                <button class="weather-location-btn ${this.weatherLocation === 'maracay' ? 'active' : ''}" onclick="app.setWeatherLocation('maracay', 10.2469, -67.5958)">
                                    锔 Maracay
                                </button>
                                <button class="weather-location-btn" onclick="app.openCustomLocation()">
                                    锔 Otra ubicaci贸n
                                </button>
                            </div>
                            
                            <!-- Contenido del clima -->
                            <div id="weatherContent">
                                <div class="weather-loading">
                                    <div class="weather-loading-spinner"></div>
                                    <div>Obteniendo datos del clima...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
                
                // Cargar datos del clima
                this.loadWeatherData();
            },
            
            loadWeatherData: async function() {
                try {
                    // Obtener ubicaci贸n
                    let lat, lon, locationName;
                    
                    const savedLocation = localStorage.getItem('weatherLocation');
                    if (savedLocation) {
                        const loc = JSON.parse(savedLocation);
                        lat = loc.lat;
                        lon = loc.lon;
                        locationName = loc.name;
                        this.weatherLocation = loc.id;
                    } else {
                        // Intentar GPS o usar Valencia por defecto
                        try {
                            const pos = await this.getCurrentPosition();
                            lat = pos.coords.latitude;
                            lon = pos.coords.longitude;
                            locationName = 'Tu ubicaci贸n';
                        } catch (e) {
                            // Valencia, Venezuela por defecto
                            lat = 10.1579;
                            lon = -67.9972;
                            locationName = 'Valencia, Carabobo';
                            this.weatherLocation = 'valencia';
                        }
                    }
                    
                    // Llamar a la API de Open-Meteo (gratuita, sin API key)
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max&timezone=America%2FCaracas&forecast_days=7`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    this.weatherData = {
                        location: locationName,
                        lat,
                        lon,
                        current: data.current,
                        daily: data.daily,
                        units: data.current_units
                    };
                    
                    // Guardar en historial
                    this.saveWeatherHistory(data.current);
                    
                    // Renderizar
                    this.renderWeatherContent();
                    
                } catch (error) {
                    console.error('Error obteniendo clima:', error);
                    document.getElementById('weatherContent').innerHTML = `
                        <div class="weather-loading">
                            <div style="font-size: 48px; margin-bottom: 16px;">锔</div>
                            <div>No se pudo obtener el clima</div>
                            <div style="font-size: 13px; margin-top: 8px; color: var(--gris-500);">Verifica tu conexi贸n a internet</div>
                            <button class="btn btn-primary" style="margin-top: 16px;" onclick="app.loadWeatherData()">Reintentar</button>
                        </div>
                    `;
                }
            },
            
            getCurrentPosition: function() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('GPS no disponible'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });
            },
            
            renderWeatherContent: function() {
                if (!this.weatherData) return;
                
                const { current, daily, location } = this.weatherData;
                const weatherIcon = this.getWeatherIcon(current.weather_code);
                const weatherDesc = this.getWeatherDescription(current.weather_code);
                
                // Generar alertas y recomendaciones
                const alerts = this.generateWeatherAlerts(current, daily);
                const recommendations = this.generatePastureRecommendations(current, daily);
                
                const html = `
                    <!-- Alertas Clim谩ticas -->
                    ${alerts.length > 0 ? `
                        <div class="weather-alerts">
                            ${alerts.map(a => `
                                <div class="weather-alert ${a.type}">
                                    <div class="weather-alert-icon">${a.icon}</div>
                                    <div class="weather-alert-content">
                                        <div class="weather-alert-title">${a.title}</div>
                                        <div class="weather-alert-message">${a.message}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Dashboard Principal -->
                    <div class="weather-dashboard">
                        <!-- Clima Actual -->
                        <div class="weather-current">
                            <div class="weather-location">
                                 ${location}
                                <span style="opacity: 0.7; font-size: 12px;"> Actualizado ${new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            
                            <div class="weather-main">
                                <div class="weather-icon">${weatherIcon}</div>
                                <div>
                                    <div class="weather-temp">
                                        ${Math.round(current.temperature_2m)}<span class="weather-temp-unit">掳C</span>
                                    </div>
                                    <div style="font-size: 14px; opacity: 0.8;">
                                        Sensaci贸n: ${Math.round(current.apparent_temperature)}掳C
                                    </div>
                                </div>
                            </div>
                            
                            <div class="weather-desc">${weatherDesc}</div>
                            
                            <div class="weather-details">
                                <div class="weather-detail-item">
                                    <div class="weather-detail-icon"></div>
                                    <div class="weather-detail-value">${current.relative_humidity_2m}%</div>
                                    <div class="weather-detail-label">Humedad</div>
                                </div>
                                <div class="weather-detail-item">
                                    <div class="weather-detail-icon"></div>
                                    <div class="weather-detail-value">${Math.round(current.wind_speed_10m)}</div>
                                    <div class="weather-detail-label">km/h Viento</div>
                                </div>
                                <div class="weather-detail-item">
                                    <div class="weather-detail-icon">э</div>
                                    <div class="weather-detail-value">${current.precipitation}</div>
                                    <div class="weather-detail-label">mm Precip.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pron贸stico 7 d铆as -->
                        <div class="weather-forecast">
                            <div class="weather-forecast-title"> Pron贸stico 7 D铆as</div>
                            <div class="forecast-days">
                                ${daily.time.map((date, i) => {
                                    const d = new Date(date + 'T12:00:00');
                                    const isToday = i === 0;
                                    const dayName = isToday ? 'Hoy' : d.toLocaleDateString('es', { weekday: 'short' });
                                    const icon = this.getWeatherIcon(daily.weather_code[i]);
                                    
                                    return `
                                        <div class="forecast-day ${isToday ? 'today' : ''}" onclick="app.showDayForecast(${i})">
                                            <div class="forecast-day-name">${dayName}</div>
                                            <div class="forecast-day-icon">${icon}</div>
                                            <div class="forecast-day-temps">
                                                <span class="forecast-temp-max">${Math.round(daily.temperature_2m_max[i])}掳</span>
                                                <span class="forecast-temp-min">${Math.round(daily.temperature_2m_min[i])}掳</span>
                                            </div>
                                            ${daily.precipitation_probability_max[i] > 30 ? `
                                                <div class="forecast-day-rain"> ${daily.precipitation_probability_max[i]}%</div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recomendaciones de Pastoreo -->
                    <div class="weather-recommendations">
                        <div class="weather-forecast-title"> Recomendaciones de Pastoreo</div>
                        ${recommendations.map(r => `
                            <div class="recommendation-item">
                                <div class="recommendation-icon">${r.icon}</div>
                                <div class="recommendation-content">
                                    <h4>${r.title}</h4>
                                    <p>${r.message}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Historial y Estad铆sticas -->
                    <div class="weather-history">
                        <div class="weather-forecast-title"> Resumen Clim谩tico del Per铆odo</div>
                        
                        <div class="weather-stats-grid">
                            <div class="weather-stat-card">
                                <div class="weather-stat-value">${Math.round(daily.temperature_2m_max.reduce((a, b) => a + b, 0) / daily.temperature_2m_max.length)}掳C</div>
                                <div class="weather-stat-label">Temp. Promedio M谩x.</div>
                            </div>
                            <div class="weather-stat-card">
                                <div class="weather-stat-value">${Math.round(daily.temperature_2m_min.reduce((a, b) => a + b, 0) / daily.temperature_2m_min.length)}掳C</div>
                                <div class="weather-stat-label">Temp. Promedio M铆n.</div>
                            </div>
                            <div class="weather-stat-card">
                                <div class="weather-stat-value">${daily.precipitation_sum.reduce((a, b) => a + b, 0).toFixed(1)} mm</div>
                                <div class="weather-stat-label">Precip. Total Semana</div>
                            </div>
                            <div class="weather-stat-card">
                                <div class="weather-stat-value">${daily.precipitation_probability_max.filter(p => p > 50).length}</div>
                                <div class="weather-stat-label">D铆as con Lluvia Probable</div>
                            </div>
                        </div>
                        
                        <!-- Indicador de condiciones para pastoreo -->
                        <div style="margin-top: 20px; padding: 20px; background: ${this.getPastureConditionColor(current, daily)}; border-radius: 12px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 8px;">${this.getPastureConditionIcon(current, daily)}</div>
                            <div style="font-size: 18px; font-weight: 700; color: white;">${this.getPastureConditionText(current, daily)}</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 4px;">Condiciones actuales para pastoreo</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('weatherContent').innerHTML = html;
            },
            
            getWeatherIcon: function(code) {
                const icons = {
                    0: '锔', // Despejado
                    1: 'わ', // Principalmente despejado
                    2: '', // Parcialmente nublado
                    3: '锔', // Nublado
                    45: '锔', // Niebla
                    48: '锔', // Niebla con escarcha
                    51: '锔', // Llovizna ligera
                    53: '锔', // Llovizna moderada
                    55: 'э', // Llovizna densa
                    61: 'э', // Lluvia ligera
                    63: 'э', // Lluvia moderada
                    65: 'э', // Lluvia fuerte
                    71: '锔', // Nieve ligera
                    73: '锔', // Nieve moderada
                    75: '锔', // Nieve fuerte
                    80: '锔', // Chubascos ligeros
                    81: 'э', // Chubascos moderados
                    82: '锔', // Chubascos fuertes
                    95: '锔', // Tormenta
                    96: '锔', // Tormenta con granizo
                    99: '锔'  // Tormenta fuerte con granizo
                };
                return icons[code] || '★';
            },
            
            getWeatherDescription: function(code) {
                const descriptions = {
                    0: 'Cielo despejado',
                    1: 'Principalmente despejado',
                    2: 'Parcialmente nublado',
                    3: 'Nublado',
                    45: 'Niebla',
                    48: 'Niebla con escarcha',
                    51: 'Llovizna ligera',
                    53: 'Llovizna moderada',
                    55: 'Llovizna densa',
                    61: 'Lluvia ligera',
                    63: 'Lluvia moderada',
                    65: 'Lluvia fuerte',
                    71: 'Nevada ligera',
                    73: 'Nevada moderada',
                    75: 'Nevada fuerte',
                    80: 'Chubascos ligeros',
                    81: 'Chubascos moderados',
                    82: 'Chubascos fuertes',
                    95: 'Tormenta el茅ctrica',
                    96: 'Tormenta con granizo',
                    99: 'Tormenta severa'
                };
                return descriptions[code] || 'Condiciones variables';
            },
            
            generateWeatherAlerts: function(current, daily) {
                const alerts = [];
                
                // Alerta de lluvia pr贸xima
                const diasLluvia = daily.precipitation_probability_max.filter(p => p > 60).length;
                if (diasLluvia >= 3) {
                    alerts.push({
                        type: 'lluvia',
                        icon: 'э',
                        title: 'Per铆odo lluvioso esperado',
                        message: `Se esperan ${diasLluvia} d铆as con alta probabilidad de lluvia. Considere ajustar la rotaci贸n de potreros.`
                    });
                } else if (daily.precipitation_probability_max[0] > 70) {
                    alerts.push({
                        type: 'lluvia',
                        icon: '',
                        title: 'Lluvia probable hoy',
                        message: `${daily.precipitation_probability_max[0]}% de probabilidad de lluvia. Revise el estado de los potreros bajos.`
                    });
                }
                
                // Alerta de calor
                if (current.temperature_2m > 35) {
                    alerts.push({
                        type: 'calor',
                        icon: '',
                        title: 'Alerta de calor extremo',
                        message: 'Temperatura superior a 35掳C. Asegure acceso a agua y sombra para el ganado.'
                    });
                } else if (current.temperature_2m > 32) {
                    alerts.push({
                        type: 'calor',
                        icon: '锔',
                        title: 'D铆a caluroso',
                        message: 'Temperatura elevada. Evite mover ganado en las horas m谩s calientes (11am-3pm).'
                    });
                }
                
                // Alerta de sequ铆a
                const lluviaTotal = daily.precipitation_sum.reduce((a, b) => a + b, 0);
                if (lluviaTotal < 5 && current.relative_humidity_2m < 40) {
                    alerts.push({
                        type: 'sequia',
                        icon: '锔',
                        title: 'Condiciones secas',
                        message: 'Poca lluvia esperada y baja humedad. Monitoree el estado de las pasturas.'
                    });
                }
                
                // Condiciones 贸ptimas
                if (alerts.length === 0 && current.temperature_2m >= 20 && current.temperature_2m <= 28) {
                    alerts.push({
                        type: 'optimo',
                        icon: '',
                        title: 'Condiciones 贸ptimas',
                        message: 'El clima actual es favorable para el pastoreo y manejo del ganado.'
                    });
                }
                
                return alerts;
            },
            
            generatePastureRecommendations: function(current, daily) {
                const recommendations = [];
                const temp = current.temperature_2m;
                const humidity = current.relative_humidity_2m;
                const rainProb = daily.precipitation_probability_max[0];
                
                // Recomendaci贸n de horario de pastoreo
                if (temp > 30) {
                    recommendations.push({
                        icon: '',
                        title: 'Horario de pastoreo',
                        message: 'Por el calor, se recomienda pastoreo temprano (6-9am) y tard铆o (4-6pm). Evite las horas centrales del d铆a.'
                    });
                } else {
                    recommendations.push({
                        icon: '',
                        title: 'Horario de pastoreo',
                        message: 'Temperatura agradable. Puede realizar pastoreo durante la mayor parte del d铆a.'
                    });
                }
                
                // Recomendaci贸n de agua
                if (temp > 28 || humidity < 50) {
                    recommendations.push({
                        icon: '',
                        title: 'Hidrataci贸n del ganado',
                        message: 'Asegure disponibilidad de agua fresca. En estas condiciones, el ganado aumenta su consumo de agua hasta un 50%.'
                    });
                }
                
                // Recomendaci贸n de rotaci贸n seg煤n lluvia
                if (rainProb > 60) {
                    recommendations.push({
                        icon: '',
                        title: 'Rotaci贸n de potreros',
                        message: 'Con lluvia esperada, evite potreros con drenaje deficiente. Priorice 谩reas elevadas para evitar compactaci贸n del suelo.'
                    });
                } else if (daily.precipitation_sum.reduce((a, b) => a + b, 0) < 10) {
                    recommendations.push({
                        icon: '',
                        title: 'Estado de pasturas',
                        message: 'Per铆odo seco esperado. Considere reducir la carga animal o acortar el tiempo de ocupaci贸n para permitir recuperaci贸n.'
                    });
                }
                
                // Recomendaci贸n de suplementaci贸n
                if (humidity < 40 && temp > 30) {
                    recommendations.push({
                        icon: '',
                        title: 'Suplementaci贸n mineral',
                        message: 'En condiciones de calor y baja humedad, considere aumentar la disponibilidad de sales minerales.'
                    });
                }
                
                return recommendations;
            },
            
            getPastureConditionColor: function(current, daily) {
                const temp = current.temperature_2m;
                const rainProb = daily.precipitation_probability_max[0];
                
                if (temp >= 20 && temp <= 28 && rainProb < 50) {
                    return 'linear-gradient(135deg, #10b981 0%, #059669 100%)'; // ptimo
                } else if (temp > 35 || rainProb > 80) {
                    return 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'; // Desfavorable
                } else {
                    return 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; // Moderado
                }
            },
            
            getPastureConditionIcon: function(current, daily) {
                const temp = current.temperature_2m;
                const rainProb = daily.precipitation_probability_max[0];
                
                if (temp >= 20 && temp <= 28 && rainProb < 50) return '';
                else if (temp > 35 || rainProb > 80) return '锔';
                else return '';
            },
            
            getPastureConditionText: function(current, daily) {
                const temp = current.temperature_2m;
                const rainProb = daily.precipitation_probability_max[0];
                
                if (temp >= 20 && temp <= 28 && rainProb < 50) return 'Condiciones ptimas';
                else if (temp > 35) return 'Precauci贸n por Calor';
                else if (rainProb > 80) return 'Precauci贸n por Lluvia';
                else return 'Condiciones Moderadas';
            },
            
            // Funciones de ubicaci贸n
            useGPSLocation: async function() {
                document.getElementById('weatherContent').innerHTML = `
                    <div class="weather-loading">
                        <div class="weather-loading-spinner"></div>
                        <div>Obteniendo tu ubicaci贸n GPS...</div>
                    </div>
                `;
                
                try {
                    const pos = await this.getCurrentPosition();
                    localStorage.removeItem('weatherLocation');
                    this.weatherLocation = null;
                    await this.loadWeatherData();
                } catch (e) {
                    this.notify('error', 'GPS no disponible', 'No se pudo obtener tu ubicaci贸n. Selecciona una ciudad.');
                    this.loadWeatherData();
                }
            },
            
            setWeatherLocation: function(id, lat, lon) {
                const names = {
                    'valencia': 'Valencia, Carabobo',
                    'caracas': 'Caracas',
                    'maracay': 'Maracay'
                };
                
                localStorage.setItem('weatherLocation', JSON.stringify({
                    id,
                    lat,
                    lon,
                    name: names[id]
                }));
                
                this.weatherLocation = id;
                
                document.getElementById('weatherContent').innerHTML = `
                    <div class="weather-loading">
                        <div class="weather-loading-spinner"></div>
                        <div>Cargando clima de ${names[id]}...</div>
                    </div>
                `;
                
                this.loadWeatherData();
            },
            
            openCustomLocation: function() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'customLocationModal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span></span> Ubicaci贸n Personalizada</h3>
                            <button class="modal-close" onclick="document.getElementById('customLocationModal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Nombre del lugar</label>
                                <input type="text" class="form-input" id="customLocationName" placeholder="Ej: Mi Finca">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Latitud</label>
                                <input type="number" step="0.0001" class="form-input" id="customLocationLat" placeholder="Ej: 10.1579">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Longitud</label>
                                <input type="number" step="0.0001" class="form-input" id="customLocationLon" placeholder="Ej: -67.9972">
                            </div>
                            <div style="padding: 12px; background: var(--verde-muy-claro); border-radius: 8px; font-size: 12px;">
                                 Puedes obtener las coordenadas desde Google Maps haciendo click derecho en el mapa.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('customLocationModal').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.saveCustomLocation()">
                                <span></span> Guardar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            saveCustomLocation: function() {
                const name = document.getElementById('customLocationName').value || 'Mi ubicaci贸n';
                const lat = parseFloat(document.getElementById('customLocationLat').value);
                const lon = parseFloat(document.getElementById('customLocationLon').value);
                
                if (isNaN(lat) || isNaN(lon)) {
                    this.notify('warning', 'Datos inv谩lidos', 'Ingresa coordenadas v谩lidas');
                    return;
                }
                
                localStorage.setItem('weatherLocation', JSON.stringify({
                    id: 'custom',
                    lat,
                    lon,
                    name
                }));
                
                this.weatherLocation = 'custom';
                document.getElementById('customLocationModal').remove();
                
                document.getElementById('weatherContent').innerHTML = `
                    <div class="weather-loading">
                        <div class="weather-loading-spinner"></div>
                        <div>Cargando clima de ${name}...</div>
                    </div>
                `;
                
                this.loadWeatherData();
            },
            
            refreshWeather: function() {
                document.getElementById('weatherContent').innerHTML = `
                    <div class="weather-loading">
                        <div class="weather-loading-spinner"></div>
                        <div>Actualizando datos del clima...</div>
                    </div>
                `;
                this.loadWeatherData();
            },
            
            showDayForecast: function(dayIndex) {
                if (!this.weatherData) return;
                
                const { daily } = this.weatherData;
                const date = new Date(daily.time[dayIndex] + 'T12:00:00');
                const dayName = date.toLocaleDateString('es', { weekday: 'long', day: 'numeric', month: 'long' });
                
                const info = `
                     ${dayName}
                    ★ M谩x: ${Math.round(daily.temperature_2m_max[dayIndex])}掳C / M铆n: ${Math.round(daily.temperature_2m_min[dayIndex])}掳C
                    э Prob. lluvia: ${daily.precipitation_probability_max[dayIndex]}%
                     Precipitaci贸n: ${daily.precipitation_sum[dayIndex]} mm
                     Viento m谩x: ${Math.round(daily.wind_speed_10m_max[dayIndex])} km/h
                `;
                
                this.notify('info', this.getWeatherIcon(daily.weather_code[dayIndex]) + ' ' + this.getWeatherDescription(daily.weather_code[dayIndex]), info);
            },
            
            saveWeatherHistory: function(currentData) {
                const history = JSON.parse(localStorage.getItem('weatherHistory') || '[]');
                
                history.unshift({
                    timestamp: new Date().toISOString(),
                    temp: currentData.temperature_2m,
                    humidity: currentData.relative_humidity_2m,
                    precipitation: currentData.precipitation
                });
                
                // Mantener solo 煤ltimos 30 registros
                const trimmed = history.slice(0, 30);
                localStorage.setItem('weatherHistory', JSON.stringify(trimmed));
                this.weatherHistory = trimmed;
            },

            renderReportesPDF: function() {
                // Cargar historial
                this.loadReportHistory();
                
                const html = `
                    <div class="report-generator">
                        <div class="report-header">
                            <h3> Generador de Reportes PDF</h3>
                            <p>Crea reportes profesionales de tu operaci贸n ganadera</p>
                        </div>
                        
                        <!-- Tipos de Reporte -->
                        <div class="report-types">
                            <div class="report-type-card ${this.selectedReportType === 'mensual' ? 'selected' : ''}" onclick="app.selectReportType('mensual')">
                                <div class="report-type-badge">Popular</div>
                                <div class="report-type-icon"></div>
                                <div class="report-type-title">Reporte Mensual</div>
                                <div class="report-type-desc">Resumen completo del mes con estad铆sticas, movimientos y an谩lisis de rotaci贸n.</div>
                            </div>
                            
                            <div class="report-type-card ${this.selectedReportType === 'potreros' ? 'selected' : ''}" onclick="app.selectReportType('potreros')">
                                <div class="report-type-icon">猴</div>
                                <div class="report-type-title">Estado de Potreros</div>
                                <div class="report-type-desc">Listado detallado de todos los potreros con estado actual y superficie.</div>
                            </div>
                            
                            <div class="report-type-card ${this.selectedReportType === 'movimientos' ? 'selected' : ''}" onclick="app.selectReportType('movimientos')">
                                <div class="report-type-icon"></div>
                                <div class="report-type-title">Historial de Movimientos</div>
                                <div class="report-type-desc">Registro completo de entradas y salidas de ganado por per铆odo.</div>
                            </div>
                            
                            <div class="report-type-card ${this.selectedReportType === 'prv' ? 'selected' : ''}" onclick="app.selectReportType('prv')">
                                <div class="report-type-icon"></div>
                                <div class="report-type-title">An谩lisis PRV</div>
                                <div class="report-type-desc">Eficiencia de rotaci贸n, estad铆sticas y recomendaciones del sistema PRV.</div>
                            </div>
                            
                            <div class="report-type-card ${this.selectedReportType === 'ejecutivo' ? 'selected' : ''}" onclick="app.selectReportType('ejecutivo')">
                                <div class="report-type-badge">PRO</div>
                                <div class="report-type-icon"></div>
                                <div class="report-type-title">Reporte Ejecutivo</div>
                                <div class="report-type-desc">Resumen compacto para presentaciones con KPIs principales y gr谩ficos.</div>
                            </div>
                            
                            <div class="report-type-card ${this.selectedReportType === 'personalizado' ? 'selected' : ''}" onclick="app.selectReportType('personalizado')">
                                <div class="report-type-icon">锔</div>
                                <div class="report-type-title">Personalizado</div>
                                <div class="report-type-desc">Configura exactamente qu茅 incluir en tu reporte.</div>
                            </div>
                        </div>
                        
                        <!-- Configuraci贸n -->
                        <div class="report-config">
                            <div class="report-config-title">锔 Configuraci贸n del Reporte</div>
                            
                            <div class="report-config-grid">
                                <div class="report-config-item">
                                    <label>Per铆odo</label>
                                    <select class="form-select" id="reportPeriodo" onchange="app.updateReportConfig()">
                                        <option value="semanal">ltima semana</option>
                                        <option value="mensual" selected>ltimo mes</option>
                                        <option value="trimestral">ltimo trimestre</option>
                                        <option value="anual">ltimo a帽o</option>
                                        <option value="personalizado">Personalizado</option>
                                    </select>
                                </div>
                                
                                <div class="report-config-item" id="fechaInicioContainer" style="display: none;">
                                    <label>Fecha Inicio</label>
                                    <input type="date" class="form-input" id="reportFechaInicio">
                                </div>
                                
                                <div class="report-config-item" id="fechaFinContainer" style="display: none;">
                                    <label>Fecha Fin</label>
                                    <input type="date" class="form-input" id="reportFechaFin" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <div class="report-config-item">
                                    <label>Nombre de la Finca</label>
                                    <input type="text" class="form-input" id="reportNombreFinca" value="${localStorage.getItem('reportNombreFinca') || 'Mi Finca'}" placeholder="Nombre de la finca">
                                </div>
                            </div>
                            
                            ${this.selectedReportType === 'personalizado' ? `
                                <div class="report-config-title" style="margin-top: 20px;"> Contenido a Incluir</div>
                                <div class="report-checklist">
                                    <label class="report-check-item ${this.reportConfig.incluirResumen ? 'checked' : ''}">
                                        <input type="checkbox" id="chkResumen" ${this.reportConfig.incluirResumen ? 'checked' : ''} onchange="app.updateReportConfig()">
                                        <span> Resumen Ejecutivo</span>
                                    </label>
                                    <label class="report-check-item ${this.reportConfig.incluirPotreros ? 'checked' : ''}">
                                        <input type="checkbox" id="chkPotreros" ${this.reportConfig.incluirPotreros ? 'checked' : ''} onchange="app.updateReportConfig()">
                                        <span>猴 Lista de Potreros</span>
                                    </label>
                                    <label class="report-check-item ${this.reportConfig.incluirMovimientos ? 'checked' : ''}">
                                        <input type="checkbox" id="chkMovimientos" ${this.reportConfig.incluirMovimientos ? 'checked' : ''} onchange="app.updateReportConfig()">
                                        <span> Movimientos</span>
                                    </label>
                                    <label class="report-check-item ${this.reportConfig.incluirGraficos ? 'checked' : ''}">
                                        <input type="checkbox" id="chkGraficos" ${this.reportConfig.incluirGraficos ? 'checked' : ''} onchange="app.updateReportConfig()">
                                        <span> Estad铆sticas</span>
                                    </label>
                                    <label class="report-check-item ${this.reportConfig.incluirPRV ? 'checked' : ''}">
                                        <input type="checkbox" id="chkPRV" ${this.reportConfig.incluirPRV ? 'checked' : ''} onchange="app.updateReportConfig()">
                                        <span> An谩lisis PRV</span>
                                    </label>
                                    <label class="report-check-item ${this.reportConfig.incluirFotos ? 'checked' : ''}">
                                        <input type="checkbox" id="chkFotos" ${this.reportConfig.incluirFotos ? 'checked' : ''} onchange="app.updateReportConfig()">
                                        <span> Fotograf铆as</span>
                                    </label>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Acciones -->
                        <div class="report-actions">
                            <button class="report-action-btn secondary" onclick="app.previewReport()">
                                锔 Vista Previa
                            </button>
                            <button class="report-action-btn primary" onclick="app.generatePDF()">
                                 Descargar PDF
                            </button>
                            <button class="report-action-btn whatsapp" onclick="app.shareReportWhatsApp()">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="report-action-btn email" onclick="app.shareReportEmail()">
                                 Email
                            </button>
                        </div>
                        
                        <!-- Historial -->
                        ${this.reportHistory.length > 0 ? `
                            <div class="report-history">
                                <div class="report-history-title"> Reportes Recientes</div>
                                <div class="report-history-list">
                                    ${this.reportHistory.slice(0, 5).map((r, i) => `
                                        <div class="report-history-item">
                                            <div class="report-history-icon"></div>
                                            <div class="report-history-info">
                                                <div class="report-history-name">${r.nombre}</div>
                                                <div class="report-history-date">${new Date(r.fecha).toLocaleDateString('es', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                                            </div>
                                            <div class="report-history-actions">
                                                <button class="btn btn-secondary btn-small" onclick="app.regenerateReport(${i})"></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            selectReportType: function(type) {
                this.selectedReportType = type;
                this.navigate('reportespdf');
            },
            
            updateReportConfig: function() {
                const periodo = document.getElementById('reportPeriodo').value;
                
                // Mostrar/ocultar fechas personalizadas
                document.getElementById('fechaInicioContainer').style.display = periodo === 'personalizado' ? 'block' : 'none';
                document.getElementById('fechaFinContainer').style.display = periodo === 'personalizado' ? 'block' : 'none';
                
                this.reportConfig.periodo = periodo;
                
                // Guardar nombre de finca
                const nombreFinca = document.getElementById('reportNombreFinca').value;
                localStorage.setItem('reportNombreFinca', nombreFinca);
                
                // Actualizar checkboxes si es personalizado
                if (this.selectedReportType === 'personalizado') {
                    this.reportConfig.incluirResumen = document.getElementById('chkResumen')?.checked ?? true;
                    this.reportConfig.incluirPotreros = document.getElementById('chkPotreros')?.checked ?? true;
                    this.reportConfig.incluirMovimientos = document.getElementById('chkMovimientos')?.checked ?? true;
                    this.reportConfig.incluirGraficos = document.getElementById('chkGraficos')?.checked ?? true;
                    this.reportConfig.incluirPRV = document.getElementById('chkPRV')?.checked ?? true;
                    this.reportConfig.incluirFotos = document.getElementById('chkFotos')?.checked ?? false;
                }
            },
            
            // Generar PDF
            generatePDF: async function() {
                // Mostrar progreso
                this.showReportProgress('Generando reporte PDF...');
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    const nombreFinca = document.getElementById('reportNombreFinca')?.value || 'Mi Finca';
                    const fechaReporte = new Date().toLocaleDateString('es', { day: 'numeric', month: 'long', year: 'numeric' });
                    
                    // Colores
                    const verdeOscuro = [15, 54, 41];
                    const verdeMedio = [45, 106, 79];
                    const verdeClaro = [82, 183, 136];
                    
                    let yPos = 20;
                    
                    // === ENCABEZADO ===
                    this.updateReportProgress('Creando encabezado...');
                    
                    // Fondo del header
                    doc.setFillColor(...verdeOscuro);
                    doc.rect(0, 0, 210, 45, 'F');
                    
                    // Logo (simulado con texto)
                    doc.setFillColor(...verdeClaro);
                    doc.circle(25, 22, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.text('', 21, 26);
                    
                    // T铆tulo
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text('WIN-TEL AgroManager PRO', 45, 20);
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'normal');
                    doc.text(nombreFinca, 45, 28);
                    
                    doc.setFontSize(10);
                    doc.text(`Reporte generado: ${fechaReporte}`, 45, 36);
                    
                    // Tipo de reporte
                    const tiposReporte = {
                        'mensual': 'Reporte Mensual',
                        'potreros': 'Estado de Potreros',
                        'movimientos': 'Historial de Movimientos',
                        'prv': 'An谩lisis PRV',
                        'ejecutivo': 'Reporte Ejecutivo',
                        'personalizado': 'Reporte Personalizado'
                    };
                    
                    doc.setFillColor(...verdeMedio);
                    doc.roundedRect(140, 10, 60, 25, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.text(tiposReporte[this.selectedReportType], 170, 20, { align: 'center' });
                    doc.setFontSize(8);
                    doc.text(this.getPeriodoTexto(), 170, 28, { align: 'center' });
                    
                    yPos = 55;
                    
                    // === RESUMEN EJECUTIVO ===
                    if (this.shouldInclude('resumen')) {
                        this.updateReportProgress('Agregando resumen ejecutivo...');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(' Resumen Ejecutivo', 15, yPos);
                        yPos += 10;
                        
                        const stats = this.calculateStats();
                        const advStats = this.calculateAdvancedStats();
                        
                        // KPIs en cajas
                        const kpis = [
                            { label: 'Total Potreros', value: stats.totalPotreros, color: verdeMedio },
                            { label: 'Ocupados', value: stats.ocupados, color: [239, 68, 68] },
                            { label: 'Disponibles', value: stats.libres, color: verdeClaro },
                            { label: 'Superficie (Ha)', value: stats.superficieTotal.toFixed(1), color: [212, 163, 115] }
                        ];
                        
                        let xKpi = 15;
                        kpis.forEach(kpi => {
                            doc.setFillColor(...kpi.color);
                            doc.roundedRect(xKpi, yPos, 42, 25, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(16);
                            doc.setFont('helvetica', 'bold');
                            doc.text(String(kpi.value), xKpi + 21, yPos + 12, { align: 'center' });
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text(kpi.label, xKpi + 21, yPos + 20, { align: 'center' });
                            xKpi += 47;
                        });
                        
                        yPos += 35;
                    }
                    
                    // === TABLA DE POTREROS ===
                    if (this.shouldInclude('potreros') && this.data.potreros.length > 0) {
                        this.updateReportProgress('Agregando tabla de potreros...');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('猴 Estado de Potreros', 15, yPos);
                        yPos += 8;
                        
                        const tableData = this.data.potreros.map(p => {
                            const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                            return [
                                p.id,
                                p.ubicacion,
                                `${p.superficie} Ha`,
                                ocupado ? 'Ocupado' : 'Disponible',
                                ocupado ? ocupado.cultivo : '-'
                            ];
                        });
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [['ID', 'Ubicaci贸n', 'Superficie', 'Estado', 'Cultivo']],
                            body: tableData,
                            theme: 'striped',
                            headStyles: { fillColor: verdeMedio, textColor: 255 },
                            alternateRowStyles: { fillColor: [216, 243, 220] },
                            margin: { left: 15, right: 15 },
                            styles: { fontSize: 9 }
                        });
                        
                        yPos = doc.lastAutoTable.finalY + 15;
                    }
                    
                    // === MOVIMIENTOS ===
                    if (this.shouldInclude('movimientos')) {
                        this.updateReportProgress('Agregando movimientos...');
                        
                        // Verificar si necesitamos nueva p谩gina
                        if (yPos > 220) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        const movsFiltrados = this.getMovimientosPorPeriodo();
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(` Movimientos del Per铆odo (${movsFiltrados.length})`, 15, yPos);
                        yPos += 8;
                        
                        if (movsFiltrados.length > 0) {
                            const movsData = movsFiltrados.slice(0, 15).map(m => [
                                m.potreroId,
                                m.cultivo,
                                new Date(m.fechaEntrada).toLocaleDateString('es'),
                                m.fechaSalida ? new Date(m.fechaSalida).toLocaleDateString('es') : 'Activo',
                                m.permanencia ? `${m.permanencia}d` : '-',
                                m.estado === 'activo' ? 'Activo' : 'Finalizado'
                            ]);
                            
                            doc.autoTable({
                                startY: yPos,
                                head: [['Potrero', 'Cultivo', 'Entrada', 'Salida', 'D铆as', 'Estado']],
                                body: movsData,
                                theme: 'striped',
                                headStyles: { fillColor: verdeMedio, textColor: 255 },
                                margin: { left: 15, right: 15 },
                                styles: { fontSize: 8 }
                            });
                            
                            yPos = doc.lastAutoTable.finalY + 15;
                        } else {
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'italic');
                            doc.text('No hay movimientos en el per铆odo seleccionado', 15, yPos + 5);
                            yPos += 15;
                        }
                    }
                    
                    // === ANLISIS PRV ===
                    if (this.shouldInclude('prv')) {
                        this.updateReportProgress('Agregando an谩lisis PRV...');
                        
                        if (yPos > 200) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        const prvStats = this.calculatePRVStats();
                        const eficiencia = this.calcularEficienciaPRV();
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(' An谩lisis de Rotaci贸n PRV', 15, yPos);
                        yPos += 10;
                        
                        // Eficiencia
                        const efColor = eficiencia.porcentaje >= 80 ? verdeClaro : eficiencia.porcentaje >= 50 ? [245, 158, 11] : [239, 68, 68];
                        doc.setFillColor(...efColor);
                        doc.roundedRect(15, yPos, 60, 30, 3, 3, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(24);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${eficiencia.porcentaje}%`, 45, yPos + 18, { align: 'center' });
                        doc.setFontSize(8);
                        doc.text('Eficiencia PRV', 45, yPos + 26, { align: 'center' });
                        
                        // Stats PRV
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Configuraci贸n: ${this.prvConfig.diasOcupacion} d铆as ocupaci贸n / ${this.prvConfig.diasDescanso} d铆as descanso`, 85, yPos + 10);
                        doc.text(`Potreros en descanso: ${prvStats.potrerosEnDescanso}`, 85, yPos + 18);
                        doc.text(`Potreros listos: ${prvStats.potrerosListos}`, 85, yPos + 26);
                        
                        yPos += 40;
                        
                        // Recomendaciones
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Recomendaciones:', 15, yPos);
                        yPos += 6;
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        this.generarRecomendacionesPRV().forEach(rec => {
                            doc.text(` ${rec}`, 20, yPos);
                            yPos += 5;
                        });
                    }

                    // === RESUMEN DE INVENTARIO DE GANADO ===
                    this.updateReportProgress('Agregando resumen de inventario...');
                    
                    if (yPos > 200) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const ganado = this.data.ganado || [];
                    if (ganado.length > 0) {
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(' Resumen de Inventario de Ganado', 15, yPos);
                        yPos += 10;

                        // Contar por categor铆a
                        const categorias = {};
                        ganado.forEach(a => {
                            const cat = a.categoria || 'Sin categor铆a';
                            categorias[cat] = (categorias[cat] || 0) + 1;
                        });

                        const totalAnimales = ganado.length;
                        const totalVacas = ganado.filter(a => a.categoria && a.categoria.includes('vaca')).length;
                        const totalToros = ganado.filter(a => a.categoria && a.categoria.includes('toro')).length;

                        // KPIs de inventario
                        const invKpis = [
                            { label: 'Total Animales', value: totalAnimales, color: verdeMedio },
                            { label: 'Vacas', value: totalVacas, color: [212, 163, 115] },
                            { label: 'Toros', value: totalToros, color: [59, 130, 246] }
                        ];

                        let xInv = 15;
                        invKpis.forEach(kpi => {
                            doc.setFillColor(...kpi.color);
                            doc.roundedRect(xInv, yPos, 55, 22, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(14);
                            doc.setFont('helvetica', 'bold');
                            doc.text(String(kpi.value), xInv + 27.5, yPos + 10, { align: 'center' });
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text(kpi.label, xInv + 27.5, yPos + 18, { align: 'center' });
                            xInv += 60;
                        });

                        yPos += 32;
                    }

                    // === RESUMEN FINANCIERO ===
                    this.updateReportProgress('Agregando resumen financiero...');
                    
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const finanzas = this.calcularSaldoFinanzas();
                    if (this.finanzasData.movimientos && this.finanzasData.movimientos.length > 0) {
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(' Resumen Financiero (Caja Menor)', 15, yPos);
                        yPos += 10;

                        // KPIs financieros
                        const finKpis = [
                            { label: 'Ingresos', value: '+' + finanzas.ingresos.toFixed(2), color: [16, 185, 129] },
                            { label: 'Egresos', value: '-' + finanzas.egresos.toFixed(2), color: [239, 68, 68] },
                            { label: 'Saldo', value: (finanzas.saldo >= 0 ? '+' : '') + finanzas.saldo.toFixed(2), color: finanzas.saldo >= 0 ? verdeMedio : [239, 68, 68] }
                        ];

                        let xFin = 15;
                        finKpis.forEach(kpi => {
                            doc.setFillColor(...kpi.color);
                            doc.roundedRect(xFin, yPos, 55, 22, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(11);
                            doc.setFont('helvetica', 'bold');
                            doc.text(kpi.value, xFin + 27.5, yPos + 10, { align: 'center' });
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text(kpi.label, xFin + 27.5, yPos + 18, { align: 'center' });
                            xFin += 60;
                        });

                        yPos += 32;
                    }
                    
                    // === PIE DE PGINA MEJORADO ===
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFillColor(...verdeOscuro);
                        doc.rect(0, 280, 210, 17, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Generado con Nexus Agro - Tecnolog铆a para el Campo', 105, 287, { align: 'center' });
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text('WIN-TEL AgroManager PRO | WindowsTelecom C.A. | WhatsApp: +58 412-406-0610', 105, 292, { align: 'center' });
                        doc.text(`P谩gina ${i} de ${totalPages}`, 195, 292, { align: 'right' });
                    }
                    
                    // Guardar
                    const fileName = `Reporte_${this.selectedReportType}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    // Guardar en historial
                    this.saveReportHistory(fileName, this.selectedReportType);
                    
                    this.hideReportProgress();
                    this.notify('success', 'Reporte Generado', `El archivo ${fileName} se ha descargado`);
                    
                } catch (error) {
                    console.error('Error generando PDF:', error);
                    this.hideReportProgress();
                    this.notify('error', 'Error', 'No se pudo generar el reporte PDF');
                }
            },
            
            shouldInclude: function(section) {
                if (this.selectedReportType === 'personalizado') {
                    return this.reportConfig[`incluir${section.charAt(0).toUpperCase() + section.slice(1)}`];
                }
                
                const includes = {
                    'mensual': ['resumen', 'potreros', 'movimientos', 'prv'],
                    'potreros': ['resumen', 'potreros'],
                    'movimientos': ['resumen', 'movimientos'],
                    'prv': ['resumen', 'prv'],
                    'ejecutivo': ['resumen', 'graficos'],
                    'personalizado': []
                };
                
                return includes[this.selectedReportType]?.includes(section) ?? false;
            },
            
            getPeriodoTexto: function() {
                const periodo = document.getElementById('reportPeriodo')?.value || 'mensual';
                const textos = {
                    'semanal': 'ltima Semana',
                    'mensual': 'ltimo Mes',
                    'trimestral': 'ltimo Trimestre',
                    'anual': 'ltimo A帽o',
                    'personalizado': 'Per铆odo Personalizado'
                };
                return textos[periodo] || periodo;
            },
            
            getMovimientosPorPeriodo: function() {
                const periodo = document.getElementById('reportPeriodo')?.value || 'mensual';
                const hoy = new Date();
                let fechaInicio = new Date();
                
                switch (periodo) {
                    case 'semanal':
                        fechaInicio.setDate(hoy.getDate() - 7);
                        break;
                    case 'mensual':
                        fechaInicio.setMonth(hoy.getMonth() - 1);
                        break;
                    case 'trimestral':
                        fechaInicio.setMonth(hoy.getMonth() - 3);
                        break;
                    case 'anual':
                        fechaInicio.setFullYear(hoy.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        fechaInicio = new Date(document.getElementById('reportFechaInicio')?.value || hoy);
                        break;
                }
                
                return this.data.movimientos.filter(m => {
                    const fechaMov = new Date(m.fechaEntrada);
                    return fechaMov >= fechaInicio;
                }).sort((a, b) => new Date(b.fechaEntrada) - new Date(a.fechaEntrada));
            },
            
            // Progreso
            showReportProgress: function(status) {
                const modal = document.createElement('div');
                modal.id = 'reportProgressModal';
                modal.className = 'report-progress-modal';
                modal.innerHTML = `
                    <div class="report-progress-content">
                        <div class="report-progress-spinner"></div>
                        <div class="report-progress-title">Generando Reporte</div>
                        <div class="report-progress-status" id="reportProgressStatus">${status}</div>
                    </div>
                `;
                document.body.appendChild(modal);
            },
            
            updateReportProgress: function(status) {
                const el = document.getElementById('reportProgressStatus');
                if (el) el.textContent = status;
            },
            
            hideReportProgress: function() {
                const modal = document.getElementById('reportProgressModal');
                if (modal) modal.remove();
            },
            
            // Vista previa
            previewReport: function() {
                const stats = this.calculateStats();
                const nombreFinca = document.getElementById('reportNombreFinca')?.value || 'Mi Finca';
                
                const previewHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: white;">
                        <div style="background: linear-gradient(135deg, #0f3629, #2d6a4f); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h2 style="margin: 0;">WIN-TEL AgroManager PRO</h2>
                            <p style="margin: 5px 0 0; opacity: 0.9;">${nombreFinca} - ${this.getPeriodoTexto()}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #2d6a4f; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${stats.totalPotreros}</div>
                                <div style="font-size: 12px;">Total Potreros</div>
                            </div>
                            <div style="background: #ef4444; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${stats.ocupados}</div>
                                <div style="font-size: 12px;">Ocupados</div>
                            </div>
                            <div style="background: #10b981; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${stats.libres}</div>
                                <div style="font-size: 12px;">Disponibles</div>
                            </div>
                            <div style="background: #d4a373; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold;">${stats.superficieTotal.toFixed(1)}</div>
                                <div style="font-size: 12px;">Hect谩reas</div>
                            </div>
                        </div>
                        
                        <p style="color: #666; font-size: 12px; text-align: center;">
                            Esta es una vista previa. El PDF final incluir谩 tablas detalladas y an谩lisis completo.
                        </p>
                    </div>
                `;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'reportPreviewModal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="modal" style="max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span>锔</span> Vista Previa del Reporte</h3>
                            <button class="modal-close" onclick="document.getElementById('reportPreviewModal').remove()"></button>
                        </div>
                        <div class="modal-body" style="padding: 0; background: #f5f5f5;">
                            ${previewHtml}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('reportPreviewModal').remove()">Cerrar</button>
                            <button class="btn btn-primary" onclick="document.getElementById('reportPreviewModal').remove(); app.generatePDF();">
                                 Generar PDF
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },
            
            // Compartir
            shareReportWhatsApp: async function() {
                this.showReportProgress('Preparando para WhatsApp...');
                
                try {
                    // Generar resumen de texto para WhatsApp
                    const stats = this.calculateStats();
                    const nombreFinca = document.getElementById('reportNombreFinca')?.value || 'Mi Finca';
                    const fecha = new Date().toLocaleDateString('es');
                    
                    let mensaje = ` *REPORTE WIN-TEL AgroManager PRO*\n`;
                    mensaje += ` ${nombreFinca}\n`;
                    mensaje += ` ${fecha}\n\n`;
                    mensaje += `*RESUMEN:*\n`;
                    mensaje += `猴 Total Potreros: ${stats.totalPotreros}\n`;
                    mensaje += ` Ocupados: ${stats.ocupados}\n`;
                    mensaje += ` Disponibles: ${stats.libres}\n`;
                    mensaje += ` Superficie: ${stats.superficieTotal.toFixed(1)} Ha\n\n`;
                    
                    if (this.shouldInclude('prv')) {
                        const eficiencia = this.calcularEficienciaPRV();
                        mensaje += `*ROTACIN PRV:*\n`;
                        mensaje += ` Eficiencia: ${eficiencia.porcentaje}%\n`;
                        mensaje += ` ${eficiencia.mensaje}\n\n`;
                    }
                    
                    mensaje += `_Generado con WIN-TEL AgroManager PRO_\n`;
                    mensaje += ` +58 412-406-0610`;
                    
                    const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, '_blank');
                    
                    this.hideReportProgress();
                    this.notify('success', 'WhatsApp', 'Se abri贸 WhatsApp para compartir');
                    
                } catch (error) {
                    this.hideReportProgress();
                    this.notify('error', 'Error', 'No se pudo abrir WhatsApp');
                }
            },
            
            shareReportEmail: function() {
                const stats = this.calculateStats();
                const nombreFinca = document.getElementById('reportNombreFinca')?.value || 'Mi Finca';
                const fecha = new Date().toLocaleDateString('es');
                
                const subject = encodeURIComponent(`Reporte ${nombreFinca} - ${fecha}`);
                let body = `REPORTE WIN-TEL AgroManager PRO\n\n`;
                body += `Finca: ${nombreFinca}\n`;
                body += `Fecha: ${fecha}\n\n`;
                body += `RESUMEN:\n`;
                body += `- Total Potreros: ${stats.totalPotreros}\n`;
                body += `- Ocupados: ${stats.ocupados}\n`;
                body += `- Disponibles: ${stats.libres}\n`;
                body += `- Superficie Total: ${stats.superficieTotal.toFixed(1)} Ha\n\n`;
                body += `---\nGenerado con WIN-TEL AgroManager PRO\n`;
                body += `WhatsApp: +58 412-406-0610`;
                
                const url = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
                window.location.href = url;
                
                this.notify('info', 'Email', 'Se abri贸 tu cliente de correo');
            },
            
            // Historial
            loadReportHistory: function() {
                const saved = localStorage.getItem('nexusAgroReportHistory');
                this.reportHistory = saved ? JSON.parse(saved) : [];
            },
            
            saveReportHistory: function(nombre, tipo) {
                this.reportHistory.unshift({
                    nombre,
                    tipo,
                    fecha: new Date().toISOString(),
                    config: { ...this.reportConfig }
                });
                
                // Mantener solo 煤ltimos 10
                this.reportHistory = this.reportHistory.slice(0, 10);
                localStorage.setItem('nexusAgroReportHistory', JSON.stringify(this.reportHistory));
            },
            
            regenerateReport: function(index) {
                const report = this.reportHistory[index];
                if (report) {
                    this.selectedReportType = report.tipo;
                    this.reportConfig = { ...report.config };
                    this.generatePDF();
                }
            },

            renderPRV: function() {
                // Cargar configuraci贸n guardada
                this.loadPRVConfig();
                
                // Calcular estad铆sticas PRV
                const stats = this.calculatePRVStats();
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Sistema de Rotaci贸n Inteligente PRV
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="app.openPlanificarRotacion()">
                                    <span></span> Planificar Rotaci贸n
                                </button>
                                <button class="btn btn-secondary" onclick="app.generarSecuenciaOptima()">
                                    <span></span> Sugerir Secuencia
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Estad铆sticas PRV -->
                            <div class="prv-stats-grid">
                                <div class="prv-stat-card">
                                    <div class="prv-stat-value">${this.data.potreros.length}</div>
                                    <div class="prv-stat-label">Potreros en Sistema</div>
                                </div>
                                <div class="prv-stat-card ${stats.potrerosEnDescanso < stats.potrerosNecesarios ? 'warning' : ''}">
                                    <div class="prv-stat-value">${stats.potrerosEnDescanso}</div>
                                    <div class="prv-stat-label">En Descanso</div>
                                </div>
                                <div class="prv-stat-card ${stats.potrerosListos > 0 ? '' : 'danger'}">
                                    <div class="prv-stat-value">${stats.potrerosListos}</div>
                                    <div class="prv-stat-label">Listos para Pastoreo</div>
                                </div>
                                <div class="prv-stat-card ${stats.alertasDescanso > 0 ? 'warning' : ''}">
                                    <div class="prv-stat-value">${stats.alertasDescanso}</div>
                                    <div class="prv-stat-label">Alertas de Descanso</div>
                                </div>
                            </div>
                            
                            <!-- Configuraci贸n PRV -->
                            <div class="prv-config-grid">
                                <div class="prv-config-card">
                                    <h4>憋 D铆as de Ocupaci贸n</h4>
                                    <input type="number" class="prv-config-input" id="prvDiasOcupacion" 
                                           value="${this.prvConfig.diasOcupacion}" min="1" max="30"
                                           onchange="app.updatePRVConfig()">
                                    <div style="font-size: 11px; color: var(--gris-500); margin-top: 8px;">
                                        Tiempo que el ganado permanece en cada potrero
                                    </div>
                                </div>
                                <div class="prv-config-card">
                                    <h4> D铆as de Descanso</h4>
                                    <input type="number" class="prv-config-input" id="prvDiasDescanso" 
                                           value="${this.prvConfig.diasDescanso}" min="7" max="90"
                                           onchange="app.updatePRVConfig()">
                                    <div style="font-size: 11px; color: var(--gris-500); margin-top: 8px;">
                                        Tiempo de recuperaci贸n de la pastura
                                    </div>
                                </div>
                                <div class="prv-config-card">
                                    <h4> Potreros Necesarios</h4>
                                    <div class="prv-config-value">
                                        ${Math.ceil(this.prvConfig.diasDescanso / this.prvConfig.diasOcupacion) + 1}
                                        <span class="prv-config-unit">m铆nimo</span>
                                    </div>
                                    <div style="font-size: 11px; color: var(--gris-500); margin-top: 8px;">
                                        Para mantener rotaci贸n continua
                                    </div>
                                </div>
                                <div class="prv-config-card">
                                    <h4> Ciclo Completo</h4>
                                    <div class="prv-config-value">
                                        ${this.prvConfig.diasDescanso + this.prvConfig.diasOcupacion}
                                        <span class="prv-config-unit">d铆as</span>
                                    </div>
                                    <div style="font-size: 11px; color: var(--gris-500); margin-top: 8px;">
                                        Tiempo hasta volver al mismo potrero
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabs -->
                            <div class="prv-tabs">
                                <button class="prv-tab ${this.prvCurrentTab === 'gantt' ? 'active' : ''}" onclick="app.switchPRVTab('gantt')">
                                     Vista Gantt
                                </button>
                                <button class="prv-tab ${this.prvCurrentTab === 'calendario' ? 'active' : ''}" onclick="app.switchPRVTab('calendario')">
                                     Calendario
                                </button>
                                <button class="prv-tab ${this.prvCurrentTab === 'secuencia' ? 'active' : ''}" onclick="app.switchPRVTab('secuencia')">
                                     Secuencia
                                </button>
                                <button class="prv-tab ${this.prvCurrentTab === 'analisis' ? 'active' : ''}" onclick="app.switchPRVTab('analisis')">
                                     An谩lisis
                                </button>
                            </div>
                            
                            <!-- Contenido de tabs -->
                            <div id="prvTabContent">
                                ${this.renderPRVTabContent()}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            switchPRVTab: function(tab) {
                this.prvCurrentTab = tab;
                document.querySelectorAll('.prv-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.prv-tab:nth-child(${['gantt', 'calendario', 'secuencia', 'analisis'].indexOf(tab) + 1})`).classList.add('active');
                document.getElementById('prvTabContent').innerHTML = this.renderPRVTabContent();
            },
            
            renderPRVTabContent: function() {
                switch (this.prvCurrentTab) {
                    case 'gantt': return this.renderGanttView();
                    case 'calendario': return this.renderCalendarView();
                    case 'secuencia': return this.renderSecuenciaView();
                    case 'analisis': return this.renderAnalisisPRV();
                    default: return this.renderGanttView();
                }
            },
            
            // Vista Gantt
            renderGanttView: function() {
                const dias = 45; // Mostrar 45 d铆as
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                // Generar headers de d铆as
                let diasHeaders = '';
                for (let i = 0; i < dias; i++) {
                    const fecha = new Date(hoy);
                    fecha.setDate(fecha.getDate() + i);
                    const esHoy = i === 0;
                    const esFinDeSemana = fecha.getDay() === 0 || fecha.getDay() === 6;
                    const nombreDia = fecha.toLocaleDateString('es', { weekday: 'short' }).substring(0, 2);
                    
                    diasHeaders += `
                        <div class="gantt-day-header ${esFinDeSemana ? 'weekend' : ''} ${esHoy ? 'today' : ''}">
                            <div class="day-number">${fecha.getDate()}</div>
                            <div class="day-name">${nombreDia}</div>
                        </div>
                    `;
                }
                
                // Generar filas de potreros
                let filas = '';
                this.data.potreros.forEach(potrero => {
                    const movActivo = this.data.movimientos.find(m => m.potreroId === potrero.id && m.estado === 'activo');
                    const ultimoMov = this.data.movimientos
                        .filter(m => m.potreroId === potrero.id && m.estado === 'finalizado')
                        .sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida))[0];
                    
                    let celdas = '';
                    let barraHtml = '';
                    
                    for (let i = 0; i < dias; i++) {
                        const fecha = new Date(hoy);
                        fecha.setDate(fecha.getDate() + i);
                        const esHoy = i === 0;
                        const esFinDeSemana = fecha.getDay() === 0 || fecha.getDay() === 6;
                        
                        celdas += `<div class="gantt-cell ${esFinDeSemana ? 'weekend' : ''} ${esHoy ? 'today' : ''}"></div>`;
                    }
                    
                    // Calcular barra de ocupaci贸n actual
                    if (movActivo) {
                        const fechaEntrada = new Date(movActivo.fechaEntrada);
                        const diasTranscurridos = Math.floor((hoy - fechaEntrada) / (1000 * 60 * 60 * 24));
                        const inicio = Math.max(0, -diasTranscurridos);
                        const duracion = diasTranscurridos + this.prvConfig.diasOcupacion;
                        const ancho = Math.min(duracion, dias - inicio);
                        
                        if (inicio < dias) {
                            const esAlerta = diasTranscurridos >= this.prvConfig.diasOcupacion;
                            barraHtml += `
                                <div class="gantt-bar ${esAlerta ? 'alerta' : 'ocupado'}" 
                                     style="left: ${inicio * 40}px; width: ${ancho * 40 - 4}px;"
                                     onmouseover="app.showGanttTooltip(event, '${potrero.id}', 'Ocupado', '${movActivo.cultivo}', ${diasTranscurridos})"
                                     onmouseout="app.hideGanttTooltip()">
                                     ${movActivo.cultivo} (${diasTranscurridos}d)
                                </div>
                            `;
                        }
                    }
                    
                    // Calcular per铆odo de descanso
                    if (ultimoMov && !movActivo) {
                        const fechaSalida = new Date(ultimoMov.fechaSalida);
                        const diasDesdeS = Math.floor((hoy - fechaSalida) / (1000 * 60 * 60 * 24));
                        const diasRestantes = this.prvConfig.diasDescanso - diasDesdeS;
                        
                        if (diasRestantes > 0) {
                            const inicio = 0;
                            const duracion = Math.min(diasRestantes, dias);
                            const progreso = Math.round((diasDesdeS / this.prvConfig.diasDescanso) * 100);
                            
                            barraHtml += `
                                <div class="gantt-bar descanso" 
                                     style="left: ${inicio * 40}px; width: ${duracion * 40 - 4}px; opacity: 0.7;"
                                     onmouseover="app.showGanttTooltip(event, '${potrero.id}', 'Descanso', '${progreso}% recuperado', ${diasDesdeS})"
                                     onmouseout="app.hideGanttTooltip()">
                                     Descanso (${diasRestantes}d restantes)
                                </div>
                            `;
                        }
                    }
                    
                    // Mostrar planificaciones
                    const planificaciones = (this.prvPlanificaciones || []).filter(p => p.potreroId === potrero.id);
                    planificaciones.forEach(plan => {
                        const fechaPlan = new Date(plan.fechaInicio);
                        const diasHastaPlan = Math.floor((fechaPlan - hoy) / (1000 * 60 * 60 * 24));
                        
                        if (diasHastaPlan >= 0 && diasHastaPlan < dias) {
                            const duracion = Math.min(plan.diasOcupacion || this.prvConfig.diasOcupacion, dias - diasHastaPlan);
                            barraHtml += `
                                <div class="gantt-bar planificado" 
                                     style="left: ${diasHastaPlan * 40}px; width: ${duracion * 40 - 4}px;"
                                     onmouseover="app.showGanttTooltip(event, '${potrero.id}', 'Planificado', '${plan.cultivo || 'Sin definir'}', ${plan.diasOcupacion || this.prvConfig.diasOcupacion})"
                                     onmouseout="app.hideGanttTooltip()">
                                     Planificado
                                </div>
                            `;
                        }
                    });
                    
                    filas += `
                        <div class="gantt-row">
                            <div class="gantt-row-potrero">
                                <div class="potrero-id">${potrero.id}</div>
                                <div class="potrero-info">${potrero.superficie} Ha</div>
                            </div>
                            <div class="gantt-row-days">
                                ${celdas}
                                ${barraHtml}
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div class="gantt-container">
                        <div class="gantt-header">
                            <div class="gantt-header-potrero">Potrero</div>
                            <div class="gantt-header-days">${diasHeaders}</div>
                        </div>
                        <div class="gantt-body">
                            ${filas || '<div style="padding: 40px; text-align: center; color: var(--gris-500);">No hay potreros registrados</div>'}
                        </div>
                        <div class="gantt-legend">
                            <div class="gantt-legend-item">
                                <div class="gantt-legend-color ocupado"></div>
                                <span>Ocupado</span>
                            </div>
                            <div class="gantt-legend-item">
                                <div class="gantt-legend-color descanso"></div>
                                <span>En Descanso</span>
                            </div>
                            <div class="gantt-legend-item">
                                <div class="gantt-legend-color planificado"></div>
                                <span>Planificado</span>
                            </div>
                            <div class="gantt-legend-item">
                                <div class="gantt-legend-color alerta"></div>
                                <span>Alerta (excede ocupaci贸n)</span>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            showGanttTooltip: function(event, potrero, estado, detalle, dias) {
                let tooltip = document.getElementById('ganttTooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'ganttTooltip';
                    tooltip.className = 'gantt-tooltip';
                    document.body.appendChild(tooltip);
                }
                
                tooltip.innerHTML = `
                    <div class="gantt-tooltip-title">${potrero} - ${estado}</div>
                    <div class="gantt-tooltip-info">${detalle}</div>
                    <div class="gantt-tooltip-info">${dias} d铆as</div>
                `;
                
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY + 10) + 'px';
                tooltip.style.display = 'block';
            },
            
            hideGanttTooltip: function() {
                const tooltip = document.getElementById('ganttTooltip');
                if (tooltip) tooltip.style.display = 'none';
            },
            
            // Vista Calendario
            renderCalendarView: function() {
                const mes = this.prvCalendarMonth;
                const primerDia = new Date(mes.getFullYear(), mes.getMonth(), 1);
                const ultimoDia = new Date(mes.getFullYear(), mes.getMonth() + 1, 0);
                const diasEnMes = ultimoDia.getDate();
                const primerDiaSemana = primerDia.getDay();
                
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                // Obtener eventos del mes
                const eventos = this.getPRVEventosDelMes(mes);
                
                let celdas = '';
                
                // D铆as del mes anterior
                const mesAnterior = new Date(mes.getFullYear(), mes.getMonth(), 0);
                for (let i = primerDiaSemana - 1; i >= 0; i--) {
                    const dia = mesAnterior.getDate() - i;
                    celdas += `<div class="calendar-cell other-month"><div class="calendar-day-number">${dia}</div></div>`;
                }
                
                // D铆as del mes actual
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const fecha = new Date(mes.getFullYear(), mes.getMonth(), dia);
                    const esHoy = fecha.getTime() === hoy.getTime();
                    const eventosDelDia = eventos.filter(e => {
                        const fechaEvento = new Date(e.fecha);
                        return fechaEvento.getDate() === dia;
                    });
                    
                    celdas += `
                        <div class="calendar-cell ${esHoy ? 'today' : ''}" onclick="app.showDayDetail('${fecha.toISOString()}')">
                            <div class="calendar-day-number">${dia}</div>
                            <div class="calendar-events">
                                ${eventosDelDia.slice(0, 3).map(e => `
                                    <div class="calendar-event ${e.tipo}">${e.icono} ${e.potrero}</div>
                                `).join('')}
                                ${eventosDelDia.length > 3 ? `<div style="font-size: 10px; color: var(--gris-500);">+${eventosDelDia.length - 3} m谩s</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // D铆as del mes siguiente
                const celdasRestantes = 42 - (primerDiaSemana + diasEnMes);
                for (let dia = 1; dia <= celdasRestantes; dia++) {
                    celdas += `<div class="calendar-cell other-month"><div class="calendar-day-number">${dia}</div></div>`;
                }
                
                const nombreMes = mes.toLocaleDateString('es', { month: 'long', year: 'numeric' });
                
                return `
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="app.changePRVMonth(-1)"></button>
                        <div class="calendar-month-title">${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}</div>
                        <button class="calendar-nav-btn" onclick="app.changePRVMonth(1)"></button>
                    </div>
                    
                    <div class="rotation-calendar">
                        <div class="calendar-header-cell">Dom</div>
                        <div class="calendar-header-cell">Lun</div>
                        <div class="calendar-header-cell">Mar</div>
                        <div class="calendar-header-cell">Mi茅</div>
                        <div class="calendar-header-cell">Jue</div>
                        <div class="calendar-header-cell">Vie</div>
                        <div class="calendar-header-cell">S谩b</div>
                        ${celdas}
                    </div>
                    
                    <div style="margin-top: 16px; display: flex; gap: 16px; justify-content: center;">
                        <div class="gantt-legend-item">
                            <div class="calendar-event entrada" style="width: 60px;">Entrada</div>
                        </div>
                        <div class="gantt-legend-item">
                            <div class="calendar-event salida" style="width: 60px;">Salida</div>
                        </div>
                        <div class="gantt-legend-item">
                            <div class="calendar-event planificado" style="width: 80px;">Planificado</div>
                        </div>
                    </div>
                `;
            },
            
            getPRVEventosDelMes: function(mes) {
                const eventos = [];
                const primerDia = new Date(mes.getFullYear(), mes.getMonth(), 1);
                const ultimoDia = new Date(mes.getFullYear(), mes.getMonth() + 1, 0);
                
                // Eventos de movimientos
                this.data.movimientos.forEach(mov => {
                    const fechaEntrada = new Date(mov.fechaEntrada);
                    if (fechaEntrada >= primerDia && fechaEntrada <= ultimoDia) {
                        eventos.push({
                            fecha: mov.fechaEntrada,
                            tipo: 'entrada',
                            potrero: mov.potreroId,
                            icono: '',
                            detalle: mov.cultivo
                        });
                    }
                    
                    if (mov.fechaSalida) {
                        const fechaSalida = new Date(mov.fechaSalida);
                        if (fechaSalida >= primerDia && fechaSalida <= ultimoDia) {
                            eventos.push({
                                fecha: mov.fechaSalida,
                                tipo: 'salida',
                                potrero: mov.potreroId,
                                icono: '',
                                detalle: `${mov.permanencia || 0} d铆as`
                            });
                        }
                    }
                });
                
                // Eventos planificados
                (this.prvPlanificaciones || []).forEach(plan => {
                    const fechaPlan = new Date(plan.fechaInicio);
                    if (fechaPlan >= primerDia && fechaPlan <= ultimoDia) {
                        eventos.push({
                            fecha: plan.fechaInicio,
                            tipo: 'planificado',
                            potrero: plan.potreroId,
                            icono: '',
                            detalle: plan.cultivo || 'Rotaci贸n'
                        });
                    }
                });
                
                return eventos;
            },
            
            changePRVMonth: function(delta) {
                this.prvCalendarMonth = new Date(
                    this.prvCalendarMonth.getFullYear(),
                    this.prvCalendarMonth.getMonth() + delta,
                    1
                );
                document.getElementById('prvTabContent').innerHTML = this.renderCalendarView();
            },
            
            showDayDetail: function(fechaISO) {
                const fecha = new Date(fechaISO);
                const eventos = this.getPRVEventosDelMes(fecha).filter(e => {
                    const fechaEvento = new Date(e.fecha);
                    return fechaEvento.toDateString() === fecha.toDateString();
                });
                
                if (eventos.length === 0) {
                    this.notify('info', fecha.toLocaleDateString('es'), 'No hay eventos para este d铆a');
                    return;
                }
                
                const mensaje = eventos.map(e => `${e.icono} ${e.potrero}: ${e.detalle}`).join('\n');
                this.notify('info', fecha.toLocaleDateString('es', { weekday: 'long', day: 'numeric', month: 'long' }), mensaje);
            },
            
            // Vista Secuencia
            renderSecuenciaView: function() {
                const secuencia = this.calcularSecuenciaRotacion();
                
                return `
                    <div class="planning-panel">
                        <h4 style="margin-bottom: 16px; color: var(--verde-oscuro);"> Secuencia de Rotaci贸n Recomendada</h4>
                        <p style="color: var(--gris-600); margin-bottom: 20px; font-size: 13px;">
                            Basado en ${this.prvConfig.diasOcupacion} d铆as de ocupaci贸n y ${this.prvConfig.diasDescanso} d铆as de descanso
                        </p>
                        
                        <div class="rotation-sequence">
                            ${secuencia.map((item, index) => `
                                <div class="rotation-step ${item.estado}">
                                    <div class="rotation-step-number">${index + 1}</div>
                                    <div class="rotation-step-potrero">${item.potreroId}</div>
                                    <div class="rotation-step-days">
                                        ${item.estado === 'active' ? ' Ocupado' : 
                                          item.estado === 'completed' ? ' Pastoreado' : 
                                          ` En ${item.diasParaEntrar}d`}
                                    </div>
                                    ${index < secuencia.length - 1 ? '<div class="rotation-step-arrow"></div>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 24px; padding: 16px; background: var(--verde-muy-claro); border-radius: 10px;">
                            <h5 style="margin-bottom: 12px;"> Pr贸ximas Acciones Recomendadas</h5>
                            ${this.renderProximasAcciones()}
                        </div>
                    </div>
                `;
            },
            
            calcularSecuenciaRotacion: function() {
                const secuencia = [];
                const hoy = new Date();
                
                this.data.potreros.forEach(potrero => {
                    const movActivo = this.data.movimientos.find(m => m.potreroId === potrero.id && m.estado === 'activo');
                    const ultimoMov = this.data.movimientos
                        .filter(m => m.potreroId === potrero.id && m.estado === 'finalizado')
                        .sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida))[0];
                    
                    let estado = '';
                    let diasParaEntrar = 0;
                    let prioridad = 0;
                    
                    if (movActivo) {
                        estado = 'active';
                        prioridad = 0;
                    } else if (ultimoMov) {
                        const fechaSalida = new Date(ultimoMov.fechaSalida);
                        const diasDescanso = Math.floor((hoy - fechaSalida) / (1000 * 60 * 60 * 24));
                        diasParaEntrar = Math.max(0, this.prvConfig.diasDescanso - diasDescanso);
                        
                        if (diasParaEntrar === 0) {
                            estado = 'completed';
                            prioridad = 1;
                        } else {
                            estado = 'pending';
                            prioridad = 2 + diasParaEntrar;
                        }
                    } else {
                        estado = 'completed';
                        prioridad = 1;
                    }
                    
                    secuencia.push({
                        potreroId: potrero.id,
                        estado,
                        diasParaEntrar,
                        prioridad
                    });
                });
                
                return secuencia.sort((a, b) => a.prioridad - b.prioridad);
            },
            
            renderProximasAcciones: function() {
                const acciones = [];
                const hoy = new Date();
                
                // Verificar potreros que necesitan salida
                this.data.movimientos.filter(m => m.estado === 'activo').forEach(mov => {
                    const diasOcupado = Math.floor((hoy - new Date(mov.fechaEntrada)) / (1000 * 60 * 60 * 24));
                    if (diasOcupado >= this.prvConfig.diasOcupacion) {
                        acciones.push({
                            tipo: 'urgente',
                            icono: '锔',
                            mensaje: `Registrar SALIDA de ${mov.potreroId} (${diasOcupado} d铆as ocupado)`,
                            accion: `app.openSalidaModal(${mov.id})`
                        });
                    } else if (diasOcupado >= this.prvConfig.diasOcupacion - 1) {
                        acciones.push({
                            tipo: 'pronto',
                            icono: '',
                            mensaje: `Preparar salida de ${mov.potreroId} ma帽ana`,
                            accion: null
                        });
                    }
                });
                
                // Verificar potreros listos para entrada
                const potrerosListos = this.calcularSecuenciaRotacion().filter(p => p.estado === 'completed' && p.prioridad === 1);
                if (potrerosListos.length > 0 && this.data.movimientos.filter(m => m.estado === 'activo').length === 0) {
                    acciones.push({
                        tipo: 'sugerencia',
                        icono: '',
                        mensaje: `Iniciar pastoreo en ${potrerosListos[0].potreroId} (listo para ocupar)`,
                        accion: `app.openModal('modalEntrada')`
                    });
                }
                
                if (acciones.length === 0) {
                    return '<div style="color: var(--gris-500);"> Todo en orden. No hay acciones pendientes.</div>';
                }
                
                return acciones.map(a => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--gris-200);">
                        <span style="font-size: 20px;">${a.icono}</span>
                        <span style="flex: 1;">${a.mensaje}</span>
                        ${a.accion ? `<button class="btn btn-primary btn-small" onclick="${a.accion}">Acci贸n</button>` : ''}
                    </div>
                `).join('');
            },
            
            // An谩lisis PRV
            renderAnalisisPRV: function() {
                const stats = this.calculatePRVStats();
                const eficiencia = this.calcularEficienciaPRV();
                
                return `
                    <div class="planning-panel">
                        <h4 style="margin-bottom: 20px; color: var(--verde-oscuro);"> An谩lisis de Rotaci贸n PRV</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            <div style="background: var(--gris-100); padding: 20px; border-radius: 12px;">
                                <h5 style="margin-bottom: 12px;"> Eficiencia del Sistema</h5>
                                <div style="font-size: 48px; font-weight: 700; color: ${eficiencia.porcentaje >= 80 ? 'var(--verde)' : eficiencia.porcentaje >= 50 ? 'var(--acento-dorado)' : 'var(--rojo)'};">
                                    ${eficiencia.porcentaje}%
                                </div>
                                <div style="font-size: 12px; color: var(--gris-600);">${eficiencia.mensaje}</div>
                            </div>
                            
                            <div style="background: var(--gris-100); padding: 20px; border-radius: 12px;">
                                <h5 style="margin-bottom: 12px;"> Estad铆sticas del Per铆odo</h5>
                                <div style="display: grid; gap: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Rotaciones completadas:</span>
                                        <strong>${stats.rotacionesCompletadas}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Promedio d铆as ocupaci贸n:</span>
                                        <strong>${stats.promedioOcupacion.toFixed(1)} d铆as</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Promedio d铆as descanso:</span>
                                        <strong>${stats.promedioDescanso.toFixed(1)} d铆as</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: ${eficiencia.porcentaje < 80 ? 'rgba(239, 68, 68, 0.1)' : 'var(--verde-muy-claro)'}; padding: 16px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="margin-bottom: 8px;">${eficiencia.porcentaje >= 80 ? '' : ''} Recomendaciones</h5>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--gris-700);">
                                ${this.generarRecomendacionesPRV().map(r => `<li style="margin-bottom: 4px;">${r}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="btn btn-primary" onclick="app.generarReportePRV()">
                                 Generar Reporte PRV
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // Funciones de c谩lculo PRV
            calculatePRVStats: function() {
                const hoy = new Date();
                let potrerosEnDescanso = 0;
                let potrerosListos = 0;
                let alertasDescanso = 0;
                let rotacionesCompletadas = 0;
                let totalOcupacion = 0;
                let totalDescanso = 0;
                let conteoOcupacion = 0;
                let conteoDescanso = 0;
                
                this.data.potreros.forEach(potrero => {
                    const movActivo = this.data.movimientos.find(m => m.potreroId === potrero.id && m.estado === 'activo');
                    const ultimoMov = this.data.movimientos
                        .filter(m => m.potreroId === potrero.id && m.estado === 'finalizado')
                        .sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida))[0];
                    
                    if (!movActivo && ultimoMov) {
                        const diasDescanso = Math.floor((hoy - new Date(ultimoMov.fechaSalida)) / (1000 * 60 * 60 * 24));
                        if (diasDescanso < this.prvConfig.diasDescanso) {
                            potrerosEnDescanso++;
                            if (diasDescanso >= this.prvConfig.diasDescanso - this.prvConfig.diasAlerta) {
                                alertasDescanso++;
                            }
                        } else {
                            potrerosListos++;
                        }
                    } else if (!movActivo) {
                        potrerosListos++;
                    }
                });
                
                // Estad铆sticas de movimientos finalizados
                this.data.movimientos.filter(m => m.estado === 'finalizado').forEach(mov => {
                    rotacionesCompletadas++;
                    if (mov.permanencia) {
                        totalOcupacion += mov.permanencia;
                        conteoOcupacion++;
                    }
                });
                
                // Calcular descansos entre movimientos del mismo potrero
                this.data.potreros.forEach(potrero => {
                    const movs = this.data.movimientos
                        .filter(m => m.potreroId === potrero.id && m.estado === 'finalizado')
                        .sort((a, b) => new Date(a.fechaEntrada) - new Date(b.fechaEntrada));
                    
                    for (let i = 1; i < movs.length; i++) {
                        const descanso = Math.floor((new Date(movs[i].fechaEntrada) - new Date(movs[i-1].fechaSalida)) / (1000 * 60 * 60 * 24));
                        if (descanso > 0 && descanso < 365) {
                            totalDescanso += descanso;
                            conteoDescanso++;
                        }
                    }
                });
                
                return {
                    potrerosEnDescanso,
                    potrerosListos,
                    alertasDescanso,
                    rotacionesCompletadas,
                    promedioOcupacion: conteoOcupacion > 0 ? totalOcupacion / conteoOcupacion : 0,
                    promedioDescanso: conteoDescanso > 0 ? totalDescanso / conteoDescanso : 0,
                    potrerosNecesarios: Math.ceil(this.prvConfig.diasDescanso / this.prvConfig.diasOcupacion) + 1
                };
            },
            
            calcularEficienciaPRV: function() {
                const stats = this.calculatePRVStats();
                const totalPotreros = this.data.potreros.length;
                
                if (totalPotreros === 0) {
                    return { porcentaje: 0, mensaje: 'Sin potreros registrados' };
                }
                
                let puntos = 0;
                let maxPuntos = 100;
                
                // Puntos por cantidad de potreros
                if (totalPotreros >= stats.potrerosNecesarios) {
                    puntos += 30;
                } else {
                    puntos += (totalPotreros / stats.potrerosNecesarios) * 30;
                }
                
                // Puntos por cumplimiento de d铆as de ocupaci贸n
                if (stats.promedioOcupacion > 0) {
                    const desviacion = Math.abs(stats.promedioOcupacion - this.prvConfig.diasOcupacion);
                    puntos += Math.max(0, 35 - (desviacion * 5));
                }
                
                // Puntos por cumplimiento de d铆as de descanso
                if (stats.promedioDescanso > 0) {
                    const cumplimiento = Math.min(stats.promedioDescanso / this.prvConfig.diasDescanso, 1);
                    puntos += cumplimiento * 35;
                }
                
                const porcentaje = Math.round(puntos);
                let mensaje = '';
                
                if (porcentaje >= 80) mensaje = 'Excelente manejo de rotaci贸n';
                else if (porcentaje >= 60) mensaje = 'Buen manejo, puede mejorar';
                else if (porcentaje >= 40) mensaje = 'Necesita ajustes en la rotaci贸n';
                else mensaje = 'Rotaci贸n deficiente, revisar par谩metros';
                
                return { porcentaje, mensaje };
            },
            
            generarRecomendacionesPRV: function() {
                const recomendaciones = [];
                const stats = this.calculatePRVStats();
                const totalPotreros = this.data.potreros.length;
                
                if (totalPotreros < stats.potrerosNecesarios) {
                    recomendaciones.push(`Necesitas al menos ${stats.potrerosNecesarios} potreros para una rotaci贸n 贸ptima. Actualmente tienes ${totalPotreros}.`);
                }
                
                if (stats.promedioOcupacion > this.prvConfig.diasOcupacion * 1.5) {
                    recomendaciones.push(`El promedio de ocupaci贸n (${stats.promedioOcupacion.toFixed(1)} d铆as) excede lo recomendado. Reduce el tiempo de pastoreo.`);
                }
                
                if (stats.promedioDescanso > 0 && stats.promedioDescanso < this.prvConfig.diasDescanso * 0.8) {
                    recomendaciones.push(`El descanso promedio (${stats.promedioDescanso.toFixed(1)} d铆as) es menor al 贸ptimo. Permite m谩s tiempo de recuperaci贸n.`);
                }
                
                if (stats.alertasDescanso > 0) {
                    recomendaciones.push(`${stats.alertasDescanso} potrero(s) est谩n pr贸ximos a completar su descanso. Planifica la siguiente rotaci贸n.`);
                }
                
                if (recomendaciones.length === 0) {
                    recomendaciones.push('El sistema de rotaci贸n est谩 funcionando correctamente. Mant茅n los par谩metros actuales.');
                }
                
                return recomendaciones;
            },
            
            // Funciones de configuraci贸n
            loadPRVConfig: function() {
                const saved = localStorage.getItem('nexusAgroPRVConfig');
                if (saved) {
                    this.prvConfig = { ...this.prvConfig, ...JSON.parse(saved) };
                }
                
                const planificaciones = localStorage.getItem('nexusAgroPRVPlanificaciones');
                if (planificaciones) {
                    this.prvPlanificaciones = JSON.parse(planificaciones);
                }
            },
            
            updatePRVConfig: function() {
                this.prvConfig.diasOcupacion = parseInt(document.getElementById('prvDiasOcupacion').value) || 3;
                this.prvConfig.diasDescanso = parseInt(document.getElementById('prvDiasDescanso').value) || 30;
                
                localStorage.setItem('nexusAgroPRVConfig', JSON.stringify(this.prvConfig));
                
                this.notify('success', 'Configuraci贸n actualizada', `Ocupaci贸n: ${this.prvConfig.diasOcupacion}d, Descanso: ${this.prvConfig.diasDescanso}d`);
                this.navigate('prv');
            },
            
            // Planificaci贸n
            openPlanificarRotacion: function() {
                const potrerosLibres = this.data.potreros.filter(p => {
                    return !this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                });
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalPlanificar';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><span></span> Planificar Rotaci贸n</h3>
                            <button class="modal-close" onclick="document.getElementById('modalPlanificar').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Potrero</label>
                                <select id="planPotreroId" class="form-select">
                                    <option value="">Seleccionar potrero...</option>
                                    ${potrerosLibres.map(p => `<option value="${p.id}">${p.id} - ${p.ubicacion}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Inicio</label>
                                <input type="date" id="planFechaInicio" class="form-input" min="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cultivo/Pastura</label>
                                <select id="planCultivo" class="form-select">
                                    <option value="Pradera 1 a帽o">Pradera 1 a帽o</option>
                                    <option value="Campo Natural">Campo Natural</option>
                                    <option value="Campo Natural Mejorado">Campo Natural Mejorado</option>
                                    <option value="Verdeo Invierno">Verdeo Invierno</option>
                                    <option value="Verdeo Verano">Verdeo Verano</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">D铆as de Ocupaci贸n</label>
                                <input type="number" id="planDiasOcupacion" class="form-input" value="${this.prvConfig.diasOcupacion}" min="1" max="30">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalPlanificar').remove()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.guardarPlanificacion()">
                                <span></span> Guardar Planificaci贸n
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            guardarPlanificacion: function() {
                const potreroId = document.getElementById('planPotreroId').value;
                const fechaInicio = document.getElementById('planFechaInicio').value;
                const cultivo = document.getElementById('planCultivo').value;
                const diasOcupacion = parseInt(document.getElementById('planDiasOcupacion').value);
                
                if (!potreroId || !fechaInicio) {
                    this.notify('warning', 'Datos incompletos', 'Selecciona potrero y fecha');
                    return;
                }
                
                const planificacion = {
                    id: `plan_${Date.now()}`,
                    potreroId,
                    fechaInicio,
                    cultivo,
                    diasOcupacion,
                    createdAt: new Date().toISOString()
                };
                
                if (!this.prvPlanificaciones) this.prvPlanificaciones = [];
                this.prvPlanificaciones.push(planificacion);
                localStorage.setItem('nexusAgroPRVPlanificaciones', JSON.stringify(this.prvPlanificaciones));
                
                document.getElementById('modalPlanificar').remove();
                this.notify('success', 'Planificaci贸n guardada', `Rotaci贸n planificada para ${potreroId} el ${fechaInicio}`);
                this.navigate('prv');
            },
            
            generarSecuenciaOptima: function() {
                const secuencia = this.calcularSecuenciaRotacion();
                const listos = secuencia.filter(s => s.estado === 'completed');
                
                if (listos.length === 0) {
                    this.notify('info', 'Secuencia ptima', 'No hay potreros listos para pastoreo. Todos est谩n en uso o descansando.');
                    return;
                }
                
                const mensaje = `Secuencia sugerida:\n${listos.slice(0, 5).map((p, i) => `${i + 1}. ${p.potreroId}`).join('\n')}`;
                this.notify('success', ' Secuencia ptima', mensaje);
            },
            
            generarReportePRV: function() {
                const stats = this.calculatePRVStats();
                const eficiencia = this.calcularEficienciaPRV();
                
                let reporte = `REPORTE DE ROTACIN PRV\n`;
                reporte += `========================\n`;
                reporte += `Fecha: ${new Date().toLocaleDateString('es')}\n\n`;
                reporte += `CONFIGURACIN\n`;
                reporte += `D铆as de ocupaci贸n: ${this.prvConfig.diasOcupacion}\n`;
                reporte += `D铆as de descanso: ${this.prvConfig.diasDescanso}\n`;
                reporte += `Potreros necesarios: ${stats.potrerosNecesarios}\n\n`;
                reporte += `ESTADSTICAS\n`;
                reporte += `Total potreros: ${this.data.potreros.length}\n`;
                reporte += `En descanso: ${stats.potrerosEnDescanso}\n`;
                reporte += `Listos para pastoreo: ${stats.potrerosListos}\n`;
                reporte += `Rotaciones completadas: ${stats.rotacionesCompletadas}\n\n`;
                reporte += `EFICIENCIA: ${eficiencia.porcentaje}%\n`;
                reporte += eficiencia.mensaje;
                
                // Copiar al portapapeles
                navigator.clipboard.writeText(reporte).then(() => {
                    this.notify('success', 'Reporte Generado', 'El reporte ha sido copiado al portapapeles');
                }).catch(() => {
                    console.log(reporte);
                    this.notify('info', 'Reporte', 'Ver consola para el reporte completo');
                });
            },

            renderGaleria: function() {
                const fotos = this.data.fotos || [];
                const potrerosConFotos = [...new Set(fotos.map(f => f.potreroId))];
                
                // Estad铆sticas
                const totalFotos = fotos.length;
                const fotosEsteMes = fotos.filter(f => {
                    const fecha = new Date(f.timestamp);
                    const ahora = new Date();
                    return fecha.getMonth() === ahora.getMonth() && fecha.getFullYear() === ahora.getFullYear();
                }).length;
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Galer铆a de Fotos Geolocalizadas
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="app.openCameraCapture()">
                                    <span></span> Tomar Foto
                                </button>
                                <button class="btn btn-secondary" onclick="app.uploadPhotoFromFile()">
                                    <span></span> Subir Imagen
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Estad铆sticas -->
                            <div class="photo-stats">
                                <div class="photo-stat-card">
                                    <div class="photo-stat-value">${totalFotos}</div>
                                    <div class="photo-stat-label">Total Fotos</div>
                                </div>
                                <div class="photo-stat-card">
                                    <div class="photo-stat-value">${fotosEsteMes}</div>
                                    <div class="photo-stat-label">Este Mes</div>
                                </div>
                                <div class="photo-stat-card">
                                    <div class="photo-stat-value">${potrerosConFotos.length}</div>
                                    <div class="photo-stat-label">Potreros Documentados</div>
                                </div>
                                <div class="photo-stat-card">
                                    <div class="photo-stat-value">${fotos.filter(f => f.latitude).length}</div>
                                    <div class="photo-stat-label">Con GPS</div>
                                </div>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="photo-filters">
                                <div class="photo-filter-group">
                                    <span class="photo-filter-label">Potrero:</span>
                                    <select class="photo-filter-select" id="filterPotrero" onchange="app.filterGallery()">
                                        <option value="">Todos</option>
                                        ${this.data.potreros.map(p => `<option value="${p.id}">${p.id} - ${p.ubicacion}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="photo-filter-group">
                                    <span class="photo-filter-label">Per铆odo:</span>
                                    <select class="photo-filter-select" id="filterPeriodo" onchange="app.filterGallery()">
                                        <option value="">Todo el tiempo</option>
                                        <option value="7">ltimos 7 d铆as</option>
                                        <option value="30">ltimos 30 d铆as</option>
                                        <option value="90">ltimos 3 meses</option>
                                    </select>
                                </div>
                                <div class="photo-filter-group">
                                    <span class="photo-filter-label">Ordenar:</span>
                                    <select class="photo-filter-select" id="filterOrden" onchange="app.filterGallery()">
                                        <option value="reciente">M谩s recientes</option>
                                        <option value="antiguo">M谩s antiguos</option>
                                        <option value="potrero">Por potrero</option>
                                    </select>
                                </div>
                                ${fotos.length >= 2 ? `
                                    <button class="btn btn-secondary btn-small" onclick="app.openPhotoCompare()">
                                        <span></span> Comparar Antes/Despu茅s
                                    </button>
                                ` : ''}
                            </div>
                            
                            <!-- Galer铆a -->
                            <div id="photoGalleryContainer">
                                ${this.renderPhotoGallery(fotos)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input oculto para subir archivos -->
                    <input type="file" id="photoFileInput" accept="image/*" style="display: none;" onchange="app.handlePhotoUpload(this)">
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            renderPhotoGallery: function(fotos) {
                if (!fotos || fotos.length === 0) {
                    return `
                        <div class="photo-empty-state">
                            <div class="photo-empty-icon"></div>
                            <div class="photo-empty-title">No hay fotos a煤n</div>
                            <div class="photo-empty-message">
                                Documenta el estado de tus potreros con fotograf铆as geolocalizadas.<br>
                                Las fotos te ayudar谩n a comparar la evoluci贸n de las pasturas.
                            </div>
                            <button class="btn btn-primary" onclick="app.openCameraCapture()">
                                <span></span> Tomar Primera Foto
                            </button>
                        </div>
                    `;
                }
                
                return `
                    <div class="photo-gallery-container">
                        ${fotos.map((foto, index) => {
                            const potrero = this.data.potreros.find(p => p.id === foto.potreroId);
                            const fecha = new Date(foto.timestamp);
                            return `
                                <div class="photo-card" onclick="app.viewPhoto(${index})">
                                    <img src="${foto.dataUrl}" alt="Foto de ${foto.potreroId}" class="photo-card-image" loading="lazy">
                                    <div class="photo-card-info">
                                        <div class="photo-card-potrero">${foto.potreroId}</div>
                                        <div class="photo-card-date">
                                             ${fecha.toLocaleDateString('es', { day: '2-digit', month: 'short', year: 'numeric' })}
                                            ${fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        ${foto.latitude ? `
                                            <div class="photo-card-location">
                                                 ${foto.latitude.toFixed(5)}, ${foto.longitude.toFixed(5)}
                                            </div>
                                        ` : ''}
                                        ${foto.notas ? `<div style="font-size: 11px; color: var(--gris-600); margin-top: 4px;"> ${foto.notas}</div>` : ''}
                                    </div>
                                    <div class="photo-card-actions">
                                        <button class="photo-card-btn primary" onclick="event.stopPropagation(); app.viewPhoto(${index})">
                                            锔 Ver
                                        </button>
                                        <button class="photo-card-btn danger" onclick="event.stopPropagation(); app.deletePhoto(${index})">
                                            锔
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            filterGallery: function() {
                const potreroFilter = document.getElementById('filterPotrero').value;
                const periodoFilter = document.getElementById('filterPeriodo').value;
                const ordenFilter = document.getElementById('filterOrden').value;
                
                let fotos = [...(this.data.fotos || [])];
                
                // Filtrar por potrero
                if (potreroFilter) {
                    fotos = fotos.filter(f => f.potreroId === potreroFilter);
                }
                
                // Filtrar por per铆odo
                if (periodoFilter) {
                    const diasAtras = parseInt(periodoFilter);
                    const fechaLimite = new Date();
                    fechaLimite.setDate(fechaLimite.getDate() - diasAtras);
                    fotos = fotos.filter(f => new Date(f.timestamp) >= fechaLimite);
                }
                
                // Ordenar
                switch (ordenFilter) {
                    case 'reciente':
                        fotos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        break;
                    case 'antiguo':
                        fotos.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        break;
                    case 'potrero':
                        fotos.sort((a, b) => a.potreroId.localeCompare(b.potreroId));
                        break;
                }
                
                document.getElementById('photoGalleryContainer').innerHTML = this.renderPhotoGallery(fotos);
            },
            
            // Abrir c谩mara para capturar foto
            openCameraCapture: async function(preselectedPotrero = null) {
                // Verificar soporte de c谩mara
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.notify('error', 'No soportado', 'Tu navegador no soporta acceso a la c谩mara. Intenta subir una imagen.');
                    return;
                }
                
                // Crear modal de captura
                const modal = document.createElement('div');
                modal.id = 'photoCaptureModal';
                modal.className = 'photo-capture-modal';
                
                modal.innerHTML = `
                    <div class="photo-capture-header">
                        <div class="photo-capture-title"> Capturar Foto del Potrero</div>
                        <button class="photo-capture-close" onclick="app.closeCameraCapture()"></button>
                    </div>
                    
                    <video id="cameraVideo" class="photo-capture-video" autoplay playsinline></video>
                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                    <img id="capturedImage" class="photo-capture-preview" style="display: none;">
                    
                    <div class="photo-capture-controls">
                        <div class="photo-gps-info" id="gpsStatus">
                            <i class="fa-solid fa-spinner fa-spin"></i> Obteniendo ubicaci贸n GPS...
                        </div>
                        
                        <div id="captureButtons">
                            <button class="photo-capture-btn" id="btnCapture" onclick="app.capturePhoto()">
                                
                            </button>
                        </div>
                        
                        <div id="confirmButtons" style="display: none;">
                            <div class="photo-capture-actions">
                                <button class="photo-capture-btn retake" onclick="app.retakePhoto()">
                                    
                                </button>
                                <button class="photo-capture-btn confirm" onclick="app.confirmPhoto()">
                                    
                                </button>
                            </div>
                        </div>
                        
                        <div id="potreroSelector" style="display: none; width: 100%; max-width: 300px;">
                            <select id="photoPotreroSelect" class="form-select" style="width: 100%; margin-bottom: 12px;">
                                <option value="">Seleccionar potrero...</option>
                                ${this.data.potreros.map(p => `<option value="${p.id}" ${preselectedPotrero === p.id ? 'selected' : ''}>${p.id} - ${p.ubicacion}</option>`).join('')}
                            </select>
                            <input type="text" id="photoNotas" class="form-input" placeholder="Notas adicionales (opcional)" style="width: 100%; margin-bottom: 12px;">
                            <button class="btn btn-primary" onclick="app.savePhoto()" style="width: 100%;">
                                 Guardar Foto
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Iniciar c谩mara
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment', // C谩mara trasera
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    this.cameraStream = stream;
                    
                } catch (error) {
                    console.error('Error accediendo a la c谩mara:', error);
                    this.notify('error', 'Error de c谩mara', 'No se pudo acceder a la c谩mara. Verifica los permisos.');
                    this.closeCameraCapture();
                    return;
                }
                
                // Obtener GPS
                this.getCurrentGPS();
            },
            
            getCurrentGPS: function() {
                const gpsStatus = document.getElementById('gpsStatus');
                
                if (!navigator.geolocation) {
                    gpsStatus.innerHTML = ' GPS no disponible';
                    gpsStatus.classList.add('error');
                    this.capturedGPS = null;
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.capturedGPS = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        gpsStatus.innerHTML = ` GPS: ${position.coords.latitude.toFixed(5)}, ${position.coords.longitude.toFixed(5)} (卤${Math.round(position.coords.accuracy)}m)`;
                        gpsStatus.classList.remove('error');
                        gpsStatus.classList.add('success');
                    },
                    (error) => {
                        console.error('Error GPS:', error);
                        gpsStatus.innerHTML = '锔 GPS no disponible - La foto se guardar谩 sin ubicaci贸n';
                        gpsStatus.classList.add('error');
                        this.capturedGPS = null;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            },
            
            capturePhoto: function() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.getElementById('cameraCanvas');
                const img = document.getElementById('capturedImage');
                
                // Configurar canvas con dimensiones del video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Dibujar frame del video en el canvas
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // Convertir a imagen
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                img.src = dataUrl;
                this.capturedPhotoData = dataUrl;
                
                // Mostrar preview y ocultar video
                video.style.display = 'none';
                img.style.display = 'block';
                
                // Cambiar botones
                document.getElementById('captureButtons').style.display = 'none';
                document.getElementById('confirmButtons').style.display = 'block';
            },
            
            retakePhoto: function() {
                const video = document.getElementById('cameraVideo');
                const img = document.getElementById('capturedImage');
                
                // Mostrar video y ocultar preview
                video.style.display = 'block';
                img.style.display = 'none';
                
                // Cambiar botones
                document.getElementById('captureButtons').style.display = 'block';
                document.getElementById('confirmButtons').style.display = 'none';
                document.getElementById('potreroSelector').style.display = 'none';
                
                this.capturedPhotoData = null;
            },
            
            confirmPhoto: function() {
                document.getElementById('confirmButtons').style.display = 'none';
                document.getElementById('potreroSelector').style.display = 'block';
            },
            
            savePhoto: function() {
                const potreroId = document.getElementById('photoPotreroSelect').value;
                const notas = document.getElementById('photoNotas').value.trim();
                
                if (!potreroId) {
                    this.notify('warning', 'Selecciona un potrero', 'Debes seleccionar el potrero al que corresponde esta foto');
                    return;
                }
                
                if (!this.capturedPhotoData) {
                    this.notify('error', 'Error', 'No hay foto capturada');
                    return;
                }
                
                // Crear objeto de foto
                const foto = {
                    id: `foto_${Date.now()}`,
                    potreroId: potreroId,
                    dataUrl: this.capturedPhotoData,
                    timestamp: new Date().toISOString(),
                    latitude: this.capturedGPS?.latitude || null,
                    longitude: this.capturedGPS?.longitude || null,
                    accuracy: this.capturedGPS?.accuracy || null,
                    notas: notas,
                    usuario: this.currentUser?.usuario || 'ADMIN'
                };
                
                // Guardar
                if (!this.data.fotos) this.data.fotos = [];
                this.data.fotos.unshift(foto);
                this.saveData();
                
                // Cerrar modal y mostrar galer铆a
                this.closeCameraCapture();
                this.notify('success', 'Foto Guardada', `Foto del potrero ${potreroId} guardada correctamente`);
                this.navigate('galeria');
            },
            
            closeCameraCapture: function() {
                // Detener c谩mara
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                
                // Limpiar datos
                this.capturedPhotoData = null;
                this.capturedGPS = null;
                
                // Remover modal
                const modal = document.getElementById('photoCaptureModal');
                if (modal) modal.remove();
            },
            
            // Subir foto desde archivo
            uploadPhotoFromFile: function() {
                document.getElementById('photoFileInput').click();
            },
            
            handlePhotoUpload: function(input) {
                const file = input.files[0];
                if (!file) return;
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    this.notify('error', 'Archivo inv谩lido', 'Solo se permiten im谩genes');
                    return;
                }
                
                // Validar tama帽o (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.notify('error', 'Archivo muy grande', 'El tama帽o m谩ximo es 10MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.capturedPhotoData = e.target.result;
                    this.showUploadPhotoDialog();
                };
                reader.readAsDataURL(file);
                
                input.value = '';
            },
            
            showUploadPhotoDialog: function() {
                const modal = document.createElement('div');
                modal.id = 'photoUploadModal';
                modal.className = 'photo-capture-modal';
                
                modal.innerHTML = `
                    <div class="photo-capture-header">
                        <div class="photo-capture-title"> Guardar Imagen</div>
                        <button class="photo-capture-close" onclick="app.closeUploadDialog()"></button>
                    </div>
                    
                    <img src="${this.capturedPhotoData}" class="photo-capture-preview">
                    
                    <div class="photo-capture-controls">
                        <div style="width: 100%; max-width: 300px;">
                            <select id="uploadPotreroSelect" class="form-select" style="width: 100%; margin-bottom: 12px;">
                                <option value="">Seleccionar potrero...</option>
                                ${this.data.potreros.map(p => `<option value="${p.id}">${p.id} - ${p.ubicacion}</option>`).join('')}
                            </select>
                            <input type="text" id="uploadPhotoNotas" class="form-input" placeholder="Notas adicionales (opcional)" style="width: 100%; margin-bottom: 12px;">
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-secondary" onclick="app.closeUploadDialog()" style="flex: 1;">
                                    Cancelar
                                </button>
                                <button class="btn btn-primary" onclick="app.saveUploadedPhoto()" style="flex: 1;">
                                     Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            closeUploadDialog: function() {
                this.capturedPhotoData = null;
                const modal = document.getElementById('photoUploadModal');
                if (modal) modal.remove();
            },
            
            saveUploadedPhoto: function() {
                const potreroId = document.getElementById('uploadPotreroSelect').value;
                const notas = document.getElementById('uploadPhotoNotas').value.trim();
                
                if (!potreroId) {
                    this.notify('warning', 'Selecciona un potrero', 'Debes seleccionar el potrero al que corresponde esta foto');
                    return;
                }
                
                const foto = {
                    id: `foto_${Date.now()}`,
                    potreroId: potreroId,
                    dataUrl: this.capturedPhotoData,
                    timestamp: new Date().toISOString(),
                    latitude: null,
                    longitude: null,
                    notas: notas,
                    usuario: this.currentUser?.usuario || 'ADMIN',
                    source: 'upload'
                };
                
                if (!this.data.fotos) this.data.fotos = [];
                this.data.fotos.unshift(foto);
                this.saveData();
                
                this.closeUploadDialog();
                this.notify('success', 'Foto Guardada', `Imagen del potrero ${potreroId} guardada correctamente`);
                this.navigate('galeria');
            },
            
            // Visor de fotos
            viewPhoto: function(index) {
                const fotos = this.data.fotos || [];
                const foto = fotos[index];
                if (!foto) return;
                
                this.currentPhotoIndex = index;
                
                const fecha = new Date(foto.timestamp);
                const potrero = this.data.potreros.find(p => p.id === foto.potreroId);
                
                const overlay = document.createElement('div');
                overlay.id = 'photoViewer';
                overlay.className = 'photo-viewer-overlay';
                
                overlay.innerHTML = `
                    <button class="photo-viewer-close" onclick="app.closePhotoViewer()"></button>
                    
                    ${index > 0 ? `<button class="photo-viewer-nav prev" onclick="app.viewPhoto(${index - 1})"></button>` : ''}
                    ${index < fotos.length - 1 ? `<button class="photo-viewer-nav next" onclick="app.viewPhoto(${index + 1})"></button>` : ''}
                    
                    <img src="${foto.dataUrl}" class="photo-viewer-image" alt="Foto de ${foto.potreroId}">
                    
                    <div class="photo-viewer-info">
                        <div class="photo-viewer-details">
                            <h4>${foto.potreroId} - ${potrero?.ubicacion || 'Sin ubicaci贸n'}</h4>
                            <p>
                                 ${fecha.toLocaleDateString('es', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })} a las ${fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}
                                ${foto.latitude ? ` |  ${foto.latitude.toFixed(5)}, ${foto.longitude.toFixed(5)}` : ''}
                                ${foto.notas ? ` |  ${foto.notas}` : ''}
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-small" onclick="app.downloadPhoto(${index})">
                                猬锔 Descargar
                            </button>
                            ${foto.latitude ? `
                                <button class="btn btn-secondary btn-small" onclick="app.viewPhotoOnMap(${index})">
                                    猴 Ver en Mapa
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Remover visor anterior si existe
                this.closePhotoViewer();
                document.body.appendChild(overlay);
                
                // Cerrar con Escape
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) this.closePhotoViewer();
                });
            },
            
            closePhotoViewer: function() {
                const overlay = document.getElementById('photoViewer');
                if (overlay) overlay.remove();
            },
            
            deletePhoto: function(index) {
                if (confirm('驴Eliminar esta foto? Esta acci贸n no se puede deshacer.')) {
                    this.data.fotos.splice(index, 1);
                    this.saveData();
                    this.notify('success', 'Foto Eliminada', 'La foto fue eliminada de la galer铆a');
                    this.navigate('galeria');
                }
            },
            
            downloadPhoto: function(index) {
                const foto = this.data.fotos[index];
                if (!foto) return;
                
                const link = document.createElement('a');
                link.href = foto.dataUrl;
                link.download = `${foto.potreroId}_${new Date(foto.timestamp).toISOString().split('T')[0]}.jpg`;
                link.click();
                
                this.notify('success', 'Descargando', 'La foto se est谩 descargando');
            },
            
            viewPhotoOnMap: function(index) {
                const foto = this.data.fotos[index];
                if (!foto || !foto.latitude) return;
                
                this.closePhotoViewer();
                this.navigate('mapa');
                
                // Esperar a que el mapa se renderice
                setTimeout(() => {
                    if (this.mapa) {
                        this.mapa.setView([foto.latitude, foto.longitude], 17);
                        L.marker([foto.latitude, foto.longitude])
                            .addTo(this.mapa)
                            .bindPopup(`<b>${foto.potreroId}</b><br>Foto tomada aqu铆`)
                            .openPopup();
                    }
                }, 500);
            },
            
            // Comparador Antes/Despu茅s
            openPhotoCompare: function() {
                const fotos = this.data.fotos || [];
                if (fotos.length < 2) {
                    this.notify('warning', 'Fotos insuficientes', 'Necesitas al menos 2 fotos para comparar');
                    return;
                }
                
                // Agrupar fotos por potrero
                const fotosPorPotrero = {};
                fotos.forEach(f => {
                    if (!fotosPorPotrero[f.potreroId]) fotosPorPotrero[f.potreroId] = [];
                    fotosPorPotrero[f.potreroId].push(f);
                });
                
                // Filtrar potreros con m谩s de 1 foto
                const potrerosComparables = Object.entries(fotosPorPotrero).filter(([id, fs]) => fs.length >= 2);
                
                if (potrerosComparables.length === 0) {
                    this.notify('warning', 'Sin comparaciones', 'No hay potreros con m煤ltiples fotos para comparar');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'photoCompareModal';
                modal.className = 'photo-capture-modal';
                modal.style.padding = '20px';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow: auto;">
                        <div style="padding: 20px; background: linear-gradient(135deg, var(--verde-medio), var(--verde-claro)); color: white; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;"> Comparar Antes / Despu茅s</h3>
                            <button onclick="app.closePhotoCompare()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 18px;"></button>
                        </div>
                        
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Seleccionar Potrero:</label>
                                <select id="comparePotreroSelect" class="form-select" onchange="app.loadComparePhotos()">
                                    <option value="">Seleccionar...</option>
                                    ${potrerosComparables.map(([id, fs]) => `<option value="${id}">${id} (${fs.length} fotos)</option>`).join('')}
                                </select>
                            </div>
                            
                            <div id="comparePhotosContainer" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">Foto ANTES:</label>
                                        <select id="compareBeforeSelect" class="form-select" onchange="app.updateCompare()"></select>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">Foto DESPUS:</label>
                                        <select id="compareAfterSelect" class="form-select" onchange="app.updateCompare()"></select>
                                    </div>
                                </div>
                                
                                <div id="compareViewer"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            loadComparePhotos: function() {
                const potreroId = document.getElementById('comparePotreroSelect').value;
                if (!potreroId) {
                    document.getElementById('comparePhotosContainer').style.display = 'none';
                    return;
                }
                
                const fotos = (this.data.fotos || [])
                    .filter(f => f.potreroId === potreroId)
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                const beforeSelect = document.getElementById('compareBeforeSelect');
                const afterSelect = document.getElementById('compareAfterSelect');
                
                const options = fotos.map((f, i) => {
                    const fecha = new Date(f.timestamp);
                    return `<option value="${i}">${fecha.toLocaleDateString('es')} ${fecha.toLocaleTimeString('es', {hour: '2-digit', minute: '2-digit'})}</option>`;
                }).join('');
                
                beforeSelect.innerHTML = options;
                afterSelect.innerHTML = options;
                
                // Seleccionar primera y 煤ltima
                beforeSelect.selectedIndex = 0;
                afterSelect.selectedIndex = fotos.length - 1;
                
                this.comparePhotos = fotos;
                document.getElementById('comparePhotosContainer').style.display = 'block';
                this.updateCompare();
            },
            
            updateCompare: function() {
                const beforeIndex = parseInt(document.getElementById('compareBeforeSelect').value);
                const afterIndex = parseInt(document.getElementById('compareAfterSelect').value);
                
                const before = this.comparePhotos[beforeIndex];
                const after = this.comparePhotos[afterIndex];
                
                if (!before || !after) return;
                
                document.getElementById('compareViewer').innerHTML = `
                    <div class="photo-compare-container">
                        <div class="photo-compare-wrapper" id="compareWrapper">
                            <img src="${before.dataUrl}" class="photo-compare-image before" alt="Antes">
                            <img src="${after.dataUrl}" class="photo-compare-image after" id="afterImage" alt="Despu茅s">
                            <div class="photo-compare-slider" id="compareSlider"></div>
                            <div class="photo-compare-labels">
                                <span class="photo-compare-label">ANTES - ${new Date(before.timestamp).toLocaleDateString('es')}</span>
                                <span class="photo-compare-label">DESPUS - ${new Date(after.timestamp).toLocaleDateString('es')}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Inicializar slider
                this.initCompareSlider();
            },
            
            initCompareSlider: function() {
                const slider = document.getElementById('compareSlider');
                const wrapper = document.getElementById('compareWrapper');
                const afterImage = document.getElementById('afterImage');
                
                if (!slider || !wrapper || !afterImage) return;
                
                let isDragging = false;
                
                const updateSlider = (x) => {
                    const rect = wrapper.getBoundingClientRect();
                    let percent = ((x - rect.left) / rect.width) * 100;
                    percent = Math.max(0, Math.min(100, percent));
                    
                    slider.style.left = percent + '%';
                    afterImage.style.clipPath = `inset(0 ${100 - percent}% 0 0)`;
                };
                
                slider.addEventListener('mousedown', () => isDragging = true);
                document.addEventListener('mouseup', () => isDragging = false);
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) updateSlider(e.clientX);
                });
                
                // Touch support
                slider.addEventListener('touchstart', () => isDragging = true);
                document.addEventListener('touchend', () => isDragging = false);
                document.addEventListener('touchmove', (e) => {
                    if (isDragging && e.touches[0]) updateSlider(e.touches[0].clientX);
                });
                
                wrapper.addEventListener('click', (e) => updateSlider(e.clientX));
            },
            
            closePhotoCompare: function() {
                const modal = document.getElementById('photoCompareModal');
                if (modal) modal.remove();
                this.comparePhotos = null;
            },

            renderExportar: function() {
                const stats = this.calculateStats();
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                Exportar y Respaldar Datos
                            </h3>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Estad铆sticas r谩pidas -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px;">
                                <div style="background: var(--verde-muy-claro); padding: 16px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--verde-medio);">${stats.totalPotreros}</div>
                                    <div style="font-size: 12px; color: var(--gris-600);">Potreros</div>
                                </div>
                                <div style="background: var(--verde-muy-claro); padding: 16px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--verde-medio);">${this.data.movimientos.length}</div>
                                    <div style="font-size: 12px; color: var(--gris-600);">Movimientos</div>
                                </div>
                                <div style="background: var(--verde-muy-claro); padding: 16px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--verde-medio);">${stats.superficieTotal.toFixed(1)}</div>
                                    <div style="font-size: 12px; color: var(--gris-600);">Hect谩reas</div>
                                </div>
                            </div>

                            <div class="export-section">
                                <h4 style="margin-bottom: 16px; font-weight: 700;"> Exportar Reportes</h4>
                                <div class="export-grid">
                                    <div class="export-card" onclick="app.exportWithPreview('potreros')">
                                        <div class="export-card-icon"></div>
                                        <div class="export-card-title">Potreros CSV</div>
                                        <div class="export-card-desc">Lista completa de potreros</div>
                                    </div>
                                    <div class="export-card" onclick="app.exportWithPreview('movimientos')">
                                        <div class="export-card-icon"></div>
                                        <div class="export-card-title">Movimientos CSV</div>
                                        <div class="export-card-desc">Historial de movimientos</div>
                                    </div>
                                    <div class="export-card" onclick="app.exportWithPreview('completo')">
                                        <div class="export-card-icon"></div>
                                        <div class="export-card-title">Reporte Completo</div>
                                        <div class="export-card-desc">Estad铆sticas + datos</div>
                                    </div>
                                    <div class="export-card" onclick="app.exportPotrerosToGeoJSON()">
                                        <div class="export-card-icon">猴</div>
                                        <div class="export-card-title">GeoJSON</div>
                                        <div class="export-card-desc">Para sistemas GIS</div>
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 32px 0; border: none; border-top: 2px solid var(--gris-200);">

                            <div class="export-section">
                                <h4 style="margin-bottom: 16px; font-weight: 700;"> Respaldo del Sistema</h4>
                                <div class="export-grid">
                                    <div class="export-card" onclick="app.descargarBackup()" style="border: 2px solid var(--verde-claro);">
                                        <div class="export-card-icon">猬锔</div>
                                        <div class="export-card-title">Descargar Backup</div>
                                        <div class="export-card-desc">Respaldo completo JSON</div>
                                    </div>
                                    <div class="export-card" onclick="document.getElementById('fileRestore').click()">
                                        <div class="export-card-icon">猬锔</div>
                                        <div class="export-card-title">Restaurar</div>
                                        <div class="export-card-desc">Desde archivo backup</div>
                                    </div>
                                    <div class="export-card" onclick="app.exportAutoBackupInfo()">
                                        <div class="export-card-icon"></div>
                                        <div class="export-card-title">Auto-Backup</div>
                                        <div class="export-card-desc">Ver 煤ltimo respaldo</div>
                                    </div>
                                </div>
                                <input type="file" id="fileRestore" accept=".json" style="display: none;" onchange="app.restaurarBackup(this)">
                            </div>

                            <div style="margin-top: 24px; padding: 16px; background: var(--gris-100); border-radius: 10px; font-size: 13px; color: var(--gris-700);">
                                <strong> Tip:</strong> El sistema realiza auto-backup cada 30 minutos. Use Ctrl+E para acceder r谩pidamente a esta secci贸n.
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },
            
            // Exportar con vista previa
            exportWithPreview: function(tipo) {
                let content = '';
                let filename = '';
                
                if (tipo === 'potreros') {
                    content = 'ID,Ubicaci贸n,Superficie (Ha),Estado,GPS,Pol铆gono\n';
                    this.data.potreros.forEach(p => {
                        const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                        const tieneGPS = p.latitud && p.longitud ? 'S铆' : 'No';
                        const tienePoligono = p.polygon && p.polygon.length > 0 ? 'S铆' : 'No';
                        content += `${p.id},"${p.ubicacion}",${p.superficie},${ocupado ? 'Ocupado' : 'Libre'},${tieneGPS},${tienePoligono}\n`;
                    });
                    filename = 'potreros.csv';
                } else if (tipo === 'movimientos') {
                    content = 'Potrero,Cultivo,Fecha Entrada,Fecha Salida,Permanencia,Mat. Verde Entrada,Mat. Verde Salida,Consumo,Estado\n';
                    this.data.movimientos.forEach(m => {
                        const consumo = (m.matVerdeEntrada || 0) - (m.matVerdeSalida || 0);
                        content += `${m.potreroId},"${m.cultivo}",${m.fechaEntrada || ''},${m.fechaSalida || ''},${m.permanencia || ''},${m.matVerdeEntrada || ''},${m.matVerdeSalida || ''},${consumo > 0 ? consumo : ''},${m.estado}\n`;
                    });
                    filename = 'movimientos.csv';
                } else if (tipo === 'completo') {
                    const stats = this.calculateStats();
                    content = `REPORTE WIN-TEL AGROMANAGER PRO\nFecha: ${new Date().toLocaleDateString('es')}\n\n`;
                    content += `RESUMEN\nTotal Potreros: ${stats.totalPotreros}\nOcupados: ${stats.ocupados}\nDisponibles: ${stats.libres}\nSuperficie Total: ${stats.superficieTotal.toFixed(1)} Ha\n\n`;
                    content += 'POTREROS\nID,Ubicaci贸n,Superficie,Estado\n';
                    this.data.potreros.forEach(p => {
                        const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                        content += `${p.id},"${p.ubicacion}",${p.superficie},${ocupado ? 'Ocupado' : 'Libre'}\n`;
                    });
                    filename = 'reporte_completo.csv';
                }
                
                // Mostrar preview
                this.showExportPreview(content, filename, tipo);
            },
            
            showExportPreview: function(content, filename, tipo) {
                const overlay = document.createElement('div');
                overlay.className = 'export-preview-modal';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
                
                const previewContent = content.length > 2000 ? content.substring(0, 2000) + '\n\n... (contenido truncado para preview)' : content;
                
                overlay.innerHTML = `
                    <div class="export-preview-container">
                        <div class="export-preview-header">
                            <div style="font-size: 18px; font-weight: 700;"> Vista Previa: ${filename}</div>
                            <button class="alert-center-close" onclick="this.closest('.export-preview-modal').remove()"></button>
                        </div>
                        <div class="export-preview-body">
                            <div class="export-preview-content">${previewContent}</div>
                        </div>
                        <div class="export-preview-footer">
                            <button class="btn btn-secondary" onclick="app.copyToClipboard(\`${content.replace(/`/g, '\\`')}\`); this.textContent=' Copiado!';">
                                 Copiar
                            </button>
                            <button class="btn btn-primary" onclick="app.exportarCSV('${tipo}'); this.closest('.export-preview-modal').remove();">
                                猬锔 Descargar ${filename}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
            },
            
            copyToClipboard: function(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.notify('success', 'Copiado', 'Contenido copiado al portapapeles');
                }).catch(() => {
                    this.notify('error', 'Error', 'No se pudo copiar');
                });
            },
            
            exportAutoBackupInfo: function() {
                const backup = localStorage.getItem('nexusAgroAutoBackup');
                if (backup) {
                    const parsed = JSON.parse(backup);
                    this.notify('info', 'Auto-Backup', `ltimo respaldo: ${new Date(parsed.timestamp).toLocaleString()}`);
                } else {
                    this.notify('info', 'Auto-Backup', 'No hay auto-backup disponible a煤n. Se crea cada 30 minutos.');
                }
            },

            renderConfig: function() {
                if (this.currentUser.rol !== 'admin') {
                    this.notify('error', 'Acceso Denegado', 'Solo administradores pueden acceder a la configuraci贸n');
                    this.navigate('dashboard');
                    return;
                }

                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">锔</span>
                                Configuraci贸n del Sistema
                            </h3>
                        </div>
                        
                        <div style="padding: 20px;">
                            <h4 style="margin-bottom: 16px; font-weight: 700;">Usuarios del Sistema</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Rol</th>
                                            <th>Contrase帽a</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.data.usuarios.map(u => `
                                            <tr>
                                                <td><strong>${u.usuario}</strong></td>
                                                <td><span class="badge ${u.rol === 'admin' ? 'ocupado' : 'libre'}">${u.rol}</span></td>
                                                <td>⑩⑩⑩⑩⑩</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <hr style="margin: 32px 0; border: none; border-top: 2px solid var(--gris-200);">

                            <h4 style="margin-bottom: 16px; font-weight: 700;">Cat谩logos del Sistema</h4>
                            
                            <div style="margin-bottom: 24px;">
                                <strong>Tipos de Cultivo:</strong>
                                <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${this.data.config.tiposCultivo.map(c => `
                                        <span class="badge libre">${c}</span>
                                    `).join('')}
                                </div>
                            </div>

                            <div>
                                <strong>Observaciones Est谩ndar:</strong>
                                <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${this.data.config.observacionesEstandar.map(o => `
                                        <span class="badge descanso">${o}</span>
                                    `).join('')}
                                </div>
                            </div>

                            <div style="margin-top: 32px;">
                                <button class="btn btn-danger" onclick="app.resetearSistema()">
                                    <span>锔</span> Resetear Sistema (Borrar Todos los Datos)
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contentArea').innerHTML = html;
            },

            // ========================================
            // RENDERS AUXILIARES
            // ========================================
            renderMovimientosActivos: function() {
                const activos = this.data.movimientos.filter(m => m.estado === 'activo');
                
                if (activos.length === 0) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No hay movimientos activos</div>
                            <div class="empty-state-message">Registre una entrada de ganado para comenzar.</div>
                        </div>
                    `;
                }

                return `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Potrero</th>
                                    <th>Cultivo</th>
                                    <th>Fecha Entrada</th>
                                    <th>D铆as Transcurridos</th>
                                    <th>Mat. Verde Entrada</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${activos.map(mov => `
                                    <tr>
                                        <td><strong>${mov.potreroId}</strong></td>
                                        <td>${mov.cultivo}</td>
                                        <td>${this.formatDate(mov.fechaEntrada)}</td>
                                        <td><strong>${this.calcularDias(mov.fechaEntrada)}</strong> d铆as</td>
                                        <td>${mov.matVerdeEntrada || '-'} kg/ha</td>
                                        <td>
                                            <button class="btn btn-success btn-small" onclick="app.openSalidaModal(${mov.id})">
                                                Registrar Salida
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderUltimosMovimientos: function() {
                const ultimos = this.data.movimientos
                    .filter(m => m.estado === 'finalizado')
                    .sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida))
                    .slice(0, 5);

                if (ultimos.length === 0) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No hay movimientos finalizados</div>
                            <div class="empty-state-message">Los movimientos completados aparecer谩n aqu铆.</div>
                        </div>
                    `;
                }

                return `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Potrero</th>
                                    <th>Cultivo</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>Permanencia</th>
                                    <th>Consumo Mat. Verde</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ultimos.map(mov => {
                                    const consumo = (mov.matVerdeEntrada || 0) - (mov.matVerdeSalida || 0);
                                    return `
                                        <tr>
                                            <td><strong>${mov.potreroId}</strong></td>
                                            <td>${mov.cultivo}</td>
                                            <td>${this.formatDate(mov.fechaEntrada)}</td>
                                            <td>${this.formatDate(mov.fechaSalida)}</td>
                                            <td><strong>${mov.permanencia}</strong> d铆as</td>
                                            <td>${consumo > 0 ? consumo.toFixed(0) + ' kg/ha' : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderAnalisisPorPotrero: function() {
                const analisis = {};
                
                this.data.movimientos.forEach(mov => {
                    if (!analisis[mov.potreroId]) {
                        analisis[mov.potreroId] = {
                            usos: 0,
                            diasTotales: 0,
                            consumoTotal: 0
                        };
                    }
                    
                    analisis[mov.potreroId].usos++;
                    if (mov.permanencia) {
                        analisis[mov.potreroId].diasTotales += mov.permanencia;
                    }
                    if (mov.matVerdeEntrada && mov.matVerdeSalida) {
                        analisis[mov.potreroId].consumoTotal += (mov.matVerdeEntrada - mov.matVerdeSalida);
                    }
                });

                const items = Object.entries(analisis);
                
                if (items.length === 0) {
                    return '<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-title">Sin datos para analizar</div></div>';
                }

                return `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Potrero</th>
                                    <th>Veces Usado</th>
                                    <th>D铆as Totales</th>
                                    <th>Prom. D铆as/Uso</th>
                                    <th>Consumo Prom.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(([id, data]) => `
                                    <tr>
                                        <td><strong>${id}</strong></td>
                                        <td>${data.usos}</td>
                                        <td>${data.diasTotales}</td>
                                        <td>${data.usos > 0 ? (data.diasTotales / data.usos).toFixed(1) : 0} d铆as</td>
                                        <td>${data.usos > 0 ? (data.consumoTotal / data.usos).toFixed(0) : 0} kg/ha</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderAnalisisPorCultivo: function() {
                const analisis = {};
                
                this.data.movimientos.forEach(mov => {
                    if (!analisis[mov.cultivo]) {
                        analisis[mov.cultivo] = {
                            usos: 0,
                            diasTotales: 0,
                            consumoTotal: 0
                        };
                    }
                    
                    analisis[mov.cultivo].usos++;
                    if (mov.permanencia) {
                        analisis[mov.cultivo].diasTotales += mov.permanencia;
                    }
                    if (mov.matVerdeEntrada && mov.matVerdeSalida) {
                        analisis[mov.cultivo].consumoTotal += (mov.matVerdeEntrada - mov.matVerdeSalida);
                    }
                });

                const items = Object.entries(analisis);
                
                if (items.length === 0) {
                    return '<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-title">Sin datos para analizar</div></div>';
                }

                return `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo de Cultivo</th>
                                    <th>Veces Usado</th>
                                    <th>D铆as Totales</th>
                                    <th>Prom. D铆as/Uso</th>
                                    <th>Consumo Prom.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(([cultivo, data]) => `
                                    <tr>
                                        <td><strong>${cultivo}</strong></td>
                                        <td>${data.usos}</td>
                                        <td>${data.diasTotales}</td>
                                        <td>${data.usos > 0 ? (data.diasTotales / data.usos).toFixed(1) : 0} d铆as</td>
                                        <td>${data.usos > 0 ? (data.consumoTotal / data.usos).toFixed(0) : 0} kg/ha</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            // ========================================
            // GESTIN DE POTREROS
            // ========================================
            openPotreroModal: function(id = null) {
                document.getElementById('potreroEditId').value = id || '';
                
                if (id) {
                    const potrero = this.data.potreros.find(p => p.id === id);
                    if (potrero) {
                        document.getElementById('modalPotreroTitle').textContent = 'Editar Potrero';
                        document.getElementById('potreroId').value = potrero.id;
                        document.getElementById('potreroId').readOnly = true;
                        document.getElementById('potreroUbicacion').value = potrero.ubicacion;
                        document.getElementById('potreroSuperficie').value = potrero.superficie;
                        document.getElementById('potreroLatitud').value = potrero.latitud || '';
                        document.getElementById('potreroLongitud').value = potrero.longitud || '';
                    }
                } else {
                    document.getElementById('modalPotreroTitle').textContent = 'Nuevo Potrero';
                    document.getElementById('formPotrero').reset();
                    document.getElementById('potreroId').readOnly = false;
                }
                
                this.openModal('modalPotrero');
            },

            savePotrero: function(e) {
                e.preventDefault();
                
                const editId = document.getElementById('potreroEditId').value;
                const id = document.getElementById('potreroId').value.trim().toUpperCase();
                const ubicacion = document.getElementById('potreroUbicacion').value.trim();
                const superficie = parseFloat(document.getElementById('potreroSuperficie').value);
                const latitud = parseFloat(document.getElementById('potreroLatitud').value) || null;
                const longitud = parseFloat(document.getElementById('potreroLongitud').value) || null;

                // Validar coordenadas si se proporcionan
                if ((latitud && !longitud) || (!latitud && longitud)) {
                    this.notify('warning', 'Coordenadas Incompletas', 'Debes proporcionar tanto latitud como longitud');
                    return;
                }

                if (!editId) {
                    // Nuevo potrero
                    if (this.data.potreros.find(p => p.id === id)) {
                        this.notify('error', 'Error', 'Ya existe un potrero con ese ID');
                        return;
                    }
                    
                    const newPotrero = { id, ubicacion, superficie, latitud, longitud };
                    this.data.potreros.push(newPotrero);
                    
                    // Registrar en historial
                    this.changeHistory.recordChange('create', 'potrero', id, { data: newPotrero });
                    
                    // Trigger plugin hook
                    this.pluginSystem.triggerHook('potrero:created', newPotrero);
                    
                    this.notify('success', 'Potrero Creado', `El potrero ${id} fue creado exitosamente${latitud ? ' con coordenadas GPS' : ''}`);
                } else {
                    // Editar potrero
                    const index = this.data.potreros.findIndex(p => p.id === editId);
                    if (index !== -1) {
                        const before = { ...this.data.potreros[index] };
                        this.data.potreros[index].ubicacion = ubicacion;
                        this.data.potreros[index].superficie = superficie;
                        this.data.potreros[index].latitud = latitud;
                        this.data.potreros[index].longitud = longitud;
                        
                        // Registrar en historial con estado anterior
                        this.changeHistory.recordChange('update', 'potrero', id, { before, after: this.data.potreros[index] });
                        
                        this.notify('success', 'Potrero Actualizado', `Los datos del potrero ${id} fueron actualizados`);
                    }
                }

                this.saveData();
                this.closeModal('modalPotrero');
                this.navigate('potreros');
            },

            editPotrero: function(id) {
                this.openPotreroModal(id);
            },

            deletePotrero: function(id) {
                if (confirm(`驴Est谩 seguro que desea eliminar el potrero ${id}?\n\nEsta acci贸n se puede deshacer con Ctrl+Z.`)) {
                    const potrero = this.data.potreros.find(p => p.id === id);
                    
                    // Registrar en historial con backup para poder restaurar
                    this.changeHistory.recordChange('delete', 'potrero', id, { backup: { ...potrero } });
                    
                    this.data.potreros = this.data.potreros.filter(p => p.id !== id);
                    this.saveData();
                    this.notify('success', 'Potrero Eliminado', `El potrero ${id} fue eliminado. Presiona Ctrl+Z para deshacer.`);
                    this.navigate('potreros');
                }
            },

            // ========================================
            // FUNCIONES DE POLGONOS DE POTREROS
            // ========================================
            
            calcularAreaPoligono: function(polygon) {
                if (!polygon || polygon.length < 3) return 0;
                
                // Calcular 谩rea usando f贸rmula de Shoelace
                let area = 0;
                for (let i = 0; i < polygon.length; i++) {
                    const j = (i + 1) % polygon.length;
                    area += polygon[i][1] * polygon[j][0];
                    area -= polygon[j][1] * polygon[i][0];
                }
                area = Math.abs(area / 2.0);
                
                // Convertir a metros cuadrados (aproximado)
                const areaM2 = area * 12321000000 * Math.cos(polygon[0][0] * Math.PI / 180);
                return areaM2 / 10000; // Convertir a hect谩reas
            },

            importPotrerosKML: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const kmlText = e.target.result;
                        const parser = new DOMParser();
                        const kml = parser.parseFromString(kmlText, 'text/xml');
                        
                        const placemarks = kml.getElementsByTagName('Placemark');
                        let importados = 0;
                        let actualizados = 0;
                        
                        for (let i = 0; i < placemarks.length; i++) {
                            const placemark = placemarks[i];
                            
                            // Obtener nombre del placemark (ser谩 el ID del potrero)
                            const nameEl = placemark.getElementsByTagName('name')[0];
                            if (!nameEl) continue;
                            
                            const potreroId = nameEl.textContent.trim().toUpperCase();
                            if (!potreroId) continue;
                            
                            // Obtener descripci贸n si existe (ser谩 la ubicaci贸n)
                            const descEl = placemark.getElementsByTagName('description')[0];
                            const ubicacion = descEl ? descEl.textContent.trim() : potreroId;
                            
                            // Obtener coordenadas
                            const coords = placemark.getElementsByTagName('coordinates')[0];
                            if (!coords) continue;
                            
                            const coordsText = coords.textContent.trim();
                            const points = coordsText.split(/\s+/);
                            const polygon = [];
                            
                            points.forEach(point => {
                                const parts = point.split(',');
                                if (parts.length >= 2) {
                                    const lng = parseFloat(parts[0]);
                                    const lat = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        polygon.push([lat, lng]);
                                    }
                                }
                            });
                            
                            if (polygon.length < 3) continue; // Necesita al menos 3 v茅rtices
                            
                            // Calcular centro del pol铆gono (promedio de coordenadas)
                            let latSum = 0, lngSum = 0;
                            polygon.forEach(p => {
                                latSum += p[0];
                                lngSum += p[1];
                            });
                            const centroLat = latSum / polygon.length;
                            const centroLng = lngSum / polygon.length;
                            
                            // Calcular 谩rea autom谩ticamente
                            const areaCalculada = this.calcularAreaPoligono(polygon);
                            
                            // Verificar si el potrero ya existe
                            const existente = this.data.potreros.find(p => p.id === potreroId);
                            
                            if (existente) {
                                // Actualizar potrero existente
                                existente.polygon = polygon;
                                existente.latitud = centroLat;
                                existente.longitud = centroLng;
                                existente.superficie = areaCalculada.toFixed(2);
                                actualizados++;
                            } else {
                                // Crear nuevo potrero
                                this.data.potreros.push({
                                    id: potreroId,
                                    ubicacion: ubicacion,
                                    superficie: areaCalculada.toFixed(2),
                                    latitud: centroLat,
                                    longitud: centroLng,
                                    polygon: polygon
                                });
                                importados++;
                            }
                        }
                        
                        if (importados > 0 || actualizados > 0) {
                            this.saveData();
                            let mensaje = '';
                            if (importados > 0) mensaje += `${importados} potrero(s) importado(s)`;
                            if (actualizados > 0) {
                                if (importados > 0) mensaje += ' y ';
                                mensaje += `${actualizados} potrero(s) actualizado(s)`;
                            }
                            this.notify('success', 'Importaci贸n Exitosa', mensaje);
                            this.navigate('potreros');
                        } else {
                            this.notify('warning', 'Sin Datos', 'No se encontraron pol铆gonos v谩lidos en el archivo KML');
                        }
                        
                    } catch (error) {
                        console.error('Error importando KML:', error);
                        this.notify('error', 'Error de Importaci贸n', 'El archivo KML no pudo ser procesado correctamente');
                    }
                };
                
                reader.readAsText(file);
                input.value = ''; // Reset input
            },

            dibujarPoligonoPotrero: function(potreroId) {
                const potrero = this.data.potreros.find(p => p.id === potreroId);
                if (!potrero) {
                    this.notify('error', 'Potrero no encontrado', 'No se pudo encontrar el potrero especificado');
                    return;
                }
                
                // Guardar ID del potrero actual
                this.currentPotreroId = potreroId;
                this.currentPolygon = null;
                
                // Actualizar t铆tulo del modal
                document.getElementById('modalPoligonoTitle').textContent = `Dibujar Pol铆gono: ${potreroId}`;
                
                // Mostrar modal
                document.getElementById('modalPoligonoMapa').style.display = 'flex';
                
                // Inicializar mapa despu茅s de un peque帽o delay para que el modal est茅 visible
                setTimeout(() => {
                    this.initMapaPoligono(potrero);
                }, 100);
            },

            verPoligonoPotrero: function(potreroId) {
                const potrero = this.data.potreros.find(p => p.id === potreroId);
                if (!potrero || !potrero.polygon) {
                    this.notify('error', 'Sin Pol铆gono', 'Este potrero no tiene pol铆gono definido');
                    return;
                }
                
                // Guardar ID del potrero actual
                this.currentPotreroId = potreroId;
                this.currentPolygon = potrero.polygon;
                
                // Actualizar t铆tulo del modal
                document.getElementById('modalPoligonoTitle').textContent = `Ver/Editar Pol铆gono: ${potreroId}`;
                
                // Mostrar modal
                document.getElementById('modalPoligonoMapa').style.display = 'flex';
                
                // Inicializar mapa con pol铆gono existente
                setTimeout(() => {
                    this.initMapaPoligono(potrero, true);
                }, 100);
            },

            initMapaPoligono: function(potrero, mostrarExistente = false) {
                // Destruir mapa existente si hay
                if (this.mapaPoligono) {
                    this.mapaPoligono.remove();
                    this.mapaPoligono = null;
                }

                // Determinar centro del mapa
                let centerLat, centerLng, initialZoom;
                
                if (mostrarExistente && potrero.polygon && potrero.polygon.length > 0) {
                    // Centrar en pol铆gono existente
                    let latSum = 0, lngSum = 0;
                    potrero.polygon.forEach(p => {
                        latSum += p[0];
                        lngSum += p[1];
                    });
                    centerLat = latSum / potrero.polygon.length;
                    centerLng = lngSum / potrero.polygon.length;
                    initialZoom = 15;
                } else if (potrero.latitud && potrero.longitud) {
                    // Centrar en coordenadas GPS
                    centerLat = potrero.latitud;
                    centerLng = potrero.longitud;
                    initialZoom = 15;
                } else {
                    // Centrar en Venezuela
                    centerLat = 8.5;
                    centerLng = -67.5;
                    initialZoom = 7;
                }

                // Crear mapa
                this.mapaPoligono = L.map('mapPoligono').setView([centerLat, centerLng], initialZoom);

                // Capa satelital
                L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                }).addTo(this.mapaPoligono);

                // Capa para elementos dibujados
                this.drawnItemsPoligono = new L.FeatureGroup();
                this.mapaPoligono.addLayer(this.drawnItemsPoligono);

                // Si hay pol铆gono existente, mostrarlo
                if (mostrarExistente && potrero.polygon && potrero.polygon.length > 0) {
                    const polygon = L.polygon(potrero.polygon, {
                        color: '#00a67d',
                        weight: 3,
                        fillOpacity: 0.2
                    }).addTo(this.drawnItemsPoligono);
                    
                    this.currentPolygon = potrero.polygon;
                    
                    // Calcular y mostrar 谩rea
                    const area = this.calcularAreaPoligono(potrero.polygon);
                    document.getElementById('poligonoArea').textContent = area.toFixed(2) + ' Ha';
                    document.getElementById('poligonoStats').classList.remove('hidden');
                    document.getElementById('btnGuardarPoligono').disabled = false;
                    
                    // Ajustar vista al pol铆gono
                    this.mapaPoligono.fitBounds(polygon.getBounds());
                }

                // Controles de dibujo
                const drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polygon: {
                            shapeOptions: {
                                color: '#00a67d',
                                weight: 3,
                                fillOpacity: 0.2
                            },
                            allowIntersection: false,
                            showArea: true
                        },
                        polyline: false,
                        marker: false,
                        circle: false,
                        rectangle: {
                            shapeOptions: {
                                color: '#00a67d',
                                weight: 3,
                                fillOpacity: 0.2
                            }
                        },
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: this.drawnItemsPoligono,
                        remove: true
                    }
                });
                this.mapaPoligono.addControl(drawControl);

                // Evento cuando se dibuja un pol铆gono
                this.mapaPoligono.on(L.Draw.Event.CREATED, (e) => {
                    // Limpiar pol铆gonos anteriores
                    this.drawnItemsPoligono.clearLayers();
                    
                    const layer = e.layer;
                    this.drawnItemsPoligono.addLayer(layer);
                    
                    // Guardar coordenadas del pol铆gono
                    this.currentPolygon = layer.getLatLngs()[0].map(ll => [ll.lat, ll.lng]);
                    
                    // Calcular 谩rea
                    const area = this.calcularAreaPoligono(this.currentPolygon);
                    document.getElementById('poligonoArea').textContent = area.toFixed(2) + ' Ha';
                    document.getElementById('poligonoStats').classList.remove('hidden');
                    document.getElementById('btnGuardarPoligono').disabled = false;
                });

                // Evento cuando se edita
                this.mapaPoligono.on(L.Draw.Event.EDITED, (e) => {
                    e.layers.eachLayer((layer) => {
                        this.currentPolygon = layer.getLatLngs()[0].map(ll => [ll.lat, ll.lng]);
                        const area = this.calcularAreaPoligono(this.currentPolygon);
                        document.getElementById('poligonoArea').textContent = area.toFixed(2) + ' Ha';
                    });
                });

                // Evento cuando se borra
                this.mapaPoligono.on(L.Draw.Event.DELETED, (e) => {
                    this.currentPolygon = null;
                    document.getElementById('poligonoStats').classList.add('hidden');
                    document.getElementById('btnGuardarPoligono').disabled = true;
                });
            },

            guardarPoligonoPotrero: function() {
                if (!this.currentPolygon || !this.currentPotreroId) {
                    this.notify('error', 'Error', 'No hay pol铆gono para guardar');
                    return;
                }
                
                const potrero = this.data.potreros.find(p => p.id === this.currentPotreroId);
                if (!potrero) {
                    this.notify('error', 'Error', 'Potrero no encontrado');
                    return;
                }
                
                // Guardar pol铆gono
                potrero.polygon = this.currentPolygon;
                
                // Calcular y actualizar centro
                let latSum = 0, lngSum = 0;
                this.currentPolygon.forEach(p => {
                    latSum += p[0];
                    lngSum += p[1];
                });
                potrero.latitud = latSum / this.currentPolygon.length;
                potrero.longitud = lngSum / this.currentPolygon.length;
                
                // Calcular y actualizar 谩rea
                const area = this.calcularAreaPoligono(this.currentPolygon);
                potrero.superficie = area.toFixed(2);
                
                this.saveData();
                this.notify('success', 'Pol铆gono Guardado', `El pol铆gono del potrero ${this.currentPotreroId} fue guardado (rea: ${area.toFixed(2)} Ha)`);
                this.closeModalPoligono();
                this.navigate('potreros');
            },

            closeModalPoligono: function() {
                document.getElementById('modalPoligonoMapa').style.display = 'none';
                if (this.mapaPoligono) {
                    this.mapaPoligono.remove();
                    this.mapaPoligono = null;
                }
                this.currentPotreroId = null;
                this.currentPolygon = null;
                this.drawnItemsPoligono = null;
                document.getElementById('poligonoStats').classList.add('hidden');
                document.getElementById('btnGuardarPoligono').disabled = true;
                // Limpiar b煤squeda
                const searchInput = document.getElementById('poligonoSearchInput');
                if (searchInput) searchInput.value = '';
                const searchResults = document.getElementById('poligonoSearchResults');
                if (searchResults) searchResults.classList.remove('active');
            },

            // ========================================
            //  BSQUEDA DE UBICACIONES EN MAPAS (GEOCODING)
            // ========================================
            
            // Buscar ubicaci贸n en el modal de pol铆gono
            searchLocationPoligono: function() {
                const input = document.getElementById('poligonoSearchInput');
                const query = input.value.trim();
                if (!query) {
                    this.notify('warning', 'B煤squeda vac铆a', 'Escribe una ciudad, localidad o direcci贸n');
                    return;
                }
                this.performGeoSearch(query, 'poligono');
            },
            
            // Buscar ubicaci贸n en el mapa satelital
            searchLocationMapa: function() {
                const input = document.getElementById('mapaSearchInput');
                const query = input.value.trim();
                if (!query) {
                    this.notify('warning', 'B煤squeda vac铆a', 'Escribe una ciudad, localidad o direcci贸n');
                    return;
                }
                this.performGeoSearch(query, 'mapa');
            },
            
            // Realizar b煤squeda de geocoding con Nominatim
            performGeoSearch: async function(query, targetMap) {
                const resultsContainer = document.getElementById(targetMap === 'poligono' ? 'poligonoSearchResults' : 'mapaSearchResults');
                
                // Mostrar loading
                resultsContainer.innerHTML = '<div class="map-search-loading"><i class="fa-solid fa-spinner fa-spin"></i> Buscando...</div>';
                resultsContainer.classList.add('active');
                
                try {
                    // Usar Nominatim (OpenStreetMap) para geocoding gratuito
                    // Agregar preferencia por Venezuela y Latinoam茅rica
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1&viewbox=-73,-1,-60,12&bounded=0`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'Accept-Language': 'es',
                            'User-Agent': 'WIN-TEL-AgroManager-PRO/2.0'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error en la b煤squeda');
                    
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="map-search-no-results">
                                <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                <div>No se encontraron resultados para "${query}"</div>
                                <div style="font-size: 11px; margin-top: 4px;">Intenta con otro nombre o agrega el pa铆s</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Mostrar resultados
                    resultsContainer.innerHTML = results.map((r, index) => {
                        const type = this.getLocationIcon(r.type, r.class);
                        const name = r.display_name.split(',')[0];
                        const detail = r.display_name.split(',').slice(1, 3).join(',');
                        
                        return `
                            <div class="map-search-result-item" onclick="app.selectSearchLocation(${r.lat}, ${r.lon}, '${targetMap}', '${name.replace(/'/g, "\\'")}')">
                                <div class="map-search-result-icon">${type}</div>
                                <div class="map-search-result-text">
                                    <div class="map-search-result-name">${name}</div>
                                    <div class="map-search-result-detail">${detail}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error en geocoding:', error);
                    resultsContainer.innerHTML = `
                        <div class="map-search-no-results">
                            <div style="font-size: 24px; margin-bottom: 8px;">锔</div>
                            <div>Error al buscar</div>
                            <div style="font-size: 11px; margin-top: 4px;">Verifica tu conexi贸n a internet</div>
                        </div>
                    `;
                }
            },
            
            // Obtener icono seg煤n tipo de lugar
            getLocationIcon: function(type, placeClass) {
                const icons = {
                    'city': '锔',
                    'town': '锔',
                    'village': '',
                    'hamlet': '',
                    'suburb': '锔',
                    'neighbourhood': '锔',
                    'administrative': '锔',
                    'boundary': '',
                    'place': '',
                    'highway': 'ｏ',
                    'natural': '',
                    'waterway': '',
                    'landuse': '',
                    'farm': '',
                    'farmland': ''
                };
                return icons[type] || icons[placeClass] || '';
            },
            
            // Seleccionar ubicaci贸n y mover el mapa
            selectSearchLocation: function(lat, lon, targetMap, name) {
                const resultsContainer = document.getElementById(targetMap === 'poligono' ? 'poligonoSearchResults' : 'mapaSearchResults');
                resultsContainer.classList.remove('active');
                
                // Actualizar input con el nombre seleccionado
                const input = document.getElementById(targetMap === 'poligono' ? 'poligonoSearchInput' : 'mapaSearchInput');
                input.value = name;
                
                // Mover el mapa correspondiente
                if (targetMap === 'poligono' && this.mapaPoligono) {
                    this.mapaPoligono.setView([lat, lon], 15);
                    
                    // Agregar marcador temporal
                    if (this.searchMarkerPoligono) {
                        this.mapaPoligono.removeLayer(this.searchMarkerPoligono);
                    }
                    this.searchMarkerPoligono = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'search-marker',
                            html: '<div style="background: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(this.mapaPoligono);
                    
                    this.notify('success', 'Ubicaci贸n encontrada', `Mapa centrado en: ${name}`);
                    
                } else if (targetMap === 'mapa' && this.mapa) {
                    this.mapa.setView([lat, lon], 15);
                    
                    // Agregar marcador temporal
                    if (this.searchMarkerMapa) {
                        this.mapa.removeLayer(this.searchMarkerMapa);
                    }
                    this.searchMarkerMapa = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'search-marker',
                            html: '<div style="background: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(this.mapa);
                    
                    this.notify('success', 'Ubicaci贸n encontrada', `Mapa centrado en: ${name}`);
                }
            },
            
            // Ocultar resultados de b煤squeda al hacer click fuera
            initSearchListeners: function() {
                document.addEventListener('click', (e) => {
                    // Cerrar resultados de b煤squeda de pol铆gono
                    const poligonoContainer = document.getElementById('poligonoSearchContainer');
                    const poligonoResults = document.getElementById('poligonoSearchResults');
                    if (poligonoContainer && poligonoResults && !poligonoContainer.contains(e.target)) {
                        poligonoResults.classList.remove('active');
                    }
                    
                    // Cerrar resultados de b煤squeda de mapa
                    const mapaContainer = document.getElementById('mapaSearchContainer');
                    const mapaResults = document.getElementById('mapaSearchResults');
                    if (mapaContainer && mapaResults && !mapaContainer.contains(e.target)) {
                        mapaResults.classList.remove('active');
                    }
                });
            },

            // ========================================
            // GESTIN DE MOVIMIENTOS
            // ========================================
            openModal: function(modalId) {
                if (modalId === 'modalEntrada') {
                    // Cargar potreros libres
                    const libres = this.data.potreros.filter(p => {
                        return !this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                    });
                    
                    const select = document.getElementById('entradaPotrero');
                    select.innerHTML = '<option value="">Seleccionar potrero...</option>';
                    libres.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.id} - ${p.ubicacion} (${p.superficie} Ha)</option>`;
                    });

                    if (libres.length === 0) {
                        this.notify('warning', 'Sin Potreros Disponibles', 'Todos los potreros est谩n ocupados. Registre primero una salida.');
                        return;
                    }
                }

                if (modalId === 'modalSalida') {
                    // Cargar movimientos activos
                    const activos = this.data.movimientos.filter(m => m.estado === 'activo');
                    
                    const select = document.getElementById('salidaMovimiento');
                    select.innerHTML = '<option value="">Seleccionar...</option>';
                    activos.forEach(m => {
                        const dias = this.calcularDias(m.fechaEntrada);
                        select.innerHTML += `<option value="${m.id}">${m.potreroId} - ${m.cultivo} (${dias} d铆as)</option>`;
                    });

                    if (activos.length === 0) {
                        this.notify('warning', 'Sin Movimientos Activos', 'No hay movimientos activos para registrar salida.');
                        return;
                    }
                }

                document.getElementById(modalId).classList.add('active');
            },

            closeModal: function(modalId) {
                document.getElementById(modalId).classList.remove('active');
                
                // Resetear formularios
                if (modalId === 'modalPotrero') {
                    document.getElementById('formPotrero').reset();
                } else if (modalId === 'modalEntrada') {
                    document.getElementById('formEntrada').reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('entradaFecha').value = today;
                } else if (modalId === 'modalSalida') {
                    document.getElementById('formSalida').reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('salidaFecha').value = today;
                }
            },

            updatePotreroInfo: function(tipo) {
                const potreroId = document.getElementById('entradaPotrero').value;
                if (!potreroId) {
                    document.getElementById('entradaPotreroInfo').classList.add('hidden');
                    return;
                }

                const potrero = this.data.potreros.find(p => p.id === potreroId);
                if (potrero) {
                    document.getElementById('entradaPotreroInfoText').textContent = 
                        `${potrero.ubicacion} - ${potrero.superficie} Ha`;
                    document.getElementById('entradaPotreroInfo').classList.remove('hidden');
                }
            },

            updateMovimientoInfo: function() {
                const movId = parseInt(document.getElementById('salidaMovimiento').value);
                if (!movId) {
                    document.getElementById('salidaMovInfo').classList.add('hidden');
                    return;
                }

                const mov = this.data.movimientos.find(m => m.id === movId);
                if (mov) {
                    const dias = this.calcularDias(mov.fechaEntrada);
                    document.getElementById('salidaMovInfoText').textContent = 
                        `${mov.potreroId} - Entrada: ${this.formatDate(mov.fechaEntrada)} (${dias} d铆as)`;
                    document.getElementById('salidaMovInfo').classList.remove('hidden');
                }
            },

            saveEntrada: function(e) {
                e.preventDefault();
                
                const potreroId = document.getElementById('entradaPotrero').value;
                const fechaEntrada = document.getElementById('entradaFecha').value;
                const cultivo = document.getElementById('entradaCultivo').value;
                const matVerdeEntrada = parseFloat(document.getElementById('entradaMatVerde').value) || null;
                const obsEstandarEntrada = document.getElementById('entradaObsEst').value;
                const obsAdicionalesEntrada = document.getElementById('entradaObsAd').value.trim();

                const potrero = this.data.potreros.find(p => p.id === potreroId);
                
                const nuevoMov = {
                    id: Date.now(),
                    potreroId,
                    ubicacion: potrero.ubicacion,
                    superficie: potrero.superficie,
                    cultivo,
                    fechaEntrada,
                    matVerdeEntrada,
                    obsEstandarEntrada,
                    obsAdicionalesEntrada,
                    estado: 'activo',
                    fechaSalida: null,
                    matVerdeSalida: null,
                    obsEstandarSalida: null,
                    obsAdicionalesSalida: null,
                    permanencia: null
                };

                this.data.movimientos.push(nuevoMov);
                
                // Registrar en historial
                this.changeHistory.recordChange('create', 'movimiento', nuevoMov.id, { data: nuevoMov });
                
                // Trigger plugin hook
                this.pluginSystem.triggerHook('movimiento:registered', nuevoMov);
                
                this.saveData();
                this.closeModal('modalEntrada');
                this.notify('success', 'Entrada Registrada', `Entrada registrada en potrero ${potreroId}`);
                this.navigate('dashboard');
            },

            openSalidaModal: function(movId) {
                const mov = this.data.movimientos.find(m => m.id === movId);
                if (!mov) return;

                // Pre-seleccionar el movimiento
                this.openModal('modalSalida');
                document.getElementById('salidaMovimiento').value = movId;
                this.updateMovimientoInfo();
            },

            saveSalida: function(e) {
                e.preventDefault();
                
                const movId = parseInt(document.getElementById('salidaMovimiento').value);
                const fechaSalida = document.getElementById('salidaFecha').value;
                const matVerdeSalida = parseFloat(document.getElementById('salidaMatVerde').value) || null;
                const obsEstandarSalida = document.getElementById('salidaObsEst').value;
                const obsAdicionalesSalida = document.getElementById('salidaObsAd').value.trim();

                const movIndex = this.data.movimientos.findIndex(m => m.id === movId);
                if (movIndex === -1) return;

                const mov = this.data.movimientos[movIndex];

                // Validar que la fecha de salida sea posterior a la de entrada
                const entrada = new Date(mov.fechaEntrada);
                const salida = new Date(fechaSalida);
                
                if (salida < entrada) {
                    this.notify('error', 'Error de Fechas', 'La fecha de salida no puede ser anterior a la de entrada');
                    return;
                }

                // Calcular permanencia
                const diffTime = Math.abs(salida - entrada);
                const permanencia = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;

                // Actualizar movimiento
                mov.fechaSalida = fechaSalida;
                mov.matVerdeSalida = matVerdeSalida;
                mov.obsEstandarSalida = obsEstandarSalida;
                mov.obsAdicionalesSalida = obsAdicionalesSalida;
                mov.permanencia = permanencia;
                mov.estado = 'finalizado';

                this.saveData();
                this.closeModal('modalSalida');
                this.notify('success', 'Salida Registrada', `Permanencia: ${permanencia} d铆as en potrero ${mov.potreroId}`);
                this.navigate('dashboard');
            },

            // ========================================
            // CLCULOS Y ESTADSTICAS
            // ========================================
            calculateStats: function(forceRefresh = false) {
                const cacheKey = 'stats_' + this.data.potreros.length + '_' + this.data.movimientos.length;
                
                if (!forceRefresh) {
                    const cached = PerformanceCache.get(cacheKey);
                    if (cached) return cached;
                }
                
                const totalPotreros = this.data.potreros.length;
                const ocupados = this.data.movimientos.filter(m => m.estado === 'activo').length;
                const libres = totalPotreros - ocupados;
                const superficieTotal = this.data.potreros.reduce((sum, p) => sum + parseFloat(p.superficie || 0), 0);

                const result = { totalPotreros, ocupados, libres, superficieTotal };
                PerformanceCache.set(cacheKey, result, 60000); // Cache 1 minuto
                return result;
            },

            calculateAdvancedStats: function(forceRefresh = false) {
                const cacheKey = 'advStats_' + this.data.movimientos.length;
                
                if (!forceRefresh) {
                    const cached = PerformanceCache.get(cacheKey);
                    if (cached) return cached;
                }
                
                const finalizados = this.data.movimientos.filter(m => m.estado === 'finalizado');
                const totalMovimientos = finalizados.length;
                
                let sumaPermanencia = 0;
                let sumaConsumo = 0;
                let conteoConsumo = 0;

                finalizados.forEach(mov => {
                    if (mov.permanencia) {
                        sumaPermanencia += mov.permanencia;
                    }
                    if (mov.matVerdeEntrada && mov.matVerdeSalida) {
                        sumaConsumo += (mov.matVerdeEntrada - mov.matVerdeSalida);
                        conteoConsumo++;
                    }
                });

                const promedioPermanencia = totalMovimientos > 0 ? (sumaPermanencia / totalMovimientos).toFixed(1) : 0;
                const consumoPromedio = conteoConsumo > 0 ? (sumaConsumo / conteoConsumo).toFixed(0) : 0;
                const tasaUso = this.data.potreros.length > 0 ? 
                    ((totalMovimientos / this.data.potreros.length) * 100).toFixed(1) : 0;

                const result = { totalMovimientos, promedioPermanencia, consumoPromedio, tasaUso };
                PerformanceCache.set(cacheKey, result, 60000);
                return result;
            },

            calcularDias: function(fechaEntrada) {
                const entrada = new Date(fechaEntrada);
                const hoy = new Date();
                const diffTime = Math.abs(hoy - entrada);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },

            // ========================================
            // EXPORTACIN DE DATOS
            // ========================================
            exportarCSV: function(tipo) {
                let csv = '';
                let filename = '';

                if (tipo === 'potreros') {
                    csv = 'ID Potrero,Ubicaci贸n,Superficie (Ha),Estado\n';
                    this.data.potreros.forEach(p => {
                        const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                        csv += `${p.id},${p.ubicacion},${p.superficie},${ocupado ? 'Ocupado' : 'Libre'}\n`;
                    });
                    filename = 'potreros.csv';
                } else if (tipo === 'movimientos') {
                    csv = 'Potrero,Cultivo,Fecha Entrada,Fecha Salida,Permanencia,Mat. Verde Entrada,Mat. Verde Salida,Consumo,Obs. Entrada,Obs. Salida\n';
                    this.data.movimientos.filter(m => m.estado === 'finalizado').forEach(m => {
                        const consumo = (m.matVerdeEntrada || 0) - (m.matVerdeSalida || 0);
                        csv += `${m.potreroId},${m.cultivo},${m.fechaEntrada},${m.fechaSalida},${m.permanencia},${m.matVerdeEntrada || ''},${m.matVerdeSalida || ''},${consumo},${m.obsEstandarEntrada || ''},${m.obsEstandarSalida || ''}\n`;
                    });
                    filename = 'movimientos.csv';
                } else if (tipo === 'completo') {
                    csv = 'REPORTE COMPLETO DE GESTIN GANADERA\n\n';
                    csv += 'ESTADSTICAS GENERALES\n';
                    const stats = this.calculateStats();
                    csv += `Total Potreros,${stats.totalPotreros}\n`;
                    csv += `Ocupados,${stats.ocupados}\n`;
                    csv += `Disponibles,${stats.libres}\n`;
                    csv += `Superficie Total,${stats.superficieTotal} Ha\n\n`;
                    
                    csv += 'LISTADO DE POTREROS\n';
                    csv += 'ID,Ubicaci贸n,Superficie,Estado\n';
                    this.data.potreros.forEach(p => {
                        const ocupado = this.data.movimientos.find(m => m.potreroId === p.id && m.estado === 'activo');
                        csv += `${p.id},${p.ubicacion},${p.superficie},${ocupado ? 'Ocupado' : 'Libre'}\n`;
                    });
                    
                    csv += '\nHISTORIAL DE MOVIMIENTOS\n';
                    csv += 'Potrero,Cultivo,Entrada,Salida,D铆as,Mat.V.Entrada,Mat.V.Salida,Consumo\n';
                    this.data.movimientos.filter(m => m.estado === 'finalizado').forEach(m => {
                        const consumo = (m.matVerdeEntrada || 0) - (m.matVerdeSalida || 0);
                        csv += `${m.potreroId},${m.cultivo},${m.fechaEntrada},${m.fechaSalida},${m.permanencia},${m.matVerdeEntrada || ''},${m.matVerdeSalida || ''},${consumo}\n`;
                    });
                    
                    filename = 'reporte_completo.csv';
                }

                this.descargarArchivo(csv, filename, 'text/csv');
                this.notify('success', 'Exportaci贸n Exitosa', `Archivo ${filename} descargado`);
            },

            descargarBackup: function() {
                const backup = JSON.stringify(this.data, null, 2);
                const fecha = new Date().toISOString().split('T')[0];
                this.descargarArchivo(backup, `backup_nexus_agro_${fecha}.json`, 'application/json');
                this.notify('success', 'Respaldo Creado', 'Respaldo completo del sistema descargado');
            },

            restaurarBackup: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm('驴Est谩 seguro que desea restaurar este respaldo?\n\nEsto reemplazar谩 todos los datos actuales.')) {
                            this.data = data;
                            this.saveData();
                            this.notify('success', 'Restauraci贸n Exitosa', 'Los datos fueron restaurados correctamente');
                            this.navigate('dashboard');
                        }
                    } catch (error) {
                        this.notify('error', 'Error', 'El archivo no es un respaldo v谩lido');
                    }
                };
                reader.readAsText(file);
                
                input.value = '';
            },

            descargarArchivo: function(contenido, nombre, tipo) {
                const blob = new Blob([contenido], { type: tipo });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = nombre;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            // ========================================
            // CONFIGURACIN
            // ========================================
            resetearSistema: function() {
                const confirmacion = prompt('ADVERTENCIA: Esta acci贸n eliminar谩 TODOS los datos.\n\nEscriba "CONFIRMAR" para continuar:');
                
                if (confirmacion === 'CONFIRMAR') {
                    this.data.potreros = [];
                    this.data.movimientos = [];
                    this.saveData();
                    this.notify('success', 'Sistema Reseteado', 'Todos los datos fueron eliminados');
                    this.navigate('dashboard');
                }
            },

            // ========================================
            // PERSISTENCIA DE DATOS
            // ========================================
            saveData: function() {
                localStorage.setItem('nexusAgroData', JSON.stringify(this.data));
                
                // Invalidar cach茅 al guardar
                PerformanceCache.clear('stats');
                
                // Trigger plugin hook
                if (this.pluginSystem) {
                    this.pluginSystem.triggerHook('data:saved', this.data);
                }
                
                // Rebuild search index
                if (this.searchEngine && this.searchEngine.buildIndex) {
                    this.searchEngine.buildIndex();
                }
            },

            loadData: function() {
                const saved = localStorage.getItem('nexusAgroData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                }
            },

            // ========================================
            //  MOTOR DE BSQUEDA GLOBAL (CTRL+K)
            // ========================================
            searchEngine: {
                index: {},
                
                buildIndex() {
                    this.index = {
                        potreros: app.data.potreros.map(p => ({
                            id: p.id,
                            text: `${p.id} ${p.ubicacion} ${p.tags?.join(' ') || ''}`.toLowerCase(),
                            data: p
                        })),
                        movimientos: app.data.movimientos.map(m => ({
                            id: m.id,
                            text: `${m.potreroId} ${m.cultivo} ${m.obsEstandarEntrada || ''} ${m.obsAdicionalesEntrada || ''}`.toLowerCase(),
                            data: m
                        })),
                        acciones: [
                            { id: 'nueva_entrada', text: 'nueva entrada registrar ganado', action: () => app.openModal('modalEntrada'), icon: '', label: 'Nueva Entrada' },
                            { id: 'nuevo_potrero', text: 'nuevo potrero agregar crear', action: () => app.openPotreroModal(), icon: '猴', label: 'Nuevo Potrero' },
                            { id: 'exportar', text: 'exportar backup respaldo csv', action: () => app.navigate('exportar'), icon: '', label: 'Exportar Datos' },
                            { id: 'dashboard', text: 'dashboard inicio resumen', action: () => app.navigate('dashboard'), icon: '', label: 'Ver Dashboard' },
                            { id: 'reportes', text: 'reportes estadisticas analisis', action: () => app.navigate('reportes'), icon: '', label: 'Ver Reportes' },
                            { id: 'historial', text: 'historial movimientos registro', action: () => app.navigate('historial'), icon: '', label: 'Ver Historial' },
                            { id: 'mapa', text: 'mapa satelital ubicacion gps', action: () => app.navigate('mapa'), icon: '帮', label: 'Ver Mapa' },
                            { id: 'alertas', text: 'alertas notificaciones avisos', action: () => app.openAlertCenter(), icon: '', label: 'Centro de Alertas' },
                            { id: 'geomatica', text: 'geomatica subdivision terrenos', action: () => app.navigate('geomatica'), icon: '', label: 'Herramientas Geom谩ticas' }
                        ]
                    };
                },
                
                search(query, type = 'all', limit = 20) {
                    const normalizedQuery = query.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const results = [];
                    
                    if (type === 'all' || type === 'potreros') {
                        this.index.potreros.forEach(item => {
                            const score = this.calculateScore(item.text, normalizedQuery);
                            if (score > 0.3) {
                                const ocupado = app.data.movimientos.find(m => m.potreroId === item.data.id && m.estado === 'activo');
                                results.push({ type: 'potrero', score, data: item.data, estado: ocupado ? 'ocupado' : 'libre' });
                            }
                        });
                    }
                    
                    if (type === 'all' || type === 'movimientos') {
                        this.index.movimientos.forEach(item => {
                            const score = this.calculateScore(item.text, normalizedQuery);
                            if (score > 0.3) {
                                results.push({ type: 'movimiento', score, data: item.data });
                            }
                        });
                    }
                    
                    if (type === 'all' || type === 'acciones') {
                        this.index.acciones.forEach(item => {
                            const score = this.calculateScore(item.text, normalizedQuery);
                            if (score > 0.3) {
                                results.push({ type: 'accion', score, data: item });
                            }
                        });
                    }
                    
                    return results.sort((a, b) => b.score - a.score).slice(0, limit);
                },
                
                calculateScore(text, query) {
                    const words = query.split(/\s+/);
                    let totalScore = 0;
                    words.forEach(word => {
                        if (text.includes(word)) {
                            totalScore += 1;
                            if (text.startsWith(word)) totalScore += 0.5;
                        }
                    });
                    return totalScore / words.length;
                }
            },
            
            openGlobalSearch: function() {
                this.searchEngine.buildIndex();
                
                const overlay = document.createElement('div');
                overlay.id = 'globalSearch';
                overlay.className = 'global-search-overlay';
                overlay.onclick = (e) => { if (e.target === overlay) this.closeGlobalSearch(); };
                
                overlay.innerHTML = `
                    <div class="global-search-container">
                        <div class="global-search-header">
                            <span class="global-search-icon"></span>
                            <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Buscar potreros, movimientos, acciones..." autocomplete="off">
                            <div class="global-search-shortcut"><kbd>Esc</kbd></div>
                        </div>
                        <div class="global-search-results" id="globalSearchResults">
                            <div class="search-category">Acciones R谩pidas</div>
                            ${this.searchEngine.index.acciones.slice(0, 5).map(a => `
                                <div class="search-result-item" onclick="app.executeSearchAction('${a.id}')">
                                    <div class="search-result-icon accion">${a.icon}</div>
                                    <div class="search-result-content">
                                        <div class="search-result-title">${a.label}</div>
                                        <div class="search-result-subtitle">Acci贸n del sistema</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="global-search-footer">
                            <span> Busca potreros por ID, ubicaci贸n o etiquetas</span>
                            <span> para seleccionar</span>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                const input = document.getElementById('globalSearchInput');
                input.focus();
                input.addEventListener('input', (e) => this.handleSearchInput(e.target.value));
            },
            
            closeGlobalSearch: function() {
                const overlay = document.getElementById('globalSearch');
                if (overlay) overlay.remove();
            },
            
            handleSearchInput: function(query) {
                const resultsContainer = document.getElementById('globalSearchResults');
                if (!query.trim()) {
                    resultsContainer.innerHTML = `
                        <div class="search-category">Acciones R谩pidas</div>
                        ${this.searchEngine.index.acciones.slice(0, 5).map(a => `
                            <div class="search-result-item" onclick="app.executeSearchAction('${a.id}')">
                                <div class="search-result-icon accion">${a.icon}</div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${a.label}</div>
                                    <div class="search-result-subtitle">Acci贸n del sistema</div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    return;
                }
                
                const results = this.searchEngine.search(query);
                if (results.length === 0) {
                    resultsContainer.innerHTML = `<div class="search-no-results"><div class="search-no-results-icon"></div><div>No se encontraron resultados</div></div>`;
                    return;
                }
                
                const grouped = {
                    acciones: results.filter(r => r.type === 'accion'),
                    potreros: results.filter(r => r.type === 'potrero'),
                    movimientos: results.filter(r => r.type === 'movimiento')
                };
                
                let html = '';
                if (grouped.acciones.length > 0) {
                    html += '<div class="search-category">Acciones</div>';
                    grouped.acciones.forEach(r => {
                        html += `<div class="search-result-item" onclick="app.executeSearchAction('${r.data.id}')">
                            <div class="search-result-icon accion">${r.data.icon}</div>
                            <div class="search-result-content"><div class="search-result-title">${r.data.label}</div></div>
                        </div>`;
                    });
                }
                if (grouped.potreros.length > 0) {
                    html += '<div class="search-category">Potreros</div>';
                    grouped.potreros.forEach(r => {
                        const badge = r.estado === 'ocupado' ? '<span class="badge ocupado" style="font-size:10px;">Ocupado</span>' : '<span class="badge libre" style="font-size:10px;">Libre</span>';
                        html += `<div class="search-result-item" onclick="app.closeGlobalSearch(); app.navigate('potreros');">
                            <div class="search-result-icon potrero">猴</div>
                            <div class="search-result-content"><div class="search-result-title">${r.data.id}</div><div class="search-result-subtitle">${r.data.ubicacion} - ${r.data.superficie} Ha</div></div>
                            ${badge}
                        </div>`;
                    });
                }
                if (grouped.movimientos.length > 0) {
                    html += '<div class="search-category">Movimientos</div>';
                    grouped.movimientos.forEach(r => {
                        const badge = r.data.estado === 'activo' ? '<span class="badge ocupado" style="font-size:10px;">Activo</span>' : '<span class="badge" style="font-size:10px;">Finalizado</span>';
                        html += `<div class="search-result-item" onclick="app.closeGlobalSearch(); app.navigate('historial');">
                            <div class="search-result-icon movimiento"></div>
                            <div class="search-result-content"><div class="search-result-title">${r.data.potreroId} - ${r.data.cultivo}</div></div>
                            ${badge}
                        </div>`;
                    });
                }
                resultsContainer.innerHTML = html;
            },
            
            executeSearchAction: function(actionId) {
                const action = this.searchEngine.index.acciones.find(a => a.id === actionId);
                if (action && action.action) { this.closeGlobalSearch(); action.action(); }
            },

            // ========================================
            //  SISTEMA DE ALERTAS EN TIEMPO REAL
            // ========================================
            alertsSystem: {
                alerts: [],
                
                init() {
                    this.checkAlerts();
                    setInterval(() => this.checkAlerts(), 300000);
                },
                
                checkAlerts() {
                    const newAlerts = [];
                    const ocupados = app.data.movimientos.filter(m => m.estado === 'activo');
                    
                    ocupados.forEach(mov => {
                        const dias = app.calcularDias(mov.fechaEntrada);
                        if (dias >= 7) {
                            newAlerts.push({
                                id: `long_stay_${mov.id}`,
                                type: dias >= 10 ? 'critical' : 'warning',
                                icon: '',
                                title: `Estancia prolongada: ${mov.potreroId}`,
                                message: `El potrero ${mov.potreroId} lleva ${dias} d铆as ocupado.`,
                                timestamp: new Date().toISOString(),
                                actions: [{ label: 'Registrar Salida', action: `app.openSalidaModal(${mov.id})` }]
                            });
                        }
                    });
                    
                    const stats = app.calculateStats();
                    if (stats.ocupados > stats.totalPotreros * 0.8 && stats.totalPotreros > 0) {
                        newAlerts.push({
                            id: 'high_occupation',
                            type: 'warning',
                            icon: '',
                            title: 'Alta ocupaci贸n',
                            message: `${stats.ocupados} de ${stats.totalPotreros} potreros ocupados.`,
                            timestamp: new Date().toISOString(),
                            actions: [{ label: 'Ver Dashboard', action: `app.navigate('dashboard')` }]
                        });
                    }
                    
                    newAlerts.forEach(newAlert => {
                        if (!this.alerts.find(a => a.id === newAlert.id)) this.alerts.unshift(newAlert);
                    });
                    this.alerts = this.alerts.slice(0, 50);
                    localStorage.setItem('nexusAgroAlerts', JSON.stringify(this.alerts));
                    this.updateIndicator();
                },
                
                updateIndicator() {
                    const active = this.alerts.filter(a => !a.dismissed);
                    let indicator = document.getElementById('alertIndicator');
                    if (!indicator && active.length > 0) {
                        const nav = document.querySelector('.sidebar-nav .nav-item');
                        if (nav) {
                            indicator = document.createElement('span');
                            indicator.id = 'alertIndicator';
                            indicator.className = 'alert-indicator';
                            nav.style.position = 'relative';
                            nav.appendChild(indicator);
                        }
                    }
                    if (indicator) {
                        indicator.textContent = active.length > 9 ? '9+' : active.length;
                        indicator.style.display = active.length > 0 ? 'flex' : 'none';
                    }
                },
                
                dismiss(alertId) {
                    const alert = this.alerts.find(a => a.id === alertId);
                    if (alert) { alert.dismissed = true; localStorage.setItem('nexusAgroAlerts', JSON.stringify(this.alerts)); this.updateIndicator(); }
                },
                
                clearAll() {
                    this.alerts.forEach(a => a.dismissed = true);
                    localStorage.setItem('nexusAgroAlerts', JSON.stringify(this.alerts));
                    this.updateIndicator();
                }
            },
            
            openAlertCenter: function() {
                const active = this.alertsSystem.alerts.filter(a => !a.dismissed);
                const overlay = document.createElement('div');
                overlay.id = 'alertCenter';
                overlay.className = 'alert-center-overlay';
                overlay.onclick = (e) => { if (e.target === overlay) this.closeAlertCenter(); };
                
                overlay.innerHTML = `
                    <div class="alert-center-container">
                        <div class="alert-center-header">
                            <div class="alert-center-title"><span></span> Centro de Alertas</div>
                            <button class="alert-center-close" onclick="app.closeAlertCenter()"></button>
                        </div>
                        <div class="alert-center-body" id="alertsList">
                            ${active.length > 0 ? active.map(alert => `
                                <div class="alert-item ${alert.type}">
                                    <div class="alert-icon">${alert.icon}</div>
                                    <div class="alert-content">
                                        <div class="alert-title">${alert.title}</div>
                                        <div class="alert-message">${alert.message}</div>
                                    </div>
                                    <div class="alert-actions">
                                        ${alert.actions ? alert.actions.map(a => `<button class="alert-action-btn primary" onclick="${a.action}; app.closeAlertCenter();">${a.label}</button>`).join('') : ''}
                                        <button class="alert-action-btn secondary" onclick="app.alertsSystem.dismiss('${alert.id}'); this.closest('.alert-item').remove();">Descartar</button>
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align:center;padding:40px;color:var(--gris-600);"><div style="font-size:48px;"></div><div>隆Todo en orden!</div></div>'}
                        </div>
                        <div style="padding:16px 24px;background:var(--gris-100);display:flex;justify-content:space-between;">
                            <button class="btn btn-secondary btn-small" onclick="app.alertsSystem.clearAll(); app.closeAlertCenter();">锔 Limpiar</button>
                            <button class="btn btn-primary btn-small" onclick="app.alertsSystem.checkAlerts(); app.closeAlertCenter(); app.openAlertCenter();"> Actualizar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            },
            
            closeAlertCenter: function() {
                const overlay = document.getElementById('alertCenter');
                if (overlay) overlay.remove();
            },

            // ========================================
            //  HISTORIAL DE CAMBIOS (CTRL+Z)
            // ========================================
            changeHistory: {
                history: [],
                maxHistory: 100,
                
                recordChange(type, entity, entityId, changes, userId) {
                    const entry = {
                        id: `ch_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        timestamp: new Date().toISOString(),
                        type, entity, entityId,
                        changes: changes,
                        userId: userId || app.currentUser?.usuario,
                        canUndo: true
                    };
                    this.history.unshift(entry);
                    this.history = this.history.slice(0, this.maxHistory);
                    localStorage.setItem('nexusAgroHistory', JSON.stringify(this.history));
                    return entry;
                },
                
                markAsUndone(changeId) {
                    const change = this.history.find(h => h.id === changeId);
                    if (change) { change.canUndo = false; localStorage.setItem('nexusAgroHistory', JSON.stringify(this.history)); }
                }
            },
            
            undoLastChange: function() {
                const undoable = this.changeHistory.history.filter(h => h.canUndo);
                if (undoable.length === 0) { this.notify('info', 'Sin cambios', 'No hay cambios que deshacer'); return; }
                
                const last = undoable[0];
                try {
                    if (last.type === 'create') {
                        if (last.entity === 'potrero') this.data.potreros = this.data.potreros.filter(p => p.id !== last.entityId);
                        else if (last.entity === 'movimiento') this.data.movimientos = this.data.movimientos.filter(m => m.id !== last.entityId);
                    } else if (last.type === 'delete' && last.changes.backup) {
                        if (last.entity === 'potrero') this.data.potreros.push(last.changes.backup);
                        else if (last.entity === 'movimiento') this.data.movimientos.push(last.changes.backup);
                    }
                    this.changeHistory.markAsUndone(last.id);
                    this.saveData();
                    this.searchEngine.buildIndex();
                    this.navigate(this.currentView);
                    this.notify('success', 'Deshecho', `Se deshizo: ${last.type} de ${last.entity}`);
                } catch (e) { this.notify('error', 'Error', 'No se pudo deshacer'); }
            },
            
            openHistoryPanel: function() {
                const history = this.changeHistory.history.slice(0, 20);
                const overlay = document.createElement('div');
                overlay.id = 'historyPanel';
                overlay.className = 'history-overlay';
                overlay.onclick = (e) => { if (e.target === overlay) this.closeHistoryPanel(); };
                
                overlay.innerHTML = `
                    <div class="history-container">
                        <div class="history-header">
                            <div style="display:flex;align-items:center;gap:10px;font-size:20px;font-weight:700;"><span></span> Historial</div>
                            <button class="alert-center-close" onclick="app.closeHistoryPanel()"></button>
                        </div>
                        <div class="history-body">
                            ${history.length > 0 ? history.map(h => `
                                <div class="history-item">
                                    <div class="history-icon ${h.type}">${h.type === 'create' ? '' : h.type === 'update' ? '锔' : '锔'}</div>
                                    <div class="history-content">
                                        <div class="history-title">${h.type} de ${h.entity} ${h.entityId}</div>
                                        <div class="history-meta"> ${new Date(h.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align:center;padding:40px;"> No hay historial</div>'}
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            },
            
            closeHistoryPanel: function() {
                const overlay = document.getElementById('historyPanel');
                if (overlay) overlay.remove();
            },

            // ========================================
            //  SISTEMA DE PLUGINS
            // ========================================
            pluginSystem: {
                plugins: new Map(),
                hooks: {
                    'potrero:created': [],
                    'movimiento:registered': [],
                    'data:saved': [],
                    'dashboard:rendered': []
                },
                
                register(name, plugin) {
                    this.plugins.set(name, plugin);
                    if (typeof plugin.init === 'function') plugin.init(app);
                    console.log(` Plugin registrado: ${name}`);
                },
                
                registerHook(hook, callback) {
                    if (!this.hooks[hook]) this.hooks[hook] = [];
                    this.hooks[hook].push(callback);
                },
                
                triggerHook(hook, data) {
                    if (!this.hooks[hook]) return data;
                    return this.hooks[hook].reduce((result, callback) => {
                        try { return callback(result, app) || result; }
                        catch (e) { console.error(`Error en hook ${hook}:`, e); return result; }
                    }, data);
                }
            },
            
            renderPluginsIndicator: function() {
                const indicator = document.createElement('div');
                indicator.className = 'plugins-indicator';
                indicator.innerHTML = `<span class="plugins-indicator-dot"></span> Sistema Mejorado v2.0`;
                indicator.onclick = () => this.notify('info', 'WIN-TEL AgroManager PRO v2.0', 'Sistema mejorado con b煤squeda global, alertas, historial y m谩s. Presiona F1 para ver atajos.');
                document.body.appendChild(indicator);
            },

            // ========================================
            // UTILIDADES
            // ========================================
            updateDate: function() {
                const ahora = new Date();
                const opciones = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                document.getElementById('currentDate').textContent = 
                    ahora.toLocaleDateString('es-ES', opciones);
            },

            formatDate: function(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            },

            notify: function(type, title, message) {
                const icons = {
                    success: '',
                    error: '',
                    warning: '锔',
                    info: '癸'
                };

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-icon">${icons[type] || '癸'}</div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            },

            // ========================================
            //  SISTEMA DE MONITOREO DE RED
            // ========================================
            initNetworkMonitor: function() {
                this.updateNetworkStatus();
                window.addEventListener('online', () => this.updateNetworkStatus());
                window.addEventListener('offline', () => this.updateNetworkStatus());
            },

            updateNetworkStatus: function() {
                const indicator = document.getElementById('networkIndicator');
                const textEl = document.getElementById('networkText');
                
                if (navigator.onLine) {
                    indicator.classList.remove('offline');
                    indicator.classList.add('online');
                    textEl.textContent = 'Conectado';
                } else {
                    indicator.classList.remove('online');
                    indicator.classList.add('offline');
                    textEl.textContent = 'Modo Offline - Datos Seguros';
                    this.notify('warning', 'Sin Conexi贸n', 'Trabajando en modo offline. Tus datos est谩n seguros en el dispositivo.');
                }
            },

            // ========================================
            //  SISTEMA DE FINANZAS (CAJA MENOR)
            // ========================================
            finanzasData: {
                movimientos: []
            },

            loadFinanzasData: function() {
                const saved = localStorage.getItem('nexus_finanzas');
                if (saved) {
                    try {
                        this.finanzasData = JSON.parse(saved);
                    } catch(e) {
                        this.finanzasData = { movimientos: [] };
                    }
                }
            },

            saveFinanzasData: function() {
                localStorage.setItem('nexus_finanzas', JSON.stringify(this.finanzasData));
            },

            calcularSaldoFinanzas: function() {
                const ingresos = this.finanzasData.movimientos
                    .filter(m => m.tipo === 'ingreso')
                    .reduce((sum, m) => sum + parseFloat(m.monto), 0);
                const egresos = this.finanzasData.movimientos
                    .filter(m => m.tipo === 'egreso')
                    .reduce((sum, m) => sum + parseFloat(m.monto), 0);
                return { ingresos, egresos, saldo: ingresos - egresos };
            },

            renderFinanzas: function() {
                const { ingresos, egresos, saldo } = this.calcularSaldoFinanzas();
                const movimientos = this.finanzasData.movimientos.slice().reverse().slice(0, 10);

                const html = `
                    <div class="finanzas-dashboard">
                        <div class="saldo-card">
                            <div class="saldo-card-icon"></div>
                            <div class="saldo-card-label">Saldo Actual</div>
                            <div class="saldo-card-value ${saldo >= 0 ? 'positivo' : 'negativo'}">
                                ${saldo >= 0 ? '+' : ''}${saldo.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                            <div class="saldo-card-subtitle">Bs. / $ (seg煤n su moneda)</div>
                        </div>

                        <div class="finanzas-resumen">
                            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <span></span> Resumen del Per铆odo
                            </h3>
                            <div class="finanzas-resumen-grid">
                                <div class="finanzas-stat ingresos">
                                    <div class="finanzas-stat-value">+${ingresos.toLocaleString('es-VE', { minimumFractionDigits: 2 })}</div>
                                    <div class="finanzas-stat-label">Total Ingresos</div>
                                </div>
                                <div class="finanzas-stat egresos">
                                    <div class="finanzas-stat-value">-${egresos.toLocaleString('es-VE', { minimumFractionDigits: 2 })}</div>
                                    <div class="finanzas-stat-label">Total Egresos</div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="app.openNuevoMovimientoFinanzas()" style="width: 100%;">
                                <span></span> Registrar Movimiento
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"></span>
                                ltimos Movimientos
                            </h3>
                            <button class="btn btn-secondary btn-small" onclick="app.exportarFinanzasCSV()">
                                <span></span> Exportar CSV
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            ${movimientos.length > 0 ? movimientos.map(mov => `
                                <div class="finanzas-movimiento-item">
                                    <div class="finanzas-movimiento-icon ${mov.tipo}">
                                        ${mov.tipo === 'ingreso' ? '' : ''}
                                    </div>
                                    <div class="finanzas-movimiento-info">
                                        <div class="finanzas-movimiento-concepto">${mov.concepto}</div>
                                        <div class="finanzas-movimiento-fecha">${this.formatDate(mov.fecha)}</div>
                                    </div>
                                    <div class="finanzas-movimiento-monto ${mov.tipo}">
                                        ${mov.tipo === 'ingreso' ? '+' : '-'}${parseFloat(mov.monto).toLocaleString('es-VE', { minimumFractionDigits: 2 })}
                                    </div>
                                    <button class="btn btn-secondary btn-small" onclick="app.eliminarMovimientoFinanzas('${mov.id}')" title="Eliminar">
                                        锔
                                    </button>
                                </div>
                            `).join('') : `
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-title">Sin Movimientos</div>
                                    <div class="empty-state-message">Registra tu primer ingreso o egreso</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;

                document.getElementById('contentArea').innerHTML = html;
            },

            openNuevoMovimientoFinanzas: function() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'modalFinanzas';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <span></span>
                                Nuevo Movimiento Financiero
                            </h3>
                            <button class="modal-close" onclick="document.getElementById('modalFinanzas').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Tipo de Movimiento *</label>
                                <div style="display: flex; gap: 12px;">
                                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 16px; border: 2px solid var(--gris-200); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="tipoMov" value="ingreso" checked style="accent-color: #10b981;">
                                        <span style="font-size: 20px;"></span>
                                        <span style="font-weight: 600;">Ingreso</span>
                                    </label>
                                    <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 16px; border: 2px solid var(--gris-200); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="tipoMov" value="egreso" style="accent-color: #ef4444;">
                                        <span style="font-size: 20px;"></span>
                                        <span style="font-weight: 600;">Egreso</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha *</label>
                                <input type="date" id="finFecha" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Concepto *</label>
                                <input type="text" id="finConcepto" class="form-input" placeholder="Ej: Venta de queso, Compra de vacunas..." required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Monto *</label>
                                <input type="number" id="finMonto" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalFinanzas').remove()">Cancelar</button>
                            <button class="btn btn-success" onclick="app.guardarMovimientoFinanzas()">
                                <span></span> Guardar
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            guardarMovimientoFinanzas: function() {
                const tipo = document.querySelector('input[name="tipoMov"]:checked').value;
                const fecha = document.getElementById('finFecha').value;
                const concepto = document.getElementById('finConcepto').value.trim();
                const monto = parseFloat(document.getElementById('finMonto').value);

                if (!fecha || !concepto || !monto || monto <= 0) {
                    this.notify('warning', 'Datos Incompletos', 'Por favor completa todos los campos correctamente');
                    return;
                }

                const movimiento = {
                    id: 'fin_' + Date.now(),
                    tipo,
                    fecha,
                    concepto,
                    monto,
                    createdAt: new Date().toISOString()
                };

                this.finanzasData.movimientos.push(movimiento);
                this.saveFinanzasData();
                document.getElementById('modalFinanzas').remove();
                this.notify('success', 'Movimiento Registrado', `${tipo === 'ingreso' ? 'Ingreso' : 'Egreso'} de ${monto.toFixed(2)} guardado`);
                this.navigate('finanzas');
            },

            eliminarMovimientoFinanzas: function(id) {
                if (!confirm('驴Eliminar este movimiento?')) return;
                this.finanzasData.movimientos = this.finanzasData.movimientos.filter(m => m.id !== id);
                this.saveFinanzasData();
                this.notify('info', 'Eliminado', 'Movimiento eliminado');
                this.navigate('finanzas');
            },

            exportarFinanzasCSV: function() {
                if (this.finanzasData.movimientos.length === 0) {
                    this.notify('warning', 'Sin datos', 'No hay movimientos para exportar');
                    return;
                }

                let csv = 'Fecha,Tipo,Concepto,Monto\\n';
                this.finanzasData.movimientos.forEach(m => {
                    csv += `${m.fecha},${m.tipo},"${m.concepto}",${m.monto}\\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `finanzas_nexus_agro_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                this.notify('success', 'Exportado', 'Archivo CSV descargado');
            },

            // ========================================
            //  SISTEMA DE BACKUP (RESPALDO Y RESTAURACIN)
            // ========================================
            renderBackup: function() {
                const ultimoBackup = localStorage.getItem('nexus_ultimo_backup') || 'Nunca';
                const totalKeys = Object.keys(localStorage).filter(k => k.startsWith('nexus')).length;

                const html = `
                    <div class="backup-section">
                        <div class="backup-section-header">
                            <div class="backup-section-icon"></div>
                            <div>
                                <div class="backup-section-title">Sistema de Respaldo</div>
                                <div class="backup-section-subtitle">Protege tus datos - Exporta y restaura cuando quieras</div>
                            </div>
                        </div>

                        <div class="backup-actions">
                            <div class="backup-card export" onclick="app.exportarBackupCompleto()">
                                <div class="backup-card-icon"></div>
                                <div class="backup-card-title">Exportar Copia de Seguridad</div>
                                <div class="backup-card-desc">
                                    Descarga un archivo .json con todos tus datos: potreros, movimientos, ganado, finanzas y configuraci贸n.
                                </div>
                            </div>

                            <div class="backup-card import" onclick="document.getElementById('backupFileInput').click()">
                                <div class="backup-card-icon"></div>
                                <div class="backup-card-title">Restaurar Copia</div>
                                <div class="backup-card-desc">
                                    Carga un archivo .json de respaldo para restaurar todos tus datos en este dispositivo.
                                </div>
                            </div>
                        </div>

                        <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="app.importarBackup(this)">

                        <div class="backup-info-box">
                            <h4> Informaci贸n Importante</h4>
                            <p>
                                 Tus datos se guardan localmente en este navegador/dispositivo.<br>
                                 Si borras el cach茅 o cambias de dispositivo, puedes perder tus datos.<br>
                                 <strong>Recomendaci贸n:</strong> Haz una copia de seguridad al menos una vez por semana.<br>
                                 ltimo respaldo: <strong>${ultimoBackup}</strong><br>
                                 Claves de datos almacenadas: <strong>${totalKeys}</strong>
                            </p>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">锔</span>
                                Datos Almacenados
                            </h3>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                <div class="stat-mini">
                                    <div class="stat-mini-icon" style="background: var(--verde-claro); color: white;">猴</div>
                                    <div class="stat-mini-content">
                                        <div class="stat-mini-label">Potreros</div>
                                        <div class="stat-mini-value">${this.data.potreros.length}</div>
                                    </div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-icon" style="background: var(--azul); color: white;"></div>
                                    <div class="stat-mini-content">
                                        <div class="stat-mini-label">Movimientos</div>
                                        <div class="stat-mini-value">${this.data.movimientos.length}</div>
                                    </div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-icon" style="background: var(--acento-dorado); color: white;"></div>
                                    <div class="stat-mini-content">
                                        <div class="stat-mini-label">Ganado</div>
                                        <div class="stat-mini-value">${(this.data.ganado || []).length}</div>
                                    </div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-icon" style="background: #10b981; color: white;"></div>
                                    <div class="stat-mini-content">
                                        <div class="stat-mini-label">Finanzas</div>
                                        <div class="stat-mini-value">${(this.finanzasData.movimientos || []).length}</div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 24px; padding: 16px; background: var(--gris-100); border-radius: 10px;">
                                <h4 style="font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    <span>锔</span> Zona de Peligro
                                </h4>
                                <p style="font-size: 13px; color: var(--gris-600); margin-bottom: 12px;">
                                    Esta acci贸n eliminar谩 TODOS tus datos de forma permanente. Aseg煤rate de tener una copia de seguridad.
                                </p>
                                <button class="btn btn-secondary" onclick="app.borrarTodosLosDatos()" style="background: #fee2e2; color: #991b1b; border-color: #fca5a5;">
                                    <span>锔</span> Borrar Todos los Datos
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('contentArea').innerHTML = html;
            },

            exportarBackupCompleto: function() {
                const backup = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    appName: 'WIN-TEL AgroManager PRO',
                    data: {}
                };

                // Recopilar todas las claves de localStorage que empiezan con 'nexus'
                const keysToBackup = [
                    'nexusAgro',
                    'nexusAgroCalcData',
                    'nexusAgroPRVConfig',
                    'nexusAgroPRVPlanificaciones',
                    'nexusAgroAlerts',
                    'nexusAgroHistory',
                    'nexus_finanzas',
                    'reportNombreFinca',
                    'weatherLocation',
                    'nexusAgroEspeciesConfig'
                ];

                keysToBackup.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        try {
                            backup.data[key] = JSON.parse(value);
                        } catch(e) {
                            backup.data[key] = value;
                        }
                    }
                });

                // Generar y descargar archivo
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                const fecha = new Date().toISOString().split('T')[0];
                link.href = URL.createObjectURL(blob);
                link.download = `backup_nexus_agro_${fecha}.json`;
                link.click();

                // Guardar fecha del 煤ltimo backup
                localStorage.setItem('nexus_ultimo_backup', new Date().toLocaleString('es-VE'));

                this.notify('success', 'Backup Exitoso', 'Tu copia de seguridad ha sido descargada. Gu谩rdala en un lugar seguro.');
            },

            importarBackup: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);

                        // Validar estructura del backup
                        if (!backup.data || !backup.appName) {
                            throw new Error('Archivo de backup inv谩lido');
                        }

                        if (!confirm(`驴Restaurar backup del ${backup.exportDate ? new Date(backup.exportDate).toLocaleString('es-VE') : 'fecha desconocida'}?\\n\\nEsto REEMPLAZAR todos tus datos actuales.`)) {
                            input.value = '';
                            return;
                        }

                        // Restaurar cada clave
                        Object.keys(backup.data).forEach(key => {
                            const value = backup.data[key];
                            if (typeof value === 'object') {
                                localStorage.setItem(key, JSON.stringify(value));
                            } else {
                                localStorage.setItem(key, value);
                            }
                        });

                        this.notify('success', 'Restauraci贸n Exitosa', 'Tus datos han sido restaurados. La p谩gina se recargar谩.');

                        setTimeout(() => location.reload(), 1500);

                    } catch(error) {
                        console.error('Error al importar backup:', error);
                        this.notify('error', 'Error de Restauraci贸n', 'El archivo no es v谩lido o est谩 corrupto. Verifica que sea un archivo .json de backup.');
                    }

                    input.value = '';
                };

                reader.onerror = () => {
                    this.notify('error', 'Error', 'No se pudo leer el archivo');
                    input.value = '';
                };

                reader.readAsText(file);
            },

            borrarTodosLosDatos: function() {
                if (!confirm('锔 ADVERTENCIA\\n\\n驴Est谩s SEGURO de que quieres borrar TODOS los datos?\\n\\nEsta acci贸n NO se puede deshacer.')) return;
                if (!confirm('LTIMA CONFIRMACIN\\n\\n驴Realmente quieres eliminar todo?\\n\\nEscribe "BORRAR" para confirmar') === 'BORRAR') {
                    // Segunda confirmaci贸n con prompt
                    const confirmText = prompt('Escribe "BORRAR" para confirmar la eliminaci贸n total:');
                    if (confirmText !== 'BORRAR') {
                        this.notify('info', 'Cancelado', 'Los datos no fueron eliminados');
                        return;
                    }
                }

                // Borrar todas las claves relacionadas
                const keysToDelete = Object.keys(localStorage).filter(k => 
                    k.startsWith('nexus') || k.startsWith('report') || k === 'weatherLocation'
                );

                keysToDelete.forEach(key => localStorage.removeItem(key));

                this.notify('success', 'Datos Eliminados', 'Todos los datos han sido borrados. Recargando...');
                setTimeout(() => location.reload(), 1500);
            }
        };

        // Inicializar aplicaci贸n cuando el DOM est茅 listo
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // ========== WIN-TEL ASISTENTE DETALLADO ==========
        const WintelAssistant = {
            isOpen: false,
            toggle() {
                if (this.isOpen) { document.getElementById('wintel-assistant')?.remove(); this.isOpen = false; return; }
                this.isOpen = true;
                const html = `
                <div id="wintel-assistant" style="position:fixed;bottom:80px;right:20px;width:400px;max-height:600px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.25);z-index:10000;display:flex;flex-direction:column;overflow:hidden;">
                    <div style="padding:18px;background:linear-gradient(135deg,#2d6a4f,#0f3629);color:#fff;display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:12px;"><i class="fa-solid fa-robot" style="font-size:22px;"></i><div><div style="font-weight:700;font-size:15px;">Asistente AgroManager</div><div style="font-size:11px;opacity:0.85;">Sistema de Gesti贸n Ganadera PRO</div></div></div>
                        <button onclick="WintelAssistant.toggle()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div style="padding:16px;flex:1;overflow-y:auto;background:#f8faf9;">
                        <div style="font-size:12px;color:#666;margin-bottom:14px;font-weight:600;">驴En qu茅 puedo ayudarte hoy?</div>
                        <div onclick="WintelAssistant.showTip('dashboard')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;"></span><div><b style="color:#2d6a4f;">Dashboard</b><br><span style="font-size:11px;color:#666;">Panel de control y KPIs</span></div></div>
                        <div onclick="WintelAssistant.showTip('potreros')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;">猴</span><div><b style="color:#2d6a4f;">Gesti贸n de Potreros</b><br><span style="font-size:11px;color:#666;">Crear, editar y administrar</span></div></div>
                        <div onclick="WintelAssistant.showTip('mapa')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;">帮</span><div><b style="color:#2d6a4f;">Mapa Satelital</b><br><span style="font-size:11px;color:#666;">Visualizaci贸n geogr谩fica</span></div></div>
                        <div onclick="WintelAssistant.showTip('geomatics')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;">Л</span><div><b style="color:#2d6a4f;">Herramientas Geom谩ticas</b><br><span style="font-size:11px;color:#666;">C谩lculos y conversiones</span></div></div>
                        <div onclick="WintelAssistant.showTip('movimientos')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;"></span><div><b style="color:#2d6a4f;">Movimientos de Ganado</b><br><span style="font-size:11px;color:#666;">Rotaci贸n y pastoreo</span></div></div>
                        <div onclick="WintelAssistant.showTip('registros')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;"></span><div><b style="color:#2d6a4f;">Historial Completo</b><br><span style="font-size:11px;color:#666;">Bit谩cora de operaciones</span></div></div>
                        <div onclick="WintelAssistant.showTip('reportes')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;"></span><div><b style="color:#2d6a4f;">Reportes y An谩lisis</b><br><span style="font-size:11px;color:#666;">Estad铆sticas avanzadas</span></div></div>
                        <div onclick="WintelAssistant.showTip('exportar')" style="padding:14px;background:#fff;border:1px solid #e5e5e5;border-radius:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:12px;transition:all 0.2s;"><span style="font-size:20px;"></span><div><b style="color:#2d6a4f;">Exportar Datos</b><br><span style="font-size:11px;color:#666;">Respaldos y formatos</span></div></div>
                    </div>
                    <div id="assistant-response" style="display:none;padding:18px;background:#fff;border-top:2px solid #52b788;font-size:13px;line-height:1.8;max-height:220px;overflow-y:auto;"></div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            },
            showTip(topic) {
                const tips = {
                    dashboard: '<b> DASHBOARD - Panel de Control</b><br><br>El Dashboard es tu centro de operaciones:<br><br> <b>KPIs en tiempo real:</b> Total de potreros, 谩rea total, animales activos, ocupaci贸n<br> <b>Gr谩ficos de distribuci贸n:</b> Visualiza la ocupaci贸n de cada potrero<br> <b>Alertas del sistema:</b> Potreros que necesitan rotaci贸n<br> <b>Actividad reciente:</b> ltimos movimientos registrados<br><br><i>Tip: Revisa el dashboard diariamente para mantener control total.</i>',
                    potreros: '<b>猴 GESTIN DE POTREROS</b><br><br>Administra todos tus potreros desde aqu铆:<br><br> <b>Crear potrero:</b> Nombre, 谩rea (ha), capacidad m谩xima<br> <b>Editar:</b> Modifica datos en cualquier momento<br> <b>Estado:</b> Disponible, Ocupado, En descanso, Mantenimiento<br> <b>Animales:</b> Asigna cantidad actual de cabezas<br> <b>Coordenadas:</b> Vincula ubicaci贸n GPS<br><br><i>Tip: Usa nombres descriptivos como "Potrero Norte - R铆o"</i>',
                    mapa: '<b>帮 MAPA SATELITAL</b><br><br>Visualizaci贸n geogr谩fica de tu finca:<br><br> <b>Vista satelital:</b> Im谩genes de alta resoluci贸n<br> <b>Dibujar potreros:</b> Herramientas de pol铆gono<br> <b>Medir 谩reas:</b> C谩lculo autom谩tico en hect谩reas<br> <b>Capas:</b> Alterna entre sat茅lite y mapa base<br> <b>Marcadores:</b> Ubica bebederos, puertas, infraestructura<br><br><i>Tip: Dibuja los l铆mites reales para c谩lculos precisos.</i>',
                    geomatics: '<b>Л HERRAMIENTAS GEOMTICAS</b><br><br>Suite completa de c谩lculos geod茅sicos:<br><br> <b>Conversi贸n UTM  Geogr谩ficas:</b> Transforma coordenadas<br> <b>C谩lculo de 谩rea:</b> Desde coordenadas o dibujo<br> <b>Distancias:</b> Entre puntos GPS<br> <b>Azimut y rumbo:</b> Orientaci贸n entre v茅rtices<br> <b>Exportar:</b> KML, CSV, GeoJSON<br><br><i>Tip: Usa zona UTM 19N para Venezuela occidental.</i>',
                    movimientos: '<b> MOVIMIENTOS DE GANADO</b><br><br>Registra toda la rotaci贸n del reba帽o:<br><br> <b>Mover animales:</b> De un potrero a otro<br> <b>Cantidad:</b> Especifica cu谩ntas cabezas<br> <b>Fecha/Hora:</b> Registro autom谩tico o manual<br> <b>Observaciones:</b> Notas del movimiento<br> <b>Historial:</b> Trazabilidad completa<br><br><i>Tip: Registra movimientos apenas ocurran para no olvidar.</i>',
                    registros: '<b> HISTORIAL COMPLETO</b><br><br>Bit谩cora de todas las operaciones:<br><br> <b>Movimientos:</b> Todos los traslados de ganado<br> <b>Cambios de estado:</b> Modificaciones a potreros<br> <b>Filtros:</b> Por fecha, potrero, tipo de acci贸n<br> <b>B煤squeda:</b> Encuentra registros espec铆ficos<br> <b>Exportar:</b> Descarga en Excel o PDF<br><br><i>Tip: Revisa el historial mensualmente para an谩lisis.</i>',
                    reportes: '<b> REPORTES Y ANLISIS</b><br><br>Estad铆sticas avanzadas de tu operaci贸n:<br><br> <b>Ocupaci贸n hist贸rica:</b> Gr谩ficos de uso por potrero<br> <b>Rotaci贸n:</b> D铆as promedio de ocupaci贸n/descanso<br> <b>Carga animal:</b> UA/ha por per铆odo<br> <b>Productividad:</b> Comparativos mensuales<br> <b>Exportar:</b> PDF profesional para informes<br><br><i>Tip: Genera reportes mensuales para toma de decisiones.</i>',
                    exportar: '<b> EXPORTAR DATOS</b><br><br>Respaldo y compatibilidad:<br><br> <b>JSON:</b> Respaldo completo del sistema<br> <b>CSV:</b> Compatible con Excel<br> <b>KML:</b> Visualizar en Google Earth<br> <b>PDF:</b> Reportes para imprimir<br> <b>Importar:</b> Restaura respaldos anteriores<br><br><i>Tip: Haz respaldo semanal en JSON para seguridad.</i>'
                };
                const resp = document.getElementById('assistant-response');
                resp.innerHTML = tips[topic] || 'Informaci贸n no disponible';
                resp.style.display = 'block';
            }
        };

        // ========== WIN-TEL GLOSARIO GANADERO COMPLETO ==========
        const WintelGlossary = {
            isOpen: false,
            terms: [
                { term: 'Potrero', def: 'rea delimitada de pastizal destinada al pastoreo del ganado. Tambi茅n llamado paddock o parcela.' },
                { term: 'Rotaci贸n', def: 'Sistema de manejo donde el ganado se mueve peri贸dicamente entre potreros para permitir la recuperaci贸n del pasto.' },
                { term: 'Carga Animal', def: 'N煤mero de animales por unidad de superficie, generalmente expresada en UA/ha (Unidades Animal por hect谩rea).' },
                { term: 'Unidad Animal (UA)', def: 'Equivalente a un bovino adulto de 450 kg. Se usa para estandarizar diferentes categor铆as de animales.' },
                { term: 'Aforo', def: 'Medici贸n de la disponibilidad de forraje en un potrero, expresada en kg de materia seca por hect谩rea.' },
                { term: 'Tiempo de Ocupaci贸n', def: 'D铆as que el ganado permanece en un potrero antes de ser movido. En PRV t铆picamente 1-3 d铆as.' },
                { term: 'Tiempo de Reposo', def: 'D铆as que un potrero descansa sin ganado para recuperaci贸n del pasto. Var铆a seg煤n clima (30-90 d铆as).' },
                { term: 'PRV', def: 'Pastoreo Racional Voisin. Sistema intensivo de manejo de pasturas desarrollado por Andr茅 Voisin.' },
                { term: 'Capacidad de Carga', def: 'M谩ximo n煤mero de animales que un potrero puede sostener sin degradar el recurso forrajero.' },
                { term: 'Sobrepastoreo', def: 'Condici贸n donde la carga animal excede la capacidad del potrero, causando degradaci贸n.' },
                { term: 'Subpastoreo', def: 'Uso insuficiente del potrero que resulta en desperdicio de forraje y p茅rdida de calidad.' },
                { term: 'Bebedero', def: 'Punto de suministro de agua para el ganado. Elemento clave en el dise帽o de potreros.' },
                { term: 'Cerca El茅ctrica', def: 'Sistema de cercado con alambre electrificado, m谩s econ贸mico y flexible que cerca tradicional.' },
                { term: 'Corredor', def: 'Camino que conecta potreros permitiendo el movimiento del ganado sin pisar 谩reas de pastoreo.' },
                { term: 'Manga', def: 'Estructura para manejo de ganado que permite vacunaci贸n, marcaje y otros procedimientos.' },
                { term: 'Destete', def: 'Separaci贸n del ternero de la madre, generalmente entre 6-8 meses de edad.' },
                { term: 'Maute', def: 'Bovino joven destetado, entre 8 meses y 2 a帽os de edad.' },
                { term: 'Novillo', def: 'Macho bovino castrado en etapa de engorde, generalmente de 2-3 a帽os.' },
                { term: 'Vaquilla', def: 'Hembra bovina joven que a煤n no ha parido.' },
                { term: 'Vaca de Cr铆a', def: 'Hembra adulta dedicada a la reproducci贸n y crianza de terneros.' },
                { term: 'Toro', def: 'Macho bovino no castrado destinado a la reproducci贸n.' },
                { term: 'Hect谩rea (ha)', def: 'Unidad de superficie equivalente a 10,000 metros cuadrados (100m x 100m).' },
                { term: 'UTM', def: 'Sistema de coordenadas Universal Transverse Mercator, expresado en metros Este y Norte.' },
                { term: 'GPS', def: 'Sistema de Posicionamiento Global. Tecnolog铆a satelital para determinar ubicaci贸n precisa.' },
                { term: 'KML', def: 'Keyhole Markup Language. Formato de archivo para visualizar datos geogr谩ficos en Google Earth.' }
            ],
            toggle() {
                if (this.isOpen) { document.getElementById('wintel-glossary')?.remove(); this.isOpen = false; return; }
                this.isOpen = true;
                const termsHtml = this.terms.map(t => `<div style="padding:14px 16px;border-bottom:1px solid #e5e5e5;"><b style="color:#2d6a4f;font-size:14px;">${t.term}</b><br><span style="font-size:12px;color:#666;line-height:1.6;">${t.def}</span></div>`).join('');
                const html = `
                <div id="wintel-glossary" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:520px;max-height:85vh;background:#fff;border-radius:16px;box-shadow:0 25px 80px rgba(0,0,0,0.3);z-index:10001;display:flex;flex-direction:column;overflow:hidden;">
                    <div style="padding:18px;background:linear-gradient(135deg,#2d6a4f,#0f3629);color:#fff;display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:12px;"><i class="fa-solid fa-book" style="font-size:22px;"></i><div><span style="font-weight:700;font-size:16px;">Glosario Ganadero</span><br><span style="font-size:11px;opacity:0.85;">${this.terms.length} t茅rminos t茅cnicos</span></div></div>
                        <button onclick="WintelGlossary.toggle()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;width:32px;height:32px;border-radius:8px;cursor:pointer;"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div style="padding:12px 16px;border-bottom:1px solid #e5e5e5;background:#f8faf9;">
                        <input type="text" id="glossary-search" placeholder=" Buscar t茅rmino..." oninput="WintelGlossary.filter(this.value)" style="width:100%;padding:12px 16px;border:1px solid #d5d5d5;border-radius:10px;font-size:14px;background:#fff;">
                    </div>
                    <div id="glossary-list" style="flex:1;overflow-y:auto;">${termsHtml}</div>
                    <div style="padding:12px;background:#f8faf9;font-size:11px;color:#666;text-align:center;border-top:1px solid #e5e5e5;">Presiona <b>F1</b> para abrir/cerrar el glosario</div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            },
            filter(query) {
                const q = query.toLowerCase();
                const filtered = this.terms.filter(t => t.term.toLowerCase().includes(q) || t.def.toLowerCase().includes(q));
                document.getElementById('glossary-list').innerHTML = filtered.map(t => `<div style="padding:14px 16px;border-bottom:1px solid #e5e5e5;"><b style="color:#2d6a4f;font-size:14px;">${t.term}</b><br><span style="font-size:12px;color:#666;line-height:1.6;">${t.def}</span></div>`).join('') || '<div style="padding:30px;text-align:center;color:#999;font-size:14px;">Sin resultados para "'+query+'"</div>';
            }
        };

        // ========== WIN-TEL TOUR GUIADO SUMAMENTE DETALLADO ==========
        const WintelTour = {
            step: 0,
            steps: [
                { 
                    target: '.sidebar', 
                    title: ' Bienvenido a WIN-TEL AgroManager', 
                    text: 'Sistema profesional para la gesti贸n integral de fincas ganaderas. Este tour te guiar谩 por todas las funciones disponibles.<br><br><b>Caracter铆sticas principales:</b><br> Gesti贸n de potreros<br> Control de rotaci贸n<br> Mapa satelital<br> Herramientas geom谩ticas<br> Reportes profesionales', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="dashboard"]', 
                    title: ' Dashboard - Centro de Control', 
                    text: 'Tu panel principal con informaci贸n en tiempo real:<br><br> <b>KPIs:</b> Potreros totales, 谩rea, animales<br> <b>Ocupaci贸n:</b> Porcentaje de uso actual<br> <b>Alertas:</b> Potreros que requieren atenci贸n<br> <b>Actividad:</b> ltimos movimientos registrados<br><br><i>Rev铆salo diariamente para control total.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="potreros"]', 
                    title: '猴 Gesti贸n de Potreros', 
                    text: 'Administra todos los potreros de tu finca:<br><br> <b>Crear:</b> Nuevo potrero con 谩rea y capacidad<br> <b>Editar:</b> Modifica nombre, estado, datos<br> <b>Estados:</b> Disponible, Ocupado, Descanso, Mantenimiento<br> <b>Animales:</b> Cantidad actual de cabezas<br> <b>Coordenadas:</b> Ubicaci贸n GPS exacta<br><br><i>Usa nombres descriptivos para f谩cil identificaci贸n.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="mapa"]', 
                    title: '帮 Mapa Satelital Interactivo', 
                    text: 'Visualizaci贸n geogr谩fica de alta precisi贸n:<br><br> <b>Im谩genes satelitales:</b> Vista real de tu finca<br> <b>Dibujar pol铆gonos:</b> Delimita potreros en el mapa<br> <b>Calcular 谩reas:</b> Hect谩reas autom谩ticas<br> <b>Marcadores:</b> Bebederos, puertas, infraestructura<br> <b>Capas:</b> Sat茅lite, mapa, h铆brido<br><br><i>Los l铆mites dibujados se sincronizan con los potreros.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="geomatics"]', 
                    title: 'Л Herramientas Geom谩ticas', 
                    text: 'Suite completa de c谩lculos geod茅sicos profesionales:<br><br> <b>Conversi贸n UTM  Geogr谩ficas:</b> Lat/Lon a Este/Norte<br> <b>C谩lculo de 谩reas:</b> Desde lista de coordenadas<br> <b>Distancias:</b> Entre puntos GPS<br> <b>Azimut y rumbo:</b> Orientaci贸n entre v茅rtices<br> <b>Zona UTM:</b> Venezuela usa zonas 18N a 21N<br><br><i>Ideal para topograf铆a y documentos legales.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="movimientos"]', 
                    title: ' Control de Movimientos', 
                    text: 'Registra toda la rotaci贸n del reba帽o:<br><br> <b>Origen  Destino:</b> De qu茅 potrero a cu谩l<br> <b>Cantidad:</b> N煤mero de cabezas movidas<br> <b>Fecha/Hora:</b> Registro autom谩tico o manual<br> <b>Observaciones:</b> Notas del movimiento<br> <b>Validaci贸n:</b> Verifica capacidad del destino<br><br><i>Registra cada movimiento para trazabilidad completa.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="registros"]', 
                    title: ' Historial Completo', 
                    text: 'Bit谩cora de todas las operaciones del sistema:<br><br> <b>Movimientos:</b> Todos los traslados de ganado<br> <b>Cambios:</b> Modificaciones a potreros<br> <b>Filtros:</b> Por fecha, potrero, tipo<br> <b>B煤squeda:</b> Encuentra registros espec铆ficos<br> <b>Exportar:</b> CSV, Excel, PDF<br><br><i>El historial no se puede borrar para auditor铆a.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="reportes"]', 
                    title: ' Reportes y An谩lisis', 
                    text: 'Estad铆sticas avanzadas para toma de decisiones:<br><br> <b>Ocupaci贸n hist贸rica:</b> Gr谩ficos de uso mensual<br> <b>Rotaci贸n:</b> Promedio d铆as ocupaci贸n/descanso<br> <b>Carga animal:</b> UA/ha por per铆odo<br> <b>Comparativos:</b> Mes actual vs anteriores<br> <b>PDF:</b> Reportes profesionales para informes<br><br><i>Genera reportes mensuales para an谩lisis de productividad.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="exportar"]', 
                    title: ' Exportar y Respaldar', 
                    text: 'Protege tu informaci贸n y comparte datos:<br><br> <b>JSON:</b> Respaldo completo del sistema<br> <b>CSV:</b> Tablas compatibles con Excel<br> <b>KML:</b> Potreros en Google Earth<br> <b>PDF:</b> Documentos para imprimir<br> <b>Importar:</b> Restaura respaldos previos<br><br><i>Haz respaldo semanal como m铆nimo.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '[data-view="config"]', 
                    title: '锔 Configuraci贸n', 
                    text: 'Personaliza el sistema a tu finca:<br><br> <b>Datos de finca:</b> Nombre, ubicaci贸n, propietario<br> <b>Zona UTM:</b> Configura tu zona geogr谩fica<br> <b>Unidades:</b> Hect谩reas, metros, etc.<br> <b>Par谩metros PRV:</b> Tiempos de rotaci贸n<br> <b>Usuarios:</b> Control de acceso<br><br><i>Configura correctamente la zona UTM para c谩lculos precisos.</i>', 
                    pos: 'right' 
                },
                { 
                    target: '.wintel-float-tools', 
                    title: '锔 Herramientas WIN-TEL', 
                    text: 'Acceso r谩pido a ayuda y recursos:<br><br> <b> Asistente:</b> Gu铆a interactiva por m贸dulo<br> <b> Glosario:</b> 25 t茅rminos ganaderos (F1)<br> <b>わ Tour:</b> Este recorrido guiado<br><br><b>Atajos de teclado:</b><br> F1 = Abrir Glosario<br><br>隆Ya est谩s listo para gestionar tu finca profesionalmente!', 
                    pos: 'left' 
                }
            ],
            start() {
                this.step = 0;
                this.showStep();
            },
            showStep() {
                document.getElementById('wintel-tour')?.remove();
                if (this.step >= this.steps.length) { 
                    alert(' 隆Tour completado!\\n\\nYa conoces todas las funciones de WIN-TEL AgroManager.\\n\\nRecuerda:\\n F1 para Glosario\\n Bot贸n  para Asistente\\n Respaldo semanal recomendado\\n\\n隆xito en tu gesti贸n ganadera!'); 
                    return; 
                }
                const s = this.steps[this.step];
                const el = document.querySelector(s.target);
                const rect = el ? el.getBoundingClientRect() : { top: 100, left: 300, right: 400, bottom: 200, width: 100, height: 50 };
                let top = rect.top, left = rect.right + 25;
                if (s.pos === 'left') { left = rect.left - 420; }
                if (left < 20) left = 20;
                if (left > window.innerWidth - 400) left = window.innerWidth - 420;
                if (top < 20) top = 20;
                if (top > window.innerHeight - 350) top = window.innerHeight - 380;
                
                const html = `
                <div id="wintel-tour" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:10002;pointer-events:none;">
                    <div style="position:absolute;top:${top}px;left:${left}px;width:400px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.25);pointer-events:auto;overflow:hidden;">
                        <div style="padding:18px;background:linear-gradient(135deg,#2d6a4f,#0f3629);color:#fff;">
                            <div style="font-weight:700;font-size:16px;">${s.title}</div>
                            <div style="font-size:11px;opacity:0.85;margin-top:4px;">Paso ${this.step + 1} de ${this.steps.length}</div>
                        </div>
                        <div style="padding:20px;font-size:13px;line-height:1.8;color:#333;max-height:280px;overflow-y:auto;">${s.text}</div>
                        <div style="padding:16px;display:flex;justify-content:space-between;border-top:1px solid #e5e5e5;background:#f8faf9;">
                            <button onclick="WintelTour.skip()" style="padding:10px 18px;background:#fff;border:1px solid #d5d5d5;border-radius:8px;color:#666;cursor:pointer;font-size:12px;font-weight:600;">Saltar Tour</button>
                            <div style="display:flex;gap:10px;">
                                ${this.step > 0 ? '<button onclick="WintelTour.prev()" style="padding:10px 18px;background:#fff;border:1px solid #d5d5d5;border-radius:8px;color:#333;cursor:pointer;font-size:12px;font-weight:600;"> Anterior</button>' : ''}
                                <button onclick="WintelTour.next()" style="padding:10px 22px;background:linear-gradient(135deg,#52b788,#2d6a4f);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:700;font-size:12px;">${this.step < this.steps.length - 1 ? 'Siguiente ' : ' Finalizar'}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            },
            next() { this.step++; this.showStep(); },
            prev() { if (this.step > 0) { this.step--; this.showStep(); } },
            skip() { document.getElementById('wintel-tour')?.remove(); }
        };

        // Atajos de teclado
        document.addEventListener('keydown', e => {
            if (e.key === 'F1') { e.preventDefault(); WintelGlossary.toggle(); }
        });

        // ========== WIN-TEL CHATBOT SYSTEM ==========
        const Chatbot = {
            config: {
                whatsappNumber: '584124060610',
                whatsappName: 'Joseph Castillo',
                appName: 'AgroManager PRO',
                appIcon: ''
            },
            
            state: 'welcome',
            failedAttempts: 0,
            isOpen: false,
            conversationContext: [],
            hasStarted: false,
            
            keywords: {
                software: ['software', 'app', 'aplicaci贸n', 'aplicacion', 'programa', 'agromanager', 'agro', 'herramienta', 'plataforma', 'suite', 'funciones', 'potrero', 'potreros', 'ganado', 'ganader铆a', 'ganaderia', 'finca', 'rotaci贸n', 'rotacion'],
                precios: ['precio', 'costo', 'cuanto', 'cu谩nto', 'vale', 'pagar', 'plan', 'suscripci贸n', 'suscripcion', 'mensual', 'anual', 'dolar', 'd贸lares', 'dolares', 'tarifa', 'cobran', 'cuesta', 'licencia'],
                servicios: ['drone', 'dron', 'vuelo', 'fotogrametr铆a', 'fotogrametria', 'levantamiento', 'servicio', 'campo', 'topograf铆a', 'topografia', 'ortomosaico', 'mapa', 'a茅reo', 'aereo', 'prv', 'voisin'],
                prueba: ['probar', 'prueba', 'gratis', 'demo', 'free', 'trial', 'gratuito', 'sin pagar', 'testear', 'evaluar'],
                soporte: ['ayuda', 'soporte', 'problema', 'error', 'funciona', 'no puedo', 'bug', 'falla', 'no carga', 'lento', 'tutorial', 'como', 'c贸mo', 'registrar', 'movimiento'],
                human: ['persona', 'humano', 'hablar', 'llamar', 'asesor', 'contactar', 'whatsapp', 'tel茅fono', 'telefono', 'agente', 'vendedor', 'representante', 'joseph']
            },
            
            responses: {
                welcome: {
                    message: `隆Hola!  Soy el asistente virtual de <b>WIN-TEL GeoSuite</b>.\n\n驴En qu茅 puedo ayudarte hoy?`,
                    options: [
                        { text: ' Sobre AgroManager', icon: 'fa-cow', next: 'software' },
                        { text: ' Servicios con Drones', icon: 'fa-helicopter', next: 'servicios' },
                        { text: ' Precios y Planes', icon: 'fa-tags', next: 'precios' },
                        { text: ' Soporte T茅cnico', icon: 'fa-graduation-cap', next: 'soporte' },
                        { text: ' Hablar con una persona', icon: 'fa-phone', next: 'human' }
                    ]
                },
                
                software: {
                    message: `<b> AgroManager PRO - Gesti贸n Ganadera</b>\n\nSistema profesional para la <b>gesti贸n integral de fincas ganaderas</b>.\n\n<b>M贸dulos principales:</b>\n Dashboard con KPIs en tiempo real\n猴 Gesti贸n de potreros\n帮 Mapa satelital interactivo\n Control de movimientos/rotaci贸n\n Historial y registros\n Reportes y an谩lisis\nЛ Herramientas geom谩ticas\n\n<b>Ideal para:</b>\nFincas ganaderas, sistemas PRV/Voisin, administraci贸n de haciendas.`,
                    options: [
                        { text: ' 驴C贸mo probar gratis?', icon: 'fa-gift', next: 'prueba' },
                        { text: ' 驴Qu茅 es rotaci贸n PRV?', icon: 'fa-sync', next: 'prv_info' },
                        { text: ' Ver precios', icon: 'fa-dollar-sign', next: 'precios' },
                        { text: '猬锔 Volver al inicio', icon: 'fa-arrow-left', next: 'welcome' }
                    ]
                },
                
                prv_info: {
                    message: `<b> Sistema PRV - Pastoreo Racional Voisin</b>\n\nAgroManager est谩 dise帽ado para implementar el sistema PRV:\n\n<b>驴Qu茅 es PRV?</b>\n Rotaci贸n planificada del ganado\n Ocupaci贸n corta (1-3 d铆as)\n Descanso largo (30-60 d铆as)\n Alta carga instant谩nea\n\n<b>Beneficios:</b>\n Mayor producci贸n de pasto\n Recuperaci贸n del suelo\n Mejor distribuci贸n de esti茅rcol\n Control de malezas natural\n\n<b>Con AgroManager:</b>\n Registra cada movimiento\n Calcula d铆as de ocupaci贸n/descanso\n Alertas autom谩ticas de rotaci贸n\n Reportes de productividad`,
                    options: [
                        { text: ' 驴C贸mo registrar movimientos?', icon: 'fa-route', next: 'tutorial' },
                        { text: ' Probar gratis', icon: 'fa-rocket', next: 'prueba' },
                        { text: ' Asesor铆a PRV', icon: 'fa-user-tie', next: 'human' },
                        { text: '猬锔 Volver', icon: 'fa-arrow-left', next: 'software' }
                    ]
                },
                
                precios: {
                    message: ` <b>Plan Profesional WIN-TEL GeoSuite</b>\n\n Acceso a las 7 aplicaciones (incluye AgroManager)\n Gesti贸n ilimitada de potreros\n Mapa satelital integrado\n Reportes PDF profesionales\n Soporte WhatsApp prioritario\n\n<b style="font-size:18px;color:#52b788;">$29/mes</b> o <b style="font-size:18px;color:#d4a373;">$199/a帽o</b> <small>(ahorras $149)</small>\n\n <b>Prueba GRATIS por 2 d铆as</b> sin tarjeta.`,
                    options: [
                        { text: ' Comenzar prueba gratis', icon: 'fa-play', next: 'prueba' },
                        { text: ' 驴C贸mo pagar?', icon: 'fa-credit-card', next: 'pago' },
                        { text: ' Hablar con ventas', icon: 'fa-headset', next: 'human' },
                        { text: '猬锔 Volver al inicio', icon: 'fa-arrow-left', next: 'welcome' }
                    ]
                },
                
                pago: {
                    message: ` <b>M茅todos de Pago:</b>\n\n <b>Internacional:</b>\n PayPal\n Tarjetas Visa/Mastercard\n Zelle\n\n火 <b>Venezuela:</b>\n Transferencia bancaria\n Pago m贸vil\n Binance (USDT)\n\nContacta para procesar tu pago:`,
                    options: [
                        { text: ' Contactar para pagar', icon: 'fa-comments', next: 'human' },
                        { text: ' Primero quiero probar', icon: 'fa-flask', next: 'prueba' },
                        { text: '猬锔 Volver', icon: 'fa-arrow-left', next: 'precios' }
                    ]
                },
                
                servicios: {
                    message: ` <b>Servicios Profesionales:</b>\n\n <b>Fotogrametr铆a con Drones</b>\nOrtomosaicos HD de tu finca completa.\n\n <b>An谩lisis NDVI</b>\nEstado del pasto, estr茅s h铆drico, plagas.\n\n <b>Levantamientos Topogr谩ficos</b>\nDelimitaci贸n precisa de potreros.\n\n <b>Dise帽o PRV/Voisin</b>\nDivisi贸n optimizada para ganader铆a regenerativa.\n\n <b>Consultor铆a Ganadera</b>\nImplementaci贸n de sistemas PRV.`,
                    options: [
                        { text: ' Solicitar cotizaci贸n', icon: 'fa-file-invoice-dollar', next: 'cotizacion' },
                        { text: ' 驴D贸nde trabajan?', icon: 'fa-map-marker-alt', next: 'cobertura' },
                        { text: '猬锔 Volver al inicio', icon: 'fa-arrow-left', next: 'welcome' }
                    ]
                },
                
                cotizacion: {
                    message: ` <b>Solicitud de Cotizaci贸n</b>\n\nPara presupuestar necesito:\n\n Ubicaci贸n de la finca\n Superficie total (hect谩reas)\n N煤mero de potreros\n Cantidad de cabezas de ganado\n Tipo de servicio requerido\n\nConversemos por WhatsApp:`,
                    options: [
                        { text: ' Solicitar cotizaci贸n', icon: 'fa-whatsapp', next: 'human' },
                        { text: '猬锔 Ver m谩s servicios', icon: 'fa-arrow-left', next: 'servicios' }
                    ],
                    isHuman: true
                },
                
                cobertura: {
                    message: ` <b>Zona de Cobertura</b>\n\n火 <b>Venezuela - Nacional</b>\n\n<b>Servicios presenciales:</b>\n Carabobo, Aragua, Cojedes, Yaracuy\n Llanos: Gu谩rico, Barinas, Apure\n Otras zonas: consultar\n\n<b>Software:</b>\n Disponible mundial \n Soporte espa帽ol 24h`,
                    options: [
                        { text: ' Solicitar cotizaci贸n', icon: 'fa-file-invoice-dollar', next: 'cotizacion' },
                        { text: ' Consultar disponibilidad', icon: 'fa-phone', next: 'human' },
                        { text: '猬锔 Volver', icon: 'fa-arrow-left', next: 'servicios' }
                    ]
                },
                
                prueba: {
                    message: ` <b>隆Excelente!</b>\n\nComienza tu <b>prueba gratuita de 2 d铆as</b>:\n\n <a href="https://wintel-geosuite.netlify.app" target="_blank" style="color:#52b788;text-decoration:underline;font-weight:700;">wintel-geosuite.netlify.app</a>\n\n<b>Pasos:</b>\n1锔 Reg铆strate con tu email\n2锔 Confirma tu cuenta\n3锔 隆Acceso completo a AgroManager!\n\n<small>Sin tarjeta. Sin compromiso.</small>`,
                    options: [
                        { text: ' Tengo dudas t茅cnicas', icon: 'fa-question-circle', next: 'soporte' },
                        { text: ' Prefiero que me llamen', icon: 'fa-phone-volume', next: 'human' },
                        { text: '猬锔 Volver al inicio', icon: 'fa-arrow-left', next: 'welcome' }
                    ]
                },
                
                soporte: {
                    message: ` <b>Soporte T茅cnico AgroManager</b>\n\n驴Qu茅 ayuda necesitas?`,
                    options: [
                        { text: ' 驴C贸mo registrar movimientos?', icon: 'fa-route', next: 'tutorial' },
                        { text: '猴 驴C贸mo usar el mapa?', icon: 'fa-map', next: 'tutorial_mapa' },
                        { text: ' Reportar un error', icon: 'fa-bug', next: 'error' },
                        { text: ' Hablar con soporte', icon: 'fa-headset', next: 'human' },
                        { text: '猬锔 Volver al inicio', icon: 'fa-arrow-left', next: 'welcome' }
                    ]
                },
                
                tutorial: {
                    message: ` <b>C贸mo registrar movimientos:</b>\n\n<b>Paso 1:</b> Ve al m贸dulo "Movimientos"\n\n<b>Paso 2:</b> Click en "Nuevo Movimiento"\n\n<b>Paso 3:</b> Selecciona:\n <b>Origen:</b> Potrero de salida\n <b>Destino:</b> Potrero de llegada\n <b>Cantidad:</b> Cabezas a mover\n <b>Fecha:</b> Autom谩tica o manual\n\n<b>Paso 4:</b> Agrega observaciones (opcional)\n\n<b>Paso 5:</b> Click en "Registrar"\n\n<b>Tip:</b> El sistema valida la capacidad del destino autom谩ticamente.`,
                    options: [
                        { text: ' 驴Qu茅 es PRV?', icon: 'fa-sync', next: 'prv_info' },
                        { text: ' Ayuda personalizada', icon: 'fa-user-check', next: 'human' },
                        { text: '猬锔 Volver', icon: 'fa-arrow-left', next: 'soporte' }
                    ]
                },
                
                tutorial_mapa: {
                    message: `猴 <b>C贸mo usar el mapa satelital:</b>\n\n<b>Ver potreros:</b>\n Los potreros aparecen como pol铆gonos de colores\n Verde = Disponible\n Rojo = Ocupado\n Amarillo = Descanso\n\n<b>Dibujar potrero:</b>\n1锔 Click en herramienta de pol铆gono\n2锔 Dibuja los v茅rtices en el mapa\n3锔 El 谩rea se calcula autom谩ticamente\n\n<b>Navegar:</b>\n Scroll para zoom\n Arrastrar para mover\n Capas: Sat茅lite, Mapa, H铆brido`,
                    options: [
                        { text: ' 驴C贸mo registrar movimientos?', icon: 'fa-route', next: 'tutorial' },
                        { text: ' Ayuda personalizada', icon: 'fa-user-check', next: 'human' },
                        { text: '猬锔 Volver', icon: 'fa-arrow-left', next: 'soporte' }
                    ]
                },
                
                error: {
                    message: ` <b>Reportar un Error</b>\n\nPara ayudarte necesito:\n\n 驴En qu茅 m贸dulo ocurri贸?\n 驴Qu茅 acci贸n realizabas?\n 驴Qu茅 mensaje apareci贸?\n\nConversemos por WhatsApp:`,
                    options: [
                        { text: ' Reportar error', icon: 'fa-whatsapp', next: 'human' },
                        { text: '猬锔 Volver a soporte', icon: 'fa-arrow-left', next: 'soporte' }
                    ],
                    isHuman: true
                },
                
                human: {
                    message: `ㄢ <b>隆Perfecto!</b> Te conectar茅 con <b>Joseph Castillo</b>, especialista en ganader铆a regenerativa y sistemas PRV.\n\nContacta por WhatsApp:`,
                    options: [],
                    isHuman: true
                },
                
                fallback: {
                    message: ` No estoy seguro de entender tu pregunta.\n\n驴Puedo ayudarte con algo de esto?`,
                    options: [
                        { text: ' Sobre AgroManager', icon: 'fa-cow', next: 'software' },
                        { text: ' Servicios con Drones', icon: 'fa-helicopter', next: 'servicios' },
                        { text: ' Precios y Planes', icon: 'fa-tags', next: 'precios' },
                        { text: ' Hablar con una persona', icon: 'fa-phone', next: 'human' }
                    ]
                }
            },
            
            init() {
                this.createHTML();
                this.bindEvents();
                console.log('WIN-TEL Chatbot initialized for AgroManager');
            },
            
            createHTML() {
                const html = `
                    <button class="chatbot-btn" id="chatbot-btn" onclick="Chatbot.toggle()">
                        <i class="fa-solid fa-comments"></i>
                        <span class="chat-badge"></span>
                    </button>
                    <div class="chatbot-container" id="chatbot-container">
                        <div class="chatbot-header">
                            <div class="chatbot-avatar"></div>
                            <div class="chatbot-info">
                                <div class="chatbot-name">Asistente WIN-TEL</div>
                                <div class="chatbot-status">En l铆nea</div>
                            </div>
                            <button class="chatbot-close" onclick="Chatbot.toggle()">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="chatbot-messages" id="chatbot-messages"></div>
                        <div class="chatbot-input">
                            <input type="text" id="chatbot-input" placeholder="Escribe tu mensaje..." onkeypress="Chatbot.handleKeyPress(event)">
                            <button class="chatbot-send" onclick="Chatbot.sendUserMessage()">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
            },
            
            bindEvents() {
                const btn = document.getElementById('chatbot-btn');
                if (btn) {
                    btn.addEventListener('click', () => {
                        const badge = btn.querySelector('.chat-badge');
                        if (badge) badge.style.display = 'none';
                    }, { once: true });
                }
            },
            
            toggle() {
                const container = document.getElementById('chatbot-container');
                if (!container) return;
                this.isOpen = !this.isOpen;
                container.classList.toggle('active', this.isOpen);
                if (this.isOpen && !this.hasStarted) {
                    this.hasStarted = true;
                    setTimeout(() => this.showResponse('welcome'), 300);
                }
                if (this.isOpen) {
                    setTimeout(() => {
                        const input = document.getElementById('chatbot-input');
                        if (input) input.focus();
                    }, 400);
                }
            },
            
            showResponse(state) {
                const response = this.responses[state];
                if (!response) { this.showResponse('fallback'); return; }
                this.state = state;
                this.addTypingIndicator();
                setTimeout(() => {
                    this.removeTypingIndicator();
                    this.addBotMessage(response.message, response.options, response.isHuman);
                }, 600 + Math.random() * 400);
            },
            
            addBotMessage(text, options = [], isHuman = false) {
                const messagesDiv = document.getElementById('chatbot-messages');
                if (!messagesDiv) return;
                const msgDiv = document.createElement('div');
                msgDiv.className = 'chat-message bot';
                msgDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                if (options && options.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'chat-options';
                    options.forEach(opt => {
                        const optBtn = document.createElement('button');
                        optBtn.className = 'chat-option';
                        optBtn.innerHTML = `<i class="fa-solid ${opt.icon || 'fa-chevron-right'}"></i> ${opt.text}`;
                        optBtn.onclick = () => this.handleOption(opt.next);
                        optionsDiv.appendChild(optBtn);
                    });
                    msgDiv.appendChild(optionsDiv);
                }
                if (isHuman) {
                    const waBtn = document.createElement('a');
                    waBtn.className = 'whatsapp-btn';
                    waBtn.href = this.generateWhatsAppUrl();
                    waBtn.target = '_blank';
                    waBtn.innerHTML = `<i class="fa-brands fa-whatsapp"></i> Abrir WhatsApp`;
                    msgDiv.appendChild(waBtn);
                }
                messagesDiv.appendChild(msgDiv);
                this.scrollToBottom();
            },
            
            addUserMessage(text) {
                const messagesDiv = document.getElementById('chatbot-messages');
                if (!messagesDiv) return;
                const msgDiv = document.createElement('div');
                msgDiv.className = 'chat-message user';
                msgDiv.textContent = text;
                messagesDiv.appendChild(msgDiv);
                this.scrollToBottom();
                this.conversationContext.push({ role: 'user', text });
            },
            
            addTypingIndicator() {
                const messagesDiv = document.getElementById('chatbot-messages');
                if (!messagesDiv) return;
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.id = 'typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                messagesDiv.appendChild(typing);
                this.scrollToBottom();
            },
            
            removeTypingIndicator() {
                const typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();
            },
            
            handleOption(nextState) {
                this.failedAttempts = 0;
                this.showResponse(nextState);
            },
            
            sendUserMessage() {
                const input = document.getElementById('chatbot-input');
                if (!input || !input.value.trim()) return;
                const text = input.value.trim();
                input.value = '';
                this.addUserMessage(text);
                const intent = this.detectIntent(text);
                if (intent) {
                    this.failedAttempts = 0;
                    this.showResponse(intent);
                } else {
                    this.failedAttempts++;
                    if (this.failedAttempts >= 2) {
                        this.addTypingIndicator();
                        setTimeout(() => {
                            this.removeTypingIndicator();
                            this.addBotMessage('Parece que necesitas atenci贸n especializada. \n\nTe recomiendo hablar con nuestro equipo:', [], true);
                        }, 800);
                    } else {
                        this.showResponse('fallback');
                    }
                }
            },
            
            detectIntent(text) {
                const normalizedText = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                for (const [intent, words] of Object.entries(this.keywords)) {
                    if (words.some(word => normalizedText.includes(word))) return intent;
                }
                return null;
            },
            
            handleKeyPress(event) {
                if (event.key === 'Enter') this.sendUserMessage();
            },
            
            generateWhatsAppUrl() {
                const context = this.conversationContext.slice(-3).map(c => c.text).join(' | ');
                let message = `Hola, vengo del chatbot de WIN-TEL GeoSuite (${this.config.appName}).`;
                if (context) message += `\n\nContexto: ${context.substring(0, 100)}...`;
                message += '\n\nNecesito ayuda con...';
                return `https://wa.me/${this.config.whatsappNumber}?text=${encodeURIComponent(message)}`;
            },
            
            scrollToBottom() {
                const messagesDiv = document.getElementById('chatbot-messages');
                if (messagesDiv) setTimeout(() => { messagesDiv.scrollTop = messagesDiv.scrollHeight; }, 50);
            }
        };

        setTimeout(() => Chatbot.init(), 2500);

        // Ocultar splash despu茅s de cargar
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            if (splash) splash.classList.add('hidden');
        }, 2000);

    // ================================================================
    // WIN-TEL AGROMANAGER PRO v4 - SISTEMA DE PROTECCIN Y LICENCIAS
    // Versi贸n: 1.0 | WindowsTelecom C.A.
    // ================================================================

    // ===== PROTECCIN ANTI-DEVTOOLS =====
    (function() {
        const threshold = 160;
        const devtools = { isOpen: false, orientation: undefined };
        
        const emitEvent = (isOpen, orientation) => {
            globalThis.dispatchEvent(new globalThis.CustomEvent('devtoolschange', {
                detail: { isOpen, orientation }
            }));
        };

        const check = () => {
            const widthThreshold = globalThis.outerWidth - globalThis.innerWidth > threshold;
            const heightThreshold = globalThis.outerHeight - globalThis.innerHeight > threshold;
            const orientation = widthThreshold ? 'vertical' : 'horizontal';

            if (!(heightThreshold && widthThreshold) &&
                ((globalThis.Firebug && globalThis.Firebug.chrome && globalThis.Firebug.chrome.isInitialized) || widthThreshold || heightThreshold)) {
                if (!devtools.isOpen || devtools.orientation !== orientation) {
                    emitEvent(true, orientation);
                }
                devtools.isOpen = true;
                devtools.orientation = orientation;
            } else {
                if (devtools.isOpen) {
                    emitEvent(false, undefined);
                }
                devtools.isOpen = false;
                devtools.orientation = undefined;
            }
        };

        setInterval(check, 500);
        check();

        globalThis.addEventListener('devtoolschange', (e) => {
            if (e.detail.isOpen) {
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#0f3629;color:#fff;font-family:sans-serif;text-align:center;padding:40px;"><div><h1 style="font-size:48px;margin-bottom:20px;">锔</h1><h2>Acceso No Autorizado</h2><p style="opacity:0.7;margin-top:10px;">Las herramientas de desarrollo est谩n deshabilitadas.<br>WIN-TEL AgroManager PRO - Software Protegido</p></div></div>';
            }
        });
    })();

    // ===== BLOQUEO CLIC DERECHO Y ATAJOS =====
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
            (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
        }
    });

    // ===== SISTEMA DE LICENCIAS =====
    const AgroLicenseSystem = {
        licenseKey: null,
        hardwareId: null,
        isActivated: false,
        
        async generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('AGRO-WT', 0, 0);
            const canvasData = canvas.toDataURL();
            
            const fingerprint = {
                canvas: canvasData.slice(-50),
                screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                cores: navigator.hardwareConcurrency || 2,
                memory: navigator.deviceMemory || 4,
                userAgent: navigator.userAgent.slice(0, 100)
            };
            
            const fingerprintStr = JSON.stringify(fingerprint);
            this.hardwareId = await this.hashString(fingerprintStr);
            return this.hardwareId;
        },
        
        async hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        },
        
        validateFormat(license) {
            const pattern = /^[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}$/;
            return pattern.test(license);
        },
        
        async verifyLicense(license, hwid) {
            const parts = license.split('-');
            const licenseCore = parts.slice(0, 3).join('');
            const checksum = parts[3];
            
            const expectedChecksumActual = await this.generateChecksum(licenseCore, hwid);
            const expectedChecksumUniversal = await this.generateChecksum(licenseCore, 'UNIVERSAL');
            
            return checksum === expectedChecksumActual || checksum === expectedChecksumUniversal;
        },
        
        async generateChecksum(licenseCore, hwid) {
            const combined = licenseCore + hwid;
            const hash = await this.hashString(combined);
            return hash.slice(0, 5).toUpperCase();
        },
        
        async activate() {
            const savedLicense = localStorage.getItem('wt_agro_license');
            const savedHWID = localStorage.getItem('wt_agro_hwid');
            await this.generateFingerprint();
            
            if (savedLicense && savedHWID) {
                if (savedHWID === this.hardwareId) {
                    const isValid = await this.verifyLicense(savedLicense, this.hardwareId);
                    if (isValid) {
                        this.licenseKey = savedLicense;
                        this.isActivated = true;
                        return { success: true, message: 'Licencia v谩lida' };
                    } else {
                        return { success: false, message: 'Licencia corrupta' };
                    }
                } else {
                    return { success: false, message: 'Esta licencia est谩 vinculada a otra computadora' };
                }
            }
            
            return await this.promptLicense();
        },
        
        async promptLicense() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.id = 'agro-license-modal';
                modal.innerHTML = `
                    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 99999; display: flex; align-items: center; justify-content: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                        <div style="background: linear-gradient(135deg, #0f3629 0%, #2d6a4f 100%); border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 2px solid #52b788;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #52b788, #2d6a4f); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(82, 183, 136, 0.3); font-size: 36px;">
                                    
                                </div>
                                <h2 style="color: white; margin: 0; font-size: 28px; font-weight: 800;">WIN-TEL AgroManager PRO</h2>
                                <p style="color: #94a3b8; margin: 10px 0 0; font-size: 14px;">Versi贸n 4.0 Professional</p>
                            </div>
                            
                            <div style="background: rgba(82, 183, 136, 0.1); border: 1px solid rgba(82, 183, 136, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                                <div style="color: #52b788; font-size: 12px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;"> ACTIVACIN REQUERIDA</div>
                                <p style="color: #cbd5e1; font-size: 13px; margin: 0; line-height: 1.6;">
                                    Ingresa tu c贸digo de licencia para activar WIN-TEL AgroManager PRO en esta computadora.
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-size: 11px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">C贸digo de Licencia</label>
                                <input 
                                    type="text" 
                                    id="agro-license-input" 
                                    placeholder="XXXXX-XXXXX-XXXXX-XXXXX"
                                    maxlength="23"
                                    style="width: 100%; padding: 15px; background: rgba(51, 65, 85, 0.7); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; color: white; font-family: 'Courier New', monospace; font-size: 16px; font-weight: 600; text-align: center; letter-spacing: 2px; text-transform: uppercase;"
                                >
                            </div>
                            
                            <div id="agro-license-error" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                                <div style="color: #ef4444; font-size: 12px; font-weight: 600;"> Error de activaci贸n</div>
                                <div id="agro-license-error-msg" style="color: #fca5a5; font-size: 11px; margin-top: 4px;"></div>
                            </div>
                            
                            <button 
                                id="agro-activate-btn"
                                style="width: 100%; padding: 16px; background: linear-gradient(135deg, #52b788, #2d6a4f); border: none; border-radius: 8px; color: white; font-weight: 800; font-size: 14px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(82, 183, 136, 0.4); transition: all 0.2s;"
                            >
                                 Activar Licencia
                            </button>
                            
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2); text-align: center;">
                                <p style="color: #64748b; font-size: 11px; margin: 0 0 10px;">驴No tienes una licencia?</p>
                                <a href="mailto:windowstelecom@gmail.com" style="color: #52b788; font-size: 12px; font-weight: 600; text-decoration: none; display: block; margin-bottom: 8px;"> windowstelecom@gmail.com</a>
                                <a href="https://wa.me/584124060610" target="_blank" style="color: #52b788; font-size: 12px; font-weight: 600; text-decoration: none; display: block;"> WhatsApp: +58 412-406-0610</a>
                            </div>
                            
                            <div style="margin-top: 20px; background: rgba(100, 116, 139, 0.1); border-radius: 8px; padding: 12px;">
                                <div style="color: #64748b; font-size: 10px; line-height: 1.5;">
                                    <strong>ID de Hardware:</strong><br>
                                    <code style="color: #94a3b8; font-family: monospace; font-size: 9px; word-break: break-all;">${this.hardwareId || 'Generando...'}</code>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const input = document.getElementById('agro-license-input');
                const btn = document.getElementById('agro-activate-btn');
                const errorDiv = document.getElementById('agro-license-error');
                const errorMsg = document.getElementById('agro-license-error-msg');
                
                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/[^A-Z0-9]/g, '').toUpperCase();
                    let formatted = '';
                    for (let i = 0; i < value.length && i < 20; i++) {
                        if (i > 0 && i % 5 === 0) formatted += '-';
                        formatted += value[i];
                    }
                    e.target.value = formatted;
                    errorDiv.style.display = 'none';
                });
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') btn.click();
                });
                
                btn.onclick = async () => {
                    const license = input.value.trim();
                    
                    if (!this.validateFormat(license)) {
                        errorMsg.textContent = 'Formato de licencia inv谩lido. Debe ser: XXXXX-XXXXX-XXXXX-XXXXX';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    btn.textContent = ' Verificando...';
                    btn.disabled = true;
                    
                    const isValid = await this.verifyLicense(license, this.hardwareId);
                    
                    if (isValid) {
                        localStorage.setItem('wt_agro_license', license);
                        localStorage.setItem('wt_agro_hwid', this.hardwareId);
                        
                        this.licenseKey = license;
                        this.isActivated = true;
                        
                        btn.textContent = ' 隆Activado!';
                        btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                        
                        setTimeout(() => {
                            modal.remove();
                            resolve({ success: true, message: 'Licencia activada correctamente' });
                        }, 1000);
                    } else {
                        errorMsg.textContent = 'C贸digo de licencia inv谩lido. Verifica que est茅 correctamente escrito.';
                        errorDiv.style.display = 'block';
                        btn.textContent = ' Activar Licencia';
                        btn.disabled = false;
                        
                        resolve({ success: false, message: 'Licencia inv谩lida' });
                    }
                };
                
                setTimeout(() => input.focus(), 300);
            });
        },
        
        lockApp() {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #0f3629 0%, #2d6a4f 100%); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="text-align: center; max-width: 500px; padding: 40px;">
                        <div style="font-size: 80px; margin-bottom: 20px;"></div>
                        <h1 style="color: white; font-size: 32px; margin-bottom: 15px; font-weight: 800;">Licencia Requerida</h1>
                        <p style="color: #94a3b8; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                            WIN-TEL AgroManager PRO requiere una licencia v谩lida para funcionar.
                        </p>
                        <button 
                            onclick="location.reload()"
                            style="padding: 15px 40px; background: linear-gradient(135deg, #52b788, #2d6a4f); border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 14px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(82, 183, 136, 0.4);"
                        >
                            Reintentar Activaci贸n
                        </button>
                        <div style="margin-top: 30px;">
                            <a href="https://wa.me/584124060610" style="color: #52b788; font-size: 14px; text-decoration: none; font-weight: 600;">
                                 Adquirir Licencia
                            </a>
                        </div>
                    </div>
                </div>
            `;
        },
        
        async init() {
            const result = await this.activate();
            
            if (!result.success) {
                let attempts = 0;
                while (attempts < 2 && !this.isActivated) {
                    attempts++;
                    const retry = await this.promptLicense();
                    if (retry.success) {
                        this.isActivated = true;
                        break;
                    }
                }
                
                if (!this.isActivated) {
                    this.lockApp();
                    return false;
                }
            }
            
            return true;
        }
    };

    // ===== INICIALIZACIN DEL SISTEMA DE LICENCIAS =====
    (async function() {
        const activated = await AgroLicenseSystem.init();
        
        if (activated) {
            console.log(' WIN-TEL AgroManager PRO v4 - Licencia v谩lida');
            console.log(' Software de Gesti贸n Ganadera Profesional');
            console.log(' Soporte: windowstelecom@gmail.com');
        } else {
            console.error(' Activaci贸n fallida - Contacte al proveedor');
        }
    })();
    </script>

</body>
</html>
